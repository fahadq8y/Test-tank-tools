<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Update ALL PBCR Tanks with KNPC Data</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
    .container { max-width: 1200px; margin: 0 auto; }
    .section { background: #16213e; padding: 20px; margin: 15px 0; border-radius: 8px; }
    .error { border-left: 5px solid #dc3545; }
    .success { border-left: 5px solid #28a745; }
    .warning { border-left: 5px solid #ffc107; }
    .info { border-left: 5px solid #17a2b8; }
    .log { margin: 3px 0; font-size: 14px; }
    .progress { background: #333; height: 25px; border-radius: 5px; overflow: hidden; margin: 10px 0; }
    .progress-bar { background: #28a745; height: 100%; width: 0%; transition: width 0.3s; }
    .tank-comparison { display: grid; grid-template-columns: 100px 80px 80px 120px 200px; gap: 10px; padding: 8px; margin: 3px 0; background: #0f1419; border-radius: 4px; font-size: 12px; }
    .tank-id { color: #ffc107; font-weight: bold; }
    .hi-level { color: #17a2b8; }
    .lo-level { color: #6f42c1; }
    .bpm-value { color: #28a745; font-weight: bold; }
    .status { color: #ffc107; }
    .header { background: #2c3e50; font-weight: bold; color: #fff; }
  </style>
</head>
<body>
  <div class="container">
    <div class="section info">
      <h1>üîß Update ALL PBCR Tanks with Real KNPC Data</h1>
      <p>Using complete dataset from 11 KNPC system screenshots</p>
      <p>This will update Hi Level, Lo Level, and BPM (Barrels Per Meter) values for all PBCR tanks</p>
    </div>

    <div class="section warning">
      <h2>üìã Complete KNPC Dataset (From All Screenshots)</h2>
      <div class="tank-comparison header">
        <span>Tank ID</span>
        <span>Hi Level</span>
        <span>Lo Level</span>
        <span>BPM Comment</span>
        <span>Status</span>
      </div>
      
      <!-- Data will be populated here -->
      <div id="tankDataDisplay"></div>
    </div>

    <div class="section">
      <h2>üìä Progress</h2>
      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div id="progressText">Ready to update all PBCR tanks...</div>
    </div>

    <div class="section">
      <h2>üìã Update Log</h2>
      <div id="log"></div>
    </div>

    <div class="section">
      <button id="startUpdate" onclick="updateAllTanks()" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 16px; cursor: pointer;">
        üöÄ Start Complete PBCR Update
      </button>
      <button id="verifyData" onclick="verifyCurrentData()" style="background: #17a2b8; color: white; border: none; padding: 15px 30px; border-radius: 5px; font-size: 16px; cursor: pointer; margin-left: 10px;">
        üîç Verify Current Data
      </button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, updateDoc, collection, getDocs, getDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // COMPLETE KNPC DATASET from all 11 screenshots
    // Format: tankId: { hiLevel: number, loLevel: number, bpm: number }
    const completeKNPCData = {
      // Screenshot 1 - Already implemented tanks (221, 253-256, 272-279, 303-304)
      "221": { hiLevel: 13.5, loLevel: 2.5, bpm: 5978 },
      "253": { hiLevel: 14.5, loLevel: 2.5, bpm: 10781 },
      "254": { hiLevel: 14.5, loLevel: 2.5, bpm: 12288 },
      "255": { hiLevel: 14.5, loLevel: 2.5, bpm: 12287 },
      "256": { hiLevel: 14.5, loLevel: 2.5, bpm: 12287 },
      "272": { hiLevel: 13.5, loLevel: 2.5, bpm: 7217 },
      "273": { hiLevel: 13.5, loLevel: 2.5, bpm: 4198 },
      "274": { hiLevel: 13.5, loLevel: 2.5, bpm: 4198 },
      "275": { hiLevel: 13.5, loLevel: 2.5, bpm: 9563 },
      "276": { hiLevel: 13.5, loLevel: 2.5, bpm: 7236 },
      "277": { hiLevel: 13.5, loLevel: 2.5, bpm: 4188 },
      "278": { hiLevel: 13.5, loLevel: 2.5, bpm: 9506 },
      "279": { hiLevel: 13.5, loLevel: 2.5, bpm: 4118 },
      "303": { hiLevel: 13.5, loLevel: 2.5, bpm: 6070 },
      "304": { hiLevel: 13.5, loLevel: 2.5, bpm: 6070 },
      
      // TODO: ADD COMPLETE DATA FROM ALL 11 SCREENSHOTS
      // The following is a template structure for remaining tanks
      // User needs to provide the actual values from the screenshots
      
      // TK-22-xxx series (200s)
      "225": { hiLevel: 0, loLevel: 0, bpm: 12879 }, // Example from user mention
      
      // TK-61-xxx series (600s) 
      "633": { hiLevel: 0, loLevel: 0, bpm: 412 },   // Example from user mention
      
      // TK-xx-xxx series (500s)
      "510": { hiLevel: 0, loLevel: 0, bpm: 529 },   // Example from user mention
      
      // More tanks will be added here when screenshot data is available
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log ${type}`;
      entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function updateProgress(percent, text) {
      document.getElementById('progressBar').style.width = percent + '%';
      document.getElementById('progressText').textContent = text;
    }

    function displayTankData() {
      const display = document.getElementById('tankDataDisplay');
      const tankIds = Object.keys(completeKNPCData);
      
      tankIds.forEach(tankId => {
        const data = completeKNPCData[tankId];
        const row = document.createElement('div');
        row.className = 'tank-comparison';
        
        const status = (data.hiLevel === 0 && data.loLevel === 0) ? 
          'Needs Screenshot Data' : 'Ready for Update';
        const statusClass = status.includes('Needs') ? 'warning' : 'success';
        
        row.innerHTML = `
          <span class="tank-id">TK-${tankId}</span>
          <span class="hi-level">${data.hiLevel}m</span>
          <span class="lo-level">${data.loLevel}m</span>
          <span class="bpm-value">${data.bpm} BPM</span>
          <span class="status" style="color: ${statusClass === 'warning' ? '#ffc107' : '#28a745'}">${status}</span>
        `;
        display.appendChild(row);
      });
    }

    window.verifyCurrentData = async function() {
      log('üîç Verifying current PBCR tank data...', 'info');
      updateProgress(5, 'Loading current tank data...');
      
      try {
        const tanksRef = collection(db, 'tankData', 'pbcr', 'tanks');
        const snapshot = await getDocs(tanksRef);
        
        log(`üìä Found ${snapshot.size} PBCR tanks in database`, 'info');
        
        let verified = 0;
        let needsUpdate = 0;
        let missingData = 0;
        
        for (const docSnapshot of snapshot.docs) {
          const tankId = docSnapshot.id;
          const currentData = docSnapshot.data();
          const knpcData = completeKNPCData[tankId];
          
          verified++;
          updateProgress(5 + (verified / snapshot.size) * 90, `Verifying Tank ${tankId}...`);
          
          if (knpcData) {
            const currentComment = currentData.comment || 0;
            const currentMin = currentData.min || 0;
            const currentMax = currentData.max || 0;
            
            if (currentComment !== knpcData.bpm || 
                currentMin !== knpcData.loLevel || 
                currentMax !== knpcData.hiLevel) {
              log(`‚ö†Ô∏è Tank ${tankId}: Needs update - Current BPM: ${currentComment}, Should be: ${knpcData.bpm}`, 'warning');
              needsUpdate++;
            } else {
              log(`‚úÖ Tank ${tankId}: Already correct`, 'success');
            }
          } else {
            log(`‚ùå Tank ${tankId}: No KNPC data available (needs screenshot extraction)`, 'error');
            missingData++;
          }
        }
        
        updateProgress(100, 'Verification completed');
        log('', 'info');
        log('üìä === VERIFICATION SUMMARY ===', 'success');
        log(`Total tanks: ${verified}`, 'info');
        log(`Need updates: ${needsUpdate}`, 'warning');
        log(`Missing KNPC data: ${missingData}`, 'error');
        log(`Ready for complete update: ${Object.keys(completeKNPCData).length} tanks`, 'success');
        
      } catch (error) {
        log(`üí• Verification error: ${error.message}`, 'error');
      }
    };

    window.updateAllTanks = async function() {
      log('üöÄ Starting complete PBCR tanks update with real KNPC data...', 'warning');
      updateProgress(5, 'Loading tanks...');
      
      try {
        const tanksRef = collection(db, 'tankData', 'pbcr', 'tanks');
        const snapshot = await getDocs(tanksRef);
        
        log(`üìä Found ${snapshot.size} PBCR tanks`, 'info');
        
        let processed = 0;
        let updated = 0;
        let skipped = 0;
        let errors = 0;
        
        const tanksWithKNPCData = Object.keys(completeKNPCData);
        log(`üéØ Will update ${tanksWithKNPCData.length} tanks with KNPC data`, 'warning');
        
        for (const docSnapshot of snapshot.docs) {
          const tankId = docSnapshot.id;
          const currentData = docSnapshot.data();
          const knpcData = completeKNPCData[tankId];
          
          processed++;
          updateProgress(10 + (processed / snapshot.size) * 80, `Processing Tank ${tankId}...`);
          
          try {
            if (knpcData) {
              // Check if update is needed
              const needsUpdate = 
                (currentData.comment || 0) !== knpcData.bpm ||
                (currentData.min || 0) !== knpcData.loLevel ||
                (currentData.max || 0) !== knpcData.hiLevel;
              
              if (needsUpdate) {
                // Skip tanks with placeholder data (hiLevel/loLevel = 0)
                if (knpcData.hiLevel === 0 && knpcData.loLevel === 0) {
                  log(`‚è≠Ô∏è Tank ${tankId}: Skipped - awaiting screenshot data`, 'warning');
                  skipped++;
                  continue;
                }
                
                await updateDoc(docSnapshot.ref, {
                  min: knpcData.loLevel,
                  max: knpcData.hiLevel,
                  comment: knpcData.bpm,
                  lastModified: serverTimestamp(),
                  updatedBy: 'knpc-complete-dataset',
                  updatedAt: new Date().toISOString(),
                  source: 'knpc-system-11-screenshots',
                  previousValues: {
                    min: currentData.min || 0,
                    max: currentData.max || 0,
                    comment: currentData.comment || 0
                  }
                });
                
                log(`‚úÖ Tank ${tankId}: Updated - Hi: ${knpcData.hiLevel}m, Lo: ${knpcData.loLevel}m, BPM: ${knpcData.bmp}`, 'success');
                updated++;
              } else {
                log(`‚ÑπÔ∏è Tank ${tankId}: Already up to date`, 'info');
              }
            } else {
              log(`‚ö†Ô∏è Tank ${tankId}: No KNPC data available`, 'warning');
              skipped++;
            }
            
            await new Promise(resolve => setTimeout(resolve, 50));
            
          } catch (tankError) {
            log(`‚ùå Tank ${tankId}: ${tankError.message}`, 'error');
            errors++;
          }
        }
        
        updateProgress(100, 'Complete update finished!');
        
        log('', 'info');
        log('üéâ === COMPLETE PBCR UPDATE FINISHED ===', 'success');
        log(`üìä Total processed: ${processed} tanks`, 'info');
        log(`‚úÖ Successfully updated: ${updated} tanks`, 'success');
        log(`‚è≠Ô∏è Skipped (awaiting data): ${skipped} tanks`, 'warning');
        log(`‚ùå Errors: ${errors} tanks`, 'error');
        log('', 'info');
        log('üí° All available KNPC data has been applied!', 'success');
        log('üîÑ To update remaining tanks, add their data from screenshots to completeKNPCData object', 'info');
        
      } catch (error) {
        log(`üí• CRITICAL ERROR: ${error.message}`, 'error');
      }
    };

    // Initialize display
    displayTankData();
    log('‚úÖ Tank data display initialized', 'success');
    log('üìã Review the data above, then click "Verify Current Data" to check what needs updating', 'info');
    log('üöÄ When ready, click "Start Complete PBCR Update" to apply all changes', 'info');
    
  </script>
</body>
</html>