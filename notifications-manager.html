<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifications Manager - KNPC Tank Tools</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <script src="permissions.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;min-height:100vh}
    
    /* Navigation Bar */
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500;font-size:inherit}
    .nav-admin:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,0,0.3)}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px;backdrop-filter:blur(10px)}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:all 0.3s ease}
    .font-controls{display:flex;gap:5px;margin-right:10px}
    .font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s ease;min-width:30px}
    .font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}
    
    /* Page Header */
    .page-header{text-align:center;margin-bottom:30px}
    .page-title{font-size:2.5rem;margin-bottom:10px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .page-subtitle{font-size:1.2rem;opacity:0.8}
    
    /* Container */
    .container{max-width:1400px;margin:0 auto}
    .section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.2)}
    .section-title{font-size:1.4rem;font-weight:bold;display:flex;align-items:center;gap:10px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid rgba(255,255,255,0.2)}
    
    /* Settings Section */
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
    .setting-item{background:rgba(255,255,255,0.05);padding:20px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)}
    .setting-label{font-size:1rem;font-weight:600;margin-bottom:10px;display:block;color:#FFD700}
    .setting-input,.setting-select{width:100%;padding:12px;border:2px solid rgba(255,255,255,0.2);border-radius:8px;font-size:14px;background:rgba(255,255,255,0.9);color:#003366;transition:border-color 0.3s ease}
    .setting-input:focus,.setting-select:focus{outline:none;border-color:#FFD700}
    
    /* Toggle Switch */
    .toggle-switch{position:relative;display:inline-block;width:60px;height:30px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:30px}
    .toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
    input:checked + .toggle-slider{background-color:#4CAF50}
    input:checked + .toggle-slider:before{transform:translateX(30px)}
    
    /* Table */
    .table-container{width:100%;overflow-x:auto;margin:20px 0;background:rgba(0,0,0,0.2);border-radius:10px;padding:5px}
    .notifications-table{width:100%;background:rgba(255,255,255,0.9);color:#003366;border-collapse:separate;border-spacing:0;border-radius:8px;overflow:hidden;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .notifications-table th,.notifications-table td{padding:12px 10px;border-bottom:1px solid #003366;text-align:center}
    .notifications-table th{background:#003366;color:white;font-weight:bold;font-size:14px}
    .notifications-table tr:hover{background:rgba(255,215,0,0.1)}
    
    /* Badges */
    .department-badge{padding:5px 15px;border-radius:20px;font-size:0.9rem;font-weight:bold}
    .badge-pbcr{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .badge-washery{background:linear-gradient(45deg,#2196F3,#1976D2);color:white}
    .badge-plcr{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    
    .status-badge{display:inline-block;padding:5px 12px;border-radius:15px;font-size:0.85rem;font-weight:bold}
    .badge-active{background:#4CAF50;color:white}
    .badge-inactive{background:#999;color:white}
    
    /* Buttons */
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-secondary{background:linear-gradient(45deg,#6c757d,#5a6268);color:white}
    .btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white}
    .btn-warning{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    .btn-success{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.2)}
    .btn:disabled{background:#666;color:#999;cursor:not-allowed;transform:none}
    
    .action-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.3s ease;color:white;margin:0 2px}
    .btn-edit{background:#4CAF50}
    .btn-delete{background:#f44336}
    .btn-test{background:#2196F3}
    .action-btn:hover{transform:scale(1.05)}
    
    /* Empty State */
    .empty-state{text-align:center;padding:60px 20px;color:rgba(255,255,255,0.7)}
    .empty-icon{font-size:4rem;margin-bottom:20px;opacity:0.5}
    .empty-text{font-size:1.2rem;margin-bottom:10px}
    .empty-subtext{font-size:1rem;opacity:0.7}
    
    /* Messages */
    .message{padding:15px 20px;border-radius:10px;margin-bottom:20px;font-weight:500;border-left:5px solid;animation:slideIn 0.3s ease}
    .message.success{background:rgba(76,175,80,0.2);border-color:#4CAF50;color:#4CAF50}
    .message.error{background:rgba(244,67,54,0.2);border-color:#f44336;color:#f44336}
    .message.info{background:rgba(33,150,243,0.2);border-color:#2196F3;color:#2196F3}
    .message.warning{background:rgba(255,193,7,0.2);border-color:#ffc107;color:#ffc107}
    @keyframes slideIn{from{transform:translateX(-100%);opacity:0}to{transform:translateX(0);opacity:1}}
    
    /* Loading */
    .loading{text-align:center;padding:40px;font-size:18px}
    .loading-spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #FFD700;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    
    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
    .modal.show{display:flex;justify-content:center;align-items:center}
    .modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ddd}
    .modal-title{font-size:1.3rem;font-weight:bold;color:#003366}
    .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#666;font-weight:bold}
    .close-btn:hover{color:#f44336}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;color:#003366}
    .form-input,.form-select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;transition:border-color 0.3s ease}
    .form-input:focus,.form-select:focus{outline:none;border-color:#4CAF50}
    .modal-buttons{display:flex;gap:15px;justify-content:flex-end;margin-top:25px}
    
    /* Responsive */
    @media (max-width: 768px) {
      .settings-grid{grid-template-columns:1fr}
      .notifications-table{font-size:12px}
      .notifications-table th,.notifications-table td{padding:8px 5px}
      .page-title{font-size:2rem}
    }
  </style>
</head>
<body>

  <!-- Navigation Bar -->
  <div class="nav-bar">
    <div class="nav-logo">üîî Tank Tools KNPC</div>
    <div class="nav-links">
      <a href="index.html" class="nav-link">üè† Home</a>
      <a href="live-tanks.html" class="nav-link">üìä Live Tanks</a>
      <a href="notifications-manager.html" class="nav-link active">üîî Notifications</a>
      <a href="dashboard.html" class="nav-admin" id="adminLink" style="display:none">‚öôÔ∏è Dashboard</a>
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="font-controls">
        <button class="font-btn" onclick="decreaseFontSize()" title="Decrease font size">A-</button>
        <button class="font-btn" onclick="increaseFontSize()" title="Increase font size">A+</button>
      </div>
      <div class="nav-user">
        <div class="user-avatar" id="userAvatar">U</div>
        <span id="userName">User</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">üîî Notifications Manager</h1>
    <p class="page-subtitle">Manage your tank alerts and notification settings</p>
  </div>

  <!-- Messages Container -->
  <div id="messagesContainer"></div>

  <!-- Container -->
  <div class="container">
    
    <!-- Default Settings Section -->
    <div class="section">
      <h2 class="section-title">‚öôÔ∏è Default Settings</h2>
      <div class="settings-grid">
        <div class="setting-item">
          <label class="setting-label">üîä Default Alert Sound</label>
          <select class="setting-select" id="defaultSound" onchange="saveDefaultSettings()">
            <option value="sound1">Sound 1 - Gentle Bell</option>
            <option value="sound2">Sound 2 - Alert Tone</option>
            <option value="sound3">Sound 3 - Urgent Alarm</option>
            <option value="custom">Custom Sound</option>
          </select>
          <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="testSound()">üîä Test Sound</button>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">‚è∞ Default Alert Time</label>
          <select class="setting-select" id="defaultAlertTime" onchange="saveDefaultSettings()">
            <option value="5">5 minutes before finish</option>
            <option value="10">10 minutes before finish</option>
            <option value="15">15 minutes before finish</option>
            <option value="30" selected>30 minutes before finish</option>
            <option value="60">60 minutes before finish</option>
          </select>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">üì≥ Vibration</label>
          <div style="display:flex;align-items:center;gap:15px;margin-top:10px">
            <label class="toggle-switch">
              <input type="checkbox" id="defaultVibration" onchange="saveDefaultSettings()" checked>
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:14px">Enable vibration on alerts</span>
          </div>
        </div>
      </div>
      <button class="btn btn-success" onclick="saveDefaultSettings()">üíæ Save Default Settings</button>
    </div>

    <!-- Active Notifications Section -->
    <div class="section">
      <h2 class="section-title">üîî Active Notifications</h2>
      <div id="notificationsContent">
        <div class="loading">
          <div class="loading-spinner"></div>
          Loading notifications...
        </div>
      </div>
    </div>

  </div>

  <!-- Edit Notification Modal -->
  <div id="editNotificationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Edit Notification Settings</h3>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="editTankInfo" style="background:rgba(33,150,243,0.1);padding:15px;border-radius:10px;margin-bottom:20px">
        <!-- Tank info will be populated here -->
      </div>
      <form id="editNotificationForm" onsubmit="saveNotificationEdit(event)">
        <div class="form-group">
          <label class="form-label">‚è∞ Alert Time:</label>
          <select class="form-select" id="editAlertTime" required>
            <option value="5">5 minutes before finish</option>
            <option value="10">10 minutes before finish</option>
            <option value="15">15 minutes before finish</option>
            <option value="30">30 minutes before finish</option>
            <option value="60">60 minutes before finish</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">üîä Alert Sound:</label>
          <select class="form-select" id="editSound" required>
            <option value="sound1">Sound 1 - Gentle Bell</option>
            <option value="sound2">Sound 2 - Alert Tone</option>
            <option value="sound3">Sound 3 - Urgent Alarm</option>
            <option value="custom">Custom Sound</option>
          </select>
          <button type="button" class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="testSound()">üîä Test Sound</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">üì≥ Vibration:</label>
          <div style="display:flex;align-items:center;gap:15px">
            <label class="toggle-switch">
              <input type="checkbox" id="editVibration">
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:14px">Enable vibration</span>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Status:</label>
          <div style="display:flex;align-items:center;gap:15px">
            <label class="toggle-switch">
              <input type="checkbox" id="editActive">
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:14px">Active</span>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Cancel</button>
          <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBCdv37V6vOFMe42rGlPyl9lVq-9JldEPg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.appspot.com",
      messagingSenderId: "678793823159",
      appId: "1:678793823159:web:7a7b1398aefdb7f24462b9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;
    window.query = query;
    window.orderBy = orderBy;
    window.onSnapshot = onSnapshot;
    window.where = where;

    console.log('üî• Firebase initialized for Notifications Manager!');
  </script>

  <script>
    // Global variables
    let currentUser = null;
    let currentEditingNotification = null;
    let unsubscribeNotifications = null;
    let notificationsData = [];

    // Check login status
    async function checkLoginStatus() {
      const session = sessionStorage.getItem('tanktools_session');
      const storedUser = localStorage.getItem('tanktools_current_user');
      
      if (!session || !storedUser) {
        window.location.href = 'login.html';
        return false;
      }
      
      currentUser = JSON.parse(storedUser);
      return true;
    }

    // Initialize app
    async function initializeApp() {
      const isLoggedIn = await checkLoginStatus();
      if (!isLoggedIn) return;
      
      loadUserInfo();
      await setupPermissions();
      loadDefaultSettings();
      loadNotifications();
      
      console.log('‚úÖ Notifications Manager initialized!');
    }

    // Load user info
    function loadUserInfo() {
      if (!currentUser) return;
      
      const userNameElement = document.getElementById('userName');
      const userAvatarElement = document.getElementById('userAvatar');
      
      if (userNameElement) {
        userNameElement.textContent = currentUser.fullName || currentUser.username;
      }
      
      if (userAvatarElement) {
        const initial = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
        userAvatarElement.textContent = initial;
      }
    }

    // Setup permissions
    async function setupPermissions() {
      if (!currentUser) return;
      
      // Show admin link if user is admin or control panel
      if (currentUser.role === 'admin' || currentUser.role === 'control_panel') {
        const adminLink = document.getElementById('adminLink');
        if (adminLink) adminLink.style.display = 'inline-block';
      }
    }

    // Load default settings
    function loadDefaultSettings() {
      const settings = JSON.parse(localStorage.getItem('tanktools_notification_defaults') || '{}');
      
      document.getElementById('defaultSound').value = settings.sound || 'sound1';
      document.getElementById('defaultAlertTime').value = settings.alertTime || '30';
      document.getElementById('defaultVibration').checked = settings.vibration !== false;
    }

    // Save default settings
    function saveDefaultSettings() {
      const settings = {
        sound: document.getElementById('defaultSound').value,
        alertTime: parseInt(document.getElementById('defaultAlertTime').value),
        vibration: document.getElementById('defaultVibration').checked,
        updatedAt: new Date().toISOString()
      };
      
      localStorage.setItem('tanktools_notification_defaults', JSON.stringify(settings));
      showMessage('‚úÖ Default settings saved successfully!', 'success');
    }

    // Load notifications from Firebase
    function loadNotifications() {
      if (!currentUser) return;
      
      try {
        // Query notifications for current user (without orderBy to avoid index requirement)
        const q = query(
          collection(db, 'notificationsManager'),
          where('userId', '==', currentUser.username)
        );
        
        // Set up real-time listener
        unsubscribeNotifications = onSnapshot(q, (snapshot) => {
          notificationsData = [];
          snapshot.forEach((doc) => {
            notificationsData.push({
              id: doc.id,
              ...doc.data()
            });
          });
          
          // Sort notifications by finishDateTime in JavaScript
          notificationsData.sort((a, b) => {
            const dateA = a.finishDateTime?.toDate ? a.finishDateTime.toDate() : new Date(a.finishDateTime);
            const dateB = b.finishDateTime?.toDate ? b.finishDateTime.toDate() : new Date(b.finishDateTime);
            return dateA - dateB;
          });
          
          displayNotifications();
        }, (error) => {
          console.error('‚ùå Error loading notifications:', error);
          showMessage('‚ùå Error loading notifications: ' + error.message, 'error');
        });
        
      } catch (error) {
        console.error('‚ùå Error setting up notifications listener:', error);
        showMessage('‚ùå Error: ' + error.message, 'error');
      }
    }

    // Display notifications
    function displayNotifications() {
      const container = document.getElementById('notificationsContent');
      
      if (notificationsData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîî</div>
            <div class="empty-text">No active notifications</div>
            <div class="empty-subtext">Add notifications from Live Tanks page</div>
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="table-container">
          <table class="notifications-table">
            <thead>
              <tr>
                <th>Tank</th>
                <th>Department</th>
                <th>Product</th>
                <th>Finish Time</th>
                <th>Alert Time</th>
                <th>Alert Before</th>
                <th>Sound</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      notificationsData.forEach(notification => {
        const finishDateTime = notification.finishDateTime?.toDate ? 
          notification.finishDateTime.toDate() : 
          new Date(notification.finishDateTime);
        
        const alertTime = new Date(finishDateTime.getTime() - (notification.alertMinutes * 60000));
        const now = new Date();
        const isPast = alertTime < now;
        
        const statusBadge = notification.active ? 
          '<span class="status-badge badge-active">Active</span>' : 
          '<span class="status-badge badge-inactive">Inactive</span>';
        
        const departmentClass = notification.department === 'PBCR' ? 'badge-pbcr' : 
                                notification.department === 'WASHERY' ? 'badge-washery' : 
                                'badge-plcr';
        
        const soundName = notification.soundFile === 'sound1' ? 'Gentle Bell' :
                          notification.soundFile === 'sound2' ? 'Alert Tone' :
                          notification.soundFile === 'sound3' ? 'Urgent Alarm' : 'Custom';
        
        html += `
          <tr style="${isPast ? 'opacity:0.6' : ''}">
            <td><strong>${notification.tankNumber}</strong></td>
            <td><span class="department-badge ${departmentClass}">${notification.department}</span></td>
            <td>${notification.product}</td>
            <td>${finishDateTime.toLocaleString('en-GB', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</td>
            <td>${alertTime.toLocaleString('en-GB', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</td>
            <td>${notification.alertMinutes} min</td>
            <td>üîä ${soundName}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="action-btn btn-edit" onclick="editNotification('${notification.id}')" title="Edit">‚úèÔ∏è</button>
              <button class="action-btn btn-test" onclick="testNotification('${notification.id}')" title="Test">üîî</button>
              <button class="action-btn btn-delete" onclick="deleteNotification('${notification.id}')" title="Delete">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // Edit notification
    window.editNotification = function(notificationId) {
      const notification = notificationsData.find(n => n.id === notificationId);
      if (!notification) return;
      
      currentEditingNotification = notification;
      
      const finishDateTime = notification.finishDateTime?.toDate ? 
        notification.finishDateTime.toDate() : 
        new Date(notification.finishDateTime);
      
      document.getElementById('editTankInfo').innerHTML = `
        <h4><strong>Tank ${notification.tankNumber}</strong> - ${notification.product} (${notification.department})</h4>
        <p><strong>Finish Time:</strong> ${finishDateTime.toLocaleString()}</p>
      `;
      
      document.getElementById('editAlertTime').value = notification.alertMinutes;
      document.getElementById('editSound').value = notification.soundFile;
      document.getElementById('editVibration').checked = notification.vibration;
      document.getElementById('editActive').checked = notification.active;
      
      document.getElementById('editNotificationModal').classList.add('show');
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editNotificationModal').classList.remove('show');
      currentEditingNotification = null;
    }

    // Save notification edit
    async function saveNotificationEdit(event) {
      event.preventDefault();
      
      if (!currentEditingNotification) return;
      
      try {
        const updateData = {
          alertMinutes: parseInt(document.getElementById('editAlertTime').value),
          soundFile: document.getElementById('editSound').value,
          vibration: document.getElementById('editVibration').checked,
          active: document.getElementById('editActive').checked,
          updatedAt: serverTimestamp()
        };
        
        await updateDoc(doc(db, 'notificationsManager', currentEditingNotification.id), updateData);
        
        showMessage('‚úÖ Notification updated successfully!', 'success');
        closeEditModal();
        
        // Reschedule notification if active
        if (updateData.active) {
          scheduleNotification(currentEditingNotification.id);
        }
        
      } catch (error) {
        console.error('‚ùå Error updating notification:', error);
        showMessage('‚ùå Error updating notification: ' + error.message, 'error');
      }
    }

    // Delete notification
    window.deleteNotification = async function(notificationId) {
      if (!confirm('Are you sure you want to delete this notification?')) return;
      
      try {
        await deleteDoc(doc(db, 'notificationsManager', notificationId));
        showMessage('‚úÖ Notification deleted successfully!', 'success');
        
        // Clear scheduled notification
        clearScheduledNotification(notificationId);
        
      } catch (error) {
        console.error('‚ùå Error deleting notification:', error);
        showMessage('‚ùå Error deleting notification: ' + error.message, 'error');
      }
    }

    // Test notification
    window.testNotification = function(notificationId) {
      const notification = notificationsData.find(n => n.id === notificationId);
      if (!notification) return;
      
      // Play sound
      playNotificationSound(notification.soundFile);
      
      // Vibrate if enabled
      if (notification.vibration && 'vibrate' in navigator) {
        navigator.vibrate([200, 100, 200]);
      }
      
      // Show browser notification
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(`üîî Tank ${notification.tankNumber} Alert (TEST)`, {
          body: `This is a test notification for Tank ${notification.tankNumber} (${notification.product} - ${notification.department})`,
          icon: '/icon.png',
          badge: '/icon.png',
          vibrate: notification.vibration ? [200, 100, 200] : undefined
        });
      }
      
      showMessage('üîî Test notification sent!', 'info');
    }

    // Test sound
    function testSound() {
      const soundFile = document.getElementById('defaultSound')?.value || 
                        document.getElementById('editSound')?.value || 
                        'sound1';
      playNotificationSound(soundFile);
    }

    // Play notification sound
    function playNotificationSound(soundFile) {
      // For now, use browser's default notification sound
      // In production, you would load actual sound files
      const audio = new Audio();
      
      switch(soundFile) {
        case 'sound1':
          // Gentle bell sound (frequency modulation)
          playTone(800, 200);
          break;
        case 'sound2':
          // Alert tone
          playTone(1000, 300);
          setTimeout(() => playTone(800, 300), 350);
          break;
        case 'sound3':
          // Urgent alarm
          playTone(1200, 200);
          setTimeout(() => playTone(1000, 200), 250);
          setTimeout(() => playTone(1200, 200), 500);
          break;
        default:
          playTone(800, 200);
      }
    }

    // Play tone using Web Audio API
    function playTone(frequency, duration) {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration / 1000);
    }

    // Schedule notification (placeholder for FCM integration)
    function scheduleNotification(notificationId) {
      // This will be implemented with FCM
      console.log('üìÖ Scheduling notification:', notificationId);
    }

    // Clear scheduled notification
    function clearScheduledNotification(notificationId) {
      // This will be implemented with FCM
      console.log('üóëÔ∏è Clearing scheduled notification:', notificationId);
    }

    // Show message
    function showMessage(message, type) {
      const container = document.getElementById('messagesContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      
      container.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // Logout
    function logout() {
      sessionStorage.removeItem('tanktools_session');
      localStorage.removeItem('tanktools_current_user');
      window.location.href = 'login.html';
    }

    // Font size controls
    let currentFontSize = parseInt(localStorage.getItem('tanktools_font_size_notifications') || '14');
    
    function increaseFontSize() {
      if (currentFontSize < 20) {
        currentFontSize += 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_notifications', currentFontSize);
        showMessage(`üìà Font size increased to ${currentFontSize}px`, 'info');
      }
    }
    
    function decreaseFontSize() {
      if (currentFontSize > 10) {
        currentFontSize -= 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_notifications', currentFontSize);
        showMessage(`üìâ Font size decreased to ${currentFontSize}px`, 'info');
      }
    }
    
    function applyFontSize() {
      document.querySelectorAll('.notifications-table, .setting-item, .form-group').forEach(el => {
        el.style.fontSize = currentFontSize + 'px';
      });
    }

    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      applyFontSize();
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (unsubscribeNotifications) {
        unsubscribeNotifications();
      }
    });
  </script>

</body>
</html>
