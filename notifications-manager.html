<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Notifications Manager - KNPC Tank Tools</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <script src="permissions.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;min-height:100vh}
    
    /* Navigation Bar */
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
    .nav-logo{font-size:24px;font-weight:bold;color:white}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold;border-radius:8px;padding:8px 16px;text-decoration:none;transition:all 0.3s ease;border:1px solid #FFA500;font-size:inherit}
    .nav-admin:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(255,215,0,0.3)}
    .nav-user{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:5px 15px;border-radius:20px;backdrop-filter:blur(10px)}
    .user-avatar{width:30px;height:30px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:12px;transition:all 0.3s ease}
    .font-controls{display:flex;gap:5px;margin-right:10px}
    .font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:5px 10px;border-radius:5px;cursor:pointer;font-size:14px;font-weight:bold;transition:all 0.3s ease;min-width:30px}
    .font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px)}
    
    /* Page Header */
    .page-header{text-align:center;margin-bottom:30px}
    .page-title{font-size:2.5rem;margin-bottom:10px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
    .page-subtitle{font-size:1.2rem;opacity:0.8}
    
    /* Container */
    .container{max-width:1400px;margin:0 auto}
    .section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.2)}
    .section-title{font-size:1.4rem;font-weight:bold;display:flex;align-items:center;gap:10px;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid rgba(255,255,255,0.2)}
    
    /* Settings Section */
    .settings-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:20px}
    .setting-item{background:rgba(255,255,255,0.05);padding:20px;border-radius:10px;border:1px solid rgba(255,255,255,0.1)}
    .setting-label{font-size:1rem;font-weight:600;margin-bottom:10px;display:block;color:#FFD700}
    .setting-input,.setting-select{width:100%;padding:12px;border:2px solid rgba(255,255,255,0.2);border-radius:8px;font-size:14px;background:rgba(255,255,255,0.9);color:#003366;transition:border-color 0.3s ease}
    .setting-input:focus,.setting-select:focus{outline:none;border-color:#FFD700}
    
    /* Toggle Switch */
    .toggle-switch{position:relative;display:inline-block;width:60px;height:30px}
    .toggle-switch input{opacity:0;width:0;height:0}
    .toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:30px}
    .toggle-slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;bottom:4px;background-color:white;transition:.4s;border-radius:50%}
    input:checked + .toggle-slider{background-color:#4CAF50}
    input:checked + .toggle-slider:before{transform:translateX(30px)}
    
    /* Table */
    .table-container{width:100%;overflow-x:auto;margin:20px 0;background:rgba(0,0,0,0.2);border-radius:10px;padding:5px}
    .notifications-table{width:100%;background:rgba(255,255,255,0.9);color:#003366;border-collapse:separate;border-spacing:0;border-radius:8px;overflow:hidden;font-size:14px;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
    .notifications-table th,.notifications-table td{padding:12px 10px;border-bottom:1px solid #003366;text-align:center}
    .notifications-table th{background:#003366;color:white;font-weight:bold;font-size:14px}
    .notifications-table tr:hover{background:rgba(255,215,0,0.1)}
    
    /* Badges */
    .department-badge{padding:5px 15px;border-radius:20px;font-size:0.9rem;font-weight:bold}
    .badge-pbcr{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .badge-washery{background:linear-gradient(45deg,#2196F3,#1976D2);color:white}
    .badge-plcr{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    
    .status-badge{display:inline-block;padding:5px 12px;border-radius:15px;font-size:0.85rem;font-weight:bold}
    .badge-active{background:#4CAF50;color:white}
    .badge-inactive{background:#999;color:white}
    
    /* Buttons */
    .btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;display:inline-flex;align-items:center;gap:8px}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-secondary{background:linear-gradient(45deg,#6c757d,#5a6268);color:white}
    .btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white}
    .btn-warning{background:linear-gradient(45deg,#ff9800,#f57c00);color:white}
    .btn-success{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(0,0,0,0.2)}
    .btn:disabled{background:#666;color:#999;cursor:not-allowed;transform:none}
    
    .action-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.3s ease;color:white;margin:0 2px}
    .btn-edit{background:#4CAF50}
    .btn-delete{background:#f44336}
    .btn-test{background:#2196F3}
    .action-btn:hover{transform:scale(1.05)}
    
    /* Empty State */
    .empty-state{text-align:center;padding:60px 20px;color:rgba(255,255,255,0.7)}
    .empty-icon{font-size:4rem;margin-bottom:20px;opacity:0.5}
    .empty-text{font-size:1.2rem;margin-bottom:10px}
    .empty-subtext{font-size:1rem;opacity:0.7}
    
    /* Messages */
    .message{padding:15px 20px;border-radius:10px;margin-bottom:20px;font-weight:500;border-left:5px solid;animation:slideIn 0.3s ease}
    .message.success{background:rgba(76,175,80,0.2);border-color:#4CAF50;color:#4CAF50}
    .message.error{background:rgba(244,67,54,0.2);border-color:#f44336;color:#f44336}
    .message.info{background:rgba(33,150,243,0.2);border-color:#2196F3;color:#2196F3}
    .message.warning{background:rgba(255,193,7,0.2);border-color:#ffc107;color:#ffc107}
    @keyframes slideIn{from{transform:translateX(-100%);opacity:0}to{transform:translateX(0);opacity:1}}
    
    /* Loading */
    .loading{text-align:center;padding:40px;font-size:18px}
    .loading-spinner{border:4px solid rgba(255,255,255,0.3);border-top:4px solid #FFD700;border-radius:50%;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 15px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    
    /* Modal */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(5px)}
    .modal.show{display:flex;justify-content:center;align-items:center}
    .modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:15px;border-bottom:2px solid #ddd}
    .modal-title{font-size:1.3rem;font-weight:bold;color:#003366}
    .close-btn{background:none;border:none;font-size:28px;cursor:pointer;color:#666;font-weight:bold}
    .close-btn:hover{color:#f44336}
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:8px;font-weight:600;color:#003366}
    .form-input,.form-select{width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;font-size:14px;transition:border-color 0.3s ease}
    .form-input:focus,.form-select:focus{outline:none;border-color:#4CAF50}
    .modal-buttons{display:flex;gap:15px;justify-content:flex-end;margin-top:25px}
    
    /* Responsive */
    @media (max-width: 768px) {
      .settings-grid{grid-template-columns:1fr}
      .notifications-table{font-size:12px}
      .notifications-table th,.notifications-table td{padding:8px 5px}
      .page-title{font-size:2rem}
    }
  </style>
</head>
<body>

  <!-- Navigation Bar -->
  <div class="nav-bar">
    <div class="nav-logo">üîî Tank Tools KNPC</div>
    <div class="nav-links">
      <a href="index.html" class="nav-link">üè† Home</a>
      <a href="live-tanks.html" class="nav-link">üìä Live Tanks</a>
      <a href="notifications-manager.html" class="nav-link active">üîî Notifications</a>
      <a href="dashboard.html" class="nav-admin" id="adminLink" style="display:none">‚öôÔ∏è Dashboard</a>
    </div>
    <div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap">
      <div class="font-controls">
        <button class="font-btn" onclick="decreaseFontSize()" title="Decrease font size">A-</button>
        <button class="font-btn" onclick="increaseFontSize()" title="Increase font size">A+</button>
      </div>
      <div class="nav-user">
        <div class="user-avatar" id="userAvatar">U</div>
        <span id="userName">User</span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">üîî Notifications Manager</h1>
    <p class="page-subtitle">Manage your tank alerts and notification settings</p>
  </div>

  <!-- Messages Container -->
  <div id="messagesContainer"></div>

  <!-- Container -->
  <div class="container">
    
    <!-- Next Alert Section -->
    <div class="section" id="nextAlertSection" style="display:none;background:linear-gradient(135deg,rgba(255,215,0,0.2),rgba(255,165,0,0.2));border:2px solid rgba(255,215,0,0.5)">
      <h2 class="section-title">üîî Next Alert</h2>
      <div id="nextAlertContent" style="text-align:center;padding:20px">
        <div style="font-size:2rem;font-weight:bold;margin-bottom:10px" id="nextTankInfo">Tank 221 - PBCR</div>
        <div style="font-size:1.2rem;opacity:0.9;margin-bottom:20px" id="nextProductInfo">Product: Diesel</div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0">
          <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px">
            <div style="font-size:0.9rem;opacity:0.7;margin-bottom:5px">‚è∞ Finish Time</div>
            <div style="font-size:1.3rem;font-weight:bold" id="nextFinishTime">18:00 - 01/11/2025</div>
          </div>
          <div style="background:rgba(255,255,255,0.1);padding:15px;border-radius:10px">
            <div style="font-size:0.9rem;opacity:0.7;margin-bottom:5px">üîî Alert Time</div>
            <div style="font-size:1.3rem;font-weight:bold" id="nextAlertTime">17:30 - 01/11/2025</div>
          </div>
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0">
          <div style="background:rgba(76,175,80,0.2);padding:20px;border-radius:10px;border:2px solid rgba(76,175,80,0.5)">
            <div style="font-size:0.9rem;opacity:0.7;margin-bottom:5px">‚è≥ Time Remaining</div>
            <div style="font-size:2rem;font-weight:bold;color:#4CAF50" id="timeRemaining">1h 23m</div>
          </div>
          <div style="background:rgba(255,152,0,0.2);padding:20px;border-radius:10px;border:2px solid rgba(255,152,0,0.5)">
            <div style="font-size:0.9rem;opacity:0.7;margin-bottom:5px">üì¢ Alert In</div>
            <div style="font-size:2rem;font-weight:bold;color:#ff9800" id="alertIn">53 minutes</div>
          </div>
        </div>
        
        <button class="btn btn-primary" onclick="goToNotification()">üìã View Details</button>
      </div>
    </div>
    
    <!-- Test Notifications Section -->
    <div class="section" style="background:linear-gradient(135deg,rgba(33,150,243,0.2),rgba(25,118,210,0.2));border:2px solid rgba(33,150,243,0.5)">
      <h2 class="section-title">üß™ Test Notifications</h2>
      <div style="text-align:center;padding:20px">
        <p style="font-size:1.1rem;margin-bottom:25px;opacity:0.9">Test your notification settings and sound</p>
        
        <div style="max-width:500px;margin:0 auto;background:rgba(255,255,255,0.1);padding:25px;border-radius:15px">
          <label style="display:block;font-size:1.1rem;font-weight:600;margin-bottom:15px;color:#FFD700">üìÖ Send test alert in:</label>
          
          <div style="display:flex;flex-direction:column;gap:12px;margin-bottom:25px">
            <label style="display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;transition:all 0.3s ease;border:2px solid transparent" class="test-option" onclick="selectTestTime(1)">
              <input type="radio" name="testTime" value="1" style="margin-right:12px;width:20px;height:20px;cursor:pointer">
              <span style="font-size:1rem;font-weight:500">‚ö° 1 minute</span>
            </label>
            
            <label style="display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;transition:all 0.3s ease;border:2px solid transparent" class="test-option" onclick="selectTestTime(5)">
              <input type="radio" name="testTime" value="5" style="margin-right:12px;width:20px;height:20px;cursor:pointer">
              <span style="font-size:1rem;font-weight:500">‚è±Ô∏è 5 minutes</span>
            </label>
            
            <label style="display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;transition:all 0.3s ease;border:2px solid transparent" class="test-option" onclick="selectTestTime(10)">
              <input type="radio" name="testTime" value="10" style="margin-right:12px;width:20px;height:20px;cursor:pointer">
              <span style="font-size:1rem;font-weight:500">‚è≤Ô∏è 10 minutes</span>
            </label>
            
            <label style="display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;transition:all 0.3s ease;border:2px solid transparent" class="test-option" onclick="selectTestTime(15)">
              <input type="radio" name="testTime" value="15" checked style="margin-right:12px;width:20px;height:20px;cursor:pointer">
              <span style="font-size:1rem;font-weight:500">‚è∞ 15 minutes</span>
            </label>
            
            <label style="display:flex;align-items:center;padding:12px;background:rgba(255,255,255,0.05);border-radius:8px;cursor:pointer;transition:all 0.3s ease;border:2px solid transparent" class="test-option" onclick="selectTestTime(30)">
              <input type="radio" name="testTime" value="30" style="margin-right:12px;width:20px;height:20px;cursor:pointer">
              <span style="font-size:1rem;font-weight:500">‚è≥ 30 minutes</span>
            </label>
          </div>
          
          <button class="btn btn-success" onclick="sendTestNotification()" style="width:100%;font-size:1.1rem;padding:15px">üîî Send Test Notification</button>
          
          <div id="testStatus" style="margin-top:15px;font-size:0.95rem;opacity:0.8"></div>
        </div>
      </div>
    </div>
    
    <!-- Notification Method Section -->
    <div class="section" style="background:linear-gradient(135deg,rgba(156,39,176,0.2),rgba(123,31,162,0.2));border:2px solid rgba(156,39,176,0.5)">
      <h2 class="section-title">üì± Notification Method</h2>
      <p style="text-align:center;font-size:1.05rem;margin-bottom:25px;opacity:0.9">Choose how you want to receive tank alerts</p>
      
      <div style="max-width:800px;margin:0 auto">
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:25px">
          <!-- Pushover Option -->
          <div class="notification-option" data-method="pushover" onclick="selectNotificationMethod('pushover')" style="background:rgba(244,67,54,0.15);border:3px solid rgba(244,67,54,0.5);border-radius:15px;padding:20px;cursor:pointer;transition:all 0.3s ease">
            <div style="text-align:center;margin-bottom:15px;font-size:2.5rem">üîî</div>
            <h3 style="text-align:center;font-size:1.3rem;margin-bottom:10px;color:#E57373">Pushover</h3>
            <p style="font-size:0.95rem;opacity:0.85;margin-bottom:15px;text-align:center">Real alarm-like notifications</p>
            <ul style="font-size:0.9rem;opacity:0.8;list-style:none;padding:0">
              <li style="margin-bottom:8px">‚úÖ Repeats until dismissed</li>
              <li style="margin-bottom:8px">‚úÖ Works in background</li>
              <li style="margin-bottom:8px">‚úÖ Loud alarm sounds</li>
              <li style="margin-bottom:8px">‚úÖ Android + iOS</li>
            </ul>
          </div>

        </div>
        
        <!-- Pushover Setup -->
        <div id="pushoverSetup" style="display:none;background:rgba(255,255,255,0.05);padding:25px;border-radius:15px;margin-top:20px">
          <h3 style="font-size:1.3rem;margin-bottom:20px;text-align:center;color:#E57373">üîî Pushover Setup</h3>
          <p style="text-align:center;margin-bottom:20px;opacity:0.9">Get real alarm-like notifications that repeat until you dismiss them!</p>
          
          <div style="max-width:600px;margin:0 auto">
            <ol style="font-size:0.95rem;margin-bottom:25px;padding-left:20px;line-height:1.8">
              <li style="margin-bottom:15px">
                <strong>Download Pushover app:</strong><br/>
                <button 
                  class="btn btn-primary" 
                  onclick="downloadPushover()" 
                  style="font-size:1rem;padding:12px 25px;background:linear-gradient(135deg,#E57373,#F44336);border:none;margin-top:10px">
                  üì• Download Pushover
                </button>
              </li>
              <li style="margin-bottom:15px"><strong>Create account</strong> and copy your <strong>User Key</strong></li>
              <li><strong>Paste your User Key below:</strong></li>
            </ol>
            
            <div style="margin-bottom:20px">
              <label style="display:block;font-size:1rem;font-weight:600;margin-bottom:10px">üîë Pushover User Key:</label>
              <input 
                type="text" 
                id="pushoverKey" 
                placeholder="Enter your Pushover User Key (e.g., uQiRzpo4DXghDmr9QzzfQu27cmVRsG)"
                style="width:100%;padding:12px;border-radius:8px;border:2px solid rgba(255,255,255,0.2);background:rgba(255,255,255,0.1);color:white;font-size:0.95rem"
              />
            </div>
            
            <div style="display:flex;gap:15px;flex-wrap:wrap">
              <button class="btn btn-success" onclick="savePushoverKey()" style="flex:1;min-width:150px">
                üíæ Save Key
              </button>
              <button class="btn btn-secondary" onclick="testPushover()" style="flex:1;min-width:150px">
                üß™ Send Test Alarm
              </button>
            </div>
            
            <div id="pushoverStatus" style="margin-top:15px;padding:12px;border-radius:8px;text-align:center;font-size:0.95rem"></div>
          </div>
        </div>

      </div>
    </div>
    
    <!-- Default Settings Section -->
    <div class="section">
      <h2 class="section-title">‚öôÔ∏è Default Settings</h2>
      <div class="settings-grid">
        <div class="setting-item">
          <label class="setting-label">üîä Default Alert Sound</label>
          <select class="setting-select" id="defaultSound" onchange="saveDefaultSettings()">
            <option value="sound1">Sound 1 - Gentle Bell</option>
            <option value="sound2">Sound 2 - Alert Tone</option>
            <option value="sound3">Sound 3 - Urgent Alarm</option>
            <option value="custom">Custom Sound</option>
          </select>
          <button class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="testSound()">üîä Test Sound</button>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">‚è∞ Default Alert Time</label>
          <select class="setting-select" id="defaultAlertTime" onchange="saveDefaultSettings()">
            <option value="5">5 minutes before finish</option>
            <option value="10">10 minutes before finish</option>
            <option value="15">15 minutes before finish</option>
            <option value="30" selected>30 minutes before finish</option>
            <option value="60">60 minutes before finish</option>
          </select>
        </div>
        
        <div class="setting-item">
          <label class="setting-label">üì≥ Vibration</label>
          <div style="display:flex;align-items:center;gap:15px;margin-top:10px">
            <label class="toggle-switch">
              <input type="checkbox" id="defaultVibration" onchange="saveDefaultSettings()" checked>
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:14px">Enable vibration on alerts</span>
          </div>
        </div>
      </div>
      <button class="btn btn-success" onclick="saveDefaultSettings()">üíæ Save Default Settings</button>
    </div>

    <!-- Active Notifications Section -->
    <div class="section">
      <h2 class="section-title">üîî Active Notifications</h2>
      <div id="notificationsContent">
        <div class="loading">
          <div class="loading-spinner"></div>
          Loading notifications...
        </div>
      </div>
    </div>

  </div>

  <!-- Edit Notification Modal -->
  <div id="editNotificationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">‚úèÔ∏è Edit Notification Settings</h3>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <div id="editTankInfo" style="background:rgba(33,150,243,0.1);padding:15px;border-radius:10px;margin-bottom:20px">
        <!-- Tank info will be populated here -->
      </div>
      <form id="editNotificationForm" onsubmit="saveNotificationEdit(event)">
        <div class="form-group">
          <label class="form-label">‚è∞ Alert Time:</label>
          <select class="form-select" id="editAlertTime" required>
            <option value="5">5 minutes before finish</option>
            <option value="10">10 minutes before finish</option>
            <option value="15">15 minutes before finish</option>
            <option value="30">30 minutes before finish</option>
            <option value="60">60 minutes before finish</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">üîä Alert Sound:</label>
          <select class="form-select" id="editSound" required>
            <option value="sound1">Sound 1 - Gentle Bell</option>
            <option value="sound2">Sound 2 - Alert Tone</option>
            <option value="sound3">Sound 3 - Urgent Alarm</option>
            <option value="custom">Custom Sound</option>
          </select>
          <button type="button" class="btn btn-secondary" style="margin-top:10px;width:100%" onclick="testSound()">üîä Test Sound</button>
        </div>
        
        <div class="form-group">
          <label class="form-label">üì≥ Vibration:</label>
          <div style="display:flex;align-items:center;gap:15px">
            <label class="toggle-switch">
              <input type="checkbox" id="editVibration">
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:14px">Enable vibration</span>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Status:</label>
          <div style="display:flex;align-items:center;gap:15px">
            <label class="toggle-switch">
              <input type="checkbox" id="editActive">
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size:14px">Active</span>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Cancel</button>
          <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, updateDoc, deleteDoc, collection, addDoc, serverTimestamp, Timestamp, query, orderBy, onSnapshot, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-functions.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messaging = getMessaging(app);
    const functions = getFunctions(app);

    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.functions = functions;
    window.httpsCallable = httpsCallable;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;
    window.Timestamp = Timestamp;
    window.query = query;
    window.orderBy = orderBy;
    window.onSnapshot = onSnapshot;
    window.where = where;
    window.messaging = messaging;
    window.getToken = getToken;
    window.onMessage = onMessage;

    console.log('üî• Firebase initialized for Notifications Manager!');
    
    // Initialize FCM
    initializeFCM();
  </script>

  <script>
    // Global variables
    let currentUser = null;
    let currentEditingNotification = null;
    let unsubscribeNotifications = null;
    let notificationsData = [];

    // Check login status
    async function checkLoginStatus() {
      const session = sessionStorage.getItem('tanktools_session');
      const storedUser = localStorage.getItem('tanktools_current_user');
      
      if (!session || !storedUser) {
        window.location.href = 'login.html';
        return false;
      }
      
      currentUser = JSON.parse(storedUser);
      return true;
    }

    // Initialize app
    async function initializeApp() {
      const isLoggedIn = await checkLoginStatus();
      if (!isLoggedIn) return;
      
      loadUserInfo();
      await setupPermissions();
      loadDefaultSettings();
      loadNotifications();
      await requestNotificationPermission();
      
      console.log('‚úÖ Notifications Manager initialized!');
    }

    // Initialize FCM
    async function initializeFCM() {
      try {
        // Register service worker
        if ('serviceWorker' in navigator) {
          const registration = await navigator.serviceWorker.register('/firebase-messaging-sw.js');
          console.log('‚úÖ Service Worker registered:', registration);
        }
        
        console.log('‚úÖ FCM initialized!');
      } catch (error) {
        console.error('‚ùå Error initializing FCM:', error);
      }
    }

    // Request notification permission and get FCM token
    async function requestNotificationPermission() {
      try {
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
          console.log('‚úÖ Notification permission granted');
          
          // Get FCM token
          const token = await window.getToken(window.messaging, {
            vapidKey: 'BCHLN8qDfvyc30MCnoQr9YlCn9wbjO11seNkqVkkdVOyCSHdOF4kQH-Oy9pqFiDz_ng4WUiwUplem86lAi6bDS8'
          });
          
          if (token) {
            console.log('üîë FCM Token:', token);
            
            // Save token to Firebase
            await saveFCMToken(token);
            
            showMessage('‚úÖ Push notifications enabled!', 'success');
          } else {
            console.log('‚ùå No registration token available');
          }
        } else {
          console.log('‚ùå Notification permission denied');
          showMessage('‚ö†Ô∏è Notification permission denied. You won\'t receive push notifications.', 'error');
        }
      } catch (error) {
        console.error('‚ùå Error requesting notification permission:', error);
      }
    }

    // Save FCM token to Firebase
    async function saveFCMToken(token) {
      if (!currentUser) return;
      
      try {
        const userRef = window.doc(window.db, 'users', currentUser.username);
        await window.updateDoc(userRef, {
          fcmToken: token,
          fcmTokenUpdatedAt: window.serverTimestamp()
        });
        
        console.log('‚úÖ FCM token saved to Firebase');
      } catch (error) {
        console.error('‚ùå Error saving FCM token:', error);
      }
    }

    // Play notification sound
    function playNotificationSound() {
      const settings = JSON.parse(localStorage.getItem('tanktools_notification_defaults') || '{}');
      const sound = settings.sound || 'sound1';
      
      const audio = new Audio(`/sounds/${sound}.mp3`);
      audio.play().catch(err => console.error('Error playing sound:', err));
    }

    // Load user info
    function loadUserInfo() {
      if (!currentUser) return;
      
      const userNameElement = document.getElementById('userName');
      const userAvatarElement = document.getElementById('userAvatar');
      
      if (userNameElement) {
        userNameElement.textContent = currentUser.fullName || currentUser.username;
      }
      
      if (userAvatarElement) {
        const initial = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
        userAvatarElement.textContent = initial;
      }
    }

    // Setup permissions
    async function setupPermissions() {
      if (!currentUser) return;
      
      // Show admin link if user is admin or control panel
      if (currentUser.role === 'admin' || currentUser.role === 'control_panel') {
        const adminLink = document.getElementById('adminLink');
        if (adminLink) adminLink.style.display = 'inline-block';
      }
    }

    // Load default settings
    function loadDefaultSettings() {
      const settings = JSON.parse(localStorage.getItem('tanktools_notification_defaults') || '{}');
      
      document.getElementById('defaultSound').value = settings.sound || 'sound1';
      document.getElementById('defaultAlertTime').value = settings.alertTime || '30';
      document.getElementById('defaultVibration').checked = settings.vibration !== false;
    }

    // Save default settings
    function saveDefaultSettings() {
      const settings = {
        sound: document.getElementById('defaultSound').value,
        alertTime: parseInt(document.getElementById('defaultAlertTime').value),
        vibration: document.getElementById('defaultVibration').checked,
        updatedAt: new Date().toISOString()
      };
      
      localStorage.setItem('tanktools_notification_defaults', JSON.stringify(settings));
      showMessage('‚úÖ Default settings saved successfully!', 'success');
    }

    // Load notifications from Firebase
    function loadNotifications() {
      if (!currentUser) return;
      
      try {
        // Query notifications for current user (without orderBy to avoid index requirement)
        const q = query(
          collection(db, 'notificationsManager'),
          where('userId', '==', currentUser.username)
        );
        
        // Set up real-time listener
        unsubscribeNotifications = onSnapshot(q, (snapshot) => {
          notificationsData = [];
          snapshot.forEach((doc) => {
            notificationsData.push({
              id: doc.id,
              ...doc.data()
            });
          });
          
          // Sort notifications by finishDateTime in JavaScript
          notificationsData.sort((a, b) => {
            const dateA = a.finishDateTime?.toDate ? a.finishDateTime.toDate() : new Date(a.finishDateTime);
            const dateB = b.finishDateTime?.toDate ? b.finishDateTime.toDate() : new Date(b.finishDateTime);
            return dateA - dateB;
          });
          
          // Make available globally for Next Alert
          window.notificationsData = notificationsData;
          
          displayNotifications();
          updateNextAlert();
        }, (error) => {
          console.error('‚ùå Error loading notifications:', error);
          showMessage('‚ùå Error loading notifications: ' + error.message, 'error');
        });
        
      } catch (error) {
        console.error('‚ùå Error setting up notifications listener:', error);
        showMessage('‚ùå Error: ' + error.message, 'error');
      }
    }

    // Display notifications
    function displayNotifications() {
      const container = document.getElementById('notificationsContent');
      
      if (notificationsData.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üîî</div>
            <div class="empty-text">No active notifications</div>
            <div class="empty-subtext">Add notifications from Live Tanks page</div>
          </div>
        `;
        return;
      }
      
      let html = `
        <div class="table-container">
          <table class="notifications-table">
            <thead>
              <tr>
                <th>Tank</th>
                <th>Department</th>
                <th>Product</th>
                <th>Finish Time</th>
                <th>Alert Time</th>
                <th>Alert Before</th>
                <th>Sound</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      notificationsData.forEach(notification => {
        const finishDateTime = notification.finishDateTime?.toDate ? 
          notification.finishDateTime.toDate() : 
          new Date(notification.finishDateTime);
        
        const alertTime = new Date(finishDateTime.getTime() - (notification.alertMinutes * 60000));
        const now = new Date();
        const isPast = alertTime < now;
        
        const statusBadge = notification.active ? 
          '<span class="status-badge badge-active">Active</span>' : 
          '<span class="status-badge badge-inactive">Inactive</span>';
        
        const departmentClass = notification.department === 'PBCR' ? 'badge-pbcr' : 
                                notification.department === 'WASHERY' ? 'badge-washery' : 
                                'badge-plcr';
        
        const soundName = notification.soundFile === 'sound1' ? 'Gentle Bell' :
                          notification.soundFile === 'sound2' ? 'Alert Tone' :
                          notification.soundFile === 'sound3' ? 'Urgent Alarm' : 'Custom';
        
        html += `
          <tr id="notification-${notification.id}" style="${isPast ? 'opacity:0.6' : ''}">
            <td><strong>${notification.tankNumber}</strong></td>
            <td><span class="department-badge ${departmentClass}">${notification.department}</span></td>
            <td>${notification.product}</td>
            <td>${finishDateTime.toLocaleString('en-GB', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</td>
            <td>${alertTime.toLocaleString('en-GB', {day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'})}</td>
            <td>${notification.alertMinutes} min</td>
            <td>üîä ${soundName}</td>
            <td>${statusBadge}</td>
            <td>
              <button class="action-btn btn-edit" onclick="editNotification('${notification.id}')" title="Edit">‚úèÔ∏è</button>
              <button class="action-btn btn-test" onclick="testNotification('${notification.id}')" title="Test">üîî</button>
              <button class="action-btn btn-delete" onclick="deleteNotification('${notification.id}')" title="Delete">üóëÔ∏è</button>
            </td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // Edit notification
    window.editNotification = function(notificationId) {
      const notification = notificationsData.find(n => n.id === notificationId);
      if (!notification) return;
      
      currentEditingNotification = notification;
      
      const finishDateTime = notification.finishDateTime?.toDate ? 
        notification.finishDateTime.toDate() : 
        new Date(notification.finishDateTime);
      
      document.getElementById('editTankInfo').innerHTML = `
        <h4><strong>Tank ${notification.tankNumber}</strong> - ${notification.product} (${notification.department})</h4>
        <p><strong>Finish Time:</strong> ${finishDateTime.toLocaleString()}</p>
      `;
      
      document.getElementById('editAlertTime').value = notification.alertMinutes;
      document.getElementById('editSound').value = notification.soundFile;
      document.getElementById('editVibration').checked = notification.vibration;
      document.getElementById('editActive').checked = notification.active;
      
      document.getElementById('editNotificationModal').classList.add('show');
    }

    // Close edit modal
    function closeEditModal() {
      document.getElementById('editNotificationModal').classList.remove('show');
      currentEditingNotification = null;
    }

    // Save notification edit
    async function saveNotificationEdit(event) {
      event.preventDefault();
      
      if (!currentEditingNotification) return;
      
      try {
        const updateData = {
          alertMinutes: parseInt(document.getElementById('editAlertTime').value),
          soundFile: document.getElementById('editSound').value,
          vibration: document.getElementById('editVibration').checked,
          active: document.getElementById('editActive').checked,
          updatedAt: serverTimestamp()
        };
        
        await updateDoc(doc(db, 'notificationsManager', currentEditingNotification.id), updateData);
        
        showMessage('‚úÖ Notification updated successfully!', 'success');
        closeEditModal();
        
        // Reschedule notification if active
        if (updateData.active) {
          scheduleNotification(currentEditingNotification.id);
        }
        
      } catch (error) {
        console.error('‚ùå Error updating notification:', error);
        showMessage('‚ùå Error updating notification: ' + error.message, 'error');
      }
    }

    // Delete notification
    window.deleteNotification = async function(notificationId) {
      if (!confirm('Are you sure you want to delete this notification?')) return;
      
      try {
        await deleteDoc(doc(db, 'notificationsManager', notificationId));
        showMessage('‚úÖ Notification deleted successfully!', 'success');
        
        // Clear scheduled notification
        clearScheduledNotification(notificationId);
        
      } catch (error) {
        console.error('‚ùå Error deleting notification:', error);
        showMessage('‚ùå Error deleting notification: ' + error.message, 'error');
      }
    }

    // Test notification
    window.testNotification = function(notificationId) {
      const notification = notificationsData.find(n => n.id === notificationId);
      if (!notification) return;
      
      // Play sound
      playNotificationSound(notification.soundFile);
      
      // Vibrate if enabled
      if (notification.vibration && 'vibrate' in navigator) {
        navigator.vibrate([200, 100, 200]);
      }
      
      // Show browser notification
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(`üîî Tank ${notification.tankNumber} Alert (TEST)`, {
          body: `This is a test notification for Tank ${notification.tankNumber} (${notification.product} - ${notification.department})`,
          icon: '/icon.png',
          badge: '/icon.png',
          vibrate: notification.vibration ? [200, 100, 200] : undefined
        });
      }
      
      showMessage('üîî Test notification sent!', 'info');
    }

    // Test sound
    function testSound() {
      const soundFile = document.getElementById('defaultSound')?.value || 
                        document.getElementById('editSound')?.value || 
                        'sound1';
      playNotificationSound(soundFile);
    }

    // Play notification sound
    function playNotificationSound(soundFile) {
      // For now, use browser's default notification sound
      // In production, you would load actual sound files
      const audio = new Audio();
      
      switch(soundFile) {
        case 'sound1':
          // Gentle bell sound (frequency modulation)
          playTone(800, 200);
          break;
        case 'sound2':
          // Alert tone
          playTone(1000, 300);
          setTimeout(() => playTone(800, 300), 350);
          break;
        case 'sound3':
          // Urgent alarm
          playTone(1200, 200);
          setTimeout(() => playTone(1000, 200), 250);
          setTimeout(() => playTone(1200, 200), 500);
          break;
        default:
          playTone(800, 200);
      }
    }

    // Play tone using Web Audio API
    function playTone(frequency, duration) {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = frequency;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration / 1000);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + duration / 1000);
    }

    // Schedule notification (placeholder for FCM integration)
    function scheduleNotification(notificationId) {
      // This will be implemented with FCM
      console.log('üìÖ Scheduling notification:', notificationId);
    }

    // Clear scheduled notification
    function clearScheduledNotification(notificationId) {
      // This will be implemented with FCM
      console.log('üóëÔ∏è Clearing scheduled notification:', notificationId);
    }

    // Show message
    function showMessage(message, type) {
      const container = document.getElementById('messagesContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = message;
      
      container.appendChild(messageDiv);
      
      setTimeout(() => {
        messageDiv.remove();
      }, 5000);
    }

    // Logout
    function logout() {
      sessionStorage.removeItem('tanktools_session');
      localStorage.removeItem('tanktools_current_user');
      window.location.href = 'login.html';
    }

    // Font size controls
    let currentFontSize = parseInt(localStorage.getItem('tanktools_font_size_notifications') || '14');
    
    function increaseFontSize() {
      if (currentFontSize < 20) {
        currentFontSize += 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_notifications', currentFontSize);
        showMessage(`üìà Font size increased to ${currentFontSize}px`, 'info');
      }
    }
    
    function decreaseFontSize() {
      if (currentFontSize > 10) {
        currentFontSize -= 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_notifications', currentFontSize);
        showMessage(`üìâ Font size decreased to ${currentFontSize}px`, 'info');
      }
    }
    
    function applyFontSize() {
      document.querySelectorAll('.notifications-table, .setting-item, .form-group').forEach(el => {
        el.style.fontSize = currentFontSize + 'px';
      });
    }

    // Next Alert Functions
    let nextAlertInterval = null;
    
    function updateNextAlert() {
      const notifications = window.notificationsData || [];
      
      if (notifications.length === 0) {
        document.getElementById('nextAlertSection').style.display = 'none';
        return;
      }
      
      // Find the next alert (earliest one)
      const now = new Date();
      const upcomingAlerts = notifications.filter(n => {
        const finishTime = n.finishDateTime?.toDate ? n.finishDateTime.toDate() : new Date(n.finishDateTime);
        const alertTime = new Date(finishTime.getTime() - (n.alertTime * 60 * 1000));
        return alertTime > now && !n.sent;
      });
      
      if (upcomingAlerts.length === 0) {
        document.getElementById('nextAlertSection').style.display = 'none';
        return;
      }
      
      // Sort by alert time
      upcomingAlerts.sort((a, b) => {
        const timeA = a.finishDateTime?.toDate ? a.finishDateTime.toDate() : new Date(a.finishDateTime);
        const timeB = b.finishDateTime?.toDate ? b.finishDateTime.toDate() : new Date(b.finishDateTime);
        const alertTimeA = new Date(timeA.getTime() - (a.alertTime * 60 * 1000));
        const alertTimeB = new Date(timeB.getTime() - (b.alertTime * 60 * 1000));
        return alertTimeA - alertTimeB;
      });
      
      const nextAlert = upcomingAlerts[0];
      const finishTime = nextAlert.finishDateTime?.toDate ? nextAlert.finishDateTime.toDate() : new Date(nextAlert.finishDateTime);
      const alertTime = new Date(finishTime.getTime() - (nextAlert.alertTime * 60 * 1000));
      
      // Update UI
      document.getElementById('nextAlertSection').style.display = 'block';
      document.getElementById('nextTankInfo').textContent = `Tank ${nextAlert.tankNumber} - ${nextAlert.department}`;
      document.getElementById('nextProductInfo').textContent = `Product: ${nextAlert.product || 'N/A'}`;
      document.getElementById('nextFinishTime').textContent = formatDateTime(finishTime);
      document.getElementById('nextAlertTime').textContent = formatDateTime(alertTime);
      
      // Calculate time remaining
      const timeToFinish = finishTime - now;
      const timeToAlert = alertTime - now;
      
      document.getElementById('timeRemaining').textContent = formatTimeRemaining(timeToFinish);
      document.getElementById('alertIn').textContent = formatTimeRemaining(timeToAlert);
      
      // Store for goToNotification
      window.nextAlertId = nextAlert.id;
    }
    
    function formatDateTime(date) {
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes} - ${day}/${month}/${year}`;
    }
    
    function formatTimeRemaining(ms) {
      if (ms < 0) return 'Overdue';
      
      const totalMinutes = Math.floor(ms / (1000 * 60));
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      
      if (hours > 0) {
        return `${hours}h ${minutes}m`;
      } else {
        return `${minutes} minutes`;
      }
    }
    
    function goToNotification() {
      if (window.nextAlertId) {
        const element = document.getElementById(`notification-${window.nextAlertId}`);
        if (element) {
          element.scrollIntoView({ behavior: 'smooth', block: 'center' });
          element.style.background = 'rgba(255,215,0,0.3)';
          setTimeout(() => {
            element.style.background = '';
          }, 2000);
        }
      }
    }
    
    // Test Notification Functions
    let selectedTestTime = 15; // Default 15 minutes
    
    function selectTestTime(minutes) {
      selectedTestTime = minutes;
      
      // Update UI - highlight selected option
      document.querySelectorAll('.test-option').forEach(option => {
        option.style.background = 'rgba(255,255,255,0.05)';
        option.style.borderColor = 'transparent';
      });
      
      const selectedOption = document.querySelector(`input[name="testTime"][value="${minutes}"]`).parentElement;
      selectedOption.style.background = 'rgba(255,215,0,0.2)';
      selectedOption.style.borderColor = '#FFD700';
    }
    
    async function sendTestNotification() {
      try {
        const testStatus = document.getElementById('testStatus');
        testStatus.innerHTML = '<div style="color:#FFD700">‚è≥ Scheduling test notification...</div>';
        
        // Get current user
        const currentUser = JSON.parse(localStorage.getItem('tanktools_current_user'));
        if (!currentUser) {
          throw new Error('User not logged in');
        }
        
        // Calculate test alert time
        const now = new Date();
        const finishTime = new Date(now.getTime() + (selectedTestTime * 60 * 1000));
        
        // Create test notification
        const testNotification = {
          userId: currentUser.username,
          tankNumber: 'TEST',
          department: 'TEST',
          product: 'Test Notification',
          finishDateTime: window.Timestamp.fromDate(finishTime),
          alertMinutes: 0, // Send immediately when time comes
          soundFile: localStorage.getItem('tanktools_default_alert_sound') || 'sound1',
          vibration: localStorage.getItem('tanktools_default_vibrate') === 'true',
          active: true, // Active by default
          sent: false,
          isTest: true,
          createdAt: window.Timestamp.now()
        };
        
        // Save to Firebase
        await window.addDoc(window.collection(window.db, 'notificationsManager'), testNotification);
        
        testStatus.innerHTML = `<div style="color:#4CAF50">‚úÖ Test notification scheduled! You will receive it in ${selectedTestTime} minute${selectedTestTime > 1 ? 's' : ''}.</div>`;
        
        showMessage(`üîî Test notification scheduled for ${selectedTestTime} minute${selectedTestTime > 1 ? 's' : ''} from now!`, 'success');
        
        // Clear status after 5 seconds
        setTimeout(() => {
          testStatus.innerHTML = '';
        }, 5000);
        
      } catch (error) {
        console.error('Error sending test notification:', error);
        document.getElementById('testStatus').innerHTML = `<div style="color:#f44336">‚ùå Error: ${error.message}</div>`;
      }
    }
    
    // ==================== Notification Method Functions ====================
    
    // Select notification method
    function selectNotificationMethod(method) {
      // Update UI
      document.querySelectorAll('.notification-option').forEach(option => {
        if (option.dataset.method === method) {
          option.style.border = '3px solid #FFD700';
          option.style.transform = 'scale(1.05)';
        } else {
          option.style.border = option.dataset.method === 'pwa' ? '3px solid rgba(76,175,80,0.5)' :
                                option.dataset.method === 'pushover' ? '3px solid rgba(244,67,54,0.5)' :
                                '3px solid rgba(33,150,243,0.5)';
          option.style.transform = 'scale(1)';
        }
      });
      
      // Hide all setups
      document.getElementById('pushoverSetup').style.display = 'none';
      
      // Show selected setup
      if (method === 'pushover') {
        document.getElementById('pushoverSetup').style.display = 'block';
        loadPushoverKey();
      }
      
      // Save preference
      localStorage.setItem('notificationMethod', method);
      
      // Save to Firestore
      if (currentUser) {
        window.updateDoc(window.doc(window.db, 'users', currentUser.username), {
          notificationMethod: method
        }).catch(err => console.error('Error saving method:', err));
      }
    }
    
    // Load saved notification method
    async function loadNotificationMethod() {
      try {
        if (!currentUser) return;
        
        const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.username));
        const data = userDoc.data();
        
        const method = data?.notificationMethod || localStorage.getItem('notificationMethod') || 'pwa';
        selectNotificationMethod(method);
      } catch (error) {
        console.error('Error loading notification method:', error);
        selectNotificationMethod('pwa');
      }
    }
    
    // ==================== Pushover Functions ====================
    
    // Download Pushover App
    function downloadPushover() {
      // Detect device
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      
      let url = 'https://pushover.net'; // Default
      
      // iOS detection
      if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
        url = 'https://apps.apple.com/app/pushover-notifications/id506088175';
      }
      // Android detection
      else if (/android/i.test(userAgent)) {
        url = 'https://play.google.com/store/apps/details?id=net.superblock.pushover';
      }
      
      // Open in new tab
      window.open(url, '_blank');
      
      // Show message
      showMessage('üì• Opening Pushover download page...', 'info');
    }
    
    // Save Pushover Key
    async function savePushoverKey() {
      const key = document.getElementById('pushoverKey').value.trim();
      const status = document.getElementById('pushoverStatus');
      
      if (!key) {
        status.style.background = 'rgba(244,67,54,0.2)';
        status.style.color = '#E57373';
        status.innerHTML = '‚ùå Please enter your Pushover User Key';
        return;
      }
      
      if (!currentUser) {
        status.style.background = 'rgba(244,67,54,0.2)';
        status.style.color = '#E57373';
        status.innerHTML = '‚ùå Please log in first';
        return;
      }
      
      try {
        // Save to Firestore
        await window.updateDoc(window.doc(window.db, 'users', currentUser.username), {
          pushoverKey: key,
          notificationMethod: 'pushover',
          pushoverKeyUpdatedAt: window.serverTimestamp()
        });
        
        status.style.background = 'rgba(76,175,80,0.2)';
        status.style.color = '#81C784';
        status.innerHTML = '‚úÖ Pushover key saved successfully!';
        
        showMessage('‚úÖ Pushover key saved!', 'success');
      } catch (error) {
        console.error('Error saving Pushover key:', error);
        status.style.background = 'rgba(244,67,54,0.2)';
        status.style.color = '#E57373';
        status.innerHTML = '‚ùå Error: ' + error.message;
      }
    }
    
    // Load saved Pushover key
    async function loadPushoverKey() {
      try {
        if (!currentUser) return;
        
        const userDoc = await window.getDoc(window.doc(window.db, 'users', currentUser.username));
        const data = userDoc.data();
        
        if (data?.pushoverKey) {
          document.getElementById('pushoverKey').value = data.pushoverKey;
        }
      } catch (error) {
        console.error('Error loading Pushover key:', error);
      }
    }
    
    // Test Pushover
    async function testPushover() {
      const key = document.getElementById('pushoverKey').value.trim();
      const status = document.getElementById('pushoverStatus');
      
      if (!key) {
        status.style.background = 'rgba(244,67,54,0.2)';
        status.style.color = '#E57373';
        status.innerHTML = '‚ùå Please save your Pushover key first';
        return;
      }
      
      status.style.background = 'rgba(33,150,243,0.2)';
      status.style.color = '#64B5F6';
      status.innerHTML = 'üîÑ Sending test alarm...';
      
      try {
        // Call Cloud Function to send test
        const testFunction = window.httpsCallable(window.functions, 'sendPushoverTest');
        const result = await testFunction({ userKey: key });
        
        if (result.data.success) {
          status.style.background = 'rgba(76,175,80,0.2)';
          status.style.color = '#81C784';
          status.innerHTML = '‚úÖ Test alarm sent! Check your Pushover app';
          
          showMessage('üß™ Test alarm sent to Pushover!', 'success');
        } else {
          throw new Error(result.data.error || 'Unknown error');
        }
      } catch (error) {
        console.error('Error sending test:', error);
        status.style.background = 'rgba(244,67,54,0.2)';
        status.style.color = '#E57373';
        status.innerHTML = '‚ùå Error: ' + error.message;
      }
    }

    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
      initializeApp();
      applyFontSize();
      
      // Load notification method
      loadNotificationMethod();
      
      // Update Next Alert every 10 seconds
      nextAlertInterval = setInterval(updateNextAlert, 10000);
      
      // Set default selected test time
      selectTestTime(15);
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (unsubscribeNotifications) {
        unsubscribeNotifications();
      }
    });
  </script>

</body>
</html>
