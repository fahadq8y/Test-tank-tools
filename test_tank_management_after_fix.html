<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Test Tank Management After Fix</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f8ff; }
    .container { max-width: 1000px; margin: 0 auto; }
    .section { background: white; padding: 20px; margin: 20px 0; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .success { border-left: 5px solid #4CAF50; }
    .error { border-left: 5px solid #f44336; }
    .info { border-left: 5px solid #2196F3; }
    .tank-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; }
    .tank-id { font-weight: bold; color: #007bff; }
    .comment-value { color: #28a745; font-weight: bold; }
    .missing { color: #dc3545; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🧪 Test Tank Management After Fix</h1>
    
    <div class="section info">
      <h2>📊 Testing Firebase Data After Comment Fix</h2>
      <div id="status">Connecting to Firebase...</div>
    </div>

    <div class="section" id="resultsSection" style="display:none;">
      <h2>🛢️ PBCR Tanks with Comments</h2>
      <div id="tanksList"></div>
    </div>

    <div class="section" id="summarySection" style="display:none;">
      <h2>📈 Summary</h2>
      <div id="summary"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function log(message) {
      const status = document.getElementById('status');
      const div = document.createElement('div');
      div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      status.appendChild(div);
      console.log(message);
    }

    async function testAfterFix() {
      try {
        log('🔍 Loading PBCR tanks to verify fix...');
        
        const tanksRef = collection(db, 'tankData', 'pbcr', 'tanks');
        const snapshot = await getDocs(tanksRef);
        
        let tanks = [];
        let withComments = 0;
        let withoutComments = 0;
        
        snapshot.forEach((doc) => {
          const data = doc.data();
          const tank = {
            id: doc.id,
            min: data.min || 0,
            max: data.max || 0,
            comment: data.comment || 0,
            hasComment: data.comment && data.comment > 0
          };
          
          tanks.push(tank);
          
          if (tank.hasComment) {
            withComments++;
          } else {
            withoutComments++;
          }
        });
        
        // Sort tanks by ID for better display
        tanks.sort((a, b) => parseInt(a.id) - parseInt(b.id));
        
        log(`✅ Loaded ${tanks.length} PBCR tanks`);
        log(`✅ With comments: ${withComments}`);
        log(`⚠️ Without comments: ${withoutComments}`);
        
        // Display results
        displayTanks(tanks);
        displaySummary(withComments, withoutComments, tanks.length);
        
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('summarySection').style.display = 'block';
        
      } catch (error) {
        log(`❌ Error: ${error.message}`);
      }
    }

    function displayTanks(tanks) {
      const container = document.getElementById('tanksList');
      
      // Filter to show only the main PBCR tanks that we fixed
      const mainTanks = tanks.filter(t => {
        const id = parseInt(t.id);
        return (id >= 210 && id <= 229) || (id >= 250 && id <= 260) || (id >= 270 && id <= 279);
      });
      
      container.innerHTML = '<h3>Main PBCR Tanks (Fixed):</h3>';
      
      mainTanks.forEach(tank => {
        const div = document.createElement('div');
        div.className = 'tank-item';
        
        const commentDisplay = tank.hasComment 
          ? `<span class="comment-value">${tank.comment} bbl/m</span>`
          : `<span class="missing">No Comment</span>`;
        
        div.innerHTML = `
          <span class="tank-id">Tank ${tank.id}</span>
          <span>Min: ${tank.min}m | Max: ${tank.max}m</span>
          ${commentDisplay}
        `;
        
        container.appendChild(div);
      });
      
      // Show some tanks without comments
      const missingTanks = tanks.filter(t => !t.hasComment).slice(0, 10);
      if (missingTanks.length > 0) {
        container.innerHTML += '<h3>Sample Tanks Still Missing Comments:</h3>';
        
        missingTanks.forEach(tank => {
          const div = document.createElement('div');
          div.className = 'tank-item';
          div.innerHTML = `
            <span class="tank-id">Tank ${tank.id}</span>
            <span>Min: ${tank.min}m | Max: ${tank.max}m</span>
            <span class="missing">No Comment</span>
          `;
          container.appendChild(div);
        });
      }
    }

    function displaySummary(withComments, withoutComments, total) {
      const summary = document.getElementById('summary');
      const fixedPercent = ((withComments / total) * 100).toFixed(1);
      
      summary.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
          <div style="text-align: center; background: #e8f5e9; padding: 20px; border-radius: 10px;">
            <h3 style="color: #2e7d32; margin: 0;">${withComments}</h3>
            <p style="margin: 5px 0; color: #2e7d32;">Tanks with Comments</p>
          </div>
          <div style="text-align: center; background: #fff3e0; padding: 20px; border-radius: 10px;">
            <h3 style="color: #f57c00; margin: 0;">${withoutComments}</h3>
            <p style="margin: 5px 0; color: #f57c00;">Still Missing Comments</p>
          </div>
          <div style="text-align: center; background: #e3f2fd; padding: 20px; border-radius: 10px;">
            <h3 style="color: #1976d2; margin: 0;">${fixedPercent}%</h3>
            <p style="margin: 5px 0; color: #1976d2;">Fix Success Rate</p>
          </div>
          <div style="text-align: center; background: #f3e5f5; padding: 20px; border-radius: 10px;">
            <h3 style="color: #7b1fa2; margin: 0;">${total}</h3>
            <p style="margin: 5px 0; color: #7b1fa2;">Total Tanks</p>
          </div>
        </div>
        
        <div style="margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px;">
          <h4 style="color: #2e7d32; margin-top: 0;">🎉 Fix Results:</h4>
          <ul style="color: #2e7d32;">
            <li>✅ Main PBCR tanks (210-279 series) now have comment data</li>
            <li>✅ Tank Management should display comment field correctly</li>
            <li>✅ PBCR calculations should work properly</li>
            <li>💡 Remaining tanks without comments are likely special purpose tanks</li>
          </ul>
        </div>
      `;
    }

    // Start test
    testAfterFix();
  </script>
</body>
</html>