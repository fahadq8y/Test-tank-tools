<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🧪 اختبار خوارزميات الريت المُحدثة</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .test-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            color: #2d3748;
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #4299e1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 0.95rem;
        }

        .form-input, .form-select {
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
        }

        .results-section {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-top: 25px;
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            margin: 10px 0;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .result-label {
            font-weight: 600;
            color: #4a5568;
        }

        .result-value {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .result-success {
            color: #38a169;
        }

        .result-error {
            color: #e53e3e;
        }

        .result-info {
            color: #3182ce;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .comparison-table th,
        .comparison-table td {
            padding: 15px 20px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }

        .comparison-table th {
            background: #4299e1;
            color: white;
            font-weight: 600;
        }

        .comparison-table tr:hover {
            background: #f7fafc;
        }

        .step-log {
            background: #1a202c;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            white-space: pre-wrap;
            line-height: 1.5;
        }

        .algorithm-info {
            background: linear-gradient(135deg, #f0fff4, #c6f6d5);
            border: 2px solid #9ae6b4;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .algorithm-info h3 {
            color: #22543d;
            margin-bottom: 15px;
        }

        .algorithm-info ul {
            color: #2f855a;
            padding-left: 25px;
        }

        .algorithm-info li {
            margin: 8px 0;
        }

        .quick-test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .quick-test-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-test-card:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .quick-test-card h4 {
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }

        .quick-test-card p {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        .tank-params {
            font-size: 0.85rem;
            color: #4a5568;
            background: #f7fafc;
            padding: 10px;
            border-radius: 8px;
        }

        @media (max-width: 768px) {
            .input-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>🧪 اختبار خوارزميات الريت المُحدثة</h1>
            <p>اختبار الخوارزميات الجديدة المأخوذة من الملف القديم مع تطبيقها على Firebase</p>
        </div>

        <!-- Algorithm Info -->
        <div class="algorithm-info">
            <h3>📋 الخوارزميات المُطبقة من الملف القديم:</h3>
            <ul>
                <li><strong>meter/hr:</strong> حساب مباشر = levelDiff / timeDiffHours</li>
                <li><strong>bbl/hr:</strong> (levelDiff * comment) / timeDiffHours</li>
                <li><strong>m³/hr:</strong> (levelDiff * comment / timeDiffHours) * 0.159</li>
                <li><strong>MT/hr:</strong> (levelDiff * comment * 0.159 * 0.85) / timeDiffHours</li>
            </ul>
        </div>

        <!-- Quick Tests -->
        <div class="test-section">
            <h2 class="section-title">⚡ اختبارات سريعة للخزانات المعطلة</h2>
            <div class="quick-test-grid">
                <div class="quick-test-card" onclick="runQuickTest('221', 'bbl/hr', 15.5, 14.2, 60)">
                    <h4>🏷️ خزان 221</h4>
                    <p>اختبار bbl/hr مع قيم افتراضية</p>
                    <div class="tank-params">
                        Current: 15.5m → Previous: 14.2m<br>
                        Time: 60 min | Expected: bbl/hr calculation
                    </div>
                </div>
                
                <div class="quick-test-card" onclick="runQuickTest('460', 'm³/hr', 12.0, 10.5, 90)">
                    <h4>🏷️ خزان 460</h4>
                    <p>اختبار m³/hr مع قيم افتراضية</p>
                    <div class="tank-params">
                        Current: 12.0m → Previous: 10.5m<br>
                        Time: 90 min | Expected: m³/hr calculation
                    </div>
                </div>
                
                <div class="quick-test-card" onclick="runQuickTest('834', 'meter/hr', 16.0, 15.2, 45)">
                    <h4>🏷️ خزان 834</h4>
                    <p>اختبار meter/hr مع قيم افتراضية</p>
                    <div class="tank-params">
                        Current: 16.0m → Previous: 15.2m<br>
                        Time: 45 min | Expected: meter/hr calculation
                    </div>
                </div>
                
                <div class="quick-test-card" onclick="runQuickTest('520', 'MT/hr', 11.5, 10.8, 120)">
                    <h4>🏷️ خزان 520</h4>
                    <p>اختبار MT/hr مع قيم افتراضية</p>
                    <div class="tank-params">
                        Current: 11.5m → Previous: 10.8m<br>
                        Time: 120 min | Expected: MT/hr calculation
                    </div>
                </div>
            </div>
        </div>

        <!-- Manual Test -->
        <div class="test-section">
            <h2 class="section-title">🔧 اختبار يدوي مخصص</h2>
            
            <div class="input-grid">
                <div class="form-group">
                    <label class="form-label">رقم الخزان:</label>
                    <input type="text" id="tankNumber" class="form-input" placeholder="مثال: 834" value="834">
                </div>
                
                <div class="form-group">
                    <label class="form-label">نوع الريت:</label>
                    <select id="rateUnit" class="form-select">
                        <option value="bbl/hr">bbl/hr (برميل/ساعة)</option>
                        <option value="m³/hr">m³/hr (متر مكعب/ساعة)</option>
                        <option value="meter/hr">meter/hr (متر طولي/ساعة)</option>
                        <option value="MT/hr">MT/hr (متريك طن/ساعة)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">المستوى الحالي (متر):</label>
                    <input type="number" id="currentLevel" class="form-input" step="0.01" value="15.5">
                </div>
                
                <div class="form-group">
                    <label class="form-label">المستوى السابق (متر):</label>
                    <input type="number" id="previousLevel" class="form-input" step="0.01" value="14.2">
                </div>
                
                <div class="form-group">
                    <label class="form-label">فرق الوقت (بالدقائق):</label>
                    <input type="number" id="timeDiffMinutes" class="form-input" value="60">
                </div>
                
                <div class="form-group">
                    <label class="form-label">قيمة BPM (اختياري):</label>
                    <input type="number" id="manualBmp" class="form-input" placeholder="تُجلب من Firebase تلقائياً">
                </div>
            </div>
            
            <div style="text-align: center; margin: 25px 0;">
                <button class="btn btn-primary" onclick="runManualTest()">
                    🧪 تشغيل الاختبار
                </button>
                <button class="btn btn-success" onclick="compareWithCurrentLogic()" style="margin-left: 15px;">
                    ⚖️ مقارنة مع المنطق الحالي
                </button>
                <button class="btn btn-warning" onclick="clearResults()" style="margin-left: 15px;">
                    🗑️ مسح النتائج
                </button>
            </div>
        </div>

        <!-- Results -->
        <div id="results" class="results-section" style="display: none;">
            <h3>📊 نتائج الاختبار:</h3>
            <div id="resultContent"></div>
            
            <div id="stepLog" class="step-log"></div>
        </div>
        
        <!-- Comparison -->
        <div id="comparison" class="test-section" style="display: none;">
            <h2 class="section-title">⚖️ مقارنة الخوارزميات</h2>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>الخوارزمية</th>
                        <th>النتيجة</th>
                        <th>الوحدة</th>
                        <th>الحالة</th>
                        <th>ملاحظات</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, doc, getDoc, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase Configuration - Same as live-tanks.html
        const firebaseConfig = {
            apiKey: "AIzaSyBCdv37V6vOFMe42rGlPyl9lVq-9JldEPg",
            authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
            projectId: "tank-tools-knpc-c2d95",
            storageBucket: "tank-tools-knpc-c2d95.appspot.com",
            messagingSenderId: "317396816895",
            appId: "1:317396816895:web:7c17ebd7c72e4a98e75c66"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.getDocs = getDocs;
        window.collection = collection;

        console.log('🔥 Firebase initialized for Rate Algorithm Testing');
    </script>

    <script>
        // Global variables
        let tankDataCache = {};
        let testResults = [];
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            console.log('🧪 Rate Algorithm Tester initialized');
            preloadTankData();
        });

        // Preload tank data from Firebase
        async function preloadTankData() {
            try {
                console.log('📥 Preloading tank data from Firebase...');
                
                const departments = ['pbcr', 'plcr'];
                for (const dept of departments) {
                    const tanksRef = window.collection(window.db, 'tankData', dept, 'tanks');
                    const snapshot = await window.getDocs(tanksRef);
                    
                    snapshot.forEach(doc => {
                        tankDataCache[doc.id] = {
                            ...doc.data(),
                            department: dept.toUpperCase()
                        };
                    });
                }
                
                console.log('✅ Tank data loaded:', Object.keys(tankDataCache).length, 'tanks');
                console.log('📊 Available tanks:', Object.keys(tankDataCache));
                
            } catch (error) {
                console.error('❌ Error loading tank data:', error);
            }
        }

        // NEW ALGORITHM - Based on old file logic with Firebase integration
        function calculateRateNewAlgorithm(rateUnit, currentLevel, previousLevel, tankNumber, timeDiffMinutes, manualBmp = null) {
            const timeDiffHours = timeDiffMinutes / 60;
            const levelDiff = Math.abs(currentLevel - previousLevel);
            
            let stepLog = [];
            stepLog.push(`🔢 Input Parameters:`);
            stepLog.push(`   Tank Number: ${tankNumber}`);
            stepLog.push(`   Rate Unit: ${rateUnit}`);
            stepLog.push(`   Current Level: ${currentLevel} meters`);
            stepLog.push(`   Previous Level: ${previousLevel} meters`);
            stepLog.push(`   Time Difference: ${timeDiffMinutes} minutes (${timeDiffHours.toFixed(3)} hours)`);
            stepLog.push(`   Level Difference: ${levelDiff} meters`);
            
            // Check time validity
            if (timeDiffHours <= 0) {
                stepLog.push(`❌ ERROR: Invalid time difference (${timeDiffHours} hours)`);
                return { result: 0, steps: stepLog, error: 'Invalid time difference' };
            }
            
            // Get BMP value
            let bmp = manualBmp;
            if (bmp === null || bmp === undefined) {
                const tankData = tankDataCache[tankNumber];
                if (tankData) {
                    // NEW: Always use comment field (simplified logic from old file)
                    bmp = parseFloat(tankData.comment) || 0;
                    stepLog.push(`📊 Tank data found in Firebase`);
                    stepLog.push(`   Comment (BMP): ${bmp}`);
                    stepLog.push(`   Department: ${tankData.department}`);
                } else {
                    stepLog.push(`❌ Tank data not found in Firebase for tank ${tankNumber}`);
                    return { result: 0, steps: stepLog, error: 'Tank data not found' };
                }
            } else {
                stepLog.push(`🔧 Using manual BMP value: ${bmp}`);
            }
            
            let actualRate = 0;
            
            // Apply old file algorithms
            if (rateUnit === 'meter/hr' || rateUnit === 'mtr/hr' || rateUnit === 'mtr') {
                // Direct calculation - no BMP needed (OLD FILE LOGIC)
                actualRate = levelDiff / timeDiffHours;
                stepLog.push(`📏 Direct meter calculation:`);
                stepLog.push(`   Rate = ${levelDiff} / ${timeDiffHours.toFixed(3)} = ${actualRate.toFixed(3)} meter/hr`);
                
            } else if (rateUnit === 'bbl/hr') {
                // Barrel calculation (OLD FILE LOGIC)
                if (bmp <= 0) {
                    stepLog.push(`❌ ERROR: Invalid BMP value (${bmp})`);
                    return { result: 0, steps: stepLog, error: 'Invalid BMP value' };
                }
                
                const volumeDiff = levelDiff * bmp;
                actualRate = volumeDiff / timeDiffHours;
                stepLog.push(`🛢️ Barrel calculation:`);
                stepLog.push(`   Volume difference = ${levelDiff} × ${bmp} = ${volumeDiff} barrels`);
                stepLog.push(`   Rate = ${volumeDiff} / ${timeDiffHours.toFixed(3)} = ${actualRate.toFixed(3)} bbl/hr`);
                
            } else if (rateUnit === 'm³/hr' || rateUnit === 'm3/hr' || rateUnit === 'm³' || rateUnit === 'm3') {
                // Cubic meter calculation (OLD FILE LOGIC)
                if (bmp <= 0) {
                    stepLog.push(`❌ ERROR: Invalid BMP value (${bmp})`);
                    return { result: 0, steps: stepLog, error: 'Invalid BMP value' };
                }
                
                const volumeDiffBarrels = levelDiff * bmp;
                const rateBarrels = volumeDiffBarrels / timeDiffHours;
                actualRate = rateBarrels * 0.159; // Convert barrels to m³
                stepLog.push(`🧊 Cubic meter calculation:`);
                stepLog.push(`   Volume difference = ${levelDiff} × ${bmp} = ${volumeDiffBarrels} barrels`);
                stepLog.push(`   Rate (barrels) = ${volumeDiffBarrels} / ${timeDiffHours.toFixed(3)} = ${rateBarrels.toFixed(3)} bbl/hr`);
                stepLog.push(`   Rate (m³) = ${rateBarrels.toFixed(3)} × 0.159 = ${actualRate.toFixed(3)} m³/hr`);
                
            } else if (rateUnit === 'MT/hr') {
                // Metric tons calculation (OLD FILE LOGIC)
                if (bmp <= 0) {
                    stepLog.push(`❌ ERROR: Invalid BMP value (${bmp})`);
                    return { result: 0, steps: stepLog, error: 'Invalid BMP value' };
                }
                
                const volumeDiffBarrels = levelDiff * bmp;
                const volumeM3 = volumeDiffBarrels * 0.159;
                const massMT = volumeM3 * 0.85; // Average density
                actualRate = massMT / timeDiffHours;
                stepLog.push(`⚖️ Metric tons calculation:`);
                stepLog.push(`   Volume difference = ${levelDiff} × ${bmp} = ${volumeDiffBarrels} barrels`);
                stepLog.push(`   Volume (m³) = ${volumeDiffBarrels} × 0.159 = ${volumeM3.toFixed(3)} m³`);
                stepLog.push(`   Mass (MT) = ${volumeM3.toFixed(3)} × 0.85 = ${massMT.toFixed(3)} MT`);
                stepLog.push(`   Rate = ${massMT.toFixed(3)} / ${timeDiffHours.toFixed(3)} = ${actualRate.toFixed(3)} MT/hr`);
                
            } else {
                stepLog.push(`❌ ERROR: Unknown rate unit: ${rateUnit}`);
                return { result: 0, steps: stepLog, error: 'Unknown rate unit' };
            }
            
            stepLog.push(`✅ FINAL RESULT: ${actualRate.toFixed(3)} ${rateUnit}`);
            
            return { 
                result: actualRate, 
                steps: stepLog, 
                error: null,
                bmp: bmp,
                tankData: tankDataCache[tankNumber] || null
            };
        }

        // Current algorithm (from current live-tanks.html - simplified simulation)
        function calculateRateCurrentAlgorithm(rateUnit, currentLevel, previousLevel, tankNumber, timeDiffMinutes) {
            // Simulated current logic with problems
            const timeDiffHours = timeDiffMinutes / 60;
            const levelDiff = Math.abs(currentLevel - previousLevel);
            
            // Simulate the problematic logic
            let firebaseDepartment = '';
            if (rateUnit === 'MT/hr') {
                firebaseDepartment = 'plcr';
            } else {
                firebaseDepartment = 'pbcr';
            }
            
            const tankData = tankDataCache[tankNumber];
            if (!tankData) {
                return { result: 0, error: 'Tank not found', algorithm: 'Current (Problematic)' };
            }
            
            let bmpField = '';
            let bmpValue = 0;
            
            // Current problematic logic for BMP field selection
            if (firebaseDepartment === 'plcr') {
                bmpField = 'factor';
                bmpValue = parseFloat(tankData.factor) || 0;
            } else {
                bmpField = 'comment';
                bmpValue = parseFloat(tankData.comment) || 0;
            }
            
            // Simulate calculation issues
            if (bmpValue <= 0 && rateUnit !== 'meter/hr') {
                return { result: 0, error: `BMP ${bmpField} is zero`, algorithm: 'Current (Problematic)' };
            }
            
            let actualRate = 0;
            if (rateUnit === 'meter/hr') {
                actualRate = levelDiff / timeDiffHours;
            } else {
                actualRate = (levelDiff * bmpValue) / timeDiffHours;
                
                if (rateUnit === 'm³/hr') {
                    actualRate = actualRate * 0.159;
                } else if (rateUnit === 'MT/hr') {
                    actualRate = actualRate * 0.159 * 0.85;
                }
            }
            
            return { 
                result: actualRate, 
                error: null, 
                algorithm: 'Current (Problematic)',
                bmpField: bmpField,
                bmpValue: bmpValue
            };
        }

        // Run quick test
        function runQuickTest(tankNumber, rateUnit, currentLevel, previousLevel, timeDiffMinutes) {
            document.getElementById('tankNumber').value = tankNumber;
            document.getElementById('rateUnit').value = rateUnit;
            document.getElementById('currentLevel').value = currentLevel;
            document.getElementById('previousLevel').value = previousLevel;
            document.getElementById('timeDiffMinutes').value = timeDiffMinutes;
            document.getElementById('manualBmp').value = '';
            
            runManualTest();
        }

        // Run manual test
        function runManualTest() {
            const tankNumber = document.getElementById('tankNumber').value;
            const rateUnit = document.getElementById('rateUnit').value;
            const currentLevel = parseFloat(document.getElementById('currentLevel').value);
            const previousLevel = parseFloat(document.getElementById('previousLevel').value);
            const timeDiffMinutes = parseFloat(document.getElementById('timeDiffMinutes').value);
            const manualBmp = document.getElementById('manualBmp').value ? parseFloat(document.getElementById('manualBmp').value) : null;
            
            if (!tankNumber || isNaN(currentLevel) || isNaN(previousLevel) || isNaN(timeDiffMinutes)) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            console.log('🧪 Running test with parameters:', { tankNumber, rateUnit, currentLevel, previousLevel, timeDiffMinutes, manualBmp });
            
            // Run new algorithm
            const newResult = calculateRateNewAlgorithm(rateUnit, currentLevel, previousLevel, tankNumber, timeDiffMinutes, manualBmp);
            
            // Display results
            displayResults(newResult, tankNumber, rateUnit);
        }

        // Compare algorithms
        function compareWithCurrentLogic() {
            const tankNumber = document.getElementById('tankNumber').value;
            const rateUnit = document.getElementById('rateUnit').value;
            const currentLevel = parseFloat(document.getElementById('currentLevel').value);
            const previousLevel = parseFloat(document.getElementById('previousLevel').value);
            const timeDiffMinutes = parseFloat(document.getElementById('timeDiffMinutes').value);
            const manualBmp = document.getElementById('manualBmp').value ? parseFloat(document.getElementById('manualBmp').value) : null;
            
            if (!tankNumber || isNaN(currentLevel) || isNaN(previousLevel) || isNaN(timeDiffMinutes)) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }
            
            // Run both algorithms
            const newResult = calculateRateNewAlgorithm(rateUnit, currentLevel, previousLevel, tankNumber, timeDiffMinutes, manualBmp);
            const currentResult = calculateRateCurrentAlgorithm(rateUnit, currentLevel, previousLevel, tankNumber, timeDiffMinutes);
            
            // Display comparison
            displayComparison(newResult, currentResult, tankNumber, rateUnit);
        }

        // Display results
        function displayResults(result, tankNumber, rateUnit) {
            const resultsDiv = document.getElementById('results');
            const resultContent = document.getElementById('resultContent');
            const stepLog = document.getElementById('stepLog');
            
            resultsDiv.style.display = 'block';
            
            let html = '';
            
            if (result.error) {
                html += `<div class="result-item">
                    <span class="result-label">❌ خطأ:</span>
                    <span class="result-value result-error">${result.error}</span>
                </div>`;
            } else {
                html += `<div class="result-item">
                    <span class="result-label">✅ النتيجة النهائية:</span>
                    <span class="result-value result-success">${result.result.toFixed(3)} ${rateUnit}</span>
                </div>`;
                
                if (result.bmp) {
                    html += `<div class="result-item">
                        <span class="result-label">📊 قيمة BMP:</span>
                        <span class="result-value result-info">${result.bmp}</span>
                    </div>`;
                }
                
                if (result.tankData) {
                    html += `<div class="result-item">
                        <span class="result-label">🏷️ قسم الخزان:</span>
                        <span class="result-value result-info">${result.tankData.department}</span>
                    </div>`;
                }
            }
            
            resultContent.innerHTML = html;
            stepLog.textContent = result.steps.join('\n');
        }

        // Display comparison
        function displayComparison(newResult, currentResult, tankNumber, rateUnit) {
            const comparisonDiv = document.getElementById('comparison');
            const comparisonBody = document.getElementById('comparisonBody');
            
            comparisonDiv.style.display = 'block';
            
            let html = '';
            
            // New algorithm row
            html += `<tr>
                <td><strong>🆕 خوارزمية جديدة (مأخوذة من الملف القديم)</strong></td>
                <td>${newResult.error ? '❌ فشل' : `<strong>${newResult.result.toFixed(3)}</strong>`}</td>
                <td>${rateUnit}</td>
                <td>${newResult.error ? '<span style="color: #e53e3e;">خطأ</span>' : '<span style="color: #38a169;">نجح ✅</span>'}</td>
                <td>${newResult.error || 'حساب صحيح باستخدام comment'}</td>
            </tr>`;
            
            // Current algorithm row
            html += `<tr>
                <td><strong>⚠️ خوارزمية حالية (مُشكِلة)</strong></td>
                <td>${currentResult.error ? '❌ فشل' : `<strong>${currentResult.result.toFixed(3)}</strong>`}</td>
                <td>${rateUnit}</td>
                <td>${currentResult.error ? '<span style="color: #e53e3e;">خطأ</span>' : '<span style="color: #3182ce;">نجح جزئياً</span>'}</td>
                <td>${currentResult.error || `استخدم ${currentResult.bmpField}: ${currentResult.bmpValue}`}</td>
            </tr>`;
            
            // Difference row
            if (!newResult.error && !currentResult.error) {
                const diff = Math.abs(newResult.result - currentResult.result);
                const diffPercent = (diff / newResult.result * 100).toFixed(2);
                html += `<tr style="background: #fff3cd;">
                    <td><strong>📊 الفرق</strong></td>
                    <td><strong>${diff.toFixed(3)}</strong></td>
                    <td>${rateUnit}</td>
                    <td>${diff < 0.001 ? '<span style="color: #38a169;">متطابق</span>' : `<span style="color: #ed8936;">${diffPercent}% فرق</span>`}</td>
                    <td>${diff < 0.001 ? 'نتائج متطابقة' : 'يوجد اختلاف في النتائج'}</td>
                </tr>`;
            }
            
            comparisonBody.innerHTML = html;
        }

        // Clear results
        function clearResults() {
            document.getElementById('results').style.display = 'none';
            document.getElementById('comparison').style.display = 'none';
        }

        // Export functions to global scope
        window.runQuickTest = runQuickTest;
        window.runManualTest = runManualTest;
        window.compareWithCurrentLogic = compareWithCurrentLogic;
        window.clearResults = clearResults;
    </script>
</body>
</html>