<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Management - KNPC System</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#003366">
  <script src="permissions.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;min-height:100vh}
    
    .nav-bar{display:flex;justify-content:space-between;align-items:center;padding:15px 25px;background:rgba(0,0,0,0.6);border-radius:15px;margin-bottom:30px;flex-wrap:wrap;backdrop-filter:blur(10px)}
    .nav-logo{font-size:24px;font-weight:bold;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .nav-link{color:white;text-decoration:none;padding:10px 18px;border-radius:10px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
    .nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-2px)}
    .nav-link.active{background:rgba(255,255,255,0.3);font-weight:bold;border:1px solid rgba(255,255,255,0.4)}
    .nav-admin{background:linear-gradient(45deg,#FFD700,#FFA500);color:#003366;font-weight:bold}
    .nav-user{display:flex;align-items:center;gap:15px;background:rgba(255,255,255,0.1);padding:8px 20px;border-radius:25px;backdrop-filter:blur(10px)}
    .user-avatar{width:35px;height:35px;border-radius:50%;background:linear-gradient(45deg,#4CAF50,#45a049);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:16px}
    .logout-btn{background:rgba(255,0,0,0.2);border:1px solid rgba(255,0,0,0.5);color:white;padding:8px 15px;border-radius:8px;cursor:pointer;font-size:14px;transition:all 0.3s ease}
    
    .page-header{text-align:center;margin-bottom:40px}
    .page-title{font-size:2.8rem;margin-bottom:15px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:bold}
    .page-subtitle{font-size:1.3rem;opacity:0.9;margin-bottom:20px}
    
    .container{max-width:95%;margin:0 auto}
    .section{background:rgba(255,255,255,0.1);backdrop-filter:blur(15px);border-radius:20px;padding:30px;margin-bottom:30px;border:1px solid rgba(255,255,255,0.2);box-shadow:0 8px 32px rgba(0,0,0,0.3)}
    .section-title{font-size:1.6rem;font-weight:bold;margin-bottom:25px;color:#FFD700;display:flex;align-items:center;gap:12px}
    
    .controls{display:flex;gap:20px;margin-bottom:30px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .search-filter{display:flex;gap:15px;flex:1;min-width:300px}
    .search-box,.filter-select{padding:12px 18px;border:none;border-radius:12px;background:rgba(255,255,255,0.9);color:#003366;font-size:15px;font-weight:500}
    .search-box{flex:1;min-width:250px}
    
    .btn{padding:12px 24px;border:none;border-radius:12px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;display:inline-flex;align-items:center;gap:10px}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white;box-shadow:0 4px 15px rgba(76,175,80,0.3)}
    .btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;box-shadow:0 4px 15px rgba(33,150,243,0.3)}
    .btn-warning{background:linear-gradient(45deg,#ff9800,#f57c00);color:white;box-shadow:0 4px 15px rgba(255,152,0,0.3)}
    .btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white;box-shadow:0 4px 15px rgba(244,67,54,0.3)}
    .btn:hover{transform:translateY(-3px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
    
    .tanks-table-container{width:100%;background:rgba(255,255,255,0.95);border-radius:20px;overflow:hidden;box-shadow:0 8px 30px rgba(0,0,0,0.2);overflow-x:auto;-webkit-overflow-scrolling:touch}
    .tanks-table{width:100%;min-width:900px;color:#003366;border-collapse:collapse}
    .tanks-table th,.tanks-table td{padding:18px 15px;text-align:center;border-bottom:1px solid rgba(0,51,102,0.1)}
    .tanks-table th{background:linear-gradient(45deg,#003366,#004080);color:white;font-weight:bold;font-size:14px;text-transform:uppercase;letter-spacing:0.5px}
    .tanks-table tr:hover{background:rgba(255,215,0,0.1)}
    .tanks-table tr:nth-child(even){background:rgba(0,0,0,0.02)}
    
    .tank-id{font-weight:bold;font-size:16px;color:#003366}
    .dept-badge{padding:6px 12px;border-radius:20px;font-size:11px;font-weight:bold;text-transform:uppercase}
    .dept-pbcr{background:#4CAF50;color:white}
    .dept-plcr{background:#ff9800;color:white}
    .dept-washery{background:#2196F3;color:white}
    
    .action-buttons{display:flex;gap:8px;justify-content:center;flex-wrap:wrap}
    .action-btn{padding:8px 12px;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:500;transition:all 0.3s ease;min-width:35px;height:35px;display:flex;align-items:center;justify-content:center}
    .action-btn:hover{transform:scale(1.1)}
    
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;backdrop-filter:blur(8px)}
    .modal.show{display:flex;justify-content:center;align-items:center;padding:20px}
    .modal-content{background:rgba(255,255,255,0.95);padding:35px;border-radius:20px;max-width:600px;width:90%;color:#003366;max-height:90vh;overflow-y:auto;backdrop-filter:blur(10px)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;padding-bottom:20px;border-bottom:3px solid #ddd}
    .modal-title{font-size:1.5rem;font-weight:bold;color:#003366}
    .close-btn{background:none;border:none;font-size:30px;cursor:pointer;color:#666;font-weight:bold;transition:all 0.3s ease}
    .close-btn:hover{color:#f44336;transform:scale(1.2)}
    
    .form-group{margin-bottom:20px}
    .form-label{display:block;margin-bottom:10px;font-weight:600;color:#003366;font-size:14px}
    .form-input,.form-select{width:100%;padding:15px;border:2px solid #ddd;border-radius:12px;font-size:15px;transition:border-color 0.3s ease}
    .form-input:focus,.form-select:focus{outline:none;border-color:#4CAF50;box-shadow:0 0 0 3px rgba(76,175,80,0.1)}
    
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;text-align:center;border:1px solid rgba(255,255,255,0.2);transition:all 0.3s ease}
    .stat-card:hover{transform:translateY(-5px);box-shadow:0 10px 30px rgba(0,0,0,0.2)}
    .stat-number{font-size:2.5rem;font-weight:bold;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
    .stat-label{font-size:0.9rem;opacity:0.8;font-weight:500}
    
    .loading{text-align:center;padding:50px;font-size:18px}
    .loading-spinner{display:inline-block;width:50px;height:50px;border:5px solid rgba(255,255,255,0.3);border-radius:50%;border-top:5px solid #FFD700;animation:spin 1s linear infinite;margin-bottom:15px}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    
    .message{padding:18px 25px;border-radius:15px;margin-bottom:25px;font-weight:500;border-left:5px solid;backdrop-filter:blur(10px)}
    .message.success{background:rgba(76,175,80,0.2);border-color:#4CAF50;color:#4CAF50}
    .message.error{background:rgba(244,67,54,0.2);border-color:#f44336;color:#f44336}
    .message.info{background:rgba(33,150,243,0.2);border-color:#2196F3;color:#2196F3}
    .message.warning{background:rgba(255,193,7,0.2);border-color:#ffc107;color:#ffc107}
    
    @media(max-width:768px){
      .nav-bar{flex-direction:column;gap:15px}
      .controls{flex-direction:column;align-items:stretch}
      .search-filter{width:100%}
      .action-buttons{flex-direction:column}
      .tanks-table th,.tanks-table td{padding:12px 8px;font-size:13px}
    }
  </style>
</head>
<body>

  <div class="nav-bar">
    <div class="nav-logo">üõ¢Ô∏è Tank Management System</div>
    <div class="nav-links">
      <a href="index.html" class="nav-link">üìä PBCR</a>
      <a href="plcr.html" class="nav-link">‚öóÔ∏è PLCR</a>
      <a href="NMOGASBL.html" class="nav-link">üîß NMOGAS</a>
      <a href="live-tanks.html" class="nav-link">üî¥ Live Tanks</a>
      <a href="tank-management.html" class="nav-link active">üõ¢Ô∏è Tanks</a>
      <a href="dashboard.html" class="nav-link nav-admin" id="adminLink" style="display:none">üîê Dashboard</a>
    </div>
    <div class="nav-user">
      <div class="user-avatar" id="userAvatar">F</div>
      <div>
        <div id="userName" style="font-weight:bold">Loading...</div>
        <div id="userRole" style="font-size:0.8rem;opacity:0.7">Admin</div>
      </div>
      <button class="logout-btn" onclick="logout()">üö™ Logout</button>
    </div>
  </div>

  <div class="container">
    <div class="page-header">
      <h1 class="page-title">üõ¢Ô∏è Tank Management Center</h1>
      <p class="page-subtitle">Comprehensive Management for Kuwait National Petroleum Company Tanks</p>
    </div>

    <div id="messageContainer"></div>

    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalTanks">-</div>
        <div class="stat-label">üõ¢Ô∏è Total Tanks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="pbcrTanks">-</div>
        <div class="stat-label">üè≠ PBCR Tanks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="plcrTanks">-</div>
        <div class="stat-label">‚öóÔ∏è PLCR Tanks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="washeryTanks">-</div>
        <div class="stat-label">üöø WASHERY Tanks</div>
      </div>
    </div>

    <!-- Tank Management Section -->
    <div class="section">
      <div class="section-title">
        üõ¢Ô∏è Tank Management
      </div>
      
      <div class="controls">
        <div class="search-filter">
          <input type="text" id="tankSearch" class="search-box" placeholder="üîç Search for tank by number or name...">
          <select id="deptFilter" class="filter-select">
            <option value="">All Departments</option>
            <option value="pbcr">PBCR</option>
            <option value="plcr">PLCR</option>
            <option value="washery">WASHERY</option>
          </select>
        </div>
        <div>
          <button class="btn btn-primary" onclick="addNewTank()">‚ûï Add New Tank</button>
          <button class="btn btn-secondary" onclick="refreshTanks()">üîÑ Refresh</button>
          <button class="btn btn-warning" onclick="debugFirebaseStructure()">üîç Debug Firebase</button>
        </div>
      </div>

      <div class="tanks-table-container">
        <table class="tanks-table">
          <thead>
            <tr>
              <th>üÜî Tank ID</th>
              <th>üè¢ Department</th>
              <th>üìä Min Level (m)</th>
              <th>üìà Max Level (m)</th>
              <th>üßÆ Comment (bbl/m)</th>
              <th>‚öóÔ∏è Factor</th>
              <th>üì¶ Gross Capacity</th>
              <th>üìÖ Last Modified</th>
              <th>‚öôÔ∏è Actions</th>
            </tr>
          </thead>
          <tbody id="tanksTableBody">
            <tr>
              <td colspan="9" style="padding: 50px; text-align: center;">
                <div class="loading">
                  <div class="loading-spinner"></div>
                  <div>Loading Tank Data...</div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Tank Edit Modal -->
  <div id="tankModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">Edit Tank Data</h3>
        <button class="close-btn" onclick="closeTankModal()">&times;</button>
      </div>
      <form id="tankForm">
        <div class="form-group">
          <label class="form-label">üÜî Tank Number:</label>
          <input type="text" class="form-input" id="editTankId" required>
        </div>
        <div class="form-group">
          <label class="form-label">üè¢ Department:</label>
          <select class="form-select" id="editDepartment" required>
            <option value="">Select Department</option>
            <option value="pbcr">PBCR</option>
            <option value="plcr">PLCR</option>
            <option value="washery">WASHERY</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">üìä Minimum Level (meters):</label>
          <input type="number" step="0.01" class="form-input" id="editMinLevel" required>
        </div>
        <div class="form-group">
          <label class="form-label">üìà Maximum Level (meters):</label>
          <input type="number" step="0.01" class="form-input" id="editMaxLevel" required>
        </div>
        <div class="form-group" id="commentFields">
          <label class="form-label">üßÆ Comment - Barrels per Meter (PBCR/WASHERY):</label>
          <input type="number" step="0.001" class="form-input" id="editComment" placeholder="e.g. 1234.567">
        </div>
        <div id="plcrFields" style="display:none">
          <div class="form-group">
            <label class="form-label">‚öóÔ∏è Factor (PLCR):</label>
            <input type="number" step="0.001" class="form-input" id="editPlcrFactor" placeholder="e.g. 0.158" required>
          </div>
          <div class="form-group">
            <label class="form-label">üì¶ Gross Capacity (PLCR):</label>
            <input type="number" step="0.01" class="form-input" id="editGross" placeholder="e.g. 50000">
          </div>
        </div>
        <div style="display:flex;gap:15px;justify-content:flex-end;margin-top:30px">
          <button type="button" class="btn btn-secondary" onclick="closeTankModal()">‚ùå Cancel</button>
          <button type="submit" class="btn btn-primary">üíæ Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, getDocs, addDoc, serverTimestamp, query, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase functions globally available
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;
    window.query = query;
    window.orderBy = orderBy;

    console.log('üî• Firebase Tank Management initialized!');
  </script>

  <script>
    let currentUser = null;
    let allTanks = [];
    let editingTankId = null;
    let editingDepartment = null;

    // Initialize the application
    async function initTankManagement() {
      console.log('üöÄ Initializing Tank Management...');
      
      // Check admin access
      if (!checkAdminAccess()) {
        return;
      }
      
      // Debug Firebase structure first
      await debugFirebaseStructure();
      
      // Load all tanks
      await loadAllTanks();
      
      // Setup event listeners
      setupEventListeners();
      
      console.log('‚úÖ Tank Management ready!');
    }
    
    // Debug function to explore Firebase structure
    async function debugFirebaseStructure() {
      try {
        console.log('üîç === FIREBASE STRUCTURE DEBUG ===');
        
        // Check root collections
        console.log('üìä Checking root collections...');
        
        // Try to list all possible collections
        const possibleCollections = ['tankData', 'tanks', 'pbcr', 'plcr', 'washery'];
        
        for (const collectionName of possibleCollections) {
          try {
            const collectionRef = collection(db, collectionName);
            const snapshot = await getDocs(collectionRef);
            console.log(`üìÅ Collection '${collectionName}': ${snapshot.size} documents`);
            
            if (snapshot.size > 0 && snapshot.size < 10) {
              snapshot.forEach((doc) => {
                console.log(`  üìÑ ${collectionName}/${doc.id}:`, doc.data());
              });
            }
          } catch (error) {
            console.log(`‚ùå Collection '${collectionName}' not accessible:`, error.message);
          }
        }
        
        // Check the exact structure used in other pages
        console.log('üîç Checking tankData structure from other pages...');
        try {
          const departments = ['pbcr', 'plcr'];
          for (const dept of departments) {
            const tanksCollectionRef = collection(db, "tankData", dept, "tanks");
            const querySnapshot = await getDocs(tanksCollectionRef);
            console.log(`üìä tankData/${dept}/tanks: ${querySnapshot.size} documents`);
            
            if (querySnapshot.size > 0) {
              querySnapshot.forEach((doc) => {
                console.log(`  üõ¢Ô∏è Tank ${doc.id}:`, doc.data());
              });
            }
          }
        } catch (error) {
          console.log('‚ùå Standard tankData structure not accessible:', error.message);
        }
        
        console.log('üîç === END FIREBASE DEBUG ===');
        
      } catch (error) {
        console.error('‚ùå Debug failed:', error);
      }
    }

    // Check admin access
    function checkAdminAccess() {
      const session = sessionStorage.getItem('tanktools_session');
      const userData = localStorage.getItem('tanktools_current_user');
      
      if (session !== 'active' || !userData) {
        showMessage('‚ùå Login required to access this page', 'error');
        setTimeout(() => window.location.href = 'login.html', 3000);
        return false;
      }
      
      try {
        currentUser = JSON.parse(userData);
        
        // Only admin and supervisors can access
        if (currentUser.username !== 'fam030' && !['admin', 'supervisor'].includes(currentUser.role)) {
          showMessage('‚ùå You do not have permission to access Tank Management!', 'error');
          setTimeout(() => window.location.href = 'index.html', 3000);
          return false;
        }
        
        // Update UI
        document.getElementById('userName').textContent = currentUser.fullName || currentUser.username;
        document.getElementById('userRole').textContent = currentUser.role || 'Admin';
        const firstLetter = (currentUser.fullName || currentUser.username).charAt(0).toUpperCase();
        document.getElementById('userAvatar').textContent = firstLetter;
        
        if (currentUser.username === 'fam030' || currentUser.role === 'admin') {
          document.getElementById('adminLink').style.display = 'inline-block';
        }
        
        return true;
        
      } catch (error) {
        console.error('Error parsing user data:', error);
        showMessage('‚ùå Error in user data', 'error');
        setTimeout(() => window.location.href = 'login.html', 3000);
        return false;
      }
    }

    // Load all tanks from Firebase
    async function loadAllTanks() {
      try {
        showMessage('üîÑ Loading tank data...', 'info');
        
        allTanks = [];
        const departments = ['pbcr', 'plcr', 'washery'];
        
        console.log('üîç Starting to load tanks from Firebase...');
        
        // Focus on existing departments first 
        const existingDepartments = ['pbcr', 'plcr'];
        
        for (const dept of existingDepartments) {
          console.log(`üîç Loading ${dept} tanks...`);
          
          try {
            const tanksCollectionRef = collection(db, "tankData", dept, "tanks");
            const querySnapshot = await getDocs(tanksCollectionRef);
            
            console.log(`üìä ${dept} collection size:`, querySnapshot.size);
            
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const tankData = { 
                id: doc.id, 
                department: dept,
                min: parseFloat(data.min || 0),
                max: parseFloat(data.max || 0),
                comment: parseFloat(data.comment || 0),
                factor: parseFloat(data.factor || 0),
                gross: parseFloat(data.gross || 0),
                lastModified: data.lastModified || 'Not Set'
              };
              console.log(`‚úÖ Loaded tank ${doc.id} from ${dept}:`, tankData);
              allTanks.push(tankData);
            });
            
          } catch (deptError) {
            console.warn(`‚ö†Ô∏è Could not load ${dept} tanks:`, deptError);
            
            // Try alternative structure: tankData/{tankId} with department field
            try {
              console.log(`üîÑ Trying alternative structure for ${dept}...`);
              const altCollectionRef = collection(db, "tankData");
              const altQuerySnapshot = await getDocs(altCollectionRef);
              
              altQuerySnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.department === dept) {
                  const tankData = { 
                    id: doc.id,
                    department: dept,
                    ...data,
                    lastModified: data.lastModified || 'Not Set'
                  };
                  console.log(`‚úÖ Loaded tank ${doc.id} from alternative structure:`, tankData);
                  allTanks.push(tankData);
                }
              });
              
            } catch (altError) {
              console.warn(`‚ö†Ô∏è Alternative structure also failed for ${dept}:`, altError);
            }
          }
        }
        
        // Remove duplicates based on id and department
        const uniqueTanks = [];
        const seen = new Set();
        
        allTanks.forEach(tank => {
          const key = `${tank.department}-${tank.id}`;
          if (!seen.has(key)) {
            seen.add(key);
            uniqueTanks.push(tank);
          }
        });
        
        allTanks = uniqueTanks;
        
        console.log(`‚úÖ Final tanks loaded: ${allTanks.length}`);
        console.log('Tank breakdown:', {
          pbcr: allTanks.filter(t => t.department === 'pbcr').length,
          plcr: allTanks.filter(t => t.department === 'plcr').length,
          washery: allTanks.filter(t => t.department === 'washery').length
        });
        
        // Update statistics
        updateStatistics();
        
        // Display tanks
        displayTanks(allTanks);
        
        if (allTanks.length === 0) {
          showMessage('‚ö†Ô∏è No tanks found in Firebase. Check database structure.', 'warning');
        } else {
          showMessage(`‚úÖ Successfully loaded ${allTanks.length} tanks!`, 'success');
        }
        
      } catch (error) {
        console.error('‚ùå Critical error loading tanks:', error);
        showMessage('‚ùå Error loading tank data: ' + error.message, 'error');
        
        // Show error in table with debug info
        const tbody = document.getElementById('tanksTableBody');
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="padding: 50px; text-align: center; color: #f44336;">
              ‚ùå Failed to load tank data
              <br><small>Error: ${error.message}</small>
              <br><small>Check Console for more details</small>
            </td>
          </tr>
        `;
      }
    }

    // Update statistics
    function updateStatistics() {
      const total = allTanks.length;
      const pbcr = allTanks.filter(tank => tank.department === 'pbcr').length;
      const plcr = allTanks.filter(tank => tank.department === 'plcr').length;
      const washery = allTanks.filter(tank => tank.department === 'washery').length;
      
      document.getElementById('totalTanks').textContent = total;
      document.getElementById('pbcrTanks').textContent = pbcr;
      document.getElementById('plcrTanks').textContent = plcr;
      document.getElementById('washeryTanks').textContent = washery;
    }

    // Display tanks in table
    function displayTanks(tanks) {
      const tbody = document.getElementById('tanksTableBody');
      
      if (tanks.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="padding: 50px; text-align: center; color: #666;">
              üì≠ No tanks found
            </td>
          </tr>
        `;
        return;
      }
      
      // Sort tanks by department then by ID
      tanks.sort((a, b) => {
        if (a.department !== b.department) {
          return a.department.localeCompare(b.department);
        }
        return a.id.localeCompare(b.id, undefined, { numeric: true });
      });
      
      tbody.innerHTML = tanks.map(tank => {
        const deptClass = `dept-${tank.department}`;
        const deptName = tank.department.toUpperCase();
        
        // Parse all values safely
        const minLevel = parseFloat(tank.min || 0);
        const maxLevel = parseFloat(tank.max || 0);
        const comment = parseFloat(tank.comment || 0);
        const factor = parseFloat(tank.factor || 0);
        const gross = parseFloat(tank.gross || 0);
        
        return `
          <tr>
            <td><span class="tank-id">${tank.id}</span></td>
            <td><span class="dept-badge ${deptClass}">${deptName}</span></td>
            <td>${minLevel.toFixed(2)}</td>
            <td>${maxLevel.toFixed(2)}</td>
            <td><strong>${comment > 0 ? comment.toFixed(3) : '-'}</strong></td>
            <td>${factor > 0 ? factor.toFixed(3) : '-'}</td>
            <td>${gross > 0 ? gross.toLocaleString() : '-'}</td>
            <td><small>${formatDate(tank.lastModified)}</small></td>
            <td>
              <div class="action-buttons">
                <button class="action-btn btn-warning" onclick="editTank('${tank.id}', '${tank.department}')" title="ÿ™ÿπÿØŸäŸÑ">
                  ‚úèÔ∏è
                </button>
                <button class="action-btn btn-danger" onclick="deleteTank('${tank.id}', '${tank.department}')" title="ÿ≠ÿ∞ŸÅ">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Format date
    function formatDate(timestamp) {
      if (!timestamp || timestamp === 'Not Set') return 'Not Set';
      
      try {
        const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
        return date.toLocaleDateString('en-US') + ' ' + date.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit' 
        });
      } catch {
        return 'Not Set';
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Search functionality
      document.getElementById('tankSearch').addEventListener('input', filterTanks);
      document.getElementById('deptFilter').addEventListener('change', filterTanks);
      
      // Department change in modal
      document.getElementById('editDepartment').addEventListener('change', function() {
        const dept = this.value;
        const commentFields = document.getElementById('commentFields');
        const plcrFields = document.getElementById('plcrFields');
        
        if (dept === 'plcr') {
          // PLCR uses factor and gross capacity
          commentFields.style.display = 'none';
          plcrFields.style.display = 'block';
          
          // Clear and disable comment field
          document.getElementById('editComment').value = '';
          document.getElementById('editComment').required = false;
          
          // Enable PLCR fields
          document.getElementById('editPlcrFactor').required = true;
          document.getElementById('editGross').required = false;
          
        } else {
          // PBCR/WASHERY uses comment (barrels per meter)
          commentFields.style.display = 'block';
          plcrFields.style.display = 'none';
          
          // Clear PLCR fields
          document.getElementById('editPlcrFactor').value = '';
          document.getElementById('editGross').value = '';
          document.getElementById('editPlcrFactor').required = false;
          document.getElementById('editGross').required = false;
          
          // Enable comment field
          document.getElementById('editComment').required = true;
        }
      });
      
      // Form submission
      document.getElementById('tankForm').addEventListener('submit', saveTank);
    }

    // Filter tanks
    function filterTanks() {
      const searchTerm = document.getElementById('tankSearch').value.toLowerCase();
      const deptFilter = document.getElementById('deptFilter').value;
      
      let filtered = allTanks;
      
      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(tank => 
          tank.id.toLowerCase().includes(searchTerm)
        );
      }
      
      // Filter by department
      if (deptFilter) {
        filtered = filtered.filter(tank => tank.department === deptFilter);
      }
      
      displayTanks(filtered);
    }

    // Add new tank
    function addNewTank() {
      editingTankId = null;
      editingDepartment = null;
      
      document.getElementById('modalTitle').textContent = 'Add New Tank';
      document.getElementById('tankForm').reset();
      
      // Enable tank ID field for new tank
      document.getElementById('editTankId').disabled = false;
      
      document.getElementById('tankModal').classList.add('show');
    }

    // Edit existing tank
    function editTank(tankId, department) {
      const tank = allTanks.find(t => t.id === tankId && t.department === department);
      if (!tank) {
        showMessage('‚ùå Tank not found', 'error');
        return;
      }
      
      editingTankId = tankId;
      editingDepartment = department;
      
      document.getElementById('modalTitle').textContent = `Edit Tank ${tankId}`;
      
      // Fill form with tank data
      document.getElementById('editTankId').value = tank.id;
      document.getElementById('editTankId').disabled = true; // Disable editing tank ID
      document.getElementById('editDepartment').value = tank.department;
      document.getElementById('editMinLevel').value = tank.min || 0;
      document.getElementById('editMaxLevel').value = tank.max || 0;
      
      // Fill department-specific fields
      const commentFields = document.getElementById('commentFields');
      const plcrFields = document.getElementById('plcrFields');
      
      if (tank.department === 'plcr') {
        // PLCR uses factor and gross capacity
        commentFields.style.display = 'none';
        plcrFields.style.display = 'block';
        
        // Clear comment and fill PLCR fields
        document.getElementById('editComment').value = '';
        document.getElementById('editComment').required = false;
        document.getElementById('editPlcrFactor').value = tank.factor || 0;
        document.getElementById('editPlcrFactor').required = true;
        document.getElementById('editGross').value = tank.gross || 0;
        
      } else {
        // PBCR/WASHERY uses comment (barrels per meter)
        commentFields.style.display = 'block';
        plcrFields.style.display = 'none';
        
        // Fill comment and clear PLCR fields
        document.getElementById('editComment').value = tank.comment || 0;
        document.getElementById('editComment').required = true;
        document.getElementById('editPlcrFactor').value = '';
        document.getElementById('editPlcrFactor').required = false;
        document.getElementById('editGross').value = '';
      }
      
      document.getElementById('tankModal').classList.add('show');
    }

    // Save tank data
    async function saveTank(event) {
      event.preventDefault();
      
      try {
        const formData = {
          tankId: document.getElementById('editTankId').value.trim(),
          department: document.getElementById('editDepartment').value,
          min: parseFloat(document.getElementById('editMinLevel').value),
          max: parseFloat(document.getElementById('editMaxLevel').value)
        };
        
        // Validation
        if (!formData.tankId || !formData.department) {
          showMessage('‚ùå Please fill all required fields', 'error');
          return;
        }
        
        if (formData.min >= formData.max) {
          showMessage('‚ùå Minimum level must be less than maximum level', 'error');
          return;
        }
        
        // Prepare tank data based on department
        let tankData = {
          min: formData.min,
          max: formData.max,
          lastModified: serverTimestamp(),
          modifiedBy: currentUser.username
        };
        
        if (formData.department === 'plcr') {
          // PLCR uses factor and gross capacity
          const plcrFactor = parseFloat(document.getElementById('editPlcrFactor').value);
          const grossCapacity = parseFloat(document.getElementById('editGross').value);
          
          if (isNaN(plcrFactor) || plcrFactor <= 0) {
            showMessage('‚ùå PLCR Factor is required and must be greater than 0', 'error');
            return;
          }
          
          tankData.factor = plcrFactor;
          tankData.gross = grossCapacity || 0;
          
        } else {
          // PBCR/WASHERY uses comment (barrels per meter)
          const commentValue = parseFloat(document.getElementById('editComment').value);
          
          if (isNaN(commentValue) || commentValue <= 0) {
            showMessage('‚ùå Comment (barrels per meter) is required and must be greater than 0', 'error');
            return;
          }
          
          tankData.comment = commentValue;
        }
        
        // Save to Firebase
        const docRef = doc(db, 'tankData', formData.department, 'tanks', formData.tankId);
        
        if (editingTankId && editingDepartment) {
          // Update existing tank
          await updateDoc(docRef, tankData);
          showMessage(`‚úÖ Tank ${formData.tankId} updated successfully!`, 'success');
        } else {
          // Create new tank
          await setDoc(docRef, tankData);
          showMessage(`‚úÖ Tank ${formData.tankId} added successfully!`, 'success');
        }
        
        // Close modal and refresh
        closeTankModal();
        await loadAllTanks();
        
        // Log activity
        await logActivity('tank_modified', currentUser.username, {
          tankId: formData.tankId,
          department: formData.department,
          action: editingTankId ? 'updated' : 'created'
        });
        
      } catch (error) {
        console.error('Error saving tank:', error);
        showMessage('‚ùå Error saving tank data: ' + error.message, 'error');
      }
    }

    // Delete tank
    async function deleteTank(tankId, department) {
      if (!confirm(`Are you sure you want to delete Tank ${tankId} from ${department.toUpperCase()} department?\n\nWarning: This action cannot be undone!`)) {
        return;
      }
      
      try {
        const docRef = doc(db, 'tankData', department, 'tanks', tankId);
        await deleteDoc(docRef);
        
        showMessage(`‚úÖ Tank ${tankId} deleted successfully!`, 'success');
        
        // Refresh tanks list
        await loadAllTanks();
        
        // Log activity
        await logActivity('tank_deleted', currentUser.username, {
          tankId: tankId,
          department: department
        });
        
      } catch (error) {
        console.error('Error deleting tank:', error);
        showMessage('‚ùå Error deleting tank: ' + error.message, 'error');
      }
    }

    // Close tank modal
    function closeTankModal() {
      document.getElementById('tankModal').classList.remove('show');
      document.getElementById('tankForm').reset();
      editingTankId = null;
      editingDepartment = null;
    }

    // Refresh tanks
    function refreshTanks() {
      loadAllTanks();
    }

    // Log activity
    async function logActivity(action, username, details = null) {
      try {
        await addDoc(collection(db, 'activities'), {
          action: action,
          username: username,
          timestamp: serverTimestamp(),
          ip: 'tank-management-page',
          userAgent: navigator.userAgent.substring(0, 100),
          page: 'tank-management',
          details: details
        });
      } catch (error) {
        console.error('Error logging activity:', error);
      }
    }

    // Show message
    function showMessage(text, type = 'info') {
      const container = document.getElementById('messageContainer');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${type}`;
      messageDiv.textContent = text;
      
      container.innerHTML = '';
      container.appendChild(messageDiv);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }

    // Logout function
    function logout() {
      if (confirm('Do you want to logout?')) {
        sessionStorage.clear();
        localStorage.clear();
        window.location.href = 'login.html';
      }
    }

    // Make functions globally available
    window.addNewTank = addNewTank;
    window.editTank = editTank;
    window.deleteTank = deleteTank;
    window.closeTankModal = closeTankModal;
    window.refreshTanks = refreshTanks;
    window.debugFirebaseStructure = debugFirebaseStructure;
    window.logout = logout;

    // Initialize when page loads
    window.addEventListener('load', initTankManagement);

  </script>

  <footer style="text-align:center;padding:20px;background:rgba(0,0,0,0.3);color:white;margin-top:30px">
    By <a href="#" style="color:#25D366;text-decoration:none;font-weight:bold" onclick="window.open('https://wa.me/96555222550','_blank'); return false;">Fahad - 17877</a> ‚Äì Tank Management v1.0
    <br><small style="color:#999;font-size:10px;margin-top:5px;display:block">üì± WhatsApp: +965 55222550</small>
  </footer>

</body>
</html>