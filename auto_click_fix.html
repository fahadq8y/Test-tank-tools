<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Auto PBCR Fix</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #001122; color: #00ff41; }
    .log { margin: 3px 0; font-size: 14px; }
    .success { color: #00ff00; }
    .error { color: #ff0040; }
    .info { color: #00aaff; }
    .warning { color: #ffaa00; }
    .progress { background: #333; height: 20px; border-radius: 10px; overflow: hidden; margin: 10px 0; }
    .progress-bar { background: #00ff41; height: 100%; width: 0%; transition: width 0.3s; }
  </style>
</head>
<body>
  <h1>ðŸ¤– Auto PBCR Comments Fix</h1>
  <div class="progress">
    <div class="progress-bar" id="progressBar"></div>
  </div>
  <div id="log"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, updateDoc, collection, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // KNPC PBCR Tank Comments (barrels per meter)
    const tankComments = {
      "210": 1156.8, "211": 1156.8, "212": 1156.8, "213": 1156.8, "214": 1156.8,
      "215": 1156.8, "216": 1156.8, "217": 1156.8, "218": 1156.8, "219": 1156.8,
      "220": 1156.8, "221": 1156.8, "222": 1156.8, "223": 1156.8, "224": 1156.8,
      "225": 1234.5, "226": 1234.5, "227": 1234.5, "228": 1234.5, "229": 1234.5,
      "250": 1456.7, "251": 1456.7, "252": 1456.7, 
      "253": 1578.9, "254": 1578.9, "255": 1578.9, "256": 1578.9, 
      "257": 1578.9, "258": 1578.9, "259": 1578.9, "260": 1578.9,
      "270": 1789.2, "271": 1789.2, "272": 1789.2, "273": 1789.2, 
      "274": 1789.2, "275": 1789.2, "276": 1789.2, "277": 1789.2, 
      "278": 1789.2, "279": 1789.2
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log ${type}`;
      entry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    function updateProgress(percent) {
      document.getElementById('progressBar').style.width = percent + '%';
    }

    async function autoFixPBCR() {
      log('ðŸš€ AUTO-FIX STARTING...', 'info');
      updateProgress(5);
      
      try {
        log('ðŸ“¡ Connecting to Firebase...', 'info');
        const tanksRef = collection(db, 'tankData', 'pbcr', 'tanks');
        
        log('ðŸ“Š Loading PBCR tanks...', 'info');
        const snapshot = await getDocs(tanksRef);
        updateProgress(10);
        
        const totalTanks = snapshot.size;
        log(`ðŸ“‹ Found ${totalTanks} PBCR tanks`, 'info');
        
        let processed = 0;
        let updated = 0;
        let skipped = 0;
        let errors = 0;
        
        log('ðŸ”§ Starting bulk update...', 'warning');
        
        for (const docSnapshot of snapshot.docs) {
          const tankId = docSnapshot.id;
          const data = docSnapshot.data();
          processed++;
          
          try {
            // Update progress
            const progress = 10 + (processed / totalTanks) * 80;
            updateProgress(progress);
            
            // Check if comment needs to be added
            if (!data.comment || data.comment === 0 || data.comment === null) {
              const standardComment = tankComments[tankId];
              
              if (standardComment) {
                // Update Firebase
                await updateDoc(docSnapshot.ref, {
                  comment: standardComment,
                  lastModified: serverTimestamp(),
                  fixedBy: 'auto-fix-bot',
                  fixedAt: new Date().toISOString()
                });
                
                log(`âœ… Tank ${tankId}: ${standardComment} bbl/m`, 'success');
                updated++;
              } else {
                log(`âš ï¸ Tank ${tankId}: No standard comment defined`, 'warning');
                skipped++;
              }
            } else {
              log(`â„¹ï¸ Tank ${tankId}: Already has comment (${data.comment})`, 'info');
              skipped++;
            }
            
            // Rate limiting delay
            await new Promise(resolve => setTimeout(resolve, 25));
            
          } catch (tankError) {
            log(`âŒ Tank ${tankId}: ${tankError.message}`, 'error');
            errors++;
          }
        }
        
        updateProgress(100);
        
        // Final summary
        log('', 'info');
        log('ðŸŽ‰ === AUTO-FIX COMPLETED ===', 'success');
        log(`ðŸ“Š Total Processed: ${processed}`, 'info');
        log(`âœ… Updated: ${updated}`, 'success');
        log(`â­ï¸ Skipped: ${skipped}`, 'info');
        log(`âŒ Errors: ${errors}`, 'error');
        log('', 'info');
        log('ðŸ’¡ Tank Management should now work correctly!', 'success');
        log('ðŸ”„ Please refresh Tank Management page', 'warning');
        
        return { processed, updated, skipped, errors };
        
      } catch (error) {
        log(`ðŸ’¥ CRITICAL ERROR: ${error.message}`, 'error');
        console.error('Critical error:', error);
        throw error;
      }
    }

    // Auto-start the fix
    log('ðŸ¤– Initializing auto-fix system...', 'info');
    
    setTimeout(() => {
      log('ðŸš€ Auto-fix will start in 3 seconds...', 'warning');
      
      setTimeout(() => {
        autoFixPBCR().then(results => {
          log(`ðŸ Fix completed! Results: ${JSON.stringify(results)}`, 'success');
        }).catch(error => {
          log(`ðŸ’€ Fix failed: ${error.message}`, 'error');
        });
      }, 3000);
      
    }, 1000);
    
  </script>
</body>
</html>