<!DOCTYPE html>
<html>
<head>
    <title>Compare Working vs Broken Tanks</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; background: #1a1a1a; color: white; }
        .result { margin: 10px 0; padding: 15px; border-radius: 8px; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .info { background: #2d4a5a; }
        .warning { background: #5a4a2d; }
        .comparison { display: flex; gap: 20px; margin: 20px 0; }
        .working, .broken { flex: 1; padding: 20px; border-radius: 10px; }
        .working { background: #1a3d2e; border: 2px solid #4CAF50; }
        .broken { background: #3d1a1a; border: 2px solid #f44336; }
        .tank-data { background: #333; padding: 10px; border-radius: 5px; margin: 5px 0; font-family: monospace; font-size: 12px; }
        button { background: #4CAF50; color: white; border: none; padding: 15px 25px; margin: 10px; cursor: pointer; border-radius: 8px; }
        .analyze-btn { background: #2196F3; }
    </style>
</head>
<body>
    <h1>🔍 Compare Working vs Broken Tanks Data Structure</h1>
    
    <div class="info">
        <h3>🎯 الهدف:</h3>
        <p>مقارنة هيكل بيانات الخزانات الشغالة مع الخزانات المكسورة لمعرفة الفرق</p>
    </div>
    
    <button onclick="analyzeAllTanks()" class="analyze-btn">🔍 تحليل جميع الخزانات</button>
    <button onclick="compareDataStructure()" class="analyze-btn">📊 مقارنة هيكل البيانات</button>
    <button onclick="findMissingFields()" class="analyze-btn">🔎 البحث عن الحقول المفقودة</button>
    
    <div class="comparison">
        <div class="working">
            <h3>✅ الخزانات الشغالة</h3>
            <p>225, 226, 227, 463, 464, 831, 832</p>
            <div id="workingTanks"></div>
        </div>
        <div class="broken">
            <h3>❌ الخزانات المكسورة</h3>
            <p>221, 460, 462, 834, 833, 520, 521</p>
            <div id="brokenTanks"></div>
        </div>
    </div>
    
    <div id="analysis"></div>
    <div id="results"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, doc, getDoc, collection, getDocs
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
            authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
            projectId: "tank-tools-knpc-c2d95",
            storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
            messagingSenderId: "510062594324",
            appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const workingTanks = ['225', '226', '227', '463', '464', '831', '832'];
        const brokenTanks = ['221', '460', '462', '834', '833', '520', '521'];
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        function addTankData(containerId, tankId, data, status) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'tank-data';
            div.innerHTML = `
                <strong>Tank ${tankId} (${status}):</strong><br>
                ${JSON.stringify(data, null, 2)}
            `;
            container.appendChild(div);
        }
        
        async function getTankData(tankId) {
            try {
                const tankRef = doc(db, 'tankData', 'pbcr', 'tanks', tankId);
                const tankDoc = await getDoc(tankRef);
                
                if (tankDoc.exists()) {
                    return {
                        exists: true,
                        data: tankDoc.data()
                    };
                } else {
                    return {
                        exists: false,
                        data: null
                    };
                }
            } catch (error) {
                return {
                    exists: false,
                    error: error.message
                };
            }
        }
        
        window.analyzeAllTanks = async function() {
            document.getElementById('workingTanks').innerHTML = '';
            document.getElementById('brokenTanks').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            
            addResult('🔍 بدء تحليل جميع الخزانات...', 'info');
            
            // Analyze working tanks
            addResult('✅ تحليل الخزانات الشغالة...', 'success');
            for (const tankId of workingTanks) {
                const result = await getTankData(tankId);
                if (result.exists) {
                    addTankData('workingTanks', tankId, result.data, '✅ WORKING');
                    addResult(`✅ Tank ${tankId}: موجود وله بيانات`, 'success');
                } else {
                    addResult(`❌ Tank ${tankId}: غير موجود أو خطأ - ${result.error || 'Not found'}`, 'error');
                }
            }
            
            // Analyze broken tanks  
            addResult('❌ تحليل الخزانات المكسورة...', 'error');
            for (const tankId of brokenTanks) {
                const result = await getTankData(tankId);
                if (result.exists) {
                    addTankData('brokenTanks', tankId, result.data, '❌ BROKEN');
                    addResult(`❓ Tank ${tankId}: موجود لكن مكسور`, 'warning');
                } else {
                    addResult(`❌ Tank ${tankId}: غير موجود في Firebase - ${result.error || 'Not found'}`, 'error');
                }
            }
            
            addResult('🎉 تحليل الخزانات اكتمل!', 'success');
        };
        
        window.compareDataStructure = async function() {
            addResult('📊 مقارنة هيكل البيانات...', 'info');
            
            // Get sample data from working and broken tanks
            const workingSample = await getTankData(workingTanks[0]); // Tank 225
            const brokenSample = await getTankData(brokenTanks[0]);   // Tank 221
            
            if (workingSample.exists && brokenSample.exists) {
                const workingFields = Object.keys(workingSample.data);
                const brokenFields = Object.keys(brokenSample.data);
                
                addResult(`🔍 حقول الخزان الشغال (${workingTanks[0]}): ${workingFields.join(', ')}`, 'success');
                addResult(`🔍 حقول الخزان المكسور (${brokenTanks[0]}): ${brokenFields.join(', ')}`, 'error');
                
                // Find differences
                const onlyInWorking = workingFields.filter(f => !brokenFields.includes(f));
                const onlyInBroken = brokenFields.filter(f => !workingFields.includes(f));
                const common = workingFields.filter(f => brokenFields.includes(f));
                
                addResult(`✅ حقول مشتركة: ${common.join(', ')}`, 'info');
                if (onlyInWorking.length > 0) {
                    addResult(`➕ حقول موجودة فقط في الشغال: ${onlyInWorking.join(', ')}`, 'success');
                }
                if (onlyInBroken.length > 0) {
                    addResult(`➖ حقول موجودة فقط في المكسور: ${onlyInBroken.join(', ')}`, 'warning');
                }
                
            } else {
                addResult('❌ لا يمكن مقارنة البيانات - بعض الخزانات غير موجودة', 'error');
            }
        };
        
        window.findMissingFields = async function() {
            addResult('🔎 البحث عن الحقول المفقودة...', 'info');
            
            // Fields that Index.html expects
            const expectedFields = ['BPM', 'bmp', 'comment', 'Comment', 'capacity', 'min', 'Min', 'minimum', 'max', 'Max', 'maximum'];
            
            const analysis = {
                working: {},
                broken: {}
            };
            
            // Analyze working tanks
            for (const tankId of workingTanks.slice(0, 3)) { // Sample first 3
                const result = await getTankData(tankId);
                if (result.exists) {
                    analysis.working[tankId] = {
                        hasData: true,
                        fields: Object.keys(result.data),
                        values: {}
                    };
                    
                    // Check expected fields
                    expectedFields.forEach(field => {
                        analysis.working[tankId].values[field] = result.data[field] || 'MISSING';
                    });
                }
            }
            
            // Analyze broken tanks
            for (const tankId of brokenTanks.slice(0, 3)) { // Sample first 3
                const result = await getTankData(tankId);
                if (result.exists) {
                    analysis.broken[tankId] = {
                        hasData: true,
                        fields: Object.keys(result.data),
                        values: {}
                    };
                    
                    // Check expected fields
                    expectedFields.forEach(field => {
                        analysis.broken[tankId].values[field] = result.data[field] || 'MISSING';
                    });
                }
            }
            
            // Display analysis
            addResult('📋 تحليل الحقول المطلوبة:', 'info');
            
            addResult('✅ الخزانات الشغالة:', 'success');
            Object.entries(analysis.working).forEach(([tankId, data]) => {
                const bpmFields = expectedFields.slice(0, 5); // BPM related fields
                const levelFields = expectedFields.slice(5); // Min/Max related fields
                
                const hasBPM = bmpFields.some(f => data.values[f] !== 'MISSING');
                const hasLevels = levelFields.some(f => data.values[f] !== 'MISSING');
                
                addResult(`   Tank ${tankId}: BPM=${hasBPM ? '✅' : '❌'}, Levels=${hasLevels ? '✅' : '❌'}`, hasBPM && hasLevels ? 'success' : 'warning');
            });
            
            addResult('❌ الخزانات المكسورة:', 'error');
            Object.entries(analysis.broken).forEach(([tankId, data]) => {
                const bpmFields = expectedFields.slice(0, 5);
                const levelFields = expectedFields.slice(5);
                
                const hasBPM = bmpFields.some(f => data.values[f] !== 'MISSING');
                const hasLevels = levelFields.some(f => data.values[f] !== 'MISSING');
                
                addResult(`   Tank ${tankId}: BPM=${hasBPM ? '✅' : '❌'}, Levels=${hasLevels ? '✅' : '❌'}`, hasBPM && hasLevels ? 'success' : 'error');
            });
            
            // Show detailed analysis
            document.getElementById('analysis').innerHTML = `
                <div class="result info">
                    <h3>📊 تحليل تفصيلي:</h3>
                    <pre>${JSON.stringify(analysis, null, 2)}</pre>
                </div>
            `;
        };
        
        // Auto-run analysis
        setTimeout(() => {
            analyzeAllTanks();
        }, 1000);
    </script>
</body>
</html>