<!DOCTYPE html>
<html>
<head>
    <title>Compare Working vs Broken Tanks</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; background: #1a1a1a; color: white; }
        .result { margin: 10px 0; padding: 15px; border-radius: 8px; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .info { background: #2d4a5a; }
        .warning { background: #5a4a2d; }
        .comparison { display: flex; gap: 20px; margin: 20px 0; }
        .working, .broken { flex: 1; padding: 20px; border-radius: 10px; }
        .working { background: #1a3d2e; border: 2px solid #4CAF50; }
        .broken { background: #3d1a1a; border: 2px solid #f44336; }
        .tank-data { background: #333; padding: 10px; border-radius: 5px; margin: 5px 0; font-family: monospace; font-size: 12px; }
        button { background: #4CAF50; color: white; border: none; padding: 15px 25px; margin: 10px; cursor: pointer; border-radius: 8px; }
        .analyze-btn { background: #2196F3; }
    </style>
</head>
<body>
    <h1>ğŸ” Compare Working vs Broken Tanks Data Structure</h1>
    
    <div class="info">
        <h3>ğŸ¯ Ø§Ù„Ù‡Ø¯Ù:</h3>
        <p>Ù…Ù‚Ø§Ø±Ù†Ø© Ù‡ÙŠÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ø´ØºØ§Ù„Ø© Ù…Ø¹ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ³ÙˆØ±Ø© Ù„Ù…Ø¹Ø±ÙØ© Ø§Ù„ÙØ±Ù‚</p>
    </div>
    
    <button onclick="analyzeAllTanks()" class="analyze-btn">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª</button>
    <button onclick="compareDataStructure()" class="analyze-btn">ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <button onclick="findMissingFields()" class="analyze-btn">ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©</button>
    
    <div class="comparison">
        <div class="working">
            <h3>âœ… Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ø´ØºØ§Ù„Ø©</h3>
            <p>225, 226, 227, 463, 464, 831, 832</p>
            <div id="workingTanks"></div>
        </div>
        <div class="broken">
            <h3>âŒ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ³ÙˆØ±Ø©</h3>
            <p>221, 460, 462, 834, 833, 520, 521</p>
            <div id="brokenTanks"></div>
        </div>
    </div>
    
    <div id="analysis"></div>
    <div id="results"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, doc, getDoc, collection, getDocs
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        const firebaseConfig = {
            apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
            authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
            projectId: "tank-tools-knpc-c2d95",
            storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
            messagingSenderId: "510062594324",
            appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        const workingTanks = ['225', '226', '227', '463', '464', '831', '832'];
        const brokenTanks = ['221', '460', '462', '834', '833', '520', '521'];
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        function addTankData(containerId, tankId, data, status) {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = 'tank-data';
            div.innerHTML = `
                <strong>Tank ${tankId} (${status}):</strong><br>
                ${JSON.stringify(data, null, 2)}
            `;
            container.appendChild(div);
        }
        
        async function getTankData(tankId) {
            try {
                const tankRef = doc(db, 'tankData', 'pbcr', 'tanks', tankId);
                const tankDoc = await getDoc(tankRef);
                
                if (tankDoc.exists()) {
                    return {
                        exists: true,
                        data: tankDoc.data()
                    };
                } else {
                    return {
                        exists: false,
                        data: null
                    };
                }
            } catch (error) {
                return {
                    exists: false,
                    error: error.message
                };
            }
        }
        
        window.analyzeAllTanks = async function() {
            document.getElementById('workingTanks').innerHTML = '';
            document.getElementById('brokenTanks').innerHTML = '';
            document.getElementById('results').innerHTML = '';
            
            addResult('ğŸ” Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª...', 'info');
            
            // Analyze working tanks
            addResult('âœ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ø´ØºØ§Ù„Ø©...', 'success');
            for (const tankId of workingTanks) {
                const result = await getTankData(tankId);
                if (result.exists) {
                    addTankData('workingTanks', tankId, result.data, 'âœ… WORKING');
                    addResult(`âœ… Tank ${tankId}: Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ„Ù‡ Ø¨ÙŠØ§Ù†Ø§Øª`, 'success');
                } else {
                    addResult(`âŒ Tank ${tankId}: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ Ø®Ø·Ø£ - ${result.error || 'Not found'}`, 'error');
                }
            }
            
            // Analyze broken tanks  
            addResult('âŒ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ³ÙˆØ±Ø©...', 'error');
            for (const tankId of brokenTanks) {
                const result = await getTankData(tankId);
                if (result.exists) {
                    addTankData('brokenTanks', tankId, result.data, 'âŒ BROKEN');
                    addResult(`â“ Tank ${tankId}: Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† Ù…ÙƒØ³ÙˆØ±`, 'warning');
                } else {
                    addResult(`âŒ Tank ${tankId}: ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firebase - ${result.error || 'Not found'}`, 'error');
                }
            }
            
            addResult('ğŸ‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§ÙƒØªÙ…Ù„!', 'success');
        };
        
        window.compareDataStructure = async function() {
            addResult('ğŸ“Š Ù…Ù‚Ø§Ø±Ù†Ø© Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            
            // Get sample data from working and broken tanks
            const workingSample = await getTankData(workingTanks[0]); // Tank 225
            const brokenSample = await getTankData(brokenTanks[0]);   // Tank 221
            
            if (workingSample.exists && brokenSample.exists) {
                const workingFields = Object.keys(workingSample.data);
                const brokenFields = Object.keys(brokenSample.data);
                
                addResult(`ğŸ” Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ø´ØºØ§Ù„ (${workingTanks[0]}): ${workingFields.join(', ')}`, 'success');
                addResult(`ğŸ” Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ù…ÙƒØ³ÙˆØ± (${brokenTanks[0]}): ${brokenFields.join(', ')}`, 'error');
                
                // Find differences
                const onlyInWorking = workingFields.filter(f => !brokenFields.includes(f));
                const onlyInBroken = brokenFields.filter(f => !workingFields.includes(f));
                const common = workingFields.filter(f => brokenFields.includes(f));
                
                addResult(`âœ… Ø­Ù‚ÙˆÙ„ Ù…Ø´ØªØ±ÙƒØ©: ${common.join(', ')}`, 'info');
                if (onlyInWorking.length > 0) {
                    addResult(`â• Ø­Ù‚ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø´ØºØ§Ù„: ${onlyInWorking.join(', ')}`, 'success');
                }
                if (onlyInBroken.length > 0) {
                    addResult(`â– Ø­Ù‚ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…ÙƒØ³ÙˆØ±: ${onlyInBroken.join(', ')}`, 'warning');
                }
                
            } else {
                addResult('âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø¨Ø¹Ø¶ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', 'error');
            }
        };
        
        window.findMissingFields = async function() {
            addResult('ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©...', 'info');
            
            // Fields that Index.html expects
            const expectedFields = ['BPM', 'bmp', 'comment', 'Comment', 'capacity', 'min', 'Min', 'minimum', 'max', 'Max', 'maximum'];
            
            const analysis = {
                working: {},
                broken: {}
            };
            
            // Analyze working tanks
            for (const tankId of workingTanks.slice(0, 3)) { // Sample first 3
                const result = await getTankData(tankId);
                if (result.exists) {
                    analysis.working[tankId] = {
                        hasData: true,
                        fields: Object.keys(result.data),
                        values: {}
                    };
                    
                    // Check expected fields
                    expectedFields.forEach(field => {
                        analysis.working[tankId].values[field] = result.data[field] || 'MISSING';
                    });
                }
            }
            
            // Analyze broken tanks
            for (const tankId of brokenTanks.slice(0, 3)) { // Sample first 3
                const result = await getTankData(tankId);
                if (result.exists) {
                    analysis.broken[tankId] = {
                        hasData: true,
                        fields: Object.keys(result.data),
                        values: {}
                    };
                    
                    // Check expected fields
                    expectedFields.forEach(field => {
                        analysis.broken[tankId].values[field] = result.data[field] || 'MISSING';
                    });
                }
            }
            
            // Display analysis
            addResult('ğŸ“‹ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:', 'info');
            
            addResult('âœ… Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ø´ØºØ§Ù„Ø©:', 'success');
            Object.entries(analysis.working).forEach(([tankId, data]) => {
                const bpmFields = expectedFields.slice(0, 5); // BPM related fields
                const levelFields = expectedFields.slice(5); // Min/Max related fields
                
                const hasBPM = bmpFields.some(f => data.values[f] !== 'MISSING');
                const hasLevels = levelFields.some(f => data.values[f] !== 'MISSING');
                
                addResult(`   Tank ${tankId}: BPM=${hasBPM ? 'âœ…' : 'âŒ'}, Levels=${hasLevels ? 'âœ…' : 'âŒ'}`, hasBPM && hasLevels ? 'success' : 'warning');
            });
            
            addResult('âŒ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ù…ÙƒØ³ÙˆØ±Ø©:', 'error');
            Object.entries(analysis.broken).forEach(([tankId, data]) => {
                const bpmFields = expectedFields.slice(0, 5);
                const levelFields = expectedFields.slice(5);
                
                const hasBPM = bmpFields.some(f => data.values[f] !== 'MISSING');
                const hasLevels = levelFields.some(f => data.values[f] !== 'MISSING');
                
                addResult(`   Tank ${tankId}: BPM=${hasBPM ? 'âœ…' : 'âŒ'}, Levels=${hasLevels ? 'âœ…' : 'âŒ'}`, hasBPM && hasLevels ? 'success' : 'error');
            });
            
            // Show detailed analysis
            document.getElementById('analysis').innerHTML = `
                <div class="result info">
                    <h3>ğŸ“Š ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ:</h3>
                    <pre>${JSON.stringify(analysis, null, 2)}</pre>
                </div>
            `;
        };
        
        // Auto-run analysis
        setTimeout(() => {
            analyzeAllTanks();
        }, 1000);
    </script>
</body>
</html>