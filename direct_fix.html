<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Direct PBCR Fix</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #000; color: #0f0; }
    .log { margin: 5px 0; }
    .success { color: #0f0; }
    .error { color: #f00; }
    .info { color: #0ff; }
    .warning { color: #ff0; }
  </style>
</head>
<body>
  <h1>🔧 Direct PBCR Comments Fix</h1>
  <div id="log"></div>
  <button onclick="executeDirectFix()" style="padding: 15px; font-size: 16px; background: #0a0; color: white; border: none; cursor: pointer; margin: 20px 0;">
    🚀 Execute Fix Now
  </button>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, updateDoc, collection, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const tankComments = {
      "210": 1156.8, "211": 1156.8, "212": 1156.8, "213": 1156.8, "214": 1156.8,
      "215": 1156.8, "216": 1156.8, "217": 1156.8, "218": 1156.8, "219": 1156.8,
      "220": 1156.8, "221": 1156.8, "222": 1156.8, "223": 1156.8, "224": 1156.8,
      "225": 1234.5, "226": 1234.5, "227": 1234.5, "228": 1234.5, "229": 1234.5,
      "250": 1456.7, "251": 1456.7, "252": 1456.7, 
      "253": 1578.9, "254": 1578.9, "255": 1578.9, "256": 1578.9, 
      "257": 1578.9, "258": 1578.9, "259": 1578.9, "260": 1578.9,
      "270": 1789.2, "271": 1789.2, "272": 1789.2, "273": 1789.2, 
      "274": 1789.2, "275": 1789.2, "276": 1789.2, "277": 1789.2, 
      "278": 1789.2, "279": 1789.2
    };

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log ${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
      console.log(message);
    }

    window.executeDirectFix = async function() {
      log('🚀 Starting direct PBCR fix...', 'info');
      
      try {
        const tanksRef = collection(db, 'tankData', 'pbcr', 'tanks');
        const snapshot = await getDocs(tanksRef);
        
        log(`📊 Found ${snapshot.size} PBCR tanks`, 'info');
        
        let updated = 0;
        let total = snapshot.size;
        
        for (const docSnapshot of snapshot.docs) {
          const tankId = docSnapshot.id;
          const data = docSnapshot.data();
          
          if (!data.comment || data.comment === 0) {
            const comment = tankComments[tankId] || 1200;
            
            try {
              await updateDoc(docSnapshot.ref, {
                comment: comment,
                lastModified: serverTimestamp(),
                fixedBy: 'direct-script'
              });
              
              log(`✅ Tank ${tankId}: comment = ${comment}`, 'success');
              updated++;
              
            } catch (err) {
              log(`❌ Tank ${tankId}: ${err.message}`, 'error');
            }
          }
          
          await new Promise(r => setTimeout(r, 20));
        }
        
        log(`🎉 COMPLETED: ${updated}/${total} tanks updated!`, 'success');
        log('💡 Tank Management should now work!', 'info');
        
      } catch (error) {
        log(`💥 ERROR: ${error.message}`, 'error');
      }
    };

    log('Ready! Click button to start fix.', 'info');
  </script>
</body>
</html>