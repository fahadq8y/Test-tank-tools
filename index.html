<!DOCTYPE html>
<!-- PBCR Calculator v8.8 - Professional Avatar Design -->
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>PBCR & WASHERY</title>
<link href="icon.png" rel="icon" type="image/png"/>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#B8860B">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tank Tools">
<link rel="apple-touch-icon" href="icon.png">
<script src="permissions.js"></script>
<script src="session-manager.js"></script>
<script src="last-page-tracker.js"></script>
<script src="navbar-component.js"></script>
<script src="footer-component.js"></script>
<style>
/* === CSS Variables & Themes === */
/* === Mobile Safe Areas === */
:root{--safe-area-inset-top:env(safe-area-inset-top);--safe-area-inset-right:env(safe-area-inset-right);--safe-area-inset-bottom:env(safe-area-inset-bottom);--safe-area-inset-left:env(safe-area-inset-left)}
:root{--primary:#B8860B;--secondary:#8B4513;--accent:#CD853F;--text:#FFD700}
[data-theme="ocean"]{--primary:#1e3a5f;--secondary:#2c5f8d;--accent:#4a90c4;--text:#87CEEB}
[data-theme="dark"]{--primary:#2c2c2c;--secondary:#1a1a1a;--accent:#ff6b35;--text:#ff6b35}
[data-theme="sunset"]{--primary:#ff6b35;--secondary:#f7931e;--accent:#ffd700;--text:#ffd700}
[data-theme="forest"]{--primary:#2d5016;--secondary:#4a7c59;--accent:#6b9b37;--text:#90EE90}
.theme-switcher{position:relative;display:inline-block}
.theme-btn{background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.3);color:white;padding:10px 15px;border-radius:8px;cursor:pointer;font-size:20px;transition:all 0.3s ease;min-width:48px;min-height:48px;display:flex;align-items:center;justify-content:center}
.theme-btn:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
.theme-dropdown{display:none;position:absolute;top:100%;right:0;margin-top:5px;background:rgba(0,0,0,0.9);border-radius:8px;min-width:180px;box-shadow:0 4px 12px rgba(0,0,0,0.3);z-index:1000}
.theme-dropdown.show{display:block;animation:slideDown 0.3s ease}
.theme-option{padding:10px 15px;cursor:pointer;color:white;transition:all 0.2s ease;border-bottom:1px solid rgba(255,255,255,0.1)}
.theme-option:last-child{border-bottom:none}
.theme-option:hover{background:rgba(255,255,255,0.1)}
.theme-option.active{background:var(--primary);font-weight:bold}
/* === Animations === */
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes glow{0%,100%{text-shadow:0 0 10px var(--text)}50%{text-shadow:0 0 20px var(--text),0 0 30px var(--text)}}
@keyframes modalFadeIn{from{opacity:0;transform:scale(0.9) translateY(-20px)}to{opacity:1;transform:scale(1) translateY(0)}}
/* === Theme Transitions === */
:root{transition:background-color 0.3s ease,color 0.3s ease}
*{transition:background-color 0.3s ease,color 0.3s ease,border-color 0.3s ease,box-shadow 0.3s ease}
/* === Original CSS === */
*{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;padding-top:calc(20px + var(--safe-area-inset-top));padding-right:calc(20px + var(--safe-area-inset-right));padding-bottom:calc(20px + var(--safe-area-inset-bottom));padding-left:calc(20px + var(--safe-area-inset-left));min-height:100vh}
/* Navigation Bar */
    .nav-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid var(--primary);
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
      position: relative;
      z-index: 1000;
    }
    
    .nav-logo {
      font-size: 24px;
      font-weight: bold;
      color: var(--primary);
    }
    
    .nav-links {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .nav-link {
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.1);
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 14px;
    }
    
    .nav-link:hover {
      background: var(--primary);
      transform: translateY(-1px);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    /* Font Controls */
    .font-controls {
      display: flex;
      gap: 5px;
    }
    
    .font-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: white;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s ease;
      min-width: 32px;
      min-height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .font-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-1px);
    }
    
    /* User Avatar */
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(45deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      color: white;
      border: 2px solid var(--accent);
    }
    
    .user-name {
      background: rgba(255,255,255,0.1);
      padding: 6px 12px;
      border-radius: 5px;
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 14px;
    }
    
    .logout-btn {
      background: rgba(255,0,0,0.3);
      color: white;
      border: 1px solid rgba(255,0,0,0.5);
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .logout-btn:hover {
      background: rgba(255,0,0,0.5);
      transform: translateY(-2px);
    }
input,select{background:rgba(255,255,255,0.9);border-radius:12px;border:none;color:#003366;box-shadow:0 2px 5px rgba(0,0,0,0.3);font-size:16px;margin:10px;padding:12px;width:250px;text-align:center;min-height:44px}
.row{display:flex;justify-content:center;align-items:center;gap:8px;margin:10px 0;max-width:400px;margin-left:auto;margin-right:auto}
.row input,.row select{margin:0;flex:1;width:50%}
.result{margin-top:10px;font-weight:bold;color:var(--text);text-align:center;text-shadow:0 0 10px var(--text);animation:glow 2s ease-in-out infinite}
#tankTable{margin:20px auto;background:rgba(255,255,255,0.95);color:#003366;border-collapse:separate;border-spacing:0;border-radius:15px;overflow:hidden;min-width:90%;max-width:600px;box-shadow:0 8px 25px rgba(0,0,0,0.3);backdrop-filter:blur(10px)}
#tankTable th{padding:15px 10px;background:var(--primary);color:white;font-weight:600;text-align:center;border-bottom:none;font-size:14px;border:2px solid var(--accent)}
#tankTable td{padding:12px 10px;text-align:center;border-bottom:1px solid rgba(0,0,0,0.1);font-weight:500}
#tankTable tr:last-child td{border-bottom:none}
#tankTable tr:nth-child(even){background:rgba(0,0,0,0.05)}
#tankTable tr.same-shift{background:rgba(255,0,0,0.1)!important;color:#d32f2f}
#tankTable tr.next-shift{background:rgba(76,175,80,0.1)!important;color:#388e3c}
#tankTable .delete-btn{background:linear-gradient(45deg,#f44336,#d32f2f);color:white;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;font-size:12px;transition:all 0.3s ease}
#tankTable .delete-btn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(244,67,54,0.3)}

.main-container{max-width:600px;margin:20px auto;padding:30px;background:rgba(0,0,0,0.3);border-radius:20px;backdrop-filter:blur(10px);border:2px solid var(--accent);box-shadow:0 8px 32px rgba(0,0,0,0.5);animation:fadeIn 0.5s ease}
.buttons-section{margin:20px 0;padding:0;background:transparent;border-radius:0;backdrop-filter:none}
.button-row{display:flex;align-items:center;justify-content:center;gap:10px;margin:8px 0;max-width:450px;margin-left:auto;margin-right:auto}
.action-btn{padding:12px 24px;font-size:16px;font-weight:600;border:none;border-radius:12px;cursor:pointer;transition:all 0.3s ease;display:inline-flex;align-items:center;gap:8px;flex:1;min-height:48px;justify-content:center;margin:0}
.live-tanks-btn{background:var(--primary);color:white;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid var(--accent);flex:1}
.reminder-btn{background:var(--secondary);color:white;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid var(--accent);flex:1}
.table-btn{background:var(--accent);color:white;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid var(--text);flex:1}
.action-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
.button-row a{flex:1;text-decoration:none}
.button-row a .action-btn{width:100%}
.help-btn{background:var(--accent);color:white;border:2px solid var(--text);padding:0;border-radius:50%;cursor:pointer;font-size:16px;transition:all 0.3s ease;display:inline-flex;align-items:center;justify-content:center;width:44px;height:44px;min-width:44px;min-height:44px;box-shadow:0 2px 6px rgba(0,0,0,0.3);flex-shrink:0}
.help-btn:hover{transform:translateY(-2px) scale(1.1);box-shadow:0 4px 10px rgba(255,152,0,0.4)}
.buttons-container{display:flex;justify-content:center;gap:10px;flex-wrap:wrap;align-items:center;margin-top:15px}
.action-button{position:fixed;width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,0.3);border:none;font-size:20px;color:white;cursor:pointer;display:flex;align-items:center;justify-content:center;top:10px;right:10px}
.access-denied{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(rgba(0,0,0,0.8),rgba(0,0,0,0.8)),url('background.jpg');background-size:cover;background-position:center;display:flex;justify-content:center;align-items:center;z-index:9999}
.access-denied-content{text-align:center;background:rgba(255,255,255,0.1);padding:40px;border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2)}
.access-denied-icon{font-size:5rem;color:#f44336;margin-bottom:20px}
.access-denied-title{font-size:2rem;color:#f44336;margin-bottom:15px}
.access-denied-text{font-size:1.2rem;margin-bottom:20px;opacity:0.8}
.login-btn{padding:12px 25px;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;border:none;border-radius:10px;cursor:pointer;font-size:16px}
.lt-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);z-index:1000;backdrop-filter:blur(10px)}
.lt-modal.show{display:flex;justify-content:center;align-items:center}
.lt-modal-content{background:rgba(0,0,0,0.95);padding:20px;border-radius:15px;max-width:500px;width:90%;color:white;border:3px solid var(--accent);box-shadow:0 10px 40px rgba(0,0,0,0.5),0 0 20px var(--accent);backdrop-filter:blur(20px);animation:modalFadeIn 0.3s ease;position:relative}
.lt-modal-content h3{color:var(--text);font-size:20px;margin-bottom:15px;padding-bottom:10px;border-bottom:2px solid var(--accent);text-shadow:0 0 10px var(--text);display:flex;align-items:center;gap:10px}
.close-btn{background:var(--accent);border:2px solid var(--text);font-size:24px;cursor:pointer;color:white;font-weight:bold;width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;position:absolute;top:15px;right:15px;transition:all 0.3s ease}.close-btn:hover{transform:rotate(90deg) scale(1.1);background:var(--text);color:#000}
.form-group{margin-bottom:10px}
.form-row{margin-bottom:10px}
.form-label{display:block;margin-bottom:5px;font-weight:600;color:var(--text);font-size:13px;text-shadow:0 0 5px var(--text)}
.form-input,.form-select{width:100%;padding:10px;border:2px solid var(--accent);border-radius:8px;font-size:13px;background:rgba(255,255,255,0.1);color:white;transition:all 0.3s ease}.form-input:focus,.form-select:focus{outline:none;border-color:var(--text);background:rgba(255,255,255,0.15);box-shadow:0 0 10px var(--accent)}
.form-select option{background:#1a1a1a;color:white;padding:10px}
.form-input[readonly]{background:rgba(255,255,255,0.2);cursor:not-allowed;opacity:1;color:white;font-weight:600;text-shadow:0 0 5px rgba(255,255,255,0.5)}
.form-textarea{width:100%;padding:10px;border:2px solid var(--accent);border-radius:8px;font-size:13px;min-height:60px;background:rgba(255,255,255,0.1);color:white;transition:all 0.3s ease;resize:vertical}.form-textarea:focus{outline:none;border-color:var(--text);background:rgba(255,255,255,0.15);box-shadow:0 0 10px var(--accent)}
.btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;display:inline-flex;align-items:center;gap:6px;transition:all 0.3s ease;min-height:40px}
.btn-primary{background:var(--primary);color:white;border:2px solid var(--accent);box-shadow:0 4px 12px rgba(0,0,0,0.3)}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(0,0,0,0.4);background:var(--secondary)}
.btn-secondary{background:rgba(255,255,255,0.1);color:white;border:2px solid var(--accent)}.btn-secondary:hover{background:rgba(255,255,255,0.2);transform:translateY(-2px)}
.modal-buttons{display:flex;gap:10px;justify-content:flex-end;margin-top:20px}
.other-product-field{display:none;margin-top:10px}
.other-product-field.show{display:block}
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);display:flex;justify-content:center;align-items:center;z-index:10000;flex-direction:column;gap:15px}
.loading-spinner{width:50px;height:50px;border:5px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
/* Media Queries */
    @media (max-width: 768px) {
      .nav-bar {
        padding: 10px 15px;
      }
      
      .nav-logo {
        font-size: 18px;
      }
      
      .nav-links {
        flex-wrap: wrap;
        gap: 5px;
        justify-content: center;
      }
      
      .nav-link {
        padding: 6px 10px;
        font-size: 12px;
      }
    }
    
    @media (max-width: 480px) {
      .nav-bar {
        padding: 8px 10px;
      }
      
      .nav-logo {
        font-size: 14px;
      }
      
      .nav-link {
        padding: 4px 6px;
        font-size: 10px;
      }
      
      .font-btn {
        min-width: 28px;
        min-height: 28px;
        padding: 4px 8px;
        font-size: 14px;
      }
    }

@media (max-width:600px){input,select{width:90%!important}.row{max-width:350px}.buttons-container{flex-direction:column}.live-tanks-btn{width:90%}.lt-modal-content{padding:15px;max-width:350px}.form-group{margin-bottom:12px}.form-row{margin-bottom:12px}.form-label{font-size:12px}.form-input,.form-select{padding:8px;font-size:12px}.btn{padding:8px 16px;font-size:12px}.modal-buttons{gap:8px;margin-top:15px}}
</style>
</head>
<body>
<div id="loadingOverlay" class="loading-overlay">
<div class="loading-spinner"></div>
<p>Loading Tank Data...</p>
</div>
<div id="accessDenied" class="access-denied" style="display:none">
<div class="access-denied-content">
<div class="access-denied-icon">üîí</div>
<div class="access-denied-title">Login Required</div>
<div class="access-denied-text">You need to login to access PBCR & WASHERY application.</div>
<button class="login-btn" onclick="goToLogin()">Go to Login</button>
</div>
</div>
<div id="mainContent" style="display:none;">
<!-- Navigation Bar (Component) -->
  <div id="navbar-container"></div>
<h2 style="text-align:center">PBCR & WASHERY</h2>
<div class="main-container">
<div class="row">
<input id="tankInput" oninput="loadTank()" placeholder="Enter Tank Number" type="number"/>
<input id="level" oninput="calculate()" placeholder="Current Level (m)" type="number"/>
</div>
<div class="result" id="availablePumpable"></div>
<div class="result" id="currentUllage"></div>
<div class="row">
<input id="target" oninput="calculate()" placeholder="Target Value" type="number"/>
<select id="mode" onchange="calculate()">
<option value="pumpable">Pumpable</option>
<option value="ullage">Ullage</option>
<option value="level">Level</option>
</select>
</div>
<div class="result" id="valueDiff"></div>
<div class="result" id="levelEstimate"></div>
<div class="row">
<input id="flowrate" oninput="calculate()" placeholder="Flowrate" type="number"/>
<select id="flowUnit" onchange="calculate()">
<option value="bbl">bbl/hr</option>
<option value="m3">m¬≥/hr</option>
<option value="mtr">meter/hr</option>
</select>
</div>
<div class="result" id="output"></div>
<div class="buttons-section">
<div class="button-row">
<button onclick="openLTModal()" class="action-btn live-tanks-btn" id="add-to-live-tanks-btn" style="display:none">üî¥ Add to Live Tanks</button>
<button onclick="showLiveTanksHelp()" class="help-btn" id="add-to-live-tanks-help" title="About Live Tanks" style="display:inline-flex">‚ÑπÔ∏è</button>
</div>
<div class="button-row">
<a href="#" id="calendarLink" target="_blank">
<button class="action-btn reminder-btn">üìÖ Add Reminder</button>
</a>
<button onclick="showCalendarHelp()" class="help-btn" title="How to use Calendar Reminder">‚ÑπÔ∏è</button>
</div>
<div class="button-row">
<button onclick="addToTable()" class="action-btn table-btn">üìä Add to Table</button>
<button onclick="showTableHelp()" class="help-btn" title="About Personal Table">‚ÑπÔ∏è</button>
</div>
</div>
<h3 style="margin-top:40px">Your tanks finishing in current shift:</h3>
<table id="tankTable">
<thead><tr><th>Tank Number</th><th>Finish Date</th><th>Finish Time</th><th>Delete</th></tr></thead>
<tbody></tbody>
</table>
</div>
<button id="darkModeButton" class="action-button" title="Dark Mode">üåô</button>
</div>
<div id="ltModal" class="lt-modal">
<div class="lt-modal-content">
<button class="close-btn" onclick="closeLTModal()">&times;</button>
<h3>üî¥ Add to Live Tanks</h3>
<form id="ltForm">
<div class="form-group">
<label class="form-label">üè≠ Department:</label>
<select class="form-select" id="ltDept" onchange="updateLTProducts()" required>
<option value="">Select Department</option>
<option value="PBCR">PBCR</option>
<option value="WASHERY">WASHERY</option>
<option value="PLCR">PLCR</option>
</select>
</div>
<div class="form-row" style="display:flex;gap:10px">
<div class="form-group" style="flex:1">
<label class="form-label">üè∑Ô∏è Tank Number:</label>
<input type="text" class="form-input" id="ltTank" readonly>
</div>
<div class="form-group" style="flex:1">
<label class="form-label">üõ¢Ô∏è Product Type:</label>
<select class="form-select" id="ltProduct" onchange="checkOtherProduct()" required>
<option value="">Select Product</option>
</select>
</div>
</div>
<div class="form-group other-product-field" id="otherProductField">
<label class="form-label">üìù Specify Product (OTHER):</label>
<input type="text" class="form-input" id="otherProductInput" placeholder="Enter product name">
</div>
<div class="form-row" style="display:flex;gap:10px">
<div class="form-group" style="flex:1">
<label class="form-label">üìä Target Value:</label>
<input type="number" step="any" class="form-input" id="ltTargetValue" placeholder="Enter target value" required>
</div>
<div class="form-group" style="flex:1">
<label class="form-label">üéØ Target Type:</label>
<select class="form-select" id="ltTargetType" required>
<option value="">Select Target Type</option>
<option value="pumpable">Pumpable</option>
<option value="ullage">Ullage</option>
<option value="level">Level</option>
</select>
</div>
</div>
<div class="form-row" style="display:flex;gap:10px">
<div class="form-group" style="flex:1">
<label class="form-label">‚ö° Flow Rate:</label>
<input type="number" step="any" class="form-input" id="ltRate" placeholder="Rate" required>
</div>
<div class="form-group" style="flex:1">
<label class="form-label">üìè Rate Unit:</label>
<select class="form-select" id="ltRateUnit" required>
<option value="bbl">bbl/hr</option>
<option value="m3">m¬≥/hr</option>
<option value="mtr">meter/hr</option>
</select>
</div>
</div>
<div class="form-row" style="display:flex;gap:10px">
<div class="form-group" style="flex:1">
<label class="form-label">üìÖ Finish Date:</label>
<input type="text" class="form-input" id="ltDate" readonly>
</div>
<div class="form-group" style="flex:1">
<label class="form-label">‚è∞ Finish Time:</label>
<input type="text" class="form-input" id="ltTime" readonly>
</div>
</div>
<div class="form-group">
<label class="form-label">üìù Notes (Optional):</label>
<textarea class="form-textarea" id="ltNotes" placeholder="Additional information..."></textarea>
</div>
<div class="modal-buttons">
<button type="button" class="btn btn-secondary" onclick="closeLTModal()">‚ùå Cancel</button>
<button type="submit" class="btn btn-primary">üíæ Add to Live Tanks</button>
</div>
</form>
</div>
</div>
<!-- Firebase Auth Handler -->
<script src="firebase-auth-handler.js" type="module"></script>
<script type="module">
import FirebaseAuthHandler from './firebase-auth-handler.js';
import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

// ‚úÖ Initialize Firebase Auth Handler
FirebaseAuthHandler.init({
  pageName: 'PBCR',
  redirectPage: 'dashboard.html',
  checkPermissions: true
});

// ‚úÖ Setup Firestore functions
window.setDoc = setDoc;
window.updateDoc = updateDoc;
window.addDoc = addDoc;
window.serverTimestamp = serverTimestamp;
window.collection = collection;
window.getDocs = getDocs;

console.log('%cüõ¢Ô∏è PBCR CALCULATOR v8.5 - Using Firebase Auth Handler', 'color:#B8860B;font-size:20px;font-weight:bold');
console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
</script>
<script>
let currentUser = null, c = 0, m = 0, x = 0, calcData = null;
let tankSpecsData = {};

const products={
  "PBCR":["LSFO","EGO 10PPM","EGO 500PPM","RHN","PCNA","NMOGAS","OLMOGAS","ATK","ARDR","IC5","ISOM","SLOP","OTHER"],
  "WASHERY":["MOGAS 98","MOGAS 95","MOGAS 91","GO","KERO","ATK","Slop","OTHER"],
  "PLCR":["NAPHA","PCNA","HSD-EGO","EGO","F.OIL","MOGAS","VGO","KKERO","ARDR","METHANOL","OTHER"]
};

async function fetchTankSpecifications() {
    const departments = ['pbcr']; // ‚úÖ FIXED: Load only PBCR to prevent data conflicts
    let allTanks = {};
    
    console.log('üîÑ Loading tank specifications from Firebase...');
    
    // Check if Firebase is ready
    if (!window.db || !window.collection || !window.getDocs) {
        console.error('‚ùå Firebase not initialized yet');
        throw new Error('Firebase not ready - please refresh the page');
    }
    try {
        for (const dept of departments) {
            console.log(`üìä Loading ${dept.toUpperCase()} tanks...`);
            const tanksCollectionRef = collection(window.db, "tankData", dept, "tanks");
            const querySnapshot = await getDocs(tanksCollectionRef);
            let deptCount = 0;
            querySnapshot.forEach((doc) => { 
                allTanks[doc.id] = doc.data(); 
                deptCount++;
            });
            console.log(`‚úÖ Loaded ${deptCount} tanks from ${dept.toUpperCase()}`);
        }
        if (Object.keys(allTanks).length === 0) { throw new Error("No tank specifications found."); }
        tankSpecsData = allTanks;
        console.log(`üéØ Successfully loaded ${Object.keys(allTanks).length} total tanks from Firebase!`);
        console.log('üìã Sample tank data:', Object.keys(allTanks).slice(0, 3).map(id => ({ id, data: allTanks[id] })));
        document.getElementById('loadingOverlay').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
    } catch (error) {
        console.error("‚ùå Critical error fetching tank specifications:", error);
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.innerHTML = `
                <div style="color:red; text-align: center; padding: 20px;">
                    <h3>‚ùå Failed to Load Tank Data</h3>
                    <p>Unable to connect to Firebase database.</p>
                    <p style="font-size: 14px; margin-top: 15px;">Error: ${error.message}</p>
                    <button onclick="location.reload()" style="
                        background: linear-gradient(45deg, #4CAF50, #45a049);
                        color: white; border: none; padding: 12px 24px;
                        border-radius: 8px; cursor: pointer; margin-top: 15px;
                        font-size: 16px; font-weight: bold;
                    ">üîÑ Retry</button>
                    <br><br>
                    <small style="opacity: 0.8;">If this problem persists, contact Fahad - 17877</small>
                </div>
            `;
        }
    }
}


window.loadTank = () => {
  const id = document.getElementById("tankInput").value.trim();
  if (tankSpecsData[id]) {
    c = tankSpecsData[id].comment;
    m = tankSpecsData[id].min;
    x = tankSpecsData[id].max;
  } else { c = m = x = 0; }
  calculate();
};

// --- ÿ®ÿØÿßŸäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸáŸÖ ---
async function checkLogin() {
    console.log('üîÑ Starting checkLogin process...');
    
    // ‚úÖ Simplified - Auth is handled by onAuthStateChanged above
    console.log('‚úÖ User already authenticated by Firebase Auth');
    
    // Get user data if available
    if (window.currentUser) {
        currentUser = window.currentUser;
        console.log('‚úÖ User data loaded:', currentUser.username || currentUser.email);
        if (typeof loadUser === 'function') {
            loadUser();
        }
    } else {
        console.log('‚úÖ Waiting for user data from Firebase Auth...');
    }
    
    // Load basic app functions (if available)
    if (typeof loadData === 'function') {
      loadData();
    }
    if (typeof setupDark === 'function') {
      setupDark();
    }
    
    // Load tank specifications with proper error handling
    console.log('üîÑ Starting tank data loading from Firebase...');
    console.log('Firebase state check:', {
        db: !!window.db,
        collection: !!window.collection,
        getDocs: !!window.getDocs
    });
    const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('Loading timeout - Firebase took too long')), 15000)
    );
    
    try {
        // Wait for tank data to load completely
        await Promise.race([fetchTankSpecifications(), timeoutPromise]);
        console.log('‚úÖ Tank data loaded successfully, PBCR ready to use!');
    } catch (error) {
        console.error('‚ùå Failed to load tank specifications:', error);
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.innerHTML = `
                <div style="color:red; text-align: center; padding: 20px;">
                    <h3>‚ùå Failed to Load Tank Data</h3>
                    <p>${error.message}</p>
                    <p style="font-size: 14px;">This usually means a slow internet connection or Firebase issue.</p>
                    <button onclick="location.reload()" style="
                        background: linear-gradient(45deg, #4CAF50, #45a049);
                        color: white; border: none; padding: 12px 24px;
                        border-radius: 8px; cursor: pointer; margin-top: 15px;
                        font-size: 16px; font-weight: bold;
                    ">üîÑ Try Again</button>
                    <br><br>
                    <small style="opacity: 0.8;">Contact Fahad - 17877 if this persists</small>
                </div>
            `;
        }
    }
}
// ŸÜÿ≥ÿ™ÿØÿπŸä checkLogin ÿπŸÜÿØ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©
window.addEventListener('load', () => {
    console.log('üèÅ Window loaded, starting checkLogin process...');
    setTimeout(checkLogin, 100);
});
// --- ŸÜŸáÿßŸäÿ© ÿßŸÑÿ™ÿπÿØŸäŸÑ ÿßŸÑŸÖŸáŸÖ ---


function loadUser(){if(!currentUser)return;document.getElementById('userName').textContent=currentUser.username;document.getElementById('userAvatar').textContent=(currentUser.fullName||currentUser.username).charAt(0).toUpperCase();if(currentUser.username==='fam030'||currentUser.role==='admin')document.getElementById('adminLink').style.display='inline-block';
  // checkLiveTanksAccess is now handled by permissions.js
}

window.calculate = () => {
  const level = parseFloat(document.getElementById("level").value || 0);
  const target = parseFloat(document.getElementById("target").value || 0);
  const flowRaw = parseFloat(document.getElementById("flowrate").value || 0);
  const unit = document.getElementById("flowUnit").value;
  const mode = document.getElementById("mode").value;
  
  const available = document.getElementById("availablePumpable");
  const ullageDiv = document.getElementById("currentUllage");
  const levelEst = document.getElementById("levelEstimate");
  const valueDiff = document.getElementById("valueDiff");
  const output = document.getElementById("output");
  const calendar = document.getElementById("calendarLink");
  
  calcData = null;
  document.getElementById('add-to-live-tanks-btn').style.display = 'none';
  
  if (!c || isNaN(level)) {
    available.innerText = ullageDiv.innerText = valueDiff.innerText = levelEst.innerText = output.innerHTML = "";
    return;
  }
  
  const availablePumpable = (level - m) * c;
  const currentUllage = (x - level) * c;
  available.innerText = `Available Pumpable: ${availablePumpable.toFixed(2)} bbl`;
  ullageDiv.innerText = `Current Ullage: ${currentUllage.toFixed(2)} bbl`;
  
  if (!isNaN(target)) {
    let estLevel = 0;
    if (mode === "pumpable") estLevel = (target / c) + m;
    else if (mode === "ullage") estLevel = x - (target / c);
    else if (mode === "level") estLevel = target;
    
    const levelDiff = estLevel - level;
    let estText = `Level Estimate: ${estLevel.toFixed(2)} m\nLevel Difference: ${levelDiff.toFixed(2)} m`;
    
    if (estLevel >= x - 0.5 || estLevel < m) {
      levelEst.style.color = "#ff5555";
      estText += `\nHigh Level = ${x.toFixed(2)} m`;
    } else {
      levelEst.style.color = "#00ffff";
    }
    levelEst.innerText = estText;
    
    let diff = 0;
    if (mode === "pumpable") {
      diff = target - availablePumpable;
      valueDiff.innerText = `Difference: ${diff.toLocaleString()} bbl`;
    } else if (mode === "ullage") {
      diff = currentUllage - target;
      valueDiff.innerText = `To leave ${target.toLocaleString()} bbl ullage, fill: ${diff.toLocaleString()} bbl`;
    } else if (mode === "level") {
      const meters = level - target;
      diff = meters * c;
      valueDiff.innerText = `Level Difference: ${Math.abs(meters).toFixed(2)} m`;
    }
    
    const flow = unit === "m3" ? flowRaw * 6.28 : unit === "mtr" ? flowRaw : flowRaw;
    let time = 0;
    
    if (unit === "mtr") {
      time = Math.abs(diff) / (flow * c);
    } else {
      time = Math.abs(diff) / flow;
    }
    
    const hrs = Math.floor(time);
    const mins = Math.round((time - hrs) * 60);
    
    if (!isNaN(time) && flow > 0) {
      const now = new Date();
      const finishTime = new Date(now.getTime() + time * 60 * 60 * 1000);
      
      const ft = finishTime.toLocaleTimeString('en-GB', {hour12: false}).substring(0, 5);
      const fd = finishTime.toLocaleDateString('en-CA');
      
      output.innerHTML = `<strong>Time: ${hrs}h ${mins}m</strong><br>Finish at: ${ft} - ${fd}`;
      calendar.href = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=Tank%20${encodeURIComponent(document.getElementById("tankInput").value)}%20Finish&dates=${finishTime.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${finishTime.toISOString().replace(/[-:]/g, '').split('.')[0]}Z&details=Tank%20Number:%20${encodeURIComponent(document.getElementById("tankInput").value)}%0ATarget%20Value:%20${encodeURIComponent(target)}%20${encodeURIComponent(mode)}%0AFlow%20Rate:%20${encodeURIComponent(flowRaw)}%20${encodeURIComponent(unit)}`;
      
      // üî• CRITICAL FIX: Set calcData for button functionality
      calcData = {
        tankNumber: document.getElementById("tankInput").value,
        finishTime: ft,
        finishDate: fd,
        currentLevel: level,
        targetValue: target,
        targetType: mode
      };
      
      // ‚úÖ Check Add to Live Tanks button permission after successful calculation
      if (window.checkAddToLiveTanksButtonAccess) {
        window.checkAddToLiveTanksButtonAccess('index.html').then(hasButtonAccess => {
          if (hasButtonAccess) {
            document.getElementById('add-to-live-tanks-btn').style.display = 'inline-flex';
            document.getElementById('add-to-live-tanks-help').style.display = 'inline-flex';
            console.log('‚úÖ Live Tanks button shown after permission check');
          } else {
            document.getElementById('add-to-live-tanks-btn').style.display = 'none';
            document.getElementById('add-to-live-tanks-help').style.display = 'none';
            console.log('‚ùå Live Tanks button hidden due to insufficient permissions');
          }
          console.log('üîò Button access for index.html:', hasButtonAccess);
        }).catch(error => {
          console.error('Error checking button access:', error);
          // ŸÅŸä ÿ≠ÿßŸÑÿ© ÿßŸÑÿÆÿ∑ÿ£ÿå ŸÜÿÆŸÅŸä ÿßŸÑÿ≤ÿ± ŸÑŸÑÿ£ŸÖÿßŸÜ
          document.getElementById('add-to-live-tanks-btn').style.display = 'none';
          document.getElementById('add-to-live-tanks-help').style.display = 'none';
        });
      } else {
        console.log('‚ö†Ô∏è checkAddToLiveTanksButtonAccess function not available, hiding button');
        document.getElementById('add-to-live-tanks-btn').style.display = 'none';
        document.getElementById('add-to-live-tanks-help').style.display = 'none';
      }
      
      // checkAddToLiveTanksPermission is now handled by permissions.js
      if (currentUser && document.getElementById("tankInput").value) {
        logPBCRCalculation(document.getElementById("tankInput").value, hrs, mins, ft, fd);
      }
    }
  }
};

function isSameShift(now,finish){const getShift=h=>{const m=h.getHours()*60+h.getMinutes();return m>=360&&m<840?"morning":m>=840&&m<1320?"evening":"night"};const currentShift=getShift(now),finishShift=getShift(finish);if(currentShift!==finishShift)return false;if(currentShift==="night"){const nowHour=now.getHours(),finishHour=finish.getHours();if(nowHour>=0&&nowHour<6){if(finishHour>=0&&finishHour<6)return Math.floor((finish.getTime()-now.getTime())/(24*60*60*1000))<=1;else if(finishHour>=22)return Math.floor((finish.getTime()-now.getTime())/(24*60*60*1000))===0}else if(nowHour>=22){if(finishHour>=22)return now.toDateString()===finish.toDateString();else if(finishHour>=0&&finishHour<6)return Math.floor((finish.getTime()-now.getTime())/(24*60*60*1000))===1}return false}return now.toDateString()===finish.toDateString()}
window.addToTable=()=>{if(!calcData||!calcData.tankNumber){alert("Please calculate a tank first!");return}const table=document.getElementById("tankTable").getElementsByTagName("tbody")[0],row=table.insertRow();const now=new Date();const finishDateTime=new Date(`${calcData.finishDate} ${calcData.finishTime}`);const sameShift=isSameShift(now,finishDateTime);row.className=sameShift?'same-shift':'next-shift';let directionArrow='';let directionColor='';if(calcData.currentLevel&&calcData.targetValue&&calcData.targetType){const currentLevel=parseFloat(calcData.currentLevel);const targetValue=parseFloat(calcData.targetValue);const targetType=calcData.targetType.toLowerCase();const tankNumber=calcData.tankNumber;const tankData=tankSpecsData[tankNumber];if(tankData){let currentValue=0;if(targetType==='pumpable'){const minLevel=tankData.min||0.5;const pumpableLevel=currentLevel-minLevel;currentValue=pumpableLevel*(tankData.comment||1);}else if(targetType==='ullage'){const maxLevel=tankData.max||0;const ullageLevel=maxLevel-currentLevel;currentValue=ullageLevel*(tankData.comment||1);}else if(targetType==='level'){currentValue=currentLevel;}if(targetType==='ullage'){if(currentValue>targetValue){directionArrow='‚ñ≤';directionColor='#4CAF50';}else if(currentValue<targetValue){directionArrow='‚ñº';directionColor='#f44336';}}else{if(currentValue<targetValue){directionArrow='‚ñ≤';directionColor='#4CAF50';}else if(currentValue>targetValue){directionArrow='‚ñº';directionColor='#f44336';}}}}const arrowSpan=directionArrow?`<span style="color:${directionColor};font-size:16px;margin-right:4px;">${directionArrow}</span>`:'';row.innerHTML=`<td>${arrowSpan}${calcData.tankNumber}</td><td>${calcData.finishDate}</td><td>${calcData.finishTime}</td><td><button class="delete-btn" onclick="this.parentNode.parentNode.remove();saveData()">Delete</button></td>`;saveData()};
function saveData(){const table=document.getElementById("tankTable").getElementsByTagName("tbody")[0],data=[];for(let i=0;i<table.rows.length;i++){const row=table.rows[i];data.push({tank:row.cells[0].innerText,date:row.cells[1].innerText,time:row.cells[2].innerText})}localStorage.setItem("tankData",JSON.stringify(data))}
function loadData(){const data=JSON.parse(localStorage.getItem("tankData")||"[]"),table=document.getElementById("tankTable").getElementsByTagName("tbody")[0];data.forEach(item=>{const row=table.insertRow();const now=new Date();const finishDateTime=new Date(`${item.date} ${item.time}`);const sameShift=isSameShift(now,finishDateTime);row.className=sameShift?'same-shift':'next-shift';row.innerHTML=`<td>${item.tank}</td><td>${item.date}</td><td>${item.time}</td><td><button class="delete-btn" onclick="this.parentNode.parentNode.remove();saveData()">Delete</button></td>`})}
function setupDark(){const btn=document.getElementById("darkModeButton");btn.addEventListener("click",()=>{document.body.style.filter=document.body.style.filter?"":"invert(1) hue-rotate(180deg)";btn.textContent=document.body.style.filter?"‚òÄÔ∏è":"üåô"})}
let currentFontSize=parseInt(localStorage.getItem('tanktools_font_size_index')||'16');
function increaseFontSize(){if(currentFontSize<24){currentFontSize+=2;applyFontSize();localStorage.setItem('tanktools_font_size_index',currentFontSize);showFontMessage(`üìà Font size increased to ${currentFontSize}px`);}}
function decreaseFontSize(){if(currentFontSize>12){currentFontSize-=2;applyFontSize();localStorage.setItem('tanktools_font_size_index',currentFontSize);showFontMessage(`üìâ Font size decreased to ${currentFontSize}px`);}}
function applyFontSize(){const style=document.createElement('style');style.id='dynamic-font-style';const existingStyle=document.getElementById('dynamic-font-style');if(existingStyle){existingStyle.remove();}
style.textContent=`
    input, select { font-size: ${currentFontSize}px !important; }
    .result { font-size: ${currentFontSize}px !important; }
    #tankTable { font-size: ${currentFontSize - 2}px !important; }
    #tankTable th { font-size: ${currentFontSize - 1}px !important; }
    h2 { font-size: ${currentFontSize + 8}px !important; }
    .reminder-btn, .add-btn, .live-tanks-btn { font-size: ${currentFontSize - 2}px !important; }
  `;document.head.appendChild(style);}
function showFontMessage(message){const msgDiv=document.createElement('div');msgDiv.style.cssText='position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease';msgDiv.textContent=message;document.body.appendChild(msgDiv);setTimeout(()=>msgDiv.remove(),3000);}
applyFontSize();
window.increaseFontSize=increaseFontSize;window.decreaseFontSize=decreaseFontSize;
function showCalendarHelp(){const userAgent=navigator.userAgent.toLowerCase();let platform='';let storeUrl='';if(/android/.test(userAgent)){platform='Android';storeUrl='https://play.google.com/store/apps/details?id=com.google.android.calendar';}else if(/iphone|ipad|ipod/.test(userAgent)){platform='iOS';storeUrl='https://apps.apple.com/app/google-calendar/id909319292';}else{platform='Web Browser';storeUrl='https://calendar.google.com/';}
const message=`1. Calculate your tank finish time<br>2. Click "üìÖ Add Reminder" button<br><br>For ${platform} users, if you don't have Google Calendar, you can download it.`;showCustomConfirm('üìÖ How to use Calendar Reminder:',message,storeUrl);}
window.showCalendarHelp=showCalendarHelp;
async function logPBCRCalculation(tankNumber,hours,minutes,finishTime,finishDate){if(!currentUser)return;try{const userIP=await fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(data=>data.ip).catch(()=>'Unknown');const timestamp=new Date();const detailedAction=`Calculated Tank ${tankNumber} in PBCR - Result: ${hours}h ${minutes}m (Finish: ${finishTime} - ${finishDate}) by ${currentUser.username}`;await addDoc(collection(db,'activities'),{action:detailedAction,originalAction:'pbcr_calculation',username:currentUser.username,tankNumber:tankNumber,calculationResult:`${hours}h ${minutes}m`,finishTime:finishTime,finishDate:finishDate,timestamp:serverTimestamp(),ip:userIP,userAgent:navigator.userAgent.substring(0,100),page:'pbcr-calculator'});}catch(error){console.error('Error logging PBCR calculation:',error);}}
function showLiveTanksHelp(){showCustomAlert('üî¥ Add to Live Tanks:','Adds your tank to the live monitoring system for all users to see. Requires panel operator or admin access.')}
function showTableHelp(){showCustomAlert('üìä Add to Table:','Adds tank to your personal table below. Only you can see this table.')}

// ‚úÖ FIXED: Add Live Tanks permission check function
async function checkAddToLiveTanksPermission() {
  try {
    console.log('üîê Checking Add to Live Tanks permission...');
    
    // Check if user is logged in
    if (!currentUser) {
      console.log('checkAddToLiveTanksPermission: No user logged in');
      return false;
    }
    
    // Check if calculation data exists
    if (!calcData || !calcData.tankNumber) {
      console.log('checkAddToLiveTanksPermission: No calculation data available');
      return false;
    }
    
    // Simple permission check - allow panel operators and admins
    const hasPermission = currentUser.role === 'admin' || 
                         currentUser.role === 'panel_operator' || 
                         currentUser.username === 'fam030';
    
    console.log('checkAddToLiveTanksPermission: Has permission:', hasPermission);
    return hasPermission;
    
  } catch (error) {
    console.error('Error checking Live Tanks permission:', error);
    return false;
  }
}

window.checkAddToLiveTanksPermission = checkAddToLiveTanksPermission;

// ‚úÖ FIXED: Add Live Tanks Modal functions
window.openLTModal = function() {
  if (!calcData || !calcData.tankNumber) {
    alert("Please calculate a tank first!");
    return;
  }
  
  document.getElementById('ltTank').value = calcData.tankNumber;
  document.getElementById('ltTargetValue').value = document.getElementById('target').value;
  document.getElementById('ltTargetType').value = document.getElementById('mode').value;
  document.getElementById('ltRate').value = document.getElementById('flowrate').value;
  document.getElementById('ltRateUnit').value = document.getElementById('flowUnit').value;
  document.getElementById('ltDate').value = calcData.finishDate;
  document.getElementById('ltTime').value = calcData.finishTime;
  document.getElementById('ltModal').classList.add('show');
};

window.closeLTModal = function() {
  document.getElementById('ltModal').classList.remove('show');
  document.getElementById('ltForm').reset();
  document.getElementById('otherProductField').classList.remove('show');
};

window.updateLTProducts = function() {
  const dept = document.getElementById('ltDept').value;
  const productSelect = document.getElementById('ltProduct');
  productSelect.innerHTML = '<option value="">Select Product</option>';
  
  if (dept && products[dept]) {
    products[dept].forEach(product => {
      const option = document.createElement('option');
      option.value = product;
      option.textContent = product;
      productSelect.appendChild(option);
    });
  }
  
  document.getElementById('otherProductField').classList.remove('show');
};

window.checkOtherProduct = function() {
  const productSelect = document.getElementById('ltProduct');
  const otherField = document.getElementById('otherProductField');
  const otherInput = document.getElementById('otherProductInput');
  
  if (productSelect.value === 'OTHER') {
    otherField.classList.add('show');
    otherInput.required = true;
  } else {
    otherField.classList.remove('show');
    otherInput.required = false;
    otherInput.value = '';
  }
};

// ‚úÖ FIXED: Added missing closing brace to balance JavaScript
// ‚úÖ Add missing functions
function loadData() {
  const data = JSON.parse(localStorage.getItem("tankData") || "[]");
  const table = document.getElementById("tankTable").getElementsByTagName("tbody")[0];
  data.forEach(item => {
    const row = table.insertRow();
    const now = new Date();
    const finishDateTime = new Date(`${item.date} ${item.time}`);
    const sameShift = isSameShift(now, finishDateTime);
    row.className = sameShift ? 'same-shift' : 'next-shift';
    row.innerHTML = `<td>${item.tank}</td><td>${item.date}</td><td>${item.time}</td><td><button class="delete-btn" onclick="this.parentNode.parentNode.remove();saveData()">Delete</button></td>`;
  });
}

function setupDark() {
  const btn = document.getElementById("darkModeButton");
  if (btn) {
    btn.addEventListener("click", () => {
      document.body.style.filter = document.body.style.filter ? "" : "invert(1) hue-rotate(180deg)";
      btn.textContent = document.body.style.filter ? "‚òÄÔ∏è" : "üåô";
    });
  }
}

window.showLiveTanksHelp=showLiveTanksHelp;window.showTableHelp=showTableHelp;

// ‚úÖ Add Live Tanks form submission handler  
document.addEventListener('DOMContentLoaded', function() {
  const ltForm = document.getElementById('ltForm');
  if (ltForm) {
    ltForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const dept = document.getElementById('ltDept').value;
      const tankNumber = document.getElementById('ltTank').value;
      const productSelect = document.getElementById('ltProduct').value;
      const otherProduct = document.getElementById('otherProductInput').value;
      const product = productSelect === 'OTHER' ? otherProduct : productSelect;
      const targetValue = document.getElementById('ltTargetValue').value;
      const targetType = document.getElementById('ltTargetType').value;
      const rate = document.getElementById('ltRate').value;
      const rateUnit = document.getElementById('ltRateUnit').value;
      const finishDate = document.getElementById('ltDate').value;
      const finishTime = document.getElementById('ltTime').value;
      const notes = document.getElementById('ltNotes').value;
      
      if (!product) {
        alert('Please select or specify a product.');
        return;
      }
      
      try {
        const finishDateTime = new Date(finishDate + ' ' + finishTime);
        // Check if user is logged in for permission
        if (!currentUser) {
          alert('‚ö†Ô∏è Please log in to add tanks to Live Tanks system.\n\nClick on any navigation link to go to login page.');
          return;
        }
        
        const tankData = {
          department: dept,
          tankNumber: tankNumber,
          product: product,
          currentLevel: parseFloat(document.getElementById('level').value) || null,
          targetType: targetType,
          targetValue: parseFloat(targetValue),
          rate: parseFloat(rate),
          rateUnit: rateUnit,
          finishDate: finishDate,
          finishTime: finishTime,
          finishDateTime: finishDateTime,
          notes: notes,
          addedBy: currentUser.username,
          userName: currentUser.fullName || currentUser.username,
          addedAt: serverTimestamp(),
          lastModified: serverTimestamp(),
          modifiedBy: currentUser.username,
          status: 'active',
          source: 'PBCR_Calculator'
        };
        
        await addDoc(collection(db, 'liveTanks'), tankData);
        alert('‚úÖ Tank added to Live Tanks successfully!');
        closeLTModal();
      } catch (error) {
        console.error('Error adding to Live Tanks:', error);
        alert('‚ùå Error adding to Live Tanks: ' + error.message);
      }
    });
  }
});


// === Theme Switching Functions ===
function setTheme(theme) {
  document.documentElement.setAttribute('data-theme', theme === 'industrial' ? '' : theme);
  localStorage.setItem('selectedTheme', theme);
  updateActiveTheme(theme);
  console.log('üé® Theme changed to:', theme);
  // Close dropdown
  const dropdown = document.getElementById('themeDropdown');
  if (dropdown) {
    dropdown.classList.remove('show');
  }
}

function toggleThemeDropdown() {
  const dropdown = document.getElementById('themeDropdown');
  if (dropdown) {
    dropdown.classList.toggle('show');
  }
}

function updateActiveTheme(theme) {
  document.querySelectorAll('.theme-option').forEach(opt => {
    opt.classList.remove('active');
    if (opt.getAttribute('data-theme') === theme) {
      opt.classList.add('active');
    }
  });
}

function loadSavedTheme() {
  const savedTheme = localStorage.getItem('selectedTheme') || 'industrial';
  setTheme(savedTheme);
  console.log('üé® Loaded saved theme:', savedTheme);
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
  const themeSwitcher = document.querySelector('.theme-switcher');
  if (themeSwitcher && !themeSwitcher.contains(event.target)) {
    document.getElementById('themeDropdown').classList.remove('show');
  }
});

// Load theme on page load
window.addEventListener('load', loadSavedTheme);

// Custom Alert Modal
function showCustomAlert(title, message) {
  const modal = document.createElement('div');
  modal.className = 'lt-modal show';
  modal.innerHTML = `
    <div class="lt-modal-content" style="max-width:400px;text-align:center">
      <button class="close-btn" onclick="this.closest('.lt-modal').remove()">&times;</button>
      <h3>${title}</h3>
      <p style="color:white;line-height:1.6;margin:20px 0">${message}</p>
      <button class="btn btn-primary" onclick="this.closest('.lt-modal').remove()">OK</button>
    </div>
  `;
  document.body.appendChild(modal);
}
window.showCustomAlert = showCustomAlert;

// Custom Confirm Modal
function showCustomConfirm(title, message, url) {
  const modal = document.createElement('div');
  modal.className = 'lt-modal show';
  modal.innerHTML = `
    <div class="lt-modal-content" style="max-width:450px;text-align:center">
      <button class="close-btn" onclick="this.closest('.lt-modal').remove()">&times;</button>
      <h3>${title}</h3>
      <p style="color:white;line-height:1.8;margin:20px 0;text-align:left">${message}</p>
      <div style="display:flex;gap:10px;justify-content:center;margin-top:25px">
        <button class="btn btn-secondary" onclick="this.closest('.lt-modal').remove()">Cancel</button>
        <button class="btn btn-primary" onclick="window.open('${url}','_blank');this.closest('.lt-modal').remove()">OK - Go to Store</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}
window.showCustomConfirm = showCustomConfirm;

// ========== LOGOUT ==========
function handleLogout() {
  if (confirm('ŸáŸÑ ÿ£ŸÜÿ™ ŸÖÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨ÿü')) {
    if (window.auth && window.auth.signOut) {
      window.auth.signOut().then(() => {
        localStorage.removeItem('tanktools_current_user');
        sessionStorage.removeItem('tanktools_session');
        window.location.href = 'login.html';
      });
    } else {
      localStorage.removeItem('tanktools_current_user');
      sessionStorage.removeItem('tanktools_session');
      window.location.href = 'login.html';
    }
  }
}

</script>
<!-- Footer (Component) -->
<div id="footer-container"></div>
<style>
footer{margin-top:40px;color:#ccc;text-align:center}
.whatsapp-link{color:#25D366;text-decoration:none;font-weight:bold;transition:all 0.3s ease;cursor:pointer}
.whatsapp-link:hover{color:#128C7E;text-shadow:0 0 5px rgba(37,211,102,0.5);transform:scale(1.05)}
/* === Mobile Responsive === */
@media(max-width:768px){body{padding:10px;padding-top:calc(10px + var(--safe-area-inset-top));padding-bottom:calc(10px + var(--safe-area-inset-bottom))}.main-container{padding:20px;margin:10px auto}.nav-link{padding:6px 12px;font-size:14px}input,select{width:100%;max-width:100%;font-size:16px}#tankTable{font-size:12px}#tankTable th,#tankTable td{padding:8px 5px}.theme-dropdown{right:auto;left:0}}
</style>
  <script src="pwa-install-banner.js"></script>
  
  <!-- Initialize Navbar & Footer Components -->
  <script>
    // Initialize Navbar
    const navbar = new NavbarComponent({
      title: 'üõ¢Ô∏è PBCR Calculator',
      version: '8.8',
      currentPage: 'pbcr-link',
      showNMOGAS: true
    });
    navbar.mount('#navbar-container');
    
    // Initialize Footer
    const footer = new FooterComponent({
      version: '8.8',
      developer: 'Fahad - 17877',
      whatsapp: '+965 55222550'
    });
    footer.mount('#footer-container');
    
    // Update navbar user info when currentUser is available
    const updateNavbarUser = setInterval(() => {
      if (window.currentUser) {
        navbar.updateUserInfo(window.currentUser);
        clearInterval(updateNavbarUser);
      }
    }, 100);
    
    console.log('‚úÖ PBCR v8.8 - Professional Avatar Design');
  </script>
</body>
</html>
