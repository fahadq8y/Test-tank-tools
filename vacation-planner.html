<!DOCTYPE html>
<!-- Vacation Planner v1.3 - Custom Date Picker + Test Mode -->
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ–ï¸ Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª - Vacation Planner</title>
  
  <!-- Permissions -->
  <script src="permissions.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      direction: rtl;
    }
    
    /* Navigation Bar */
    .nav-bar {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 15px 30px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .nav-logo {
      font-size: 24px;
      font-weight: bold;
      color: white;
    }
    
    .nav-links {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .nav-link {
      background: rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-name {
      color: white;
      font-weight: bold;
    }
    
    .logout-btn {
      background: rgba(255, 0, 0, 0.3);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .logout-btn:hover {
      background: rgba(255, 0, 0, 0.5);
    }
    
    /* Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    /* Card */
    .card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }
    
    .card-title {
      font-size: 28px;
      color: #667eea;
      margin-bottom: 20px;
      text-align: center;
    }
    
    /* Form */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    
    /* Custom Date Picker */
    .date-picker-container {
      position: relative;
    }
    
    .date-display {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      background: white;
      transition: all 0.3s;
    }
    
    .date-display:hover {
      border-color: #667eea;
    }
    
    .date-picker-popup {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 10px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      padding: 20px;
      z-index: 1000;
      display: none;
    }
    
    .date-picker-popup.active {
      display: block;
    }
    
    .date-picker-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .date-picker-nav {
      background: #667eea;
      color: white;
      border: none;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s;
    }
    
    .date-picker-nav:hover {
      background: #5568d3;
      transform: scale(1.1);
    }
    
    .date-picker-month {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .date-picker-days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-bottom: 10px;
    }
    
    .date-picker-day-header {
      text-align: center;
      font-weight: bold;
      color: #666;
      padding: 8px;
      font-size: 12px;
    }
    
    .date-picker-day {
      aspect-ratio: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      position: relative;
      padding: 5px;
      border: 1px solid #e0e0e0;
    }
    
    .date-picker-day:hover {
      background: rgba(102, 126, 234, 0.1);
      transform: scale(1.05);
    }
    
    .date-picker-day.disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .date-picker-day.disabled:hover {
      transform: none;
      background: none;
    }
    
    .date-picker-day.selected {
      background: #667eea;
      color: white;
      font-weight: bold;
    }
    
    .day-number {
      font-size: 14px;
      font-weight: bold;
    }
    
    .day-shift {
      font-size: 10px;
      margin-top: 2px;
    }
    
    .day-holiday {
      position: absolute;
      top: 2px;
      right: 2px;
      width: 6px;
      height: 6px;
      background: #f44336;
      border-radius: 50%;
    }
    
    /* Shift Colors */
    .shift-M { background: rgba(76, 175, 80, 0.2); color: #2e7d32; }
    .shift-A { background: rgba(255, 152, 0, 0.2); color: #e65100; }
    .shift-N { background: rgba(33, 150, 243, 0.2); color: #0d47a1; }
    .shift-O { background: rgba(158, 158, 158, 0.2); color: #424242; }
    
    .shift-M.selected { background: #4CAF50; color: white; }
    .shift-A.selected { background: #FF9800; color: white; }
    .shift-N.selected { background: #2196F3; color: white; }
    .shift-O.selected { background: #9E9E9E; color: white; }
    
    /* Shift Info */
    .shift-info {
      margin-top: 10px;
      padding: 15px;
      border-radius: 10px;
      background: rgba(102, 126, 234, 0.1);
      border-left: 4px solid #667eea;
    }
    
    .shift-info.warning {
      background: rgba(255, 152, 0, 0.1);
      border-left-color: #FF9800;
    }
    
    /* Buttons */
    .btn-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    
    .btn {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    
    /* Leave Card */
    .leave-card {
      background: rgba(102, 126, 234, 0.05);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      border-left: 5px solid #667eea;
      position: relative;
    }
    
    .leave-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .leave-dates {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }
    
    .leave-shift {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: bold;
    }
    
    .leave-details {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    
    .delete-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .delete-btn:hover {
      background: #d32f2f;
    }
    
    /* Alert */
    .alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .alert-success {
      background: rgba(76, 175, 80, 0.1);
      border-left: 4px solid #4CAF50;
      color: #2e7d32;
    }
    
    .alert-error {
      background: rgba(244, 67, 54, 0.1);
      border-left: 4px solid #f44336;
      color: #c62828;
    }
    
    /* Test Mode */
    .test-mode {
      background: rgba(255, 193, 7, 0.1);
      border: 2px dashed #FFC107;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .test-mode-title {
      font-size: 20px;
      font-weight: bold;
      color: #F57C00;
      margin-bottom: 15px;
      text-align: center;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .nav-bar {
        flex-direction: column;
        align-items: stretch;
      }
      
      .nav-links {
        flex-direction: column;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <div class="nav-bar">
    <div class="nav-logo">ğŸ–ï¸ Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª - Vacation Planner v1.3</div>
    <div class="nav-links">
      <a href="pbcr-calculator.html" class="nav-link">ğŸ›¢ï¸ PBCR</a>
      <a href="plcr.html" class="nav-link">âš—ï¸ PLCR</a>
      <a href="live-tanks.html" class="nav-link">ğŸ”´ Live Tanks</a>
      <a href="shift-roster.html" class="nav-link">ğŸ“… Shift Roster</a>
      <a href="dashboard.html" class="nav-link">ğŸ“Š Dashboard</a>
      <div class="user-info">
        <span class="user-name" id="userName">Loading...</span>
        <button class="logout-btn" onclick="handleLogout()">ğŸšª Logout</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <!-- Test Mode Card -->
    <div class="card test-mode">
      <div class="test-mode-title">ğŸ§ª ÙˆØ¶Ø¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± - Test Mode</div>
      <div class="form-group">
        <label class="form-label">ğŸ“ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ¬Ø±ÙŠØ¨ÙŠ:</label>
        <input type="text" class="form-input" id="testUserName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ØŒ Ø³Ø§Ù„Ù…ØŒ Ø®Ø§Ù„Ø¯...">
      </div>
      <button class="btn btn-primary" onclick="createTestUser()">âœ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ</button>
      <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
        ğŸ’¡ Ù‡Ø°Ø§ Ø§Ù„ÙˆØ¶Ø¹ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙÙ‚Ø·. Ø³ÙŠØªÙ… Ø¥Ø²Ø§Ù„ØªÙ‡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙØ­Ø©.
      </p>
    </div>
    
    <!-- Leave Request Card -->
    <div class="card">
      <h2 class="card-title">ğŸ“ Ø·Ù„Ø¨ Ø¥Ø¬Ø§Ø²Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
      
      <!-- Shift Selection -->
      <div class="form-group">
        <label class="form-label">ğŸ”„ Ø§Ø®ØªØ± Ø§Ù„Ø´ÙØª:</label>
        <select class="form-select" id="shiftSelect" onchange="selectShift()">
          <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´ÙØª --</option>
          <option value="A">A Shift</option>
          <option value="B">B Shift</option>
          <option value="C">C Shift</option>
          <option value="D">D Shift</option>
        </select>
      </div>
      
      <!-- Leave Form -->
      <div id="leaveForm" style="display:none;">
        <div class="form-row">
          <!-- Start Date -->
          <div class="form-group">
            <label class="form-label">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</label>
            <div class="date-picker-container">
              <div class="date-display" id="startDateDisplay" onclick="toggleDatePicker('start')">
                Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
              </div>
              <div class="date-picker-popup" id="startDatePicker">
                <div class="date-picker-header">
                  <button class="date-picker-nav" onclick="changeMonth('start', -1)">â—€</button>
                  <div class="date-picker-month" id="startMonthDisplay"></div>
                  <button class="date-picker-nav" onclick="changeMonth('start', 1)">â–¶</button>
                </div>
                <div class="date-picker-days" id="startDaysGrid"></div>
              </div>
            </div>
            <div id="startDateInfo" class="shift-info" style="display:none;"></div>
          </div>
          
          <!-- End Date -->
          <div class="form-group">
            <label class="form-label">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</label>
            <div class="date-picker-container">
              <div class="date-display" id="endDateDisplay" onclick="toggleDatePicker('end')">
                Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
              </div>
              <div class="date-picker-popup" id="endDatePicker">
                <div class="date-picker-header">
                  <button class="date-picker-nav" onclick="changeMonth('end', -1)">â—€</button>
                  <div class="date-picker-month" id="endMonthDisplay"></div>
                  <button class="date-picker-nav" onclick="changeMonth('end', 1)">â–¶</button>
                </div>
                <div class="date-picker-days" id="endDaysGrid"></div>
              </div>
            </div>
            <div id="endDateInfo" class="shift-info" style="display:none;"></div>
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveLeave()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</button>
          <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </div>
    </div>
    
    <!-- My Leaves Card -->
    <div class="card">
      <h2 class="card-title">ğŸ“‹ Ø¥Ø¬Ø§Ø²Ø§ØªÙŠ (0/3)</h2>
      <div id="leavesContainer">
        <p style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>
      </div>
    </div>
    
    <!-- Annual Roster Card -->
    <div class="card">
      <h2 class="card-title">ğŸ“Š Ø§Ù„Ø±ÙˆØ³ØªØ± Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h2>
      
      <!-- Year Selector -->
      <div class="form-group">
        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
        <select class="form-select" id="rosterYear" onchange="renderAnnualRoster()">
          <option value="2025">2025</option>
          <option value="2026" selected>2026</option>
          <option value="2027">2027</option>
        </select>
      </div>
      
      <!-- Legend -->
      <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(76,175,80,0.3); border-radius: 4px;"></div>
          <span style="font-size: 14px;">âœ… 1-2 Ø£Ø´Ø®Ø§Øµ</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(255,152,0,0.3); border-radius: 4px;"></div>
          <span style="font-size: 14px;">âš ï¸ 3 Ø£Ø´Ø®Ø§Øµ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(244,67,54,0.3); border-radius: 4px;"></div>
          <span style="font-size: 14px;">ğŸ”´ 4+ Ø£Ø´Ø®Ø§Øµ (ØªØ¹Ø§Ø±Ø¶!)</span>
        </div>
      </div>
      
      <!-- Annual Roster Grid -->
      <div id="annualRosterGrid" style="overflow-x: auto;">
        <p style="text-align: center; opacity: 0.7;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
      </div>
      
      <!-- Conflict Suggestions -->
      <div id="conflictSuggestions" style="margin-top: 20px;"></div>
    </div>
  </div>
  
  <script type="module">
    // ========== FIREBASE IMPORTS ==========
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
    import { getFirestore, doc, getDoc, collection, getDocs, addDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDCkL9qMG8L7NNZ8jHqGbY3_Uf9VLxIcB0",
      authDomain: "tank-tools-knpc.firebaseapp.com",
      projectId: "tank-tools-knpc",
      storageBucket: "tank-tools-knpc.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:51006259432481e7e1d5c6"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // Make Firebase globally available
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.collection = collection;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.deleteDoc = deleteDoc;
    window.query = query;
    window.where = where;
    
    // ========== CONSTANTS ==========
    const START_DATE = new Date('2025-10-31');
    const SHIFTS = ['A', 'M', 'N', 'O'];
    const GOOGLE_CALENDAR_API_KEY = 'AIzaSyC5GZwG7bOgSSke3mRzmAYvc0DIyrPxGzM';
    const KUWAIT_CALENDAR_ID = 'en.kw.official%23holiday@group.v.calendar.google.com';
    
    // ========== STATE ==========
    let currentUser = null;
    let userShift = '';
    let userLeaves = [];
    let allLeaves = [];
    let kuwaitHolidays = [];
    let startDatePicker = { month: new Date().getMonth(), year: new Date().getFullYear(), selectedDate: null };
    let endDatePicker = { month: new Date().getMonth(), year: new Date().getFullYear(), selectedDate: null };
    
    // ========== SHIFT ROSTER LOGIC ==========
    function getShiftForDate(date, shift) {
      const daysDiff = Math.floor((date - START_DATE) / (1000 * 60 * 60 * 24));
      const cycleDay = ((daysDiff % 32) + 32) % 32;
      
      const shiftIndex = { 'A': 0, 'B': 1, 'C': 2, 'D': 3 }[shift];
      const rotatedDay = (cycleDay + shiftIndex * 8) % 32;
      
      if (rotatedDay < 8) return 'M';
      if (rotatedDay < 16) return 'A';
      if (rotatedDay < 24) return 'N';
      return 'O';
    }
    
    function getShiftType(date, shift) {
      const shiftLetter = getShiftForDate(date, shift);
      const prevDate = new Date(date);
      prevDate.setDate(prevDate.getDate() - 1);
      const prevShift = getShiftForDate(prevDate, shift);
      
      const isFirstDay = prevShift !== shiftLetter;
      const dayType = isFirstDay ? 'First' : 'Second';
      
      const shiftNames = {
        'M': 'Morning',
        'A': 'Afternoon',
        'N': 'Night',
        'O': 'Off'
      };
      
      return {
        letter: shiftLetter,
        name: `${dayType} ${shiftNames[shiftLetter]}`,
        isFirst: isFirstDay
      };
    }
    
    // ========== KUWAIT HOLIDAYS ==========
    async function fetchKuwaitHolidays() {
      try {
        const year = new Date().getFullYear();
        const timeMin = `${year}-01-01T00:00:00Z`;
        const timeMax = `${year + 2}-12-31T23:59:59Z`;
        
        const url = `https://www.googleapis.com/calendar/v3/calendars/${KUWAIT_CALENDAR_ID}/events?key=${GOOGLE_CALENDAR_API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.items) {
          kuwaitHolidays = data.items.map(event => ({
            date: event.start.date,
            name: event.summary
          }));
          console.log('âœ… Loaded', kuwaitHolidays.length, 'Kuwait holidays');
        }
      } catch (error) {
        console.error('âŒ Error fetching holidays:', error);
      }
    }
    
    function isHoliday(date) {
      const y = date.getFullYear();
      const m = String(date.getMonth() + 1).padStart(2, '0');
      const d = String(date.getDate()).padStart(2, '0');
      const dateStr = `${y}-${m}-${d}`;
      return kuwaitHolidays.find(h => h.date === dateStr);
    }
    
    // ========== DATE PICKER ==========
    window.toggleDatePicker = function(type) {
      const picker = document.getElementById(`${type}DatePicker`);
      const otherPicker = document.getElementById(type === 'start' ? 'endDatePicker' : 'startDatePicker');
      
      if (picker.classList.contains('active')) {
        picker.classList.remove('active');
      } else {
        otherPicker.classList.remove('active');
        picker.classList.add('active');
        renderDatePicker(type);
      }
    };
    
    window.changeMonth = function(type, delta) {
      const picker = type === 'start' ? startDatePicker : endDatePicker;
      picker.month += delta;
      
      if (picker.month < 0) {
        picker.month = 11;
        picker.year--;
      } else if (picker.month > 11) {
        picker.month = 0;
        picker.year++;
      }
      
      renderDatePicker(type);
    };
    
    function renderDatePicker(type) {
      const picker = type === 'start' ? startDatePicker : endDatePicker;
      const monthDisplay = document.getElementById(`${type}MonthDisplay`);
      const daysGrid = document.getElementById(`${type}DaysGrid`);
      
      const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];
      monthDisplay.textContent = `${monthNames[picker.month]} ${picker.year}`;
      
      // Day headers
      let html = '';
      ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
        html += `<div class="date-picker-day-header">${day}</div>`;
      });
      
      // Days
      const firstDay = new Date(picker.year, picker.month, 1).getDay();
      const daysInMonth = new Date(picker.year, picker.month + 1, 0).getDate();
      
      // Empty cells
      for (let i = 0; i < firstDay; i++) {
        html += '<div class="date-picker-day disabled"></div>';
      }
      
      // Days of month
      for (let day = 1; day <= daysInMonth; day++) {
        const date = new Date(picker.year, picker.month, day);
        const shiftInfo = userShift ? getShiftType(date, userShift) : null;
        const holiday = isHoliday(date);
        
        const isSelected = picker.selectedDate && 
          picker.selectedDate.getDate() === day &&
          picker.selectedDate.getMonth() === picker.month &&
          picker.selectedDate.getFullYear() === picker.year;
        
        const shiftClass = shiftInfo ? `shift-${shiftInfo.letter}` : '';
        const selectedClass = isSelected ? 'selected' : '';
        
        html += `
          <div class="date-picker-day ${shiftClass} ${selectedClass}" onclick="selectDate('${type}', ${day})">
            ${holiday ? '<div class="day-holiday"></div>' : ''}
            <div class="day-number">${day}</div>
            ${shiftInfo ? `<div class="day-shift">${shiftInfo.letter}</div>` : ''}
          </div>
        `;
      }
      
      daysGrid.innerHTML = html;
    }
    
    window.selectDate = function(type, day) {
      const picker = type === 'start' ? startDatePicker : endDatePicker;
      picker.selectedDate = new Date(picker.year, picker.month, day);
      
      const display = document.getElementById(`${type}DateDisplay`);
      display.textContent = picker.selectedDate.toLocaleDateString('ar-EG', { 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      
      document.getElementById(`${type}DatePicker`).classList.remove('active');
      
      if (type === 'start') {
        checkStartDate();
      } else {
        checkEndDate();
      }
    };
    
    function checkStartDate() {
      if (!startDatePicker.selectedDate || !userShift) return;
      
      const shiftInfo = getShiftType(startDatePicker.selectedDate, userShift);
      const holiday = isHoliday(startDatePicker.selectedDate);
      
      const info = document.getElementById('startDateInfo');
      info.style.display = 'block';
      
      let html = `<strong>${userShift} Shift - ${shiftInfo.name} (${shiftInfo.letter})</strong>`;
      if (holiday) {
        html += `<br>ğŸ”´ <strong>Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©:</strong> ${holiday.name}`;
      }
      
      if (!shiftInfo.name.includes('First Morning')) {
        info.classList.add('warning');
        html += '<br>âš ï¸ <strong>ØªØ­Ø°ÙŠØ±:</strong> ÙŠÙÙØ¶Ù„ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† First Morning';
      } else {
        info.classList.remove('warning');
      }
      
      info.innerHTML = html;
    }
    
    function checkEndDate() {
      if (!endDatePicker.selectedDate || !userShift) return;
      
      const shiftInfo = getShiftType(endDatePicker.selectedDate, userShift);
      const holiday = isHoliday(endDatePicker.selectedDate);
      
      const info = document.getElementById('endDateInfo');
      info.style.display = 'block';
      
      let html = `<strong>${userShift} Shift - ${shiftInfo.name} (${shiftInfo.letter})</strong>`;
      if (holiday) {
        html += `<br>ğŸ”´ <strong>Ø¹Ø·Ù„Ø© Ø±Ø³Ù…ÙŠØ©:</strong> ${holiday.name}`;
      }
      
      if (!shiftInfo.name.includes('Second Night')) {
        info.classList.add('warning');
        html += '<br>âš ï¸ <strong>ØªØ­Ø°ÙŠØ±:</strong> ÙŠÙÙØ¶Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙŠ Second Night';
      } else {
        info.classList.remove('warning');
      }
      
      info.innerHTML = html;
    }
    
    // ========== SHIFT SELECTION ==========
    window.selectShift = function() {
      const select = document.getElementById('shiftSelect');
      userShift = select.value;
      
      if (userShift) {
        document.getElementById('leaveForm').style.display = 'block';
      } else {
        document.getElementById('leaveForm').style.display = 'none';
      }
    };
    
    // ========== SAVE LEAVE ==========
    window.saveLeave = async function() {
      if (!startDatePicker.selectedDate || !endDatePicker.selectedDate) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
        return;
      }
      
      if (startDatePicker.selectedDate > endDatePicker.selectedDate) {
        alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©');
        return;
      }
      
      if (userLeaves.length >= 3) {
        alert('Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (3 Ø¥Ø¬Ø§Ø²Ø§Øª)');
        return;
      }
      
      const startShiftInfo = getShiftType(startDatePicker.selectedDate, userShift);
      const endShiftInfo = getShiftType(endDatePicker.selectedDate, userShift);
      
      const leave = {
        userId: currentUser.username,
        userName: currentUser.name || currentUser.username,
        shift: userShift,
        startDate: startDatePicker.selectedDate.toISOString().split('T')[0],
        endDate: endDatePicker.selectedDate.toISOString().split('T')[0],
        startShiftType: startShiftInfo.name,
        endShiftType: endShiftInfo.name,
        createdAt: new Date().toISOString()
      };
      
      try {
        const docRef = await window.addDoc(window.collection(window.db, 'vacations'), leave);
        leave.id = docRef.id;
        
        userLeaves.push(leave);
        renderLeaves();
        resetForm();
        
        await loadAllLeaves();
        
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­!');
      } catch (error) {
        console.error('âŒ Error saving leave:', error);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©: ' + error.message);
      }
    };
    
    // ========== DELETE LEAVE ==========
    window.deleteLeave = async function(id) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©ØŸ')) {
        try {
          await window.deleteDoc(window.doc(window.db, 'vacations', id));
          
          userLeaves = userLeaves.filter(l => l.id !== id);
          renderLeaves();
          
          await loadAllLeaves();
          
          alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­!');
        } catch (error) {
          console.error('âŒ Error deleting leave:', error);
          alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©: ' + error.message);
        }
      }
    };
    
    // ========== RENDER LEAVES ==========
    function renderLeaves() {
      const container = document.getElementById('leavesContainer');
      const title = document.querySelector('.card-title');
      title.textContent = `ğŸ“‹ Ø¥Ø¬Ø§Ø²Ø§ØªÙŠ (${userLeaves.length}/3)`;
      
      if (userLeaves.length === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>';
        return;
      }
      
      let html = '';
      userLeaves.forEach(leave => {
        const startDate = new Date(leave.startDate);
        const endDate = new Date(leave.endDate);
        const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
        
        html += `
          <div class="leave-card">
            <div class="leave-header">
              <div>
                <div class="leave-dates">
                  ${startDate.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' })} - 
                  ${endDate.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric', year: 'numeric' })}
                </div>
                <div class="leave-details">
                  <span class="leave-shift shift-${leave.shift.charAt(0)}" style="background: rgba(102,126,234,0.2); color: #667eea;">
                    ${leave.shift} Shift
                  </span>
                  â€¢ ${days} Ø£ÙŠØ§Ù…
                </div>
                <div class="leave-details" style="margin-top: 5px;">
                  Ù…Ù†: ${leave.startShiftType} | Ø¥Ù„Ù‰: ${leave.endShiftType}
                </div>
              </div>
              <button class="delete-btn" onclick="deleteLeave('${leave.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // ========== RESET FORM ==========
    window.resetForm = function() {
      startDatePicker.selectedDate = null;
      endDatePicker.selectedDate = null;
      
      document.getElementById('startDateDisplay').textContent = 'Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©';
      document.getElementById('endDateDisplay').textContent = 'Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©';
      document.getElementById('startDateInfo').style.display = 'none';
      document.getElementById('endDateInfo').style.display = 'none';
    };
    
    // ========== LOAD USER LEAVES ==========
    async function loadUserLeaves() {
      if (!currentUser) return;
      
      try {
        const q = window.query(
          window.collection(window.db, 'vacations'),
          window.where('userId', '==', currentUser.username)
        );
        
        const querySnapshot = await window.getDocs(q);
        userLeaves = [];
        
        querySnapshot.forEach((doc) => {
          userLeaves.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderLeaves();
        console.log('âœ… Loaded', userLeaves.length, 'leaves from Firestore');
      } catch (error) {
        console.error('âŒ Error loading leaves:', error);
      }
    }
    
    // ========== LOAD ALL LEAVES ==========
    async function loadAllLeaves() {
      try {
        const querySnapshot = await window.getDocs(window.collection(window.db, 'vacations'));
        allLeaves = [];
        
        querySnapshot.forEach((doc) => {
          allLeaves.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        console.log('âœ… Loaded', allLeaves.length, 'total leaves from Firestore');
        renderAnnualRoster();
      } catch (error) {
        console.error('âŒ Error loading all leaves:', error);
      }
    }
    
    // ========== ANNUAL ROSTER ==========
    window.renderAnnualRoster = function() {
      const year = parseInt(document.getElementById('rosterYear').value);
      const grid = document.getElementById('annualRosterGrid');
      const suggestions = document.getElementById('conflictSuggestions');
      
      const dailyCounts = {};
      const dailyPeople = {};
      
      allLeaves.forEach(leave => {
        const start = new Date(leave.startDate);
        const end = new Date(leave.endDate);
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          if (d.getFullYear() === year) {
            const dateStr = d.toISOString().split('T')[0];
            dailyCounts[dateStr] = (dailyCounts[dateStr] || 0) + 1;
            
            if (!dailyPeople[dateStr]) dailyPeople[dateStr] = [];
            dailyPeople[dateStr].push(leave.userName || leave.userId);
          }
        }
      });
      
      const conflicts = Object.entries(dailyCounts)
        .filter(([date, count]) => count >= 4)
        .sort((a, b) => new Date(a[0]) - new Date(b[0]));
      
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">';
      
      for (let month = 0; month < 12; month++) {
        const monthDate = new Date(year, month, 1);
        const monthName = monthDate.toLocaleDateString('ar-EG', { month: 'long' });
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        html += `
          <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
            <h3 style="text-align: center; color: #4CAF50; margin-bottom: 10px; font-size: 16px;">${monthName} ${year}</h3>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
        `;
        
        ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
          html += `<div style="text-align: center; font-size: 12px; font-weight: bold; opacity: 0.7;">${day}</div>`;
        });
        
        const firstDay = new Date(year, month, 1).getDay();
        for (let i = 0; i < firstDay; i++) {
          html += '<div></div>';
        }
        
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dateStr = date.toISOString().split('T')[0];
          const count = dailyCounts[dateStr] || 0;
          
          let bgColor = 'rgba(255,255,255,0.05)';
          let textColor = '#fff';
          
          if (count >= 4) {
            bgColor = 'rgba(244,67,54,0.4)';
            textColor = '#fff';
          } else if (count === 3) {
            bgColor = 'rgba(255,152,0,0.4)';
            textColor = '#fff';
          } else if (count > 0) {
            bgColor = 'rgba(76,175,80,0.3)';
            textColor = '#fff';
          }
          
          const title = count > 0 ? `${count} Ø£Ø´Ø®Ø§Øµ: ${dailyPeople[dateStr].join(', ')}` : '';
          
          html += `
            <div style="
              background: ${bgColor};
              border-radius: 4px;
              padding: 8px 4px;
              text-align: center;
              font-size: 12px;
              color: ${textColor};
              cursor: ${count > 0 ? 'pointer' : 'default'};
              border: ${count >= 4 ? '2px solid #f44336' : count === 3 ? '1px solid #FF9800' : 'none'};
            " title="${title}">
              ${day}${count > 0 ? `<br><span style="font-size: 10px;">(${count})</span>` : ''}
            </div>
          `;
        }
        
        html += '</div></div>';
      }
      
      html += '</div>';
      grid.innerHTML = html;
      
      if (conflicts.length > 0) {
        let suggestionsHtml = `
          <div class="alert alert-error">
            <h3 style="margin-bottom: 10px;">ğŸ”´ ØªØ¹Ø§Ø±Ø¶Ø§Øª Ù…ÙƒØªØ´ÙØ© (${conflicts.length} ÙŠÙˆÙ…)</h3>
            <ul style="margin: 10px 0; padding-right: 20px;">
        `;
        
        conflicts.forEach(([date, count]) => {
          const people = dailyPeople[date].join(', ');
          const dateObj = new Date(date);
          const dateStr = dateObj.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
          suggestionsHtml += `<li style="margin: 5px 0;"><strong>${dateStr}</strong>: ${count} Ø£Ø´Ø®Ø§Øµ (${people})</li>`;
        });
        
        suggestionsHtml += `
            </ul>
            <p style="margin-top: 15px; font-size: 14px;">
              ğŸ’¡ <strong>Ù†ØµÙŠØ­Ø©:</strong> ÙŠØ±Ø¬Ù‰ Ù…Ù† Ø£Ø­Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ ØªØºÙŠÙŠØ± ØªØ§Ø±ÙŠØ® Ø¥Ø¬Ø§Ø²ØªÙ‡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶.
            </p>
          </div>
        `;
        
        suggestions.innerHTML = suggestionsHtml;
      } else {
        suggestions.innerHTML = `
          <div class="alert alert-success">
            âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶Ø§Øª! Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ù…ØªÙˆØ§ÙÙ‚Ø©.
          </div>
        `;
      }
    };
    
    // ========== TEST MODE ==========
    window.createTestUser = function() {
      const nameInput = document.getElementById('testUserName');
      const name = nameInput.value.trim();
      
      if (!name) {
        alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        return;
      }
      
      currentUser = {
        username: `test_${Date.now()}`,
        name: name,
        isTestUser: true
      };
      
      document.getElementById('userName').textContent = name + ' (Ø§Ø®ØªØ¨Ø§Ø±)';
      nameInput.value = '';
      
      loadUserLeaves();
      loadAllLeaves();
      
      alert(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø³ØªØ®Ø¯Ù… ØªØ¬Ø±ÙŠØ¨ÙŠ: ${name}`);
    };
    
    // ========== LOGOUT ==========
    window.handleLogout = async function() {
      if (currentUser && currentUser.isTestUser) {
        currentUser = null;
        userShift = '';
        userLeaves = [];
        document.getElementById('userName').textContent = 'Loading...';
        document.getElementById('leaveForm').style.display = 'none';
        document.getElementById('shiftSelect').value = '';
        renderLeaves();
        alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
        return;
      }
      
      try {
        await signOut(auth);
        window.location.href = 'login.html';
      } catch (error) {
        console.error('Error signing out:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
      }
    };
    
    // ========== INITIALIZE ==========
    console.log('%cğŸ–ï¸ VACATION PLANNER v1.3', 'color:#4CAF50;font-size:20px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
    
    // Fetch Kuwait holidays
    await fetchKuwaitHolidays();
    
    // Auth state listener
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        const username = user.email.split('@')[0];
        const userDoc = await window.getDoc(window.doc(window.db, 'users', username));
        
        if (!userDoc.exists()) {
          alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ù…Ø³Ø¬Ù„');
          await signOut(auth);
          window.location.href = 'login.html';
          return;
        }
        
        const userData = userDoc.data();
        
        if (!window.hasPageAccess(userData, 'dashboard.html')) {
          alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
          window.location.href = 'index.html';
          return;
        }
        
        currentUser = {
          username: username,
          name: userData.name || username,
          ...userData
        };
        
        document.getElementById('userName').textContent = userData.name || userData.username;
        console.log('âœ… Vacation Planner loaded for:', userData.name);
        
        await loadUserLeaves();
        await loadAllLeaves();
        return;
      }
      
      // No user logged in - allow test mode
      console.log('âš ï¸ No user logged in - Test Mode enabled');
    });
  </script>
</body>
</html>
