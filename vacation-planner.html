<!DOCTYPE html>
<!-- Vacation Planner v1.4 - Fixed shift display, added leave selector, days calculation -->
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª - Vacation Planner</title>
  <link href="icon.png" rel="icon" type="image/png"/>
  <script src="permissions.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('background.jpg');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: white;
      font-family: Arial, sans-serif;
      min-height: 100vh;
    }
    
    /* Navigation Bar */
    .nav-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(10px);
      border-bottom: 2px solid #4CAF50;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .nav-logo {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .nav-links {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    .nav-link {
      color: white;
      text-decoration: none;
      padding: 8px 16px;
      border-radius: 8px;
      transition: all 0.3s ease;
      background: rgba(255,255,255,0.1);
      font-weight: 500;
      border: 1px solid rgba(255,255,255,0.2);
    }
    
    .nav-link:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-1px);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .user-name {
      background: rgba(255,255,255,0.1);
      padding: 6px 12px;
      border-radius: 5px;
      border: 1px solid rgba(255,255,255,0.2);
      font-size: 14px;
    }
    
    .logout-btn {
      background: rgba(255,0,0,0.3);
      color: white;
      border: 1px solid rgba(255,0,0,0.5);
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
    }
    
    .logout-btn:hover {
      background: rgba(255,0,0,0.5);
      transform: translateY(-2px);
    }
    
    /* Main Container */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .page-title {
      text-align: center;
      font-size: 32px;
      margin-bottom: 30px;
      color: #4CAF50;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    
    /* Cards */
    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 25px;
      margin-bottom: 20px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    .card-title {
      font-size: 20px;
      margin-bottom: 20px;
      color: #4CAF50;
      border-bottom: 2px solid rgba(76,175,80,0.3);
      padding-bottom: 10px;
    }
    
    /* Form */
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #fff;
    }
    
    .form-input, .form-select {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.9);
      color: #003366;
      font-size: 16px;
      transition: all 0.3s;
    }
    
    .form-input:focus, .form-select:focus {
      outline: none;
      border-color: #4CAF50;
      box-shadow: 0 0 10px rgba(76,175,80,0.3);
    }
    
    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }
    
    /* Shift Info Display */
    .shift-info {
      background: rgba(76,175,80,0.2);
      border: 2px solid #4CAF50;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      font-weight: bold;
      text-align: center;
    }
    
    .shift-info.warning {
      background: rgba(255,152,0,0.2);
      border-color: #FF9800;
      color: #FFB74D;
    }
    
    .shift-info.error {
      background: rgba(244,67,54,0.2);
      border-color: #f44336;
      color: #EF5350;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #4CAF50, #45a049);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(76,175,80,0.4);
    }
    
    .btn-secondary {
      background: linear-gradient(45deg, #2196F3, #1976D2);
      color: white;
    }
    
    .btn-secondary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(33,150,243,0.4);
    }
    
    .btn-danger {
      background: linear-gradient(45deg, #f44336, #d32f2f);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(244,67,54,0.4);
    }
    
    .btn-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    /* Leave List */
    .leave-item {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      border-left: 4px solid #4CAF50;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .leave-info {
      flex: 1;
    }
    
    .leave-dates {
      font-size: 14px;
      color: #4CAF50;
      margin-bottom: 5px;
    }
    
    .leave-shift-type {
      font-size: 12px;
      opacity: 0.8;
    }
    
    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
    }
    
    .loading-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 4px solid #4CAF50;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Alert */
    .alert {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: bold;
    }
    
    .alert-success {
      background: rgba(76,175,80,0.2);
      border: 2px solid #4CAF50;
      color: #4CAF50;
    }
    
    .alert-error {
      background: rgba(244,67,54,0.2);
      border: 2px solid #f44336;
      color: #f44336;
    }
    
    .alert-warning {
      background: rgba(255,152,0,0.2);
      border: 2px solid #FF9800;
      color: #FF9800;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .nav-bar {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .nav-links {
        width: 100%;
        justify-content: center;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .btn-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <div class="nav-bar">
    <div class="nav-logo">ğŸ–ï¸ Ù…Ø®Ø·Ø· Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª - Vacation Planner v1.4</div>
    <div class="nav-links">
      <a href="pbcr-calculator.html" class="nav-link">ğŸ›¢ï¸ PBCR</a>
      <a href="plcr.html" class="nav-link">âš—ï¸ PLCR</a>
      <a href="live-tanks.html" class="nav-link">ğŸ”´ Live Tanks</a>
      <a href="shift-roster.html" class="nav-link">ğŸ“… Shift Roster</a>
      <a href="dashboard.html" class="nav-link">ğŸ“Š Dashboard</a>
      <div class="user-info">
        <span class="user-name" id="userName">Loading...</span>
        <button class="logout-btn" onclick="handleLogout()">ğŸšª Logout</button>
      </div>
    </div>
  </div>
  
  <!-- Main Container -->
  <div class="main-container">
    <h1 class="page-title">ğŸ–ï¸ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h1>
    
    <!-- My Leaves Card -->
    <div class="card">
      <h2 class="card-title">ğŸ“‹ Ø¥Ø¬Ø§Ø²Ø§ØªÙŠ (3 Ø¥Ø¬Ø§Ø²Ø§Øª Ù…ØªØ§Ø­Ø©)</h2>
      
      <!-- Shift Selection -->
      <div class="form-group">
        <label class="form-label">Ø§Ø®ØªØ± Ø´ÙØªÙƒ:</label>
        <select class="form-select" id="userShift" onchange="updateShiftInfo()">
          <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø´ÙØª --</option>
          <option value="A">A Shift</option>
          <option value="B">B Shift</option>
          <option value="C">C Shift</option>
          <option value="D">D Shift</option>
        </select>
      </div>
      
      <!-- Leave Selector -->
      <div id="leaveSelector" style="display:none; margin-bottom: 20px;">
        <div class="form-group">
          <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©:</label>
          <select class="form-select" id="leaveNumber" onchange="selectLeave()">
            <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© --</option>
            <option value="1">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰</option>
            <option value="2">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option>
            <option value="3">Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø©</option>
          </select>
        </div>
      </div>
      
      <!-- Leave Form -->
      <div id="leaveForm" style="display:none;">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©:</label>
            <input type="date" class="form-input" id="startDate" onchange="checkStartDate()">
            <div id="startDateInfo" class="shift-info" style="display:none;"></div>
          </div>
          
          <div class="form-group">
            <label class="form-label">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©:</label>
            <input type="date" class="form-input" id="endDate" onchange="checkEndDate()">
            <div id="endDateInfo" class="shift-info" style="display:none;"></div>
          </div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveLeave()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©</button>
          <button class="btn btn-secondary" onclick="resetForm()">ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        </div>
      </div>
      
      <!-- My Leaves List -->
      <div id="myLeavesList" style="margin-top: 30px;">
        <h3 style="color: #4CAF50; margin-bottom: 15px;">Ø¥Ø¬Ø§Ø²Ø§ØªÙŠ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:</h3>
        <div id="leavesContainer">
          <p style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>
        </div>
      </div>
    </div>
    
    <!-- Annual Roster Card -->
    <div class="card">
      <h2 class="card-title">ğŸ“Š Ø§Ù„Ø±ÙˆØ³ØªØ± Ø§Ù„Ø³Ù†ÙˆÙŠ Ù„Ù„Ø¥Ø¬Ø§Ø²Ø§Øª</h2>
      
      <!-- Year Selector -->
      <div class="form-group">
        <label class="form-label">Ø§Ø®ØªØ± Ø§Ù„Ø³Ù†Ø©:</label>
        <select class="form-select" id="rosterYear" onchange="renderAnnualRoster()">
          <option value="2025">2025</option>
          <option value="2026" selected>2026</option>
          <option value="2027">2027</option>
        </select>
      </div>
      
      <!-- Legend -->
      <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(76,175,80,0.3); border-radius: 4px;"></div>
          <span style="font-size: 14px;">âœ… 1-2 Ø£Ø´Ø®Ø§Øµ</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(255,152,0,0.3); border-radius: 4px;"></div>
          <span style="font-size: 14px;">âš ï¸ 3 Ø£Ø´Ø®Ø§Øµ (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰)</span>
        </div>
        <div style="display: flex; align-items: center; gap: 5px;">
          <div style="width: 20px; height: 20px; background: rgba(244,67,54,0.3); border-radius: 4px;"></div>
          <span style="font-size: 14px;">ğŸ”´ 4+ Ø£Ø´Ø®Ø§Øµ (ØªØ¹Ø§Ø±Ø¶!)</span>
        </div>
      </div>
      
      <!-- Annual Roster Grid -->
      <div id="annualRosterGrid" style="overflow-x: auto;">
        <p style="text-align: center; opacity: 0.7;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
      </div>
      
      <!-- Conflict Suggestions -->
      <div id="conflictSuggestions" style="margin-top: 20px;"></div>
    </div>
  </div>
  
  <script>
    // ========== CONSTANTS ==========
    // EXACT SAME LOGIC AS shift-roster.html v8.4
    const START_DATE = new Date(2025, 9, 31); // Oct 31, 2025
    const PATTERN = ['A', 'A', 'N', 'N', 'O', 'O', 'M', 'M'];
    const SHIFT_OFFSETS = {
      'A': 0,
      'B': 4,
      'C': 2,
      'D': 6
    };
    
    // ========== STATE ==========
    let currentUser = null;
    let userShift = '';
    let userLeaves = [];
    let allLeaves = []; // All users' leaves
    
    // ========== SHIFT ROSTER LOGIC ==========
    // EXACT SAME LOGIC AS shift-roster.html v8.4
    function getShiftForDate(date, shift) {
      const diffTime = date - START_DATE;
      const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
      const index = ((diffDays + SHIFT_OFFSETS[shift]) % 8 + 8) % 8;
      return PATTERN[index];
    }
    
    function getShiftType(date, shift) {
      const shiftCode = getShiftForDate(date, shift);
      
      // Check if it's first or second day of the shift
      const prevDate = new Date(date);
      prevDate.setDate(prevDate.getDate() - 1);
      const prevShift = getShiftForDate(prevDate, shift);
      
      const isFirstDay = prevShift !== shiftCode;
      
      const shiftNames = {
        'M': isFirstDay ? 'First Morning' : 'Second Morning',
        'A': isFirstDay ? 'First Afternoon' : 'Second Afternoon',
        'N': isFirstDay ? 'First Night' : 'Second Night',
        'O': 'Off Day'
      };
      
      return {
        code: shiftCode,
        name: shiftNames[shiftCode],
        isFirst: isFirstDay
      };
    }
    
    // ========== UI FUNCTIONS ==========
    function updateShiftInfo() {
      userShift = document.getElementById('userShift').value;
      const leaveSelector = document.getElementById('leaveSelector');
      const leaveForm = document.getElementById('leaveForm');
      
      if (userShift) {
        leaveSelector.style.display = 'block';
        leaveForm.style.display = 'none';
        document.getElementById('leaveNumber').value = '';
      } else {
        leaveSelector.style.display = 'none';
        leaveForm.style.display = 'none';
      }
    }
    
    function selectLeave() {
      const leaveNumber = document.getElementById('leaveNumber').value;
      const leaveForm = document.getElementById('leaveForm');
      
      if (leaveNumber) {
        leaveForm.style.display = 'block';
      } else {
        leaveForm.style.display = 'none';
      }
    }
    
    function checkStartDate() {
      const startDateInput = document.getElementById('startDate');
      const startDateInfo = document.getElementById('startDateInfo');
      
      if (!startDateInput.value || !userShift) return;
      
      const date = new Date(startDateInput.value);
      const shiftInfo = getShiftType(date, userShift);
      
      startDateInfo.style.display = 'block';
      startDateInfo.textContent = `${userShift} Shift - ${shiftInfo.name}`;
      
      // Check if it's First Morning (recommended)
      if (shiftInfo.code === 'M' && shiftInfo.isFirst) {
        startDateInfo.className = 'shift-info';
        startDateInfo.textContent += ' âœ… (Ù…ÙˆØµÙ‰ Ø¨Ù‡)';
      } else if (shiftInfo.code === 'O') {
        startDateInfo.className = 'shift-info warning';
        startDateInfo.textContent += ' âš ï¸ (ÙŠÙˆÙ… Ø±Ø§Ø­Ø©)';
      } else {
        startDateInfo.className = 'shift-info warning';
        startDateInfo.textContent += ' âš ï¸ (ÙŠÙÙØ¶Ù„ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† First Morning)';
      }
    }
    
    function checkEndDate() {
      const endDateInput = document.getElementById('endDate');
      const endDateInfo = document.getElementById('endDateInfo');
      
      if (!endDateInput.value || !userShift) return;
      
      const date = new Date(endDateInput.value);
      const shiftInfo = getShiftType(date, userShift);
      
      endDateInfo.style.display = 'block';
      endDateInfo.textContent = `${userShift} Shift - ${shiftInfo.name}`;
      
      // Check if it's Second Night (recommended)
      if (shiftInfo.code === 'N' && !shiftInfo.isFirst) {
        endDateInfo.className = 'shift-info';
        endDateInfo.textContent += ' âœ… (Ù…ÙˆØµÙ‰ Ø¨Ù‡)';
      } else if (shiftInfo.code === 'O') {
        endDateInfo.className = 'shift-info warning';
        endDateInfo.textContent += ' âš ï¸ (ÙŠÙˆÙ… Ø±Ø§Ø­Ø©)';
      } else {
        endDateInfo.className = 'shift-info warning';
        endDateInfo.textContent += ' âš ï¸ (ÙŠÙÙØ¶Ù„ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ ÙÙŠ Second Night)';
      }
    }
    
    async function saveLeave() {
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      
      if (!startDate || !endDate) {
        alert('ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙˆØ§Ù„Ù†Ù‡Ø§ÙŠØ©');
        return;
      }
      
      if (new Date(startDate) > new Date(endDate)) {
        alert('ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ù‡Ø§ÙŠØ©');
        return;
      }
      
      if (userLeaves.length >= 3) {
        alert('Ù„Ù‚Ø¯ ÙˆØµÙ„Øª Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù…Ù† Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª (3 Ø¥Ø¬Ø§Ø²Ø§Øª)');
        return;
      }
      
      const startShiftInfo = getShiftType(new Date(startDate), userShift);
      const endShiftInfo = getShiftType(new Date(endDate), userShift);
      
      const leave = {
        userId: currentUser.username,
        userName: currentUser.name || currentUser.username,
        shift: userShift,
        startDate: startDate,
        endDate: endDate,
        startShiftType: startShiftInfo.name,
        endShiftType: endShiftInfo.name,
        createdAt: new Date().toISOString()
      };
      
      try {
        // Save to Firestore
        const docRef = await window.addDoc(window.collection(window.db, 'vacations'), leave);
        leave.id = docRef.id;
        
        userLeaves.push(leave);
        renderLeaves();
        resetForm();
        
        alert('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­!');
        console.log('âœ… Leave saved to Firestore:', docRef.id);
      } catch (error) {
        console.error('âŒ Error saving leave:', error);
        alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©: ' + error.message);
      }
    }
    
    async function deleteLeave(id) {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©ØŸ')) {
        try {
          // Delete from Firestore
          await window.deleteDoc(window.doc(window.db, 'vacations', id));
          
          userLeaves = userLeaves.filter(l => l.id !== id);
          renderLeaves();
          
          alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          console.log('âœ… Leave deleted from Firestore:', id);
        } catch (error) {
          console.error('âŒ Error deleting leave:', error);
          alert('âŒ Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¥Ø¬Ø§Ø²Ø©: ' + error.message);
        }
      }
    }
    
    function renderLeaves() {
      const container = document.getElementById('leavesContainer');
      
      if (userLeaves.length === 0) {
        container.innerHTML = '<p style="text-align: center; opacity: 0.7;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¬Ø§Ø²Ø§Øª Ù…Ø­ÙÙˆØ¸Ø©</p>';
        return;
      }
      
      container.innerHTML = userLeaves.map(leave => `
        <div class="leave-item">
          <div class="leave-info">
            <div class="leave-dates">
              ğŸ“… ${leave.startDate} â†’ ${leave.endDate}
            </div>
            <div class="leave-shift-type">
              ${leave.shift} Shift: ${leave.startShiftType} â†’ ${leave.endShiftType}
            </div>
          </div>
          <button class="btn btn-danger" onclick="deleteLeave(${leave.id})" style="padding: 8px 16px; font-size: 14px;">
            ğŸ—‘ï¸ Ø­Ø°Ù
          </button>
        </div>
      `).join('');
    }
    
    function resetForm() {
      document.getElementById('startDate').value = '';
      document.getElementById('endDate').value = '';
      document.getElementById('startDateInfo').style.display = 'none';
      document.getElementById('endDateInfo').style.display = 'none';
    }
    
    // ========== LOGOUT ==========
    function handleLogout() {
      if (confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
        if (window.auth && window.auth.signOut) {
          window.auth.signOut().then(() => {
            localStorage.removeItem('tanktools_current_user');
            sessionStorage.removeItem('tanktools_session');
            window.location.href = 'login.html';
          });
        } else {
          localStorage.removeItem('tanktools_current_user');
          sessionStorage.removeItem('tanktools_session');
          window.location.href = 'login.html';
        }
      }
    }
    
    // ========== LOAD USER LEAVES ==========
    async function loadUserLeaves() {
      if (!currentUser) return;
      
      try {
        const q = window.query(
          window.collection(window.db, 'vacations'),
          window.where('userId', '==', currentUser.username)
        );
        
        const querySnapshot = await window.getDocs(q);
        userLeaves = [];
        
        querySnapshot.forEach((doc) => {
          userLeaves.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        renderLeaves();
        console.log('âœ… Loaded', userLeaves.length, 'leaves from Firestore');
      } catch (error) {
        console.error('âŒ Error loading leaves:', error);
      }
    }
    
    // ========== LOAD ALL LEAVES ==========
    async function loadAllLeaves() {
      try {
        const querySnapshot = await window.getDocs(window.collection(window.db, 'vacations'));
        allLeaves = [];
        
        querySnapshot.forEach((doc) => {
          allLeaves.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        console.log('âœ… Loaded', allLeaves.length, 'total leaves from Firestore');
        renderAnnualRoster();
      } catch (error) {
        console.error('âŒ Error loading all leaves:', error);
      }
    }
    
    // ========== ANNUAL ROSTER ==========
    function renderAnnualRoster() {
      const year = parseInt(document.getElementById('rosterYear').value);
      const grid = document.getElementById('annualRosterGrid');
      const suggestions = document.getElementById('conflictSuggestions');
      
      // Count people on leave for each day
      const dailyCounts = {};
      const dailyPeople = {};
      
      allLeaves.forEach(leave => {
        const start = new Date(leave.startDate);
        const end = new Date(leave.endDate);
        
        // Iterate through each day of the leave
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          if (d.getFullYear() === year) {
            const dateStr = d.toISOString().split('T')[0];
            dailyCounts[dateStr] = (dailyCounts[dateStr] || 0) + 1;
            
            if (!dailyPeople[dateStr]) dailyPeople[dateStr] = [];
            dailyPeople[dateStr].push(leave.userName || leave.userId);
          }
        }
      });
      
      // Find conflicts (4+ people)
      const conflicts = Object.entries(dailyCounts)
        .filter(([date, count]) => count >= 4)
        .sort((a, b) => new Date(a[0]) - new Date(b[0]));
      
      // Render calendar grid (12 months)
      let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px;">';
      
      for (let month = 0; month < 12; month++) {
        const monthDate = new Date(year, month, 1);
        const monthName = monthDate.toLocaleDateString('ar-EG', { month: 'long' });
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        html += `
          <div style="background: rgba(255,255,255,0.05); border-radius: 10px; padding: 15px;">
            <h3 style="text-align: center; color: #4CAF50; margin-bottom: 10px; font-size: 16px;">${monthName} ${year}</h3>
            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px;">
        `;
        
        // Day headers
        ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
          html += `<div style="text-align: center; font-size: 12px; font-weight: bold; opacity: 0.7;">${day}</div>`;
        });
        
        // Empty cells before month starts
        const firstDay = new Date(year, month, 1).getDay();
        for (let i = 0; i < firstDay; i++) {
          html += '<div></div>';
        }
        
        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const dateStr = date.toISOString().split('T')[0];
          const count = dailyCounts[dateStr] || 0;
          
          let bgColor = 'rgba(255,255,255,0.05)';
          let textColor = '#fff';
          
          if (count >= 4) {
            bgColor = 'rgba(244,67,54,0.4)';
            textColor = '#fff';
          } else if (count === 3) {
            bgColor = 'rgba(255,152,0,0.4)';
            textColor = '#fff';
          } else if (count > 0) {
            bgColor = 'rgba(76,175,80,0.3)';
            textColor = '#fff';
          }
          
          const title = count > 0 ? `${count} Ø£Ø´Ø®Ø§Øµ: ${dailyPeople[dateStr].join(', ')}` : '';
          
          html += `
            <div style="
              background: ${bgColor};
              border-radius: 4px;
              padding: 8px 4px;
              text-align: center;
              font-size: 12px;
              color: ${textColor};
              cursor: ${count > 0 ? 'pointer' : 'default'};
              border: ${count >= 4 ? '2px solid #f44336' : count === 3 ? '1px solid #FF9800' : 'none'};
            " title="${title}">
              ${day}${count > 0 ? `<br><span style="font-size: 10px;">(${count})</span>` : ''}
            </div>
          `;
        }
        
        html += '</div></div>';
      }
      
      html += '</div>';
      grid.innerHTML = html;
      
      // Render conflict suggestions
      if (conflicts.length > 0) {
        let suggestionsHtml = `
          <div class="alert alert-error">
            <h3 style="margin-bottom: 10px;">ğŸ”´ ØªØ¹Ø§Ø±Ø¶Ø§Øª Ù…ÙƒØªØ´ÙØ© (${conflicts.length} ÙŠÙˆÙ…)</h3>
            <ul style="margin: 10px 0; padding-right: 20px;">
        `;
        
        conflicts.forEach(([date, count]) => {
          const people = dailyPeople[date].join(', ');
          const dateObj = new Date(date);
          const dateStr = dateObj.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
          suggestionsHtml += `<li style="margin: 5px 0;"><strong>${dateStr}</strong>: ${count} Ø£Ø´Ø®Ø§Øµ (${people})</li>`;
        });
        
        suggestionsHtml += `
            </ul>
            <p style="margin-top: 15px; font-size: 14px;">
              ğŸ’¡ <strong>Ù†ØµÙŠØ­Ø©:</strong> ÙŠØ±Ø¬Ù‰ Ù…Ù† Ø£Ø­Ø¯ Ø§Ù„Ø£Ø´Ø®Ø§Øµ ØªØºÙŠÙŠØ± ØªØ§Ø±ÙŠØ® Ø¥Ø¬Ø§Ø²ØªÙ‡ Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶.
            </p>
          </div>
        `;
        
        suggestions.innerHTML = suggestionsHtml;
      } else {
        suggestions.innerHTML = `
          <div class="alert alert-success">
            âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ø§Ø±Ø¶Ø§Øª! Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø²Ø§Øª Ù…ØªÙˆØ§ÙÙ‚Ø©.
          </div>
        `;
      }
    }
    
    // ========== INITIALIZE ==========
    console.log('%cğŸ–ï¸ VACATION PLANNER v1.4', 'color:#4CAF50;font-size:20px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
  </script>
  
  <!-- Firebase SDK & Auth -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBCdv37V6vOFMe42rGlPyl9lVq-9JldEPg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.appspot.com",
      messagingSenderId: "678793823159",
      appId: "1:678793823159:web:7a7b1398aefdb7f24462b9"
    };

    // Initialize Firebase
    let app, db;
    const existingApps = getApps();
    if (existingApps.length === 0) {
      app = initializeApp(firebaseConfig);
      console.log('ğŸ”¥ Firebase initialized for Vacation Planner!');
    } else {
      app = getApp();
      console.log('ğŸ”„ Using existing Firebase app');
    }
    db = getFirestore(app);
    
    // Make Firebase globally available
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    
    // Import additional Firestore functions
    import { collection, getDocs, addDoc, deleteDoc, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    window.collection = collection;
    window.getDocs = getDocs;
    window.addDoc = addDoc;
    window.deleteDoc = deleteDoc;
    window.query = query;
    window.where = where;
    
    const auth = getAuth(app);
    window.auth = auth;
    
    // AUTH STATE MANAGEMENT
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log('âŒ No Firebase Auth user, checking localStorage...');
        
        // Fallback to localStorage for non-migrated users
        const savedUser = localStorage.getItem('tanktools_current_user');
        const savedSession = sessionStorage.getItem('tanktools_session');
        
        if (!savedUser || !savedSession) {
          console.log('âŒ No session found, redirecting to login...');
          alert('ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
          window.location.href = 'login.html';
          return;
        }
        
        // Use localStorage data for non-migrated users
        const userData = JSON.parse(savedUser);
        console.log('âœ… Using localStorage session for:', userData.username);
        window.currentUser = userData;
        currentUser = userData;
        
        // Check page permissions (for now, allow dashboard users)
        if (typeof hasPageAccess === 'function') {
          if (!hasPageAccess(userData, 'dashboard.html')) {
            alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
            window.location.href = 'index.html';
            return;
          }
        }
        
        // Update UI with user name
        document.getElementById('userName').textContent = userData.name || userData.username;
        console.log('âœ… Vacation Planner loaded for:', userData.name);
        
        // Load user leaves
        await loadUserLeaves();
        
        // Load all leaves for annual roster
        await loadAllLeaves();
        return;
      }
      
      console.log('âœ… Firebase Auth user logged in:', user.email);
      
      // Get username from email
      const username = user.email.split('@')[0];
      console.log('ğŸ” Looking up user in Firestore:', username);
      
      // Get user data from Firestore
      try {
        const userDoc = await getDoc(doc(db, 'users', username));
        if (!userDoc.exists()) {
          console.error('âŒ User document not found for:', username);
          alert('Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
          await signOut(auth);
          window.location.href = 'login.html';
          return;
        }
        
        const userData = userDoc.data();
        window.currentUser = userData;
        currentUser = userData;
        
        // Check page permissions (for now, allow dashboard users)
        if (typeof hasPageAccess === 'function') {
          if (!hasPageAccess(userData, 'dashboard.html')) {
            alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
            window.location.href = 'index.html';
            return;
          }
        }
        
        // Update UI with user name
        document.getElementById('userName').textContent = userData.name || username;
        console.log('âœ… Vacation Planner loaded for:', userData.name);
        
        // Load user leaves
        await loadUserLeaves();
        
        // Load all leaves for annual roster
        await loadAllLeaves();
        
      } catch (error) {
        console.error('âŒ Error loading user data:', error);
        alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
        window.location.href = 'login.html';
      }
    });
  </script>
</body>
</html>
