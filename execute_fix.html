<!DOCTYPE html>
<html>
<head>
  <title>Execute PBCR Fix</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #1a1a2e; color: white; }
    .container { max-width: 800px; margin: 0 auto; }
    .log { background: #16213e; padding: 20px; border-radius: 10px; margin: 20px 0; }
    .success { color: #4CAF50; }
    .error { color: #f44336; }
    .info { color: #2196F3; }
    .warning { color: #ff9800; }
    pre { background: #0f1419; padding: 15px; border-radius: 5px; font-size: 14px; overflow-x: auto; }
    .btn { padding: 15px 30px; margin: 10px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: bold; }
    .btn:hover { background: #45a049; }
    .progress { width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; margin: 15px 0; }
    .progress-bar { height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s ease; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🔧 Execute PBCR Comments Fix</h1>
    
    <div class="log">
      <h2>📊 Status</h2>
      <div id="status">Ready to fix PBCR comments...</div>
      <button class="btn" onclick="startFix()">🚀 Start Auto Fix</button>
    </div>

    <div class="log" id="progressSection" style="display:none;">
      <h2>📈 Progress</h2>
      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div id="progressText">Initializing...</div>
    </div>

    <div class="log" id="resultsSection" style="display:none;">
      <h2>✅ Results</h2>
      <div id="results"></div>
    </div>

    <div class="log">
      <h2>📋 Console Log</h2>
      <pre id="consoleLog">Waiting for execution...</pre>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, updateDoc, collection, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // KNPC PBCR Standard Comments (barrels per meter)
    const tankComments = {
      "210": 1156.8, "211": 1156.8, "212": 1156.8, "213": 1156.8, "214": 1156.8,
      "215": 1156.8, "216": 1156.8, "217": 1156.8, "218": 1156.8, "219": 1156.8,
      "220": 1156.8, "221": 1156.8, "222": 1156.8, "223": 1156.8, "224": 1156.8,
      "225": 1234.5, "226": 1234.5, "227": 1234.5, "228": 1234.5, "229": 1234.5,
      "250": 1456.7, "251": 1456.7, "252": 1456.7, 
      "253": 1578.9, "254": 1578.9, "255": 1578.9, "256": 1578.9, 
      "257": 1578.9, "258": 1578.9, "259": 1578.9, "260": 1578.9,
      "270": 1789.2, "271": 1789.2, "272": 1789.2, "273": 1789.2, 
      "274": 1789.2, "275": 1789.2, "276": 1789.2, "277": 1789.2, 
      "278": 1789.2, "279": 1789.2
    };

    let consoleOutput = [];
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      consoleOutput.push(logEntry);
      
      // Update console display
      document.getElementById('consoleLog').textContent = consoleOutput.join('\n');
      
      // Update status
      const statusEl = document.getElementById('status');
      const span = document.createElement('div');
      span.className = type;
      span.textContent = logEntry;
      statusEl.appendChild(span);
      
      // Auto scroll to bottom
      statusEl.scrollTop = statusEl.scrollHeight;
      
      console.log(message);
    }

    window.startFix = async function() {
      try {
        log('🚀 Starting PBCR Comments Auto-Fix...', 'info');
        
        document.getElementById('progressSection').style.display = 'block';
        
        // Load all PBCR tanks
        log('📊 Loading PBCR tanks...', 'info');
        const tanksRef = collection(db, 'tankData', 'pbcr', 'tanks');
        const snapshot = await getDocs(tanksRef);
        
        let processed = 0;
        let updated = 0;
        let errors = 0;
        const total = snapshot.size;
        
        log(`📋 Found ${total} PBCR tanks`, 'info');
        
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        
        // Process each tank
        for (const docSnapshot of snapshot.docs) {
          const tankId = docSnapshot.id;
          const data = docSnapshot.data();
          
          processed++;
          
          try {
            // Update progress
            const progress = (processed / total) * 100;
            progressBar.style.width = progress + '%';
            progressText.textContent = `Processing Tank ${tankId}... (${processed}/${total})`;
            
            // Check if comment is missing or zero
            if (!data.comment || data.comment === 0) {
              const standardComment = tankComments[tankId] || 1200; // Default fallback
              
              // Update the tank with comment
              await updateDoc(docSnapshot.ref, {
                comment: standardComment,
                lastModified: serverTimestamp(),
                modifiedBy: 'auto-fix-script',
                fixedAt: new Date().toISOString()
              });
              
              log(`✅ Tank ${tankId}: Added comment = ${standardComment} bbl/m`, 'success');
              updated++;
              
            } else {
              log(`ℹ️ Tank ${tankId}: Comment already exists (${data.comment})`, 'info');
            }
            
            // Small delay to avoid rate limiting
            await new Promise(resolve => setTimeout(resolve, 30));
            
          } catch (tankError) {
            log(`❌ Tank ${tankId}: ${tankError.message}`, 'error');
            errors++;
          }
        }
        
        // Final results
        document.getElementById('resultsSection').style.display = 'block';
        const results = document.getElementById('results');
        
        results.innerHTML = `
          <div class="success">🎉 FIX COMPLETED!</div>
          <div class="info">📊 Total tanks processed: ${processed}</div>
          <div class="success">✅ Tanks updated: ${updated}</div>
          <div class="error">❌ Errors: ${errors}</div>
          <div class="info">💡 PBCR calculations should now work correctly!</div>
          <div class="warning">🔄 Refresh Tank Management page to see changes</div>
        `;
        
        log('🎉 === FIX COMPLETED ===', 'success');
        log(`📊 Total tanks processed: ${processed}`, 'info');
        log(`✅ Tanks updated: ${updated}`, 'success');
        log(`❌ Errors: ${errors}`, 'error');
        log('💡 PBCR calculations should now work correctly!', 'success');
        
        progressText.textContent = 'Fix completed successfully!';
        
      } catch (error) {
        log(`💥 Critical error: ${error.message}`, 'error');
        console.error('Critical error:', error);
      }
    };
  </script>
</body>
</html>