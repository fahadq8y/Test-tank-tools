<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”§ Ø£Ø¯Ø§Ø© ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø±ÙŠØª Ø§Ù„ÙØ¹Ù„ÙŠ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .main-content {
            padding: 30px;
        }
        
        .test-section {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .test-section h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .btn {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #c82333);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ffc107, #e0a800);
            color: #212529;
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
        }
        
        .result-box {
            background: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.4;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .success { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .error { background: #f8d7da; border-color: #f5c6cb; color: #721c24; }
        .warning { background: #fff3cd; border-color: #ffeaa7; color: #856404; }
        .info { background: #d1ecf1; border-color: #bee5eb; color: #0c5460; }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-left: 8px;
        }
        
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #495057;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Ø£Ø¯Ø§Ø© ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø±ÙŠØª Ø§Ù„ÙØ¹Ù„ÙŠ</h1>
            <p>ØªØ´Ø®ÙŠØµ Ø´Ø§Ù…Ù„ Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø±ÙŠØª Ø§Ù„ÙØ¹Ù„ÙŠ ÙŠØ±Ø¬Ø¹ ØµÙØ± ÙÙŠ Live Tanks</p>
        </div>
        
        <div class="main-content">
            
            <!-- Ù‚Ø³Ù… Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase -->
            <div class="test-section">
                <h3>ğŸ”¥ 1. ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase</h3>
                <button class="btn" onclick="testFirebaseConnection()">ğŸ” ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„</button>
                <button class="btn btn-info" onclick="loadFirebaseConfig()">âš™ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <div id="firebaseResult" class="result-box" style="display:none;"></div>
            </div>
            
            <!-- Ù‚Ø³Ù… ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª -->
            <div class="test-section">
                <h3>ğŸ—ï¸ 2. ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª</h3>
                <div class="grid">
                    <div>
                        <div class="input-group">
                            <label>Ø±Ù‚Ù… Ø§Ù„Ø®Ø²Ø§Ù†:</label>
                            <input type="text" id="testTankNumber" placeholder="Ù…Ø«Ø§Ù„: 221" value="221">
                        </div>
                        <div class="input-group">
                            <label>ÙˆØ­Ø¯Ø© Ø§Ù„Ø±ÙŠØª:</label>
                            <select id="testRateUnit">
                                <option value="bbl/hr">bbl/hr</option>
                                <option value="mÂ³/hr">mÂ³/hr</option>
                                <option value="MT/hr">MT/hr</option>
                                <option value="meter/hr">meter/hr</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="testTankData()">ğŸ” ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù†</button>
                <button class="btn btn-warning" onclick="testAllDepartments()">ğŸ“Š ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
                <div id="tankDataResult" class="result-box" style="display:none;"></div>
            </div>
            
            <!-- Ù‚Ø³Ù… Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª -->
            <div class="test-section">
                <h3>âš¡ 3. Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª Ø§Ù„ÙØ¹Ù„ÙŠ</h3>
                <div class="grid">
                    <div>
                        <div class="input-group">
                            <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ:</label>
                            <input type="number" id="testCurrentLevel" placeholder="5.5" value="5.5" step="0.1">
                        </div>
                        <div class="input-group">
                            <label>Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚:</label>
                            <input type="number" id="testPreviousLevel" placeholder="4.2" value="4.2" step="0.1">
                        </div>
                    </div>
                    <div>
                        <div class="input-group">
                            <label>ÙØ±Ù‚ Ø§Ù„ÙˆÙ‚Øª (Ø³Ø§Ø¹Ø§Øª):</label>
                            <input type="number" id="testTimeDiff" placeholder="1" value="1" step="0.1">
                        </div>
                    </div>
                </div>
                <button class="btn" onclick="simulateRateCalculation()">ğŸ§® Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</button>
                <button class="btn btn-info" onclick="testOriginalFunction()">ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©</button>
                <div id="calculationResult" class="result-box" style="display:none;"></div>
            </div>
            
            <!-- Ù‚Ø³Ù… ÙØ­Øµ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
            <div class="test-section">
                <h3>ğŸŒ 4. ÙØ­Øµ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h3>
                <button class="btn" onclick="checkGlobalVariables()">ğŸ” ÙØ­Øµ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª</button>
                <button class="btn btn-warning" onclick="inspectTanksObject()">ğŸ“‹ ÙØ­Øµ ÙƒØ§Ø¦Ù† Tanks</button>
                <button class="btn btn-danger" onclick="testErrorScenarios()">âŒ Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø®Ø·Ø£</button>
                <div id="globalResult" class="result-box" style="display:none;"></div>
            </div>
            
            <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ -->
            <div class="test-section">
                <h3>ğŸ“Š 5. Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØ§Ù„Ø­Ù„ÙˆÙ„</h3>
                <button class="btn" onclick="generateFullReport()">ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„</button>
                <button class="btn btn-info" onclick="suggestSolutions()">ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­ Ø§Ù„Ø­Ù„ÙˆÙ„</button>
                <div id="finalReport" class="result-box" style="display:none;"></div>
            </div>
            
        </div>
    </div>

    <!-- ØªØ­Ù…ÙŠÙ„ Firebase -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js';
        import { getFirestore, doc, getDoc, collection, getDocs, query, limit } from 'https://www.gstatic.com/firebasejs/10.4.0/firebase-firestore.js';
        
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDGpAHia_wEmrhnmYjrPf1n1TrAzwEk2lI",
            authDomain: "livetanks-b6f24.firebaseapp.com", 
            projectId: "livetanks-b6f24",
            storageBucket: "livetanks-b6f24.appspot.com",
            messagingSenderId: "278680662267",
            appId: "1:278680662267:web:d523362428f168238cdd7f"
        };

        // Initialize Firebase
        let app, db;
        let tanks = {}; // Global tanks object
        let currentEditingTank = null;
        let tanksLoaded = false;
        
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            console.log('âœ… Firebase initialized successfully');
            window.db = db;
            window.tanks = tanks;
            window.currentEditingTank = currentEditingTank;
            window.tanksLoaded = tanksLoaded;
        } catch (error) {
            console.error('âŒ Firebase initialization failed:', error);
        }
        
        // Make Firebase functions globally available
        window.doc = doc;
        window.getDoc = getDoc;
        window.collection = collection;
        window.getDocs = getDocs;
        window.query = query;
        window.limit = limit;
    </script>

    <script>
        // Global variables for testing
        let diagnosisResults = {};
        let testStartTime = new Date();
        
        // 1. Test Firebase Connection
        async function testFirebaseConnection() {
            const resultDiv = document.getElementById('firebaseResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">ğŸ”„ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firebase...</div>';
            
            let results = '<h4>ğŸ”¥ Ù†ØªØ§Ø¦Ø¬ ÙØ­Øµ Firebase:</h4>';
            
            try {
                // Check if Firebase is initialized
                if (typeof db !== 'undefined' && db) {
                    results += '<div class="success">âœ… Firebase Ù…Ù‡ÙŠØ£ Ø¨Ù†Ø¬Ø§Ø­ <span class="status-indicator status-ok"></span></div>';
                    
                    // Test basic connection
                    try {
                        const testRef = doc(db, 'test', 'connection');
                        const testDoc = await getDoc(testRef);
                        results += '<div class="success">âœ… Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Firestore ÙŠØ¹Ù…Ù„ <span class="status-indicator status-ok"></span></div>';
                    } catch (connError) {
                        results += '<div class="warning">âš ï¸ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„: ' + connError.message + ' <span class="status-indicator status-warning"></span></div>';
                    }
                    
                    // Test tankData collections
                    try {
                        const pbcrRef = collection(db, 'tankData', 'pbcr', 'tanks');
                        const pbcrQuery = query(pbcrRef, limit(1));
                        const pbcrSnapshot = await getDocs(pbcrQuery);
                        
                        results += '<div class="success">âœ… Ù…Ø¬Ù…ÙˆØ¹Ø© PBCR Ù…ØªØ§Ø­Ø© (' + pbcrSnapshot.size + ' Ø®Ø²Ø§Ù† Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±) <span class="status-indicator status-ok"></span></div>';
                        
                        const plcrRef = collection(db, 'tankData', 'plcr', 'tanks');
                        const plcrQuery = query(plcrRef, limit(1));
                        const plcrSnapshot = await getDocs(plcrQuery);
                        
                        results += '<div class="success">âœ… Ù…Ø¬Ù…ÙˆØ¹Ø© PLCR Ù…ØªØ§Ø­Ø© (' + plcrSnapshot.size + ' Ø®Ø²Ø§Ù† Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±) <span class="status-indicator status-ok"></span></div>';
                        
                    } catch (collError) {
                        results += '<div class="error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª: ' + collError.message + ' <span class="status-indicator status-error"></span></div>';
                    }
                    
                } else {
                    results += '<div class="error">âŒ Firebase ØºÙŠØ± Ù…Ù‡ÙŠØ£ <span class="status-indicator status-error"></span></div>';
                }
                
                // Check global variables
                results += '<h5 style="margin-top:15px;">ğŸŒ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©:</h5>';
                results += '<div>â€¢ window.db: ' + (typeof window.db !== 'undefined' ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯') + '</div>';
                results += '<div>â€¢ window.tanks: ' + (typeof window.tanks !== 'undefined' ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯ (' + Object.keys(window.tanks).length + ' Ø®Ø²Ø§Ù†)' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯') + '</div>';
                results += '<div>â€¢ window.tanksLoaded: ' + (typeof window.tanksLoaded !== 'undefined' ? window.tanksLoaded : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯') + '</div>';
                
            } catch (error) {
                results += '<div class="error">âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: ' + error.message + ' <span class="status-indicator status-error"></span></div>';
            }
            
            diagnosisResults.firebase = results;
            resultDiv.innerHTML = results;
        }
        
        // Load Firebase Configuration
        function loadFirebaseConfig() {
            const resultDiv = document.getElementById('firebaseResult');
            resultDiv.style.display = 'block';
            
            const config = `
<h4>âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase:</h4>
<div class="info">
<strong>Project ID:</strong> livetanks-b6f24<br>
<strong>Auth Domain:</strong> livetanks-b6f24.firebaseapp.com<br>
<strong>Database Structure:</strong><br>
&nbsp;&nbsp;â€¢ tankData/<br>
&nbsp;&nbsp;&nbsp;&nbsp;â”œâ”€â”€ pbcr/tanks/ (Ø®Ø²Ø§Ù†Ø§Øª PBCR)<br>
&nbsp;&nbsp;&nbsp;&nbsp;â””â”€â”€ plcr/tanks/ (Ø®Ø²Ø§Ù†Ø§Øª PLCR)<br>
</div>
            `;
            
            resultDiv.innerHTML = config;
        }
        
        // 2. Test Tank Data
        async function testTankData() {
            const resultDiv = document.getElementById('tankDataResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">ğŸ”„ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù†...</div>';
            
            const tankNumber = document.getElementById('testTankNumber').value;
            const rateUnit = document.getElementById('testRateUnit').value;
            
            let results = `<h4>ğŸ—ï¸ Ù†ØªØ§Ø¦Ø¬ ÙØ­Øµ Ø§Ù„Ø®Ø²Ø§Ù† ${tankNumber}:</h4>`;
            
            try {
                // Determine department based on rate unit
                let department = '';
                if (rateUnit === 'MT/hr') {
                    department = 'plcr';
                } else {
                    department = 'pbcr';
                }
                
                results += `<div class="info">ğŸ“Š ÙˆØ­Ø¯Ø© Ø§Ù„Ø±ÙŠØª: ${rateUnit} â†’ Ø§Ù„Ù‚Ø³Ù…: ${department}</div>`;
                
                // Check in global tanks object first
                if (window.tanks && window.tanks[tankNumber]) {
                    const tankData = window.tanks[tankNumber];
                    results += '<div class="success">âœ… Ø§Ù„Ø®Ø²Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ global tanks object <span class="status-indicator status-ok"></span></div>';
                    results += '<div class="info">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ' + JSON.stringify(tankData, null, 2) + '</div>';
                    
                    // Check BPM field
                    const bpmField = department === 'plcr' ? 'factor' : 'comment';
                    const bpmValue = tankData[bpmField];
                    
                    if (bpmValue && bpmValue > 0) {
                        results += `<div class="success">âœ… BPM (${bpmField}): ${bpmValue} <span class="status-indicator status-ok"></span></div>`;
                    } else {
                        results += `<div class="error">âŒ BPM (${bpmField}) ØºÙŠØ± ØµØ§Ù„Ø­: ${bmpValue} <span class="status-indicator status-error"></span></div>`;
                    }
                    
                } else {
                    results += '<div class="warning">âš ï¸ Ø§Ù„Ø®Ø²Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ global tanks object <span class="status-indicator status-warning"></span></div>';
                    
                    // Try to load directly from Firebase
                    try {
                        const tankRef = doc(db, 'tankData', department, 'tanks', tankNumber);
                        const tankDoc = await getDoc(tankRef);
                        
                        if (tankDoc.exists()) {
                            const tankData = tankDoc.data();
                            results += '<div class="success">âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø²Ø§Ù† ÙÙŠ Firebase <span class="status-indicator status-ok"></span></div>';
                            results += '<div class="info">Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase: ' + JSON.stringify(tankData, null, 2) + '</div>';
                            
                            // Cache it in global object
                            window.tanks[tankNumber] = tankData;
                            results += '<div class="info">ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ global tanks object</div>';
                            
                        } else {
                            results += '<div class="error">âŒ Ø§Ù„Ø®Ø²Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Firebase: tankData/' + department + '/tanks/' + tankNumber + ' <span class="status-indicator status-error"></span></div>';
                        }
                        
                    } catch (firebaseError) {
                        results += '<div class="error">âŒ Ø®Ø·Ø£ Firebase: ' + firebaseError.message + ' <span class="status-indicator status-error"></span></div>';
                    }
                }
                
                // Test other department as well
                const otherDepartment = department === 'plcr' ? 'pbcr' : 'plcr';
                try {
                    const otherTankRef = doc(db, 'tankData', otherDepartment, 'tanks', tankNumber);
                    const otherTankDoc = await getDoc(otherTankRef);
                    
                    if (otherTankDoc.exists()) {
                        results += `<div class="warning">âš ï¸ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø®Ø²Ø§Ù† Ù…ÙˆØ¬ÙˆØ¯ Ø£ÙŠØ¶Ø§Ù‹ ÙÙŠ Ù‚Ø³Ù… ${otherDepartment}! <span class="status-indicator status-warning"></span></div>`;
                    } else {
                        results += `<div class="info">â„¹ï¸ Ø§Ù„Ø®Ø²Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ù‚Ø³Ù… ${otherDepartment} (Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ)</div>`;
                    }
                } catch (error) {
                    // Ignore errors for other department check
                }
                
            } catch (error) {
                results += '<div class="error">âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…: ' + error.message + ' <span class="status-indicator status-error"></span></div>';
            }
            
            diagnosisResults.tankData = results;
            resultDiv.innerHTML = results;
        }
        
        // Test All Departments
        async function testAllDepartments() {
            const resultDiv = document.getElementById('tankDataResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">ğŸ”„ Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...</div>';
            
            let results = '<h4>ğŸ“Š ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…:</h4>';
            
            try {
                // Test PBCR department
                const pbcrRef = collection(db, 'tankData', 'pbcr', 'tanks');
                const pbcrSnapshot = await getDocs(pbcrRef);
                
                results += `<div class="success">âœ… Ù‚Ø³Ù… PBCR: ${pbcrSnapshot.size} Ø®Ø²Ø§Ù† <span class="status-indicator status-ok"></span></div>`;
                
                // List some tanks from PBCR
                let pbcrTanks = [];
                pbcrSnapshot.forEach((doc) => {
                    pbcrTanks.push(doc.id);
                });
                results += '<div class="info">Ø¹ÙŠÙ†Ø© Ù…Ù† Ø®Ø²Ø§Ù†Ø§Øª PBCR: ' + pbcrTanks.slice(0, 10).join(', ') + (pbcrTanks.length > 10 ? '...' : '') + '</div>';
                
                // Test PLCR department  
                const plcrRef = collection(db, 'tankData', 'plcr', 'tanks');
                const plcrSnapshot = await getDocs(plcrRef);
                
                results += `<div class="success">âœ… Ù‚Ø³Ù… PLCR: ${plcrSnapshot.size} Ø®Ø²Ø§Ù† <span class="status-indicator status-ok"></span></div>`;
                
                // List some tanks from PLCR
                let plcrTanks = [];
                plcrSnapshot.forEach((doc) => {
                    plcrTanks.push(doc.id);
                });
                results += '<div class="info">Ø¹ÙŠÙ†Ø© Ù…Ù† Ø®Ø²Ø§Ù†Ø§Øª PLCR: ' + plcrTanks.slice(0, 10).join(', ') + (plcrTanks.length > 10 ? '...' : '') + '</div>';
                
                // Check specific test tank in both departments
                const testTankNumber = document.getElementById('testTankNumber').value;
                if (testTankNumber) {
                    // Check in PBCR
                    try {
                        const pbcrTankRef = doc(db, 'tankData', 'pbcr', 'tanks', testTankNumber);
                        const pbcrTankDoc = await getDoc(pbcrTankRef);
                        if (pbcrTankDoc.exists()) {
                            results += `<div class="success">âœ… Ø®Ø²Ø§Ù† ${testTankNumber} Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ PBCR <span class="status-indicator status-ok"></span></div>`;
                        } else {
                            results += `<div class="warning">âš ï¸ Ø®Ø²Ø§Ù† ${testTankNumber} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ PBCR <span class="status-indicator status-warning"></span></div>`;
                        }
                    } catch (e) {}
                    
                    // Check in PLCR
                    try {
                        const plcrTankRef = doc(db, 'tankData', 'plcr', 'tanks', testTankNumber);
                        const plcrTankDoc = await getDoc(plcrTankRef);
                        if (plcrTankDoc.exists()) {
                            results += `<div class="success">âœ… Ø®Ø²Ø§Ù† ${testTankNumber} Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ PLCR <span class="status-indicator status-ok"></span></div>`;
                        } else {
                            results += `<div class="warning">âš ï¸ Ø®Ø²Ø§Ù† ${testTankNumber} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ PLCR <span class="status-indicator status-warning"></span></div>`;
                        }
                    } catch (e) {}
                }
                
            } catch (error) {
                results += '<div class="error">âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ' + error.message + ' <span class="status-indicator status-error"></span></div>';
            }
            
            resultDiv.innerHTML = results;
        }
        
        // 3. Simulate Rate Calculation
        async function simulateRateCalculation() {
            const resultDiv = document.getElementById('calculationResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div class="info">ğŸ”„ Ø¬Ø§Ø±ÙŠ Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª...</div>';
            
            const tankNumber = document.getElementById('testTankNumber').value;
            const rateUnit = document.getElementById('testRateUnit').value;
            const currentLevel = parseFloat(document.getElementById('testCurrentLevel').value);
            const previousLevel = parseFloat(document.getElementById('testPreviousLevel').value);
            const timeDiffHours = parseFloat(document.getElementById('testTimeDiff').value);
            
            let results = `<h4>âš¡ Ù…Ø­Ø§ÙƒØ§Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª:</h4>`;
            
            try {
                // Step 1: Input validation
                results += '<h5>ğŸ“‹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©:</h5>';
                
                if (!tankNumber) {
                    results += '<div class="error">âŒ Ø±Ù‚Ù… Ø§Ù„Ø®Ø²Ø§Ù† Ù…Ø·Ù„ÙˆØ¨ <span class="status-indicator status-error"></span></div>';
                    resultDiv.innerHTML = results;
                    return;
                }
                
                if (!currentLevel || isNaN(currentLevel)) {
                    results += '<div class="error">âŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­ <span class="status-indicator status-error"></span></div>';
                } else {
                    results += `<div class="success">âœ… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentLevel} Ù…ØªØ± <span class="status-indicator status-ok"></span></div>`;
                }
                
                if (!previousLevel || isNaN(previousLevel)) {
                    results += '<div class="error">âŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ ØºÙŠØ± ØµØ§Ù„Ø­ <span class="status-indicator status-error"></span></div>';
                } else {
                    results += `<div class="success">âœ… Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚: ${previousLevel} Ù…ØªØ± <span class="status-indicator status-ok"></span></div>`;
                }
                
                if (!timeDiffHours || isNaN(timeDiffHours) || timeDiffHours <= 0) {
                    results += '<div class="error">âŒ ÙØ±Ù‚ Ø§Ù„ÙˆÙ‚Øª ØºÙŠØ± ØµØ§Ù„Ø­ <span class="status-indicator status-error"></span></div>';
                } else {
                    results += `<div class="success">âœ… ÙØ±Ù‚ Ø§Ù„ÙˆÙ‚Øª: ${timeDiffHours} Ø³Ø§Ø¹Ø© <span class="status-indicator status-ok"></span></div>`;
                }
                
                // Step 2: Calculate level difference
                const levelDiff = Math.abs(currentLevel - previousLevel);
                results += `<div class="info">ğŸ“ ÙØ±Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${levelDiff.toFixed(3)} Ù…ØªØ±</div>`;
                
                // Step 3: Determine department
                let department = '';
                if (rateUnit === 'MT/hr') {
                    department = 'plcr';
                } else {
                    department = 'pbcr';
                }
                results += `<div class="info">ğŸ¢ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø­Ø¯Ø¯: ${department} (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆØ­Ø¯Ø© ${rateUnit})</div>`;
                
                // Step 4: Get tank data
                let tankData = null;
                
                // Check in global tanks object first
                if (window.tanks && window.tanks[tankNumber]) {
                    tankData = window.tanks[tankNumber];
                    results += '<div class="success">âœ… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† Ù…ØªÙˆÙØ±Ø© ÙÙŠ global object <span class="status-indicator status-ok"></span></div>';
                } else {
                    results += '<div class="warning">âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© ÙÙŠ global objectØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ù…Ù† Firebase... <span class="status-indicator status-warning"></span></div>';
                    
                    // Load from Firebase
                    const tankRef = doc(db, 'tankData', department, 'tanks', tankNumber);
                    const tankDoc = await getDoc(tankRef);
                    
                    if (tankDoc.exists()) {
                        tankData = tankDoc.data();
                        results += '<div class="success">âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† Ù…Ù† Firebase <span class="status-indicator status-ok"></span></div>';
                        // Cache it
                        window.tanks[tankNumber] = tankData;
                    } else {
                        results += '<div class="error">âŒ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Firebase <span class="status-indicator status-error"></span></div>';
                    }
                }
                
                // Step 5: Calculate rate
                let actualRate = 0;
                
                if (rateUnit === 'meter/hr' || rateUnit === 'mtr/hr' || rateUnit === 'mtr') {
                    // Direct calculation - no BPM needed
                    actualRate = levelDiff / timeDiffHours;
                    results += `<div class="success">âœ… Ø­Ø³Ø§Ø¨ Ù…Ø¨Ø§Ø´Ø± (meter/hr): ${actualRate.toFixed(3)} <span class="status-indicator status-ok"></span></div>`;
                    
                } else if (tankData) {
                    // BPM-based calculations
                    let bpm = 0;
                    
                    if (department === 'plcr') {
                        bpm = parseFloat(tankData.factor) || 0;
                        results += `<div class="info">ğŸ­ PLCR - BPM Ù…Ù† Ø­Ù‚Ù„ factor: ${bmp}</div>`;
                    } else {
                        bpm = parseFloat(tankData.comment) || 0;
                        results += `<div class="info">ğŸ›¢ï¸ PBCR - BPM Ù…Ù† Ø­Ù‚Ù„ comment: ${bmp}</div>`;
                    }
                    
                    if (bmp > 0) {
                        const volumeDiffBarrels = levelDiff * bmp;
                        let finalRate = volumeDiffBarrels / timeDiffHours;
                        
                        results += `<div class="info">ğŸ“Š Ø­Ø¬Ù… Ø§Ù„Ø§Ø®ØªÙ„Ø§Ù Ø¨Ø§Ù„Ø¨Ø±Ø§Ù…ÙŠÙ„: ${volumeDiffBarrels.toFixed(3)}</div>`;
                        results += `<div class="info">ğŸ“Š Ù…Ø¹Ø¯Ù„ Ø£ÙˆÙ„ÙŠ: ${finalRate.toFixed(3)} bbl/hr</div>`;
                        
                        if (rateUnit === 'mÂ³/hr' || rateUnit === 'm3/hr' || rateUnit === 'mÂ³' || rateUnit === 'm3') {
                            actualRate = finalRate * 0.159;
                            results += `<div class="success">âœ… ØªØ­ÙˆÙŠÙ„ Ù„Ù€ mÂ³/hr: ${actualRate.toFixed(3)} <span class="status-indicator status-ok"></span></div>`;
                            
                        } else if (rateUnit === 'MT/hr') {
                            actualRate = finalRate * 0.159 * 0.85;
                            results += `<div class="success">âœ… ØªØ­ÙˆÙŠÙ„ Ù„Ù€ MT/hr: ${actualRate.toFixed(3)} <span class="status-indicator status-ok"></span></div>`;
                            
                        } else {
                            actualRate = finalRate;
                            results += `<div class="success">âœ… bbl/hr: ${actualRate.toFixed(3)} <span class="status-indicator status-ok"></span></div>`;
                        }
                        
                    } else {
                        results += '<div class="error">âŒ BPM ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ÙŠØ³Ø§ÙˆÙŠ ØµÙØ± <span class="status-indicator status-error"></span></div>';
                        actualRate = 0;
                    }
                    
                } else {
                    results += '<div class="error">âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø³Ø§Ø¨ Ø§Ù„Ø±ÙŠØª Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† <span class="status-indicator status-error"></span></div>';
                    actualRate = 0;
                }
                
                // Final result
                results += `<h5 style="margin-top:20px; padding:10px; background:#e8f5e8; border-left:4px solid #28a745;">ğŸ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©: ${actualRate.toFixed(2)} ${rateUnit}</h5>`;
                
                if (actualRate === 0) {
                    results += '<div class="error">ğŸš¨ ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø±ÙŠØª ÙŠØ³Ø§ÙˆÙŠ ØµÙØ±! Ù‡Ø°Ø§ ÙŠÙØ³Ø± Ø§Ù„Ù…Ø´ÙƒÙ„Ø© <span class="status-indicator status-error"></span></div>';
                }
                
            } catch (error) {
                results += '<div class="error">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©: ' + error.message + ' <span class="status-indicator status-error"></span></div>';
            }
            
            diagnosisResults.calculation = results;
            resultDiv.innerHTML = results;
        }
        
        // Test Original Function (if available)
        function testOriginalFunction() {
            const resultDiv = document.getElementById('calculationResult');
            
            let results = '<h4>ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©:</h4>';
            
            // Check if calculateActualRate function exists
            if (typeof calculateActualRate === 'function') {
                results += '<div class="success">âœ… Ø¯Ø§Ù„Ø© calculateActualRate Ù…ÙˆØ¬ÙˆØ¯Ø© <span class="status-indicator status-ok"></span></div>';
                
                try {
                    // Mock the form inputs
                    const mockInputs = {
                        editCurrentLevel: document.getElementById('testCurrentLevel').value,
                        editPreviousLevelDisplay: document.getElementById('testPreviousLevel').value,
                        editRateUnit: document.getElementById('testRateUnit').value,
                        editTankNumber: document.getElementById('testTankNumber').value
                    };
                    
                    results += '<div class="info">Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©...</div>';
                    
                    // This would require mocking the DOM elements
                    results += '<div class="warning">âš ï¸ ÙŠØªØ·Ù„Ø¨ ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± ÙˆØ¬ÙˆØ¯ Ù†Ù…ÙˆØ°Ø¬ Live Tanks Ø§Ù„Ø£ØµÙ„ÙŠ <span class="status-indicator status-warning"></span></div>';
                    
                } catch (error) {
                    results += '<div class="error">âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©: ' + error.message + ' <span class="status-indicator status-error"></span></div>';
                }
                
            } else {
                results += '<div class="warning">âš ï¸ Ø¯Ø§Ù„Ø© calculateActualRate ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙŠØ§Ù‚ <span class="status-indicator status-warning"></span></div>';
                results += '<div class="info">Ù‡Ø°Ø§ Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ø£Ù†Ù†Ø§ ÙÙŠ ØµÙØ­Ø© ØªØ´Ø®ÙŠØµ Ù…Ù†ÙØµÙ„Ø©</div>';
            }
            
            resultDiv.innerHTML = results;
        }
        
        // 4. Check Global Variables
        function checkGlobalVariables() {
            const resultDiv = document.getElementById('globalResult');
            resultDiv.style.display = 'block';
            
            let results = '<h4>ğŸŒ ÙØ­Øµ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©:</h4>';
            
            // Check window.db
            if (typeof window.db !== 'undefined' && window.db) {
                results += '<div class="success">âœ… window.db Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ù‡ÙŠØ£ <span class="status-indicator status-ok"></span></div>';
            } else {
                results += '<div class="error">âŒ window.db ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ØºÙŠØ± Ù…Ù‡ÙŠØ£ <span class="status-indicator status-error"></span></div>';
            }
            
            // Check window.tanks
            if (typeof window.tanks !== 'undefined') {
                const tanksCount = Object.keys(window.tanks).length;
                if (tanksCount > 0) {
                    results += `<div class="success">âœ… window.tanks Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ${tanksCount} Ø®Ø²Ø§Ù† <span class="status-indicator status-ok"></span></div>`;
                } else {
                    results += '<div class="warning">âš ï¸ window.tanks Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ†Ù‡ ÙØ§Ø±Øº <span class="status-indicator status-warning"></span></div>';
                }
            } else {
                results += '<div class="error">âŒ window.tanks ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ <span class="status-indicator status-error"></span></div>';
            }
            
            // Check window.tanksLoaded
            if (typeof window.tanksLoaded !== 'undefined') {
                if (window.tanksLoaded) {
                    results += '<div class="success">âœ… window.tanksLoaded = true <span class="status-indicator status-ok"></span></div>';
                } else {
                    results += '<div class="warning">âš ï¸ window.tanksLoaded = false <span class="status-indicator status-warning"></span></div>';
                }
            } else {
                results += '<div class="warning">âš ï¸ window.tanksLoaded ØºÙŠØ± Ù…Ø­Ø¯Ø¯ <span class="status-indicator status-warning"></span></div>';
            }
            
            // Check window.currentEditingTank
            if (typeof window.currentEditingTank !== 'undefined' && window.currentEditingTank) {
                results += '<div class="success">âœ… window.currentEditingTank Ù…ÙˆØ¬ÙˆØ¯ <span class="status-indicator status-ok"></span></div>';
                results += '<div class="info">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† Ù‚ÙŠØ¯ Ø§Ù„ØªØ­Ø±ÙŠØ±: ' + JSON.stringify(window.currentEditingTank, null, 2) + '</div>';
            } else {
                results += '<div class="info">â„¹ï¸ window.currentEditingTank ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ (Ø·Ø¨ÙŠØ¹ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ ØªØ­Ø±ÙŠØ± Ø¬Ø§Ø±ÙŠ)</div>';
            }
            
            // Check other Firebase functions
            const firebaseFunctions = ['doc', 'getDoc', 'collection', 'getDocs', 'query', 'limit'];
            results += '<h5 style="margin-top:15px;">ğŸ”¥ ÙˆØ¸Ø§Ø¦Ù Firebase:</h5>';
            
            firebaseFunctions.forEach(funcName => {
                if (typeof window[funcName] !== 'undefined') {
                    results += `<div class="success">âœ… ${funcName} Ù…ØªÙˆÙØ± <span class="status-indicator status-ok"></span></div>`;
                } else {
                    results += `<div class="error">âŒ ${funcName} ØºÙŠØ± Ù…ØªÙˆÙØ± <span class="status-indicator status-error"></span></div>`;
                }
            });
            
            diagnosisResults.globals = results;
            resultDiv.innerHTML = results;
        }
        
        // Inspect Tanks Object
        function inspectTanksObject() {
            const resultDiv = document.getElementById('globalResult');
            resultDiv.style.display = 'block';
            
            let results = '<h4>ğŸ“‹ ÙØ­Øµ ØªÙØµÙŠÙ„ÙŠ Ù„ÙƒØ§Ø¦Ù† Tanks:</h4>';
            
            if (typeof window.tanks !== 'undefined' && window.tanks) {
                const tankIds = Object.keys(window.tanks);
                
                results += `<div class="info">ğŸ“Š Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª: ${tankIds.length}</div>`;
                
                if (tankIds.length > 0) {
                    results += '<h5>ğŸ—ï¸ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª:</h5>';
                    
                    // Show first 5 tanks
                    tankIds.slice(0, 5).forEach(tankId => {
                        const tankData = window.tanks[tankId];
                        results += `<div class="info"><strong>Ø®Ø²Ø§Ù† ${tankId}:</strong></div>`;
                        results += `<div style="margin-right:20px; font-family:monospace; font-size:11px;">${JSON.stringify(tankData, null, 2)}</div>`;
                    });
                    
                    if (tankIds.length > 5) {
                        results += `<div class="info">... Ùˆ ${tankIds.length - 5} Ø®Ø²Ø§Ù† Ø¢Ø®Ø±</div>`;
                    }
                    
                    // Check specific test tank
                    const testTankNumber = document.getElementById('testTankNumber').value;
                    if (testTankNumber && window.tanks[testTankNumber]) {
                        results += `<h5>ğŸ¯ Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${testTankNumber}):</h5>`;
                        results += `<div class="success">âœ… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙƒØ§Ø¦Ù† tanks <span class="status-indicator status-ok"></span></div>`;
                        results += `<div style="font-family:monospace; font-size:11px; background:#f8f9fa; padding:10px; border-radius:5px;">${JSON.stringify(window.tanks[testTankNumber], null, 2)}</div>`;
                    } else if (testTankNumber) {
                        results += `<h5>ğŸ¯ Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (${testTankNumber}):</h5>`;
                        results += '<div class="error">âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ ÙƒØ§Ø¦Ù† tanks <span class="status-indicator status-error"></span></div>';
                    }
                    
                } else {
                    results += '<div class="warning">âš ï¸ ÙƒØ§Ø¦Ù† tanks ÙØ§Ø±Øº <span class="status-indicator status-warning"></span></div>';
                }
                
            } else {
                results += '<div class="error">âŒ ÙƒØ§Ø¦Ù† tanks ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ null <span class="status-indicator status-error"></span></div>';
            }
            
            resultDiv.innerHTML = results;
        }
        
        // Test Error Scenarios
        function testErrorScenarios() {
            const resultDiv = document.getElementById('globalResult');
            resultDiv.style.display = 'block';
            
            let results = '<h4>âŒ Ø§Ø®ØªØ¨Ø§Ø± Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø®Ø·Ø£:</h4>';
            
            // Scenario 1: Tank not found
            results += '<h5>Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 1: Ø®Ø²Ø§Ù† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h5>';
            const nonExistentTank = '99999';
            if (window.tanks && !window.tanks[nonExistentTank]) {
                results += `<div class="success">âœ… Ø®Ø²Ø§Ù† ${nonExistentTank} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙƒÙ…Ø§ Ù…ØªÙˆÙ‚Ø¹ <span class="status-indicator status-ok"></span></div>`;
            } else {
                results += `<div class="warning">âš ï¸ Ø®Ø²Ø§Ù† ${nonExistentTank} Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø´ÙƒÙ„ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ <span class="status-indicator status-warning"></span></div>`;
            }
            
            // Scenario 2: Invalid BPM
            results += '<h5>Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 2: BPM ØºÙŠØ± ØµØ§Ù„Ø­</h5>';
            const testTankNumber = document.getElementById('testTankNumber').value;
            if (testTankNumber && window.tanks && window.tanks[testTankNumber]) {
                const tankData = window.tanks[testTankNumber];
                const comment = parseFloat(tankData.comment) || 0;
                const factor = parseFloat(tankData.factor) || 0;
                
                if (comment <= 0 && factor <= 0) {
                    results += '<div class="error">âŒ ÙƒÙ„Ø§ Ù…Ù† comment Ùˆ factor ØºÙŠØ± ØµØ§Ù„Ø­ÙŠÙ†! <span class="status-indicator status-error"></span></div>';
                } else if (comment > 0 && factor > 0) {
                    results += '<div class="info">â„¹ï¸ ÙƒÙ„Ø§ Ù…Ù† comment Ùˆ factor Ù…ØªÙˆÙØ±ÙŠÙ†</div>';
                } else if (comment > 0) {
                    results += '<div class="success">âœ… comment ØµØ§Ù„Ø­ Ù„Ù„Ù€ PBCR <span class="status-indicator status-ok"></span></div>';
                } else if (factor > 0) {
                    results += '<div class="success">âœ… factor ØµØ§Ù„Ø­ Ù„Ù„Ù€ PLCR <span class="status-indicator status-ok"></span></div>';
                }
            }
            
            // Scenario 3: Invalid inputs
            results += '<h5>Ø³ÙŠÙ†Ø§Ø±ÙŠÙˆ 3: Ù…Ø¯Ø®Ù„Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­Ø©</h5>';
            const currentLevel = document.getElementById('testCurrentLevel').value;
            const previousLevel = document.getElementById('testPreviousLevel').value;
            
            if (!currentLevel || isNaN(parseFloat(currentLevel))) {
                results += '<div class="error">âŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ ØºÙŠØ± ØµØ§Ù„Ø­ <span class="status-indicator status-error"></span></div>';
            }
            
            if (!previousLevel || isNaN(parseFloat(previousLevel))) {
                results += '<div class="error">âŒ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ ØºÙŠØ± ØµØ§Ù„Ø­ <span class="status-indicator status-error"></span></div>';
            }
            
            const levelDiff = Math.abs(parseFloat(currentLevel) - parseFloat(previousLevel));
            if (levelDiff === 0) {
                results += '<div class="warning">âš ï¸ ÙØ±Ù‚ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙŠØ³Ø§ÙˆÙŠ ØµÙØ± - Ø³ÙŠØ¤Ø¯ÙŠ Ù„Ø±ÙŠØª ØµÙØ±ÙŠ <span class="status-indicator status-warning"></span></div>';
            }
            
            resultDiv.innerHTML = results;
        }
        
        // 5. Generate Full Report
        function generateFullReport() {
            const resultDiv = document.getElementById('finalReport');
            resultDiv.style.display = 'block';
            
            let report = '<h4>ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ØªØ´Ø®ÙŠØµ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø±ÙŠØª Ø§Ù„ÙØ¹Ù„ÙŠ:</h4>';
            
            report += `<div class="info"><strong>â° ÙˆÙ‚Øª Ø§Ù„ØªØ´Ø®ÙŠØµ:</strong> ${new Date().toLocaleString('ar-SA')}</div>`;
            report += `<div class="info"><strong>ğŸ¯ Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ù…Ø®ØªØ¨Ø±:</strong> ${document.getElementById('testTankNumber').value}</div>`;
            report += `<div class="info"><strong>âš¡ ÙˆØ­Ø¯Ø© Ø§Ù„Ø±ÙŠØª:</strong> ${document.getElementById('testRateUnit').value}</div>`;
            
            report += '<h5 style="margin-top:20px; color:#dc3545;">ğŸš¨ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ù…ÙƒØªØ´ÙØ©:</h5>';
            
            let criticalIssues = [];
            let warnings = [];
            let recommendations = [];
            
            // Analyze results
            if (!window.db) {
                criticalIssues.push('Firebase ØºÙŠØ± Ù…Ù‡ÙŠØ£ Ø£Ùˆ ØºÙŠØ± Ù…ØªØµÙ„');
            }
            
            if (!window.tanks || Object.keys(window.tanks).length === 0) {
                criticalIssues.push('ÙƒØ§Ø¦Ù† tanks ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± Ù…Ø­Ù…Ù„');
                recommendations.push('ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase');
            }
            
            const testTankNumber = document.getElementById('testTankNumber').value;
            if (testTankNumber && window.tanks && !window.tanks[testTankNumber]) {
                criticalIssues.push(`Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† ${testTankNumber} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ÙƒØ§Ø¦Ù† tanks`);
                recommendations.push('ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø±Ù‚Ù… Ø§Ù„Ø®Ø²Ø§Ù† Ø£Ùˆ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­');
            }
            
            if (!window.tanksLoaded) {
                warnings.push('Ù…ØªØºÙŠØ± tanksLoaded ÙŠØ¸Ù‡Ø± false - Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©');
            }
            
            // Display issues
            if (criticalIssues.length > 0) {
                criticalIssues.forEach(issue => {
                    report += `<div class="error">âŒ ${issue} <span class="status-indicator status-error"></span></div>`;
                });
            } else {
                report += '<div class="success">âœ… Ù„Ù… ÙŠØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù…Ø´Ø§ÙƒÙ„ Ø­Ø±Ø¬Ø© <span class="status-indicator status-ok"></span></div>';
            }
            
            if (warnings.length > 0) {
                report += '<h5 style="margin-top:15px; color:#ffc107;">âš ï¸ ØªØ­Ø°ÙŠØ±Ø§Øª:</h5>';
                warnings.forEach(warning => {
                    report += `<div class="warning">âš ï¸ ${warning} <span class="status-indicator status-warning"></span></div>`;
                });
            }
            
            if (recommendations.length > 0) {
                report += '<h5 style="margin-top:15px; color:#28a745;">ğŸ’¡ Ø§Ù„ØªÙˆØµÙŠØ§Øª:</h5>';
                recommendations.forEach(rec => {
                    report += `<div class="success">âœ… ${rec}</div>`;
                });
            }
            
            // Root cause analysis
            report += '<h5 style="margin-top:20px; color:#6f42c1;">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø¬Ø°Ø±ÙŠ:</h5>';
            
            if (criticalIssues.length > 0) {
                report += '<div class="error">ğŸ¯ <strong>Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø§Ø­ØªÙ…Ø§Ù„Ø§Ù‹:</strong> Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…Ø­Ù…Ù„Ø© ÙÙŠ ÙƒØ§Ø¦Ù† tanks Ø§Ù„Ø¹Ø§Ù…</div>';
                report += '<div class="error">ğŸ”§ <strong>Ø§Ù„Ø­Ù„ Ø§Ù„Ù…Ù‚ØªØ±Ø­:</strong> ØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase ÙˆØ¶Ù…Ø§Ù† ØªØ­Ù…ÙŠÙ„Ù‡Ø§ ÙÙŠ Ø§Ù„ÙƒØ§Ø¦Ù† Ø§Ù„Ø¹Ø§Ù…</div>';
            } else {
                report += '<div class="success">âœ… Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù…Ù„Ø© Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ - Ø§Ù„Ù…Ø´ÙƒÙ„Ø© Ù‚Ø¯ ØªÙƒÙˆÙ† ÙÙŠ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨</div>';
            }
            
            diagnosisResults.fullReport = report;
            resultDiv.innerHTML = report;
        }
        
        // Suggest Solutions
        function suggestSolutions() {
            const resultDiv = document.getElementById('finalReport');
            
            let solutions = '<h4>ğŸ’¡ Ø§Ù„Ø­Ù„ÙˆÙ„ Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©:</h4>';
            
            solutions += '<div class="success"><h5>ğŸ”§ Ø§Ù„Ø­Ù„ Ø§Ù„Ø£ÙˆÙ„: ØªØ­Ø³ÙŠÙ† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h5>';
            solutions += '<div style="margin-right:20px;">'; 
            solutions += 'â€¢ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ waitForTanks()<br>';
            solutions += 'â€¢ Ø¥Ø¶Ø§ÙØ© retry mechanism Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø§Ù„Ù…Ø­Ù…Ù„Ø©<br>';
            solutions += 'â€¢ ØªØ­Ø³ÙŠÙ† error handling Ùˆlogging<br>';
            solutions += '</div></div>';
            
            solutions += '<div class="info"><h5>ğŸ”„ Ø§Ù„Ø­Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø¥ØµÙ„Ø§Ø­ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø³Ù…</h5>';
            solutions += '<div style="margin-right:20px;">';
            solutions += 'â€¢ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ (PLCR vs PBCR)<br>';
            solutions += 'â€¢ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„ØµØ­ÙŠØ­ (factor vs comment)<br>';
            solutions += 'â€¢ Ø¥Ø¶Ø§ÙØ© fallback Ù„Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰<br>';
            solutions += '</div></div>';
            
            solutions += '<div class="warning"><h5>âš¡ Ø§Ù„Ø­Ù„ Ø§Ù„Ø«Ø§Ù„Ø«: ØªØ­Ø³ÙŠÙ† Ø¯Ø§Ù„Ø© calculateActualRate</h5>';
            solutions += '<div style="margin-right:20px;">';
            solutions += 'â€¢ Ø¥Ø¶Ø§ÙØ© validation Ù„Ù„Ù…Ø¯Ø®Ù„Ø§Øª<br>';
            solutions += 'â€¢ ØªØ­Ø³ÙŠÙ† error messages Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…<br>';
            solutions += 'â€¢ Ø¥Ø¶Ø§ÙØ© visual feedback Ù„Ù„Ø­Ù‚ÙˆÙ„<br>';
            solutions += '</div></div>';
            
            solutions += '<div class="error"><h5>ğŸš¨ Ø§Ù„Ø­Ù„ Ø§Ù„Ø¹Ø§Ø¬Ù„: Workaround Ù…Ø¤Ù‚Øª</h5>';
            solutions += '<div style="margin-right:20px;">';
            solutions += 'â€¢ Ø¥Ø¶Ø§ÙØ© ØªØ­Ù…ÙŠÙ„ Ù…Ø¨Ø§Ø´Ø± Ù…Ù† Firebase ÙÙŠ calculateActualRate()<br>';
            solutions += 'â€¢ Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø© ØªØ´Ø®ÙŠØµ Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ Live Tanks<br>';
            solutions += 'â€¢ ØªØ­Ø³ÙŠÙ† Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø®Ø·Ø£ Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…<br>';
            solutions += '</div></div>';
            
            // Add implementation code examples
            solutions += '<h5 style="margin-top:20px;">ğŸ“ Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø³Ù†:</h5>';
            solutions += `<pre style="background:#f8f9fa; padding:10px; border-radius:5px; font-size:11px; overflow-x:auto;">
// Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ø§ ÙÙŠ calculateActualRate()
if (!tanks || !tanks[tankNumber]) {
    console.log('âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø²Ø§Ù† ØºÙŠØ± Ù…Ø­Ù…Ù„Ø©ØŒ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
    
    // Determine department
    const dept = rateUnit === 'MT/hr' ? 'plcr' : 'pbcr';
    
    try {
        const tankRef = doc(db, 'tankData', dept, 'tanks', tankNumber);
        const tankDoc = await getDoc(tankRef);
        
        if (tankDoc.exists()) {
            tanks[tankNumber] = tankDoc.data();
            console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
            setTimeout(() => calculateActualRate(), 300);
            return;
        }
    } catch (error) {
        console.error('âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
        actualRate = 0;
        return;
    }
}
            </pre>`;
            
            resultDiv.innerHTML = solutions;
        }
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ”§ Ø£Ø¯Ø§Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…');
            
            // Auto-run Firebase connection test
            setTimeout(() => {
                testFirebaseConnection();
            }, 1000);
        });
    </script>
</body>
</html>