<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Firebase Paths - Rate Calculation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #FFD700;
            font-size: 2rem;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 4px solid #007AFF;
        }
        .section-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: #007AFF;
            margin-bottom: 15px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #FFD700;
        }
        input, select {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
            box-sizing: border-box;
        }
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.3s ease;
        }
        .btn-test {
            background: linear-gradient(45deg, #007AFF, #5856D6);
            color: white;
        }
        .btn-test:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        .results {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        .result-item {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        .success {
            border-left: 4px solid #34C759;
        }
        .error {
            border-left: 4px solid #FF3B30;
        }
        .warning {
            border-left: 4px solid #FF9500;
        }
        .info {
            border-left: 4px solid #007AFF;
        }
        .path-info {
            background: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }
        .data-preview {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Firebase Paths Ù„Ù„Ù€ Rate Calculation</h1>
        
        <div class="path-info">
            <h3>ğŸ“‹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø§Ø®ØªØ¨Ø§Ø±Ù‡:</h3>
            <p><strong>ğŸŸ¦ PBCR Path:</strong> Ù„Ù„Ù€ Rate Units: meter/hr, bbl/hr, mÂ³/hr</p>
            <p><strong>ğŸŸª PLCR Path:</strong> Ù„Ù„Ù€ Rate Unit: MT/hr</p>
        </div>

        <div class="test-section">
            <div class="section-title">ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Tank Number Ùˆ Rate Unit</div>
            
            <div class="form-group">
                <label>ğŸ·ï¸ Ø±Ù‚Ù… Ø§Ù„Ø®Ø²Ø§Ù†:</label>
                <select id="testTankNumber">
                    <option value="221">Tank 221</option>
                    <option value="460">Tank 460</option>
                    <option value="462">Tank 462</option>
                    <option value="834">Tank 834</option>
                    <option value="833">Tank 833</option>
                    <option value="520">Tank 520</option>
                    <option value="521">Tank 521</option>
                </select>
            </div>

            <div class="form-group">
                <label>ğŸ“Š Rate Unit:</label>
                <select id="testRateUnit">
                    <option value="meter/hr">meter/hr (PBCR)</option>
                    <option value="bbl/hr">bbl/hr (PBCR)</option>
                    <option value="mÂ³/hr">mÂ³/hr (PBCR)</option>
                    <option value="MT/hr">MT/hr (PLCR)</option>
                </select>
            </div>

            <div class="form-group">
                <label>ğŸ“ Current Level (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±):</label>
                <input type="number" id="testCurrentLevel" value="10.5" step="0.1">
            </div>

            <div class="form-group">
                <label>ğŸ“ Previous Level (Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±):</label>
                <input type="number" id="testPreviousLevel" value="8.2" step="0.1">
            </div>

            <button class="btn btn-test" onclick="testFirebasePaths()">
                ğŸ§ª Ø§Ø®ØªØ¨Ø± Firebase Paths
            </button>
        </div>

        <div class="test-section">
            <div class="section-title">ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</div>
            <div id="testResults" class="results">
                <p>Ø§Ø¶ØºØ· "Ø§Ø®ØªØ¨Ø± Firebase Paths" Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</p>
            </div>
        </div>

        <div class="test-section">
            <div class="section-title">ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø§Ù„ÙØ¹Ù„ÙŠØ©</div>
            <div id="firebaseData" class="data-preview">
                Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§...
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js';

        // Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyCBdaH6j5meX5w_m8dxOCdYFyRU3SYe7Y4",
            authDomain: "livetanks-d4dc2.firebaseapp.com",
            projectId: "livetanks-d4dc2",
            storageBucket: "livetanks-d4dc2.appspot.com",
            messagingSenderId: "677395694442",
            appId: "1:677395694442:web:0110bb743ceef889bab077"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make available globally
        window.db = db;
        window.getDocs = getDocs;
        window.getDoc = getDoc;
        window.collection = collection;
        window.doc = doc;

        console.log('âœ… Firebase initialized for testing');
    </script>

    <script>
        let currentTestResults = {};

        async function testFirebasePaths() {
            const tankNumber = document.getElementById('testTankNumber').value;
            const rateUnit = document.getElementById('testRateUnit').value;
            const currentLevel = parseFloat(document.getElementById('testCurrentLevel').value);
            const previousLevel = parseFloat(document.getElementById('testPreviousLevel').value);

            const resultsDiv = document.getElementById('testResults');
            const firebaseDiv = document.getElementById('firebaseData');
            
            resultsDiv.innerHTML = '<p>ğŸ”„ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±...</p>';
            firebaseDiv.innerHTML = 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...';

            try {
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø± Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ù€ Rate
                let collectionPath = '';
                let expectedPath = '';
                
                if (rateUnit === 'MT/hr') {
                    collectionPath = 'tankData/plcr/tanks';
                    expectedPath = 'PLCR';
                } else {
                    collectionPath = 'tankData/pbcr/tanks'; 
                    expectedPath = 'PBCR';
                }

                // Ø§Ø®ØªØ¨Ø§Ø± 1: ÙØ­Øµ ÙˆØ¬ÙˆØ¯ Collection
                const testResults = [];
                testResults.push({
                    test: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§Ø±',
                    result: `Rate Unit: ${rateUnit} â†’ Path: ${collectionPath}`,
                    status: 'info'
                });

                // Ø§Ø®ØªØ¨Ø§Ø± 2: Ù…Ø­Ø§ÙˆÙ„Ø© Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
                let tankData = null;
                let allTanksData = {};

                try {
                    // Use the same method as live-tanks.html
                    const pathType = rateUnit === 'MT/hr' ? 'plcr' : 'pbcr';
                    const tanksCollection = window.collection(window.db, 'tankData', pathType, 'tanks');
                    const tanksSnapshot = await window.getDocs(tanksCollection);
                    
                    tanksSnapshot.forEach((doc) => {
                        allTanksData[doc.id] = doc.data();
                    });

                    tankData = allTanksData[tankNumber];

                    testResults.push({
                        test: 'Ù‚Ø±Ø§Ø¡Ø© Collection',
                        result: `ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${Object.keys(allTanksData).length} Ø®Ø²Ø§Ù† ÙÙŠ ${collectionPath}`,
                        status: 'success'
                    });

                    if (tankData) {
                        testResults.push({
                            test: 'ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨',
                            result: `âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Tank ${tankNumber} ÙÙŠ ${expectedPath}`,
                            status: 'success'
                        });
                    } else {
                        testResults.push({
                            test: 'ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø®Ø²Ø§Ù† Ø§Ù„Ù…Ø·Ù„ÙˆØ¨',
                            result: `âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Tank ${tankNumber} ÙÙŠ ${expectedPath}`,
                            status: 'error'
                        });
                    }

                } catch (error) {
                    testResults.push({
                        test: 'Ù‚Ø±Ø§Ø¡Ø© Collection',
                        result: `âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ${collectionPath}: ${error.message}`,
                        status: 'error'
                    });
                }

                // Ø§Ø®ØªØ¨Ø§Ø± 3: Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ Rate Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªØ§Ø­Ø©
                if (tankData) {
                    const levelDiff = Math.abs(currentLevel - previousLevel);
                    const timeDiffHours = 2; // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
                    let calculatedRate = 0;
                    let calculationDetails = '';

                    if (rateUnit === 'meter/hr') {
                        calculatedRate = levelDiff / timeDiffHours;
                        calculationDetails = `${levelDiff} m Ã· ${timeDiffHours} hr = ${calculatedRate.toFixed(2)} m/hr`;
                        
                        testResults.push({
                            test: 'Ø­Ø³Ø§Ø¨ Rate (meter/hr)',
                            result: calculationDetails,
                            status: 'success'
                        });

                    } else if (rateUnit === 'bbl/hr' || rateUnit === 'mÂ³/hr' || rateUnit === 'MT/hr') {
                        const bpm = tankData.comment || 'ØºÙŠØ± Ù…ØªØ§Ø­';
                        
                        if (typeof bpm === 'number') {
                            const volumeDiffBarrels = levelDiff * bpm;
                            let finalRate = volumeDiffBarrels / timeDiffHours;
                            
                            if (rateUnit === 'mÂ³/hr') {
                                finalRate = finalRate * 0.159; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ mÂ³
                                calculationDetails = `(${levelDiff} m Ã— ${bpm} BPM Ã· ${timeDiffHours} hr) Ã— 0.159 = ${finalRate.toFixed(2)} mÂ³/hr`;
                            } else if (rateUnit === 'MT/hr') {
                                finalRate = finalRate * 0.159 * 0.85; // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ MT
                                calculationDetails = `(${levelDiff} m Ã— ${bpm} BPM Ã· ${timeDiffHours} hr) Ã— 0.159 Ã— 0.85 = ${finalRate.toFixed(2)} MT/hr`;
                            } else {
                                calculationDetails = `(${levelDiff} m Ã— ${bpm} BPM) Ã· ${timeDiffHours} hr = ${finalRate.toFixed(2)} bbl/hr`;
                            }
                            
                            calculatedRate = finalRate;
                            
                            testResults.push({
                                test: `Ø­Ø³Ø§Ø¨ Rate (${rateUnit})`,
                                result: `BPM: ${bpm} â†’ ${calculationDetails}`,
                                status: 'success'
                            });
                        } else {
                            testResults.push({
                                test: `Ø­Ø³Ø§Ø¨ Rate (${rateUnit})`,
                                result: `âŒ BPM ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (comment = ${bpm})`,
                                status: 'error'
                            });
                        }
                    }
                }

                // Ø§Ø®ØªØ¨Ø§Ø± 4: ÙØ­Øµ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                let alternativeData = {};
                const alternativePath = rateUnit === 'MT/hr' ? 'tankData/pbcr/tanks' : 'tankData/plcr/tanks';
                
                try {
                    const altPathType = rateUnit === 'MT/hr' ? 'pbcr' : 'plcr';
                    const altCollection = window.collection(window.db, 'tankData', altPathType, 'tanks');
                    const altSnapshot = await window.getDocs(altCollection);
                    
                    altSnapshot.forEach((doc) => {
                        alternativeData[doc.id] = doc.data();
                    });

                    const altTankExists = alternativeData[tankNumber];
                    
                    testResults.push({
                        test: 'ÙØ­Øµ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¨Ø¯ÙŠÙ„',
                        result: `Tank ${tankNumber} ÙÙŠ ${alternativePath}: ${altTankExists ? 'âœ… Ù…ÙˆØ¬ÙˆØ¯' : 'âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'}`,
                        status: altTankExists ? 'warning' : 'info'
                    });

                } catch (error) {
                    testResults.push({
                        test: 'ÙØ­Øµ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¨Ø¯ÙŠÙ„',
                        result: `Ø®Ø·Ø£ ÙÙŠ Ù‚Ø±Ø§Ø¡Ø© ${alternativePath}: ${error.message}`,
                        status: 'warning'
                    });
                }

                // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
                displayTestResults(testResults);
                displayFirebaseData(allTanksData, tankNumber, collectionPath, alternativeData, alternativePath);

                currentTestResults = {
                    tankNumber,
                    rateUnit,
                    expectedPath: collectionPath,
                    tankData,
                    testResults
                };

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result-item error">
                        âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}
                    </div>
                `;
            }
        }

        function displayTestResults(results) {
            const resultsDiv = document.getElementById('testResults');
            let html = '<h4>ğŸ“Š Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±:</h4>';
            
            results.forEach((result, index) => {
                html += `
                    <div class="result-item ${result.status}">
                        <strong>${index + 1}. ${result.test}:</strong><br>
                        ${result.result}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

        function displayFirebaseData(mainData, tankNumber, mainPath, altData, altPath) {
            const firebaseDiv = document.getElementById('firebaseData');
            
            let html = `<h4>ğŸ“ Ø¨ÙŠØ§Ù†Ø§Øª Firebase:</h4>`;
            
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            html += `<h5>ğŸ” ${mainPath}:</h5>`;
            if (Object.keys(mainData).length > 0) {
                html += `<div>Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${Object.keys(mainData).join(', ')}</div>`;
                
                if (mainData[tankNumber]) {
                    html += `<div><strong>Tank ${tankNumber} Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong></div>`;
                    html += `<pre>${JSON.stringify(mainData[tankNumber], null, 2)}</pre>`;
                } else {
                    html += `<div>âŒ Tank ${tankNumber} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`;
                }
            } else {
                html += `<div>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ${mainPath}</div>`;
            }
            
            // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø¨Ø¯ÙŠÙ„
            html += `<h5>ğŸ”„ ${altPath} (Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©):</h5>`;
            if (Object.keys(altData).length > 0) {
                html += `<div>Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø©: ${Object.keys(altData).join(', ')}</div>`;
                
                if (altData[tankNumber]) {
                    html += `<div><strong>Tank ${tankNumber} Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</strong></div>`;
                    html += `<pre>${JSON.stringify(altData[tankNumber], null, 2)}</pre>`;
                } else {
                    html += `<div>âŒ Tank ${tankNumber} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</div>`;
                }
            } else {
                html += `<div>âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ ${altPath}</div>`;
            }
            
            firebaseDiv.innerHTML = html;
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ§ª Test page loaded');
        });
    </script>
</body>
</html>