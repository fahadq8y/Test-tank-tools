<!DOCTYPE html>
<html>
<head>
    <title>Debug Index Tank Loading</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial; margin: 20px; background: #1a1a1a; color: white; }
        .result { margin: 10px 0; padding: 15px; border-radius: 8px; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .info { background: #2d4a5a; }
        .warning { background: #5a4a2d; }
        button { background: #4CAF50; color: white; border: none; padding: 15px 25px; margin: 10px; cursor: pointer; border-radius: 8px; }
        .code { background: #333; padding: 10px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>ğŸ” Debug Index Tank Loading - ØªØ´Ø®ÙŠØµ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª</h1>
    
    <div class="info">
        <h3>ğŸ¯ Ø§Ù„Ù‡Ø¯Ù:</h3>
        <p>Ù…Ø­Ø§ÙƒØ§Ø© Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ ÙÙŠ ØµÙØ­Ø© Index ÙˆÙ…Ø¹Ø±ÙØ© Ù„ÙŠØ´ Ù…Ùˆ Ù‚Ø§Ø¯Ø± ÙŠØ³Ø­Ø¨ Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª</p>
    </div>
    
    <button onclick="simulateIndexLoading()">ğŸš€ Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Index</button>
    <button onclick="testSpecificTanks()">â›½ Ø§Ø®ØªØ¨Ø§Ø± Ø®Ø²Ø§Ù†Ø§Øª Ù…Ø­Ø¯Ø¯Ø© (460-464)</button>
    <button onclick="testDataStructure()">ğŸ“Š ÙØ­Øµ Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    
    <div id="results"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { 
            getFirestore, doc, getDoc, setDoc, collection, 
            addDoc, serverTimestamp, getDocs 
        } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Same Firebase config as Index
        const firebaseConfig = {
            apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
            authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
            projectId: "tank-tools-knpc-c2d95",
            storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
            messagingSenderId: "510062594324",
            appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make same globals as Index
        window.db = db;
        window.doc = doc;
        window.getDoc = getDoc;
        window.setDoc = setDoc;
        window.addDoc = addDoc;
        window.serverTimestamp = serverTimestamp;
        window.collection = collection;
        window.getDocs = getDocs;
        
        function addResult(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `result ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong> - ${message}`;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }
        
        // Copy exact function from Index.html
        async function fetchTankSpecifications() {
            const departments = ['pbcr', 'plcr', 'washery'];
            let allTanks = {};
            
            addResult('ğŸ”„ Loading tank specifications from Firebase...', 'info');
            
            // Check if Firebase is ready
            if (!window.db || !window.collection || !window.getDocs) {
                addResult('âŒ Firebase not initialized yet', 'error');
                throw new Error('Firebase not ready - please refresh the page');
            }
            
            try {
                for (const dept of departments) {
                    addResult(`ğŸ“Š Loading ${dept.toUpperCase()} tanks...`, 'info');
                    // Try multiple possible paths for tank data
                    let querySnapshot = null;
                    let tanksCollectionRef = null;
                    
                    // Method 1: Try tankData/dept/tanks (current method)
                    try {
                        tanksCollectionRef = collection(window.db, "tankData", dept, "tanks");
                        querySnapshot = await getDocs(tanksCollectionRef);
                        if (querySnapshot && !querySnapshot.empty) {
                            addResult(`âœ… Found tanks in tankData/${dept}/tanks - ${querySnapshot.size} documents`, 'success');
                        }
                    } catch (error) {
                        addResult(`âŒ tankData/${dept}/tanks failed: ${error.message}`, 'error');
                    }
                    
                    // Method 2: Try dept/tanks if first method failed or returned empty
                    if (!querySnapshot || querySnapshot.empty) {
                        try {
                            tanksCollectionRef = collection(window.db, dept, "tanks");
                            querySnapshot = await getDocs(tanksCollectionRef);
                            if (querySnapshot && !querySnapshot.empty) {
                                addResult(`âœ… Found tanks in ${dept}/tanks`, 'success');
                            }
                        } catch (error) {
                            addResult(`âŒ ${dept}/tanks failed: ${error.message}`, 'error');
                        }
                    }
                    
                    // Method 3: Try tankData/dept directly if still empty
                    if (!querySnapshot || querySnapshot.empty) {
                        try {
                            tanksCollectionRef = collection(window.db, "tankData", dept);
                            querySnapshot = await getDocs(tanksCollectionRef);
                            if (querySnapshot && !querySnapshot.empty) {
                                addResult(`âœ… Found tanks in tankData/${dept}`, 'success');
                            }
                        } catch (error) {
                            addResult(`âŒ tankData/${dept} failed: ${error.message}`, 'error');
                        }
                    }
                    
                    if (querySnapshot && !querySnapshot.empty) {
                        querySnapshot.forEach(doc => {
                            const data = doc.data();
                            allTanks[doc.id] = data;
                            addResult(`   ğŸ“„ Tank ${doc.id}: ${data.product || 'N/A'} (${data.volume || data.capacity || 'N/A'}mÂ³)`, 'info');
                        });
                    } else {
                        addResult(`âš ï¸ No tanks found for department: ${dept}`, 'warning');
                    }
                }
                
                addResult(`ğŸ‰ Total tanks loaded: ${Object.keys(allTanks).length}`, 'success');
                addResult(`ğŸ“‹ Tank IDs: ${Object.keys(allTanks).join(', ')}`, 'info');
                
                return allTanks;
                
            } catch (error) {
                addResult(`âŒ Critical error: ${error.message}`, 'error');
                throw error;
            }
        }
        
        window.simulateIndexLoading = async function() {
            document.getElementById('results').innerHTML = '';
            addResult('ğŸš€ Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ù…ÙŠÙ„ Ø®Ø²Ø§Ù†Ø§Øª Index Ø¨Ø§Ù„Ø¶Ø¨Ø·...', 'info');
            
            try {
                const tanks = await fetchTankSpecifications();
                
                // Check specific tanks that Index needs
                const requiredTanks = ['460', '461', '462', '463', '464'];
                let foundTanks = [];
                let missingTanks = [];
                
                requiredTanks.forEach(tankId => {
                    if (tanks[tankId]) {
                        foundTanks.push(tankId);
                    } else {
                        missingTanks.push(tankId);
                    }
                });
                
                addResult(`âœ… Found required tanks: ${foundTanks.join(', ') || 'None'}`, foundTanks.length > 0 ? 'success' : 'warning');
                addResult(`âŒ Missing required tanks: ${missingTanks.join(', ') || 'None'}`, missingTanks.length > 0 ? 'error' : 'success');
                
                if (foundTanks.length === requiredTanks.length) {
                    addResult('ğŸ‰ ALL REQUIRED TANKS FOUND! Index should work!', 'success');
                } else {
                    addResult(`âš ï¸ ${missingTanks.length} tanks missing. Index might have issues.`, 'warning');
                }
                
            } catch (error) {
                addResult(`ğŸ’¥ Same error as Index: ${error.message}`, 'error');
            }
        };
        
        window.testSpecificTanks = async function() {
            addResult('â›½ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø®Ø²Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø¨Ø§Ø´Ø±Ø©...', 'info');
            
            const requiredTanks = ['460', '461', '462', '463', '464'];
            
            for (const tankId of requiredTanks) {
                try {
                    const tankRef = doc(db, 'tankData', 'pbcr', 'tanks', tankId);
                    const tankDoc = await getDoc(tankRef);
                    
                    if (tankDoc.exists()) {
                        const data = tankDoc.data();
                        addResult(`âœ… Tank ${tankId}: EXISTS - ${JSON.stringify(data, null, 2)}`, 'success');
                    } else {
                        addResult(`âŒ Tank ${tankId}: NOT FOUND`, 'error');
                    }
                } catch (error) {
                    addResult(`âŒ Error checking Tank ${tankId}: ${error.message}`, 'error');
                }
            }
        };
        
        window.testDataStructure = async function() {
            addResult('ğŸ“Š ÙØ­Øµ Ù‡ÙŠÙƒÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Firebase...', 'info');
            
            try {
                const pbcrRef = collection(db, 'tankData', 'pbcr', 'tanks');
                const snapshot = await getDocs(pbcrRef);
                
                addResult(`ğŸ“ tankData/pbcr/tanks contains ${snapshot.size} documents`, 'info');
                
                const tankIds = [];
                const sampleData = {};
                
                snapshot.forEach(doc => {
                    tankIds.push(doc.id);
                    if (tankIds.length <= 5) {
                        sampleData[doc.id] = doc.data();
                    }
                });
                
                addResult(`ğŸ“„ All tank IDs: ${tankIds.join(', ')}`, 'info');
                addResult(`ğŸ“Š Sample data structure:<div class="code">${JSON.stringify(sampleData, null, 2)}</div>`, 'info');
                
                // Check if required tanks are in the list
                const required = ['460', '461', '462', '463', '464'];
                const found = required.filter(id => tankIds.includes(id));
                const missing = required.filter(id => !tankIds.includes(id));
                
                addResult(`âœ… Required tanks found in Firebase: ${found.join(', ') || 'None'}`, found.length > 0 ? 'success' : 'warning');
                addResult(`âŒ Required tanks missing: ${missing.join(', ') || 'None'}`, missing.length > 0 ? 'error' : 'success');
                
            } catch (error) {
                addResult(`âŒ Error checking data structure: ${error.message}`, 'error');
            }
        };
        
        // Auto-run simulation
        setTimeout(() => {
            simulateIndexLoading();
        }, 1000);
    </script>
</body>
</html>