<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PBCR & WASHERY Calculator</title>
<link href="icon.png" rel="icon" type="image/png"/>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;color:white;font-family:Arial,sans-serif;padding:20px;min-height:100vh}
.nav-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(0,0,0,0.5);border-radius:10px;margin-bottom:20px;flex-wrap:wrap}
.nav-logo{font-size:24px;font-weight:bold;color:white}
.nav-links{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.nav-link{color:white;text-decoration:none;padding:8px 16px;border-radius:8px;transition:all 0.3s ease;background:rgba(255,255,255,0.1);font-weight:500;border:1px solid rgba(255,255,255,0.2)}
.nav-link:hover{background:rgba(255,255,255,0.2);transform:translateY(-1px)}
input,select{background:rgba(255,255,255,0.9);border-radius:12px;border:none;color:#003366;box-shadow:0 2px 5px rgba(0,0,0,0.3);font-size:16px;margin:10px;padding:10px;width:250px;text-align:center}
.row{display:flex;justify-content:center;align-items:center;gap:8px;margin:10px 0;max-width:400px;margin-left:auto;margin-right:auto}
.row input,.row select{margin:0;flex:1;width:50%}
.result{margin-top:10px;font-weight:bold;color:#00ffff;text-align:center}
.main-container{max-width:600px;margin:20px auto;padding:30px;background:rgba(255,255,255,0.1);border-radius:20px;backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.2);box-shadow:0 8px 32px rgba(0,0,0,0.3)}
.loading{text-align:center;padding:40px;color:white}
.loading-spinner{border:4px solid rgba(255,255,255,0.3);border-radius:50%;border-top:4px solid white;width:40px;height:40px;animation:spin 1s linear infinite;margin:0 auto 20px}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.error{color:#ff4444;background:rgba(255,0,0,0.1);padding:20px;border-radius:10px;margin:20px 0}
.success{color:#44ff44;background:rgba(0,255,0,0.1);padding:20px;border-radius:10px;margin:20px 0}
</style>
</head>
<body>

<div class="nav-bar">
  <div class="nav-logo">üõ¢Ô∏è KNPC Tank Tools</div>
  <div class="nav-links">
    <a href="plcr.html" class="nav-link">‚öóÔ∏è PLCR</a>
    <a href="live-tanks.html" class="nav-link">üî¥ Live Tanks</a>
    <a href="dashboard.html" class="nav-link">üìä Dashboard</a>
  </div>
</div>

<div id="loadingOverlay" class="loading">
  <div class="loading-spinner"></div>
  <p>Loading Tank Data...</p>
  <p style="font-size: 14px; opacity: 0.8;">Connecting to Firebase...</p>
</div>

<div id="mainContent" style="display:none;">
  <h2 style="text-align:center">PBCR & WASHERY Calculator</h2>
  <div class="main-container">
    <div class="row">
      <input id="tankInput" oninput="loadTank()" placeholder="Enter Tank Number" type="number"/>
      <input id="level" oninput="calculate()" placeholder="Current Level (m)" type="number"/>
    </div>
    <div class="result" id="availablePumpable"></div>
    <div class="result" id="currentUllage"></div>
    <div class="row">
      <input id="target" oninput="calculate()" placeholder="Target Value" type="number"/>
      <select id="mode" onchange="calculate()">
        <option value="pumpable">Pumpable</option>
        <option value="ullage">Ullage</option>
        <option value="level">Level</option>
      </select>
    </div>
    <div class="result" id="valueDiff"></div>
    <div class="result" id="levelEstimate"></div>
    <div class="row">
      <input id="flowrate" oninput="calculate()" placeholder="Flowrate" type="number"/>
      <select id="flowUnit" onchange="calculate()">
        <option value="bbl">bbl/hr</option>
        <option value="m3">m¬≥/hr</option>
        <option value="mtr">meter/hr</option>
      </select>
    </div>
    <div class="result" id="output"></div>
  </div>
</div>

<div id="errorDisplay" style="display:none;" class="error">
  <h3>‚ùå Loading Error</h3>
  <p id="errorMessage"></p>
  <button onclick="location.reload()" style="background:#4CAF50;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;margin-top:10px">üîÑ Retry</button>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
  import { getFirestore, collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

  const firebaseConfig = {
    apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
    authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
    projectId: "tank-tools-knpc-c2d95",
    storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
    messagingSenderId: "510062594324",
    appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Make Firebase functions globally available
  window.db = db;
  window.collection = collection;
  window.getDocs = getDocs;
  
  console.log('üî• Firebase initialized for PBCR Calculator!');
</script>

<script>
let tankSpecsData = {};
let c = 0, m = 0, x = 0;

// Load tank specifications from Firebase
async function fetchTankSpecifications() {
  try {
    console.log('üîÑ Loading tank specifications from Firebase...');
    
    const departments = ['pbcr', 'plcr', 'washery'];
    let allTanks = {};
    let totalCount = 0;
    
    for (const dept of departments) {
      console.log(`üìä Loading ${dept.toUpperCase()} tanks...`);
      
      const tanksCollectionRef = collection(window.db, "tankData", dept, "tanks");
      const querySnapshot = await getDocs(tanksCollectionRef);
      
      let deptCount = 0;
      querySnapshot.forEach((doc) => { 
        allTanks[doc.id] = doc.data(); 
        deptCount++;
        totalCount++;
      });
      
      console.log(`‚úÖ Loaded ${deptCount} tanks from ${dept.toUpperCase()}`);
    }
    
    if (totalCount === 0) {
      throw new Error("No tank specifications found in Firebase");
    }
    
    tankSpecsData = allTanks;
    console.log(`üéØ Successfully loaded ${totalCount} total tanks from Firebase!`);
    
    // Hide loading and show calculator
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    
    return tankSpecsData;
    
  } catch (error) {
    console.error('‚ùå Error loading tanks:', error);
    
    document.getElementById('loadingOverlay').style.display = 'none';
    document.getElementById('errorDisplay').style.display = 'block';
    document.getElementById('errorMessage').textContent = error.message;
    
    throw error;
  }
}

// Load tank function
window.loadTank = () => {
  const id = document.getElementById("tankInput").value.trim();
  if (tankSpecsData[id]) {
    c = tankSpecsData[id].comment || 0;  // BPM from real KNPC system
    m = tankSpecsData[id].min || 0;      // Lo Level from real KNPC system  
    x = tankSpecsData[id].max || 0;      // Hi Level from real KNPC system
    console.log(`üî• Tank ${id} loaded:`, { bpm: c, min: m, max: x });
  } else { 
    c = m = x = 0; 
    console.log(`‚ö†Ô∏è Tank ${id} not found`);
  }
  calculate();
};

// Calculate function with real KNPC data
window.calculate = () => {
  const level = parseFloat(document.getElementById("level").value || 0);
  const target = parseFloat(document.getElementById("target").value || 0);
  const flowRaw = parseFloat(document.getElementById("flowrate").value || 0);
  const unit = document.getElementById("flowUnit").value;
  const mode = document.getElementById("mode").value;
  
  const available = document.getElementById("availablePumpable");
  const ullageDiv = document.getElementById("currentUllage"); 
  const levelEst = document.getElementById("levelEstimate");
  const valueDiff = document.getElementById("valueDiff");
  const output = document.getElementById("output");
  
  if (!c || isNaN(level)) {
    available.innerText = ullageDiv.innerText = valueDiff.innerText = levelEst.innerText = output.innerHTML = "";
    return;
  }
  
  // Calculations using real KNPC BPM values
  const availablePumpable = (level - m) * c;
  const currentUllage = (x - level) * c;
  
  available.innerText = `Available Pumpable: ${availablePumpable.toFixed(2)} bbl`;
  ullageDiv.innerText = `Current Ullage: ${currentUllage.toFixed(2)} bbl`;
  
  if (!isNaN(target)) {
    let estLevel = 0;
    if (mode === "pumpable") estLevel = (target / c) + m;
    else if (mode === "ullage") estLevel = x - (target / c);
    else if (mode === "level") estLevel = target;
    
    const levelDiff = estLevel - level;
    let estText = `Level Estimate: ${estLevel.toFixed(2)} m\nLevel Difference: ${levelDiff.toFixed(2)} m`;
    
    if (estLevel >= x - 0.5 || estLevel < m) {
      levelEst.style.color = "#ff5555";
      estText += `\nHi Level = ${x.toFixed(2)} m`;
    } else {
      levelEst.style.color = "#00ffff";
    }
    levelEst.innerText = estText;
    
    let diff = 0;
    if (mode === "pumpable") {
      diff = target - availablePumpable;
      valueDiff.innerText = `Difference: ${diff.toLocaleString()} bbl`;
    } else if (mode === "ullage") {
      diff = currentUllage - target;
      valueDiff.innerText = `To leave ${target.toLocaleString()} bbl ullage, fill: ${diff.toLocaleString()} bbl`;
    } else if (mode === "level") {
      const meters = level - target;
      diff = meters * c;
      valueDiff.innerText = `Level Difference: ${Math.abs(meters).toFixed(2)} m`;
    }
    
    if (!isNaN(flowRaw) && flowRaw > 0) {
      const flow = unit === "m3" ? flowRaw * 6.28 : unit === "mtr" ? flowRaw : flowRaw;
      let time = 0;
      
      if (unit === "mtr" && mode !== "level") {
        time = Math.abs(diff / c) / flowRaw;
      } else if (mode === "level" && unit === "mtr") {
        time = Math.abs(level - target) / flowRaw;
      } else {
        time = Math.abs(diff) / flow;
      }
      
      if (!isNaN(time) && time > 0) {
        const hrs = Math.floor(time);
        const mins = Math.round((time % 1) * 60);
        const now = new Date();
        const finish = new Date(now.getTime() + time * 3600000);
        
        let ft, fd;
        try {
          ft = finish.toLocaleTimeString('en-GB', {hour: "2-digit", minute: "2-digit", hour12: false});
          fd = finish.toLocaleDateString('en-GB');
        } catch {
          ft = `${finish.getHours().toString().padStart(2, '0')}:${finish.getMinutes().toString().padStart(2, '0')}`;
          fd = `${finish.getDate()}/${finish.getMonth() + 1}/${finish.getFullYear()}`;
        }
        
        output.innerHTML = `Time Needed: ${hrs} hr ${mins} min<br>Finish Time: ${ft}<br>Finish Date: ${fd}`;
        output.style.color = "#00ffff";
        
        console.log(`üéØ Calculation completed using real KNPC data - Tank BPM: ${c}`);
      }
    }
  }
};

// Initialize calculator
document.addEventListener('DOMContentLoaded', async () => {
  console.log('üöÄ PBCR Calculator starting...');
  
  try {
    await fetchTankSpecifications();
    console.log('‚úÖ PBCR Calculator ready with real KNPC tank data!');
  } catch (error) {
    console.error('‚ùå Failed to initialize calculator:', error);
  }
});
</script>

</body>
</html>