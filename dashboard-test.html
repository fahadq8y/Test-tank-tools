<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Tools - Test Dashboard (No Auth)</title>
  <link rel="icon" href="icon.png" type="image/png">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;font-family:Arial,sans-serif;min-height:100vh;color:white;padding:20px}
    .container{max-width:1200px;margin:0 auto;background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:30px;border:1px solid rgba(255,255,255,0.2)}
    .header{text-align:center;margin-bottom:30px}
    .title{font-size:2.5rem;font-weight:bold;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:10px}
    .subtitle{font-size:1.1rem;opacity:0.8;margin-bottom:20px}
    .test-badge{display:inline-block;background:linear-gradient(45deg,#4CAF50,#45a049);color:white;padding:8px 20px;border-radius:25px;font-weight:bold;font-size:0.9rem}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;text-align:center;border:1px solid rgba(255,255,255,0.2);transition:all 0.3s ease}
    .stat-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,0.3)}
    .stat-number{font-size:2.5rem;font-weight:bold;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px}
    .stat-label{font-size:1rem;opacity:0.9;font-weight:500}
    .section{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:25px;margin-bottom:25px;border:1px solid rgba(255,255,255,0.2)}
    .section-title{font-size:1.5rem;margin-bottom:20px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-weight:bold;border-bottom:2px solid rgba(255,215,0,0.3);padding-bottom:10px}
    .loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top-color:#FFD700;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .info-box{background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.5);border-radius:10px;padding:15px;margin:15px 0;color:#fff}
    .success-box{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);border-radius:10px;padding:15px;margin:15px 0;color:#fff}
    .btn{padding:12px 25px;border:none;border-radius:10px;cursor:pointer;font-weight:600;transition:all 0.3s ease;font-size:14px;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
    .btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}
    .btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 25px rgba(0,0,0,0.3)}
    .nav-links{display:flex;gap:15px;justify-content:center;margin:20px 0;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="title">🔧 Tank Tools Dashboard</div>
      <div class="subtitle">Test Version - No Authentication Required</div>
      <div class="test-badge">✅ Test Mode Active</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-number" id="totalUsers">Loading...</div>
        <div class="stat-label">👥 Total Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="activeUsers">Loading...</div>
        <div class="stat-label">🟢 Active Users</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="totalTanks">Loading...</div>
        <div class="stat-label">🛢️ Total Tanks</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="liveTanks">Loading...</div>
        <div class="stat-label">🔴 Live Tanks</div>
      </div>
    </div>

    <div class="nav-links">
      <a href="index.html" class="btn btn-primary">📊 PBCR Calculator</a>
      <a href="plcr.html" class="btn btn-secondary">🏭 PLCR Calculator</a>
      <a href="live-tanks.html" class="btn btn-primary">🔴 Live Tanks</a>
      <a href="nmogas.html" class="btn btn-secondary">⚗️ NMOGAS Blender</a>
      <a href="dashboard.html" class="btn btn-primary">🔧 Full Dashboard</a>
    </div>

    <div class="section">
      <div class="section-title">📊 System Status</div>
      <div class="info-box">
        <strong>🔥 Firebase Connection:</strong> <span id="firebaseStatus">Testing...</span>
      </div>
      <div class="success-box">
        <strong>✅ Page Access:</strong> No authentication required for testing
      </div>
      <div class="info-box">
        <strong>🌍 Environment:</strong> Vercel Deployment - test-tank-tools.vercel.app
      </div>
    </div>

    <div class="section">
      <div class="section-title">🛠️ Quick Tests</div>
      <button class="btn btn-primary" onclick="testFirebaseConnection()">🔥 Test Firebase</button>
      <button class="btn btn-secondary" onclick="testTankData()">🛢️ Test Tank Data</button>
      <button class="btn btn-primary" onclick="testUserAccess()">👤 Test User Access</button>
    </div>

    <div class="section">
      <div class="section-title">📝 Test Results</div>
      <div id="testResults">
        <div class="info-box">Click the test buttons above to run diagnostics...</div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp, getApps, getApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBCdv37V6vOFMe42rGlPyl9lVq-9JldEPg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.appspot.com",
      messagingSenderId: "678793823159",
      appId: "1:678793823159:web:7a7b1398aefdb7f24462b9"
    };

    // ✅ PREVENT DUPLICATE APP INITIALIZATION
    let app, db;
    const existingApps = getApps();
    if (existingApps.length === 0) {
        app = initializeApp(firebaseConfig);
        console.log('🔥 Firebase initialized for Test Dashboard!');
    } else {
        app = getApp();
        console.log('🔄 Using existing Firebase app for Test Dashboard');
    }
    db = getFirestore(app);

    // Make Firebase functions globally available
    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;

    document.getElementById('firebaseStatus').innerHTML = '✅ Connected';
    loadDashboardStats();
  </script>

  <script>
    async function loadDashboardStats() {
      try {
        // Load users count
        const usersSnapshot = await getDocs(collection(window.db, 'users'));
        let totalUsers = 0, activeUsers = 0;
        usersSnapshot.forEach(doc => {
          totalUsers++;
          if (doc.data().isActive) activeUsers++;
        });
        
        document.getElementById('totalUsers').textContent = totalUsers;
        document.getElementById('activeUsers').textContent = activeUsers;

        // Load tanks count
        let totalTanks = 0;
        const departments = ['pbcr', 'plcr', 'washery'];
        
        for (const dept of departments) {
          try {
            const tanksSnapshot = await getDocs(collection(window.db, 'tankData', dept, 'tanks'));
            totalTanks += tanksSnapshot.size;
          } catch (error) {
            console.log(`Department ${dept} not found or empty`);
          }
        }
        
        document.getElementById('totalTanks').textContent = totalTanks;

        // Load live tanks count
        try {
          const liveTanksSnapshot = await getDocs(collection(window.db, 'liveTanks'));
          document.getElementById('liveTanks').textContent = liveTanksSnapshot.size;
        } catch (error) {
          document.getElementById('liveTanks').textContent = '0';
        }

      } catch (error) {
        console.error('Error loading dashboard stats:', error);
        document.getElementById('totalUsers').textContent = 'Error';
        document.getElementById('activeUsers').textContent = 'Error';
        document.getElementById('totalTanks').textContent = 'Error';
        document.getElementById('liveTanks').textContent = 'Error';
      }
    }

    window.testFirebaseConnection = async () => {
      const resultsDiv = document.getElementById('testResults');
      resultsDiv.innerHTML = '<div class="info-box">🔄 Testing Firebase connection...</div>';
      
      try {
        // Test basic connection
        const testDoc = await getDoc(doc(window.db, 'test', 'connection'));
        
        // Test users collection
        const usersSnapshot = await getDocs(collection(window.db, 'users'));
        
        resultsDiv.innerHTML = `
          <div class="success-box">
            ✅ <strong>Firebase Connection Successful!</strong><br>
            📊 Users collection size: ${usersSnapshot.size}<br>
            🔗 Database accessible from Vercel
          </div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="info-box" style="background:rgba(244,67,54,0.2);border-color:rgba(244,67,54,0.5);">
            ❌ <strong>Firebase Connection Error:</strong><br>
            ${error.message}
          </div>
        `;
      }
    };

    window.testTankData = async () => {
      const resultsDiv = document.getElementById('testResults');
      resultsDiv.innerHTML = '<div class="info-box">🔄 Testing tank data access...</div>';
      
      try {
        const departments = ['pbcr', 'plcr', 'washery'];
        let results = [];
        
        for (const dept of departments) {
          try {
            const tanksSnapshot = await getDocs(collection(window.db, 'tankData', dept, 'tanks'));
            results.push(`${dept.toUpperCase()}: ${tanksSnapshot.size} tanks`);
          } catch (error) {
            results.push(`${dept.toUpperCase()}: Error - ${error.message}`);
          }
        }
        
        resultsDiv.innerHTML = `
          <div class="success-box">
            ✅ <strong>Tank Data Test Results:</strong><br>
            ${results.join('<br>')}
          </div>
        `;
      } catch (error) {
        resultsDiv.innerHTML = `
          <div class="info-box" style="background:rgba(244,67,54,0.2);border-color:rgba(244,67,54,0.5);">
            ❌ <strong>Tank Data Error:</strong><br>
            ${error.message}
          </div>
        `;
      }
    };

    window.testUserAccess = () => {
      const resultsDiv = document.getElementById('testResults');
      resultsDiv.innerHTML = `
        <div class="success-box">
          ✅ <strong>User Access Test:</strong><br>
          🔓 No authentication required in test mode<br>
          🌍 Page accessible from: ${window.location.href}<br>
          📱 User Agent: ${navigator.userAgent.substring(0, 50)}...
        </div>
      `;
    };
  </script>
</body>
</html>