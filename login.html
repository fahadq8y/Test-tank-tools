<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Tools - PWA Persistence v6.7</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tank Tools">
  <!-- Telegram Notifications -->
  <script src="telegram-notifications.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;background-repeat:no-repeat;font-family:Arial,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;color:white}.container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:40px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);width:100%;max-width:450px;text-align:center;position:relative;overflow:hidden}.container::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:0.5s}.container:hover::before{left:100%}.logo{font-size:3rem;margin-bottom:10px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:pulse 2s ease-in-out infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.subtitle{font-size:1.2rem;margin-bottom:30px;opacity:0.9;font-weight:300}.tab-container{display:flex;margin-bottom:30px;background:rgba(255,255,255,0.1);border-radius:10px;padding:5px}.tab{flex:1;padding:12px 20px;border:none;background:transparent;color:white;cursor:pointer;border-radius:8px;transition:all 0.3s ease;font-weight:500}.tab.active{background:linear-gradient(45deg,#4CAF50,#45a049);box-shadow:0 5px 15px rgba(76,175,80,0.3);transform:translateY(-2px)}.form-container{display:none}.form-container.active{display:block;animation:slideIn 0.5s ease}@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.form-group{margin-bottom:20px;text-align:left}label{display:block;margin-bottom:8px;font-weight:500;color:rgba(255,255,255,0.9)}input{width:100%;padding:15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:16px;transition:all 0.3s ease;border:2px solid transparent;box-shadow:0 2px 5px rgba(0,0,0,0.3)}input::placeholder{color:rgba(0,51,102,0.6)}input:focus{outline:none;background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}.username-container{display:flex;align-items:center;background:rgba(255,255,255,0.9);border-radius:10px;border:2px solid transparent;transition:all 0.3s ease;box-shadow:0 2px 5px rgba(0,0,0,0.3)}.username-container:focus-within{background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}.username-input{background:transparent;border:none;padding:15px;flex:1;box-shadow:none;transform:none;color:#003366;font-family:monospace;text-transform:lowercase}.username-input:focus{background:transparent;border:none;box-shadow:none;transform:none}.email-suffix{padding:15px;color:#003366;font-weight:500;background:rgba(0,51,102,0.1);border-radius:0 8px 8px 0}.validation-message{margin-top:5px;font-size:12px;color:#ff6b6b;opacity:0;transition:opacity 0.3s ease}.validation-message.show{opacity:1}.validation-message.success{color:#4CAF50}.password-strength{margin-top:8px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden}.password-strength-bar{height:100%;width:0%;transition:all 0.3s ease;border-radius:2px}.strength-weak{background:#ff6b6b;width:25%}.strength-fair{background:#ffa726;width:50%}.strength-good{background:#42a5f5;width:75%}.strength-strong{background:#4CAF50;width:100%}.btn{width:100%;padding:15px;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s ease;margin-top:20px;position:relative;overflow:hidden}.btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}.btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;margin-top:10px;font-size:14px;padding:10px}.btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white;margin-top:10px;font-size:14px;padding:10px}.btn:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(76,175,80,0.4)}.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:0.5s}.btn:hover::before{left:100%}.forgot-password-link{color:#2196F3;text-decoration:none;font-size:14px;display:block;margin-top:15px;transition:all 0.3s ease}.forgot-password-link:hover{color:#1976D2;text-shadow:0 0 5px rgba(33,150,243,0.5)}.message{margin-top:15px;padding:12px;border-radius:8px;font-size:14px;opacity:0;transform:translateY(-10px);transition:all 0.3s ease}.message.show{opacity:1;transform:translateY(0)}.message.success{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50}.message.error{background:rgba(255,107,107,0.2);border:1px solid rgba(255,107,107,0.5);color:#ff6b6b}.message.info{background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.5);color:#2196F3}.message.warning{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#ffc107}.footer{margin-top:30px;font-size:12px;opacity:0.7;text-align:center}.loading{display:none;margin-top:10px}.spinner{border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top:3px solid white;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.firebase-status{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50;padding:10px;border-radius:8px;margin-bottom:20px;font-size:13px;text-align:center}.forgot-container{display:none;text-align:center}.forgot-container.active{display:block;animation:slideIn 0.5s ease}.forgot-icon{font-size:4rem;margin-bottom:20px;color:#2196F3}.forgot-title{font-size:1.5rem;margin-bottom:15px;color:#2196F3}.forgot-text{margin-bottom:20px;opacity:0.8}.back-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:white;padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;margin-top:10px}.back-btn:hover{background:rgba(255,255,255,0.1)}.security-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;backdrop-filter:blur(5px)}.security-modal.show{display:flex;justify-content:center;align-items:center}.security-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;text-align:center;animation:modalSlideIn 0.5s ease}@keyframes modalSlideIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}.security-icon{font-size:3rem;margin-bottom:15px}.security-title{font-size:1.5rem;margin-bottom:15px;font-weight:bold}.security-text{margin-bottom:20px;line-height:1.5}.attempt-counter{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold}.security-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}.modal-btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease}.modal-btn-primary{background:#4CAF50;color:white}.modal-btn-secondary{background:#2196F3;color:white}.modal-btn-danger{background:#f44336;color:white}.modal-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3)}.font-controls{position:absolute;top:15px;right:15px;display:flex;gap:8px}.font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px;font-weight:bold;transition:all 0.3s ease;min-width:40px;min-height:40px;display:flex;align-items:center;justify-content:center}.font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.2)}.username-hint{color:#999;font-size:11px;display:block;margin-top:3px;text-align:center}@media (max-width:480px){.container{padding:30px 20px;margin:20px}.logo{font-size:2.5rem}.tab{padding:10px 15px;font-size:14px}.security-buttons{flex-direction:column}.modal-btn{width:100%}}
  </style>
</head>
<body>
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">‚ö†Ô∏è</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">We detected you trying to access developer tools.</div>
      <div class="attempt-counter" id="attemptCounter">Attempts: <span id="attemptCount">1</span>/3</div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="font-controls">
      <button class="font-btn" onclick="decreaseFontSize()" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿÆÿ∑">-</button>
      <button class="font-btn" onclick="increaseFontSize()" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ∑">+</button>
    </div>
    <div class="logo">üõ†Ô∏è Tank Tools</div>
    <div class="subtitle">Kuwait National Petroleum Company</div>
    <div class="firebase-status">üî• Firebase Cloud Database - Real-time & Secure</div>
    <div class="device-info-container" style="text-align: center; margin: 10px 0;">
      <button onclick="showDeviceInfo()" class="btn" style="background: rgba(33,150,243,0.2); color: #2196F3; font-size: 12px; padding: 8px 16px; margin: 5px;">
        üì± View Device Info
      </button>
    </div>
    
    <div id="mainContainer">
      <div class="tab-container">
        <button class="tab active" onclick="switchTab('login')">Login</button>
        <button class="tab" onclick="switchTab('register')">Register</button>
      </div>

      <div id="loginForm" class="form-container active">
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label for="loginUsername">üë§ Username:</label>
            <div class="username-container">
              <input type="text" id="loginUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
              <div class="email-suffix">@knpc.com</div>
            </div>
            <div class="validation-message" id="loginUsernameMsg"></div>
          </div>
          <div class="form-group">
            <label for="loginPassword">üîí Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter your password" required>
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="rememberMe" style="width:auto;margin-right:8px;">Remember me</label>
          </div>
          <button type="submit" class="btn btn-primary" id="loginBtn">üöÄ Login</button>
          <a href="#" class="forgot-password-link" onclick="showForgotPassword()">üîë Forgot Password?</a>
          <div class="loading" id="loginLoading"><div class="spinner"></div><div>Connecting to Firebase...</div></div>
        </form>
      </div>

      <div id="registerForm" class="form-container">
        <form onsubmit="handleRegister(event)">
          <div class="form-group">
            <label for="fullName">üë§ Full Name:</label>
            <input type="text" id="fullName" placeholder="Enter your full name" required minlength="3">
            <div class="validation-message" id="fullNameMsg"></div>
          </div>
          <div class="form-group">
            <label for="username">üìß Username (Email):</label>
            <div class="username-container">
              <input type="text" id="username" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
              <div class="email-suffix">@knpc.com</div>
            </div>
            <div class="validation-message" id="usernameMsg"></div>
          </div>

          <div class="form-group">
            <label for="password">üîí Password:</label>
            <input type="password" id="password" placeholder="Create a strong password" required minlength="8">
            <div class="password-strength"><div class="password-strength-bar" id="strengthBar"></div></div>
            <div class="validation-message" id="passwordMsg"></div>
          </div>
          <div class="form-group">
            <label for="confirmPassword">üîí Confirm Password:</label>
            <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            <div class="validation-message" id="confirmPasswordMsg"></div>
          </div>
          <button type="submit" class="btn btn-primary" id="registerBtn">‚ú® Create Account</button>
          <div class="loading" id="registerLoading"><div class="spinner"></div><div>Creating account in Firebase...</div></div>
        </form>
      </div>
    </div>

    <div id="forgotContainer" class="forgot-container">
      <div class="forgot-icon">üîë</div>
      <div class="forgot-title">Reset Password</div>
      <div class="forgot-text">Enter your username to reset your password</div>
      <form onsubmit="handleForgotPassword(event)">
        <div class="form-group">
          <label for="forgotUsername">üë§ Username:</label>
          <div class="username-container">
            <input type="text" id="forgotUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
            <div class="email-suffix">@knpc.com</div>
          </div>
        </div>
        <button type="submit" class="btn btn-secondary" id="resetBtn">üìß Send Reset Request</button>
        <button type="button" class="btn btn-danger" onclick="contactAdmin()" style="margin-top:10px;">üì± Contact Admin</button>
        <button type="button" class="back-btn" onclick="backToLogin()">Back to Login</button>
        <div class="loading" id="forgotLoading"><div class="spinner"></div><div>Processing request...</div></div>
      </form>
    </div>

    <div id="messageContainer"></div>
    <div class="footer"><strong>üî• Firebase Powered</strong><br>By <a href="#" class="whatsapp-link" onclick="openWhatsApp(); return false;">Fahad - 17877</a> | Version v6.5 - PWA Persistence + 7-Day Auto-Logout<br><small>Real-time cloud database</small></div>
  </div>

  <!-- Device Fingerprinting System - Simple & Reliable -->
  <script src="device-fingerprint-simple.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, setPersistence, browserLocalPersistence, browserSessionPersistence } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Make Firebase functions globally available
    window.db = db;
    window.auth = auth;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.collection = collection;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;
    window.signInWithEmailAndPassword = signInWithEmailAndPassword;
    window.createUserWithEmailAndPassword = createUserWithEmailAndPassword;
    window.setPersistence = setPersistence;
    window.browserLocalPersistence = browserLocalPersistence;
    window.browserSessionPersistence = browserSessionPersistence;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;

    console.log('üî• Firebase initialized successfully!');
  </script>

  <script>
    // Enhanced Security system with iPhone optimizations
    (function(){
      let attempts=0,modalOpen=false,isTyping=false,typingTimer=null;
      
      // Enhanced iPhone detection
      const isIPhone = /iPad|iPhone|iPod/.test(navigator.userAgent);
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);
      
      function initSecurity(){
        console.log('üîí Security system initializing - iPhone detected:', isIPhone);
        
        // Enhanced input tracking with iPhone-specific handling
        ['focusin','focus','input','keydown','keyup','touchstart','touchend','click'].forEach(eventType=>{
          document.addEventListener(eventType,e=>{
            if(e.target.matches('input,textarea,select,button,a,label')){
              isTyping=true;
              clearTimeout(typingTimer);
              // Much longer timeout for iPhone users
              typingTimer=setTimeout(()=>isTyping=false, isIPhone ? 3000 : 1000);
            }
          },true);
        });
        
        // Additional iPhone-specific events
        if(isIPhone) {
          ['touchmove','scroll','resize','orientationchange','focus','blur'].forEach(eventType=>{
            document.addEventListener(eventType,()=>{
              isTyping=true;
              clearTimeout(typingTimer);
              typingTimer=setTimeout(()=>isTyping=false, 3000);
            },true);
          });
        }
        
        // Form interaction safety
        document.addEventListener('change',e=>{
          if(e.target.matches('input,textarea,select')){
            isTyping=true;
            clearTimeout(typingTimer);
            typingTimer=setTimeout(()=>isTyping=false, isIPhone ? 2000 : 1000);
          }
        });
        
        // Enhanced event blocking with iPhone exceptions
        document.addEventListener('contextmenu',e=>{
          if(isTyping||e.target.matches('input,textarea,select,button,a,label')||e.target.closest('form')){
            console.log('Context menu allowed - user is interacting with form');
            return;
          }
          handleViolation('context-menu')(e);
        });
        
        document.addEventListener('selectstart',e=>{
          if(isTyping||e.target.matches('input,textarea,select,button,a,label')||e.target.closest('form')){
            console.log('Text selection allowed - user is interacting with form');
            return;
          }
          // Allow text selection on iPhone for better UX
          if(isIPhone && e.target.closest('.container')) {
            console.log('Text selection allowed on iPhone');
            return;
          }
          handleViolation('text-selection')(e);
        });
        
        document.addEventListener('keydown',e=>{
          if(isTyping||e.target.matches('input,textarea,select,button,a,label')||e.target.closest('form')){
            console.log('Keyboard input allowed - user is interacting with form');
            return;
          }
          
          const dangerous=[(e.ctrlKey&&e.key==='u'),(e.ctrlKey&&e.key==='s'),(e.ctrlKey&&e.shiftKey&&e.key==='I'),(e.key==='F12'),(e.ctrlKey&&e.shiftKey&&e.key==='C'),(e.ctrlKey&&e.shiftKey&&e.key==='J')];
          
          // iPhone doesn't have these shortcuts, so be more lenient
          if(isIPhone && (e.ctrlKey || e.metaKey)) {
            console.log('iPhone keyboard shortcut allowed');
            return;
          }
          
          if(dangerous.some(c=>c))handleViolation('keyboard-shortcut')(e);
        });
        
        // DevTools detection with iPhone-specific handling
        let devOpen=false;
        setInterval(()=>{
          if(isTyping){
            console.log('Skipping DevTools check - user is typing');
            return;
          }
          
          // More lenient threshold for iPhone
          const threshold = isIPhone ? 200 : 160;
          const wDiff=window.outerWidth-window.innerWidth;
          const hDiff=window.outerHeight-window.innerHeight;
          
          // iPhone Safari has different window behavior
          if(isIPhone && isSafari) {
            // Skip DevTools detection on iPhone Safari due to dynamic UI
            return;
          }
          
          if(wDiff>threshold||hDiff>threshold){
            if(!devOpen){
              devOpen=true;
              setTimeout(()=>{
                if(!isTyping && !modalOpen) {
                  console.log('DevTools detected after delay check');
                  handleViolation('devtools-detected')();
                }
              }, isIPhone ? 1000 : 500);
            }
          }else{
            devOpen=false;
          }
        }, isIPhone ? 8000 : 3000); // Much less frequent checks on iPhone
      }
      
      function handleViolation(type){
        return function(e){
          // Double check if user is still interacting
          if(isTyping) {
            console.log('Violation ignored - user is still typing');
            return false;
          }
          
          if(e&&e.preventDefault)e.preventDefault();
          attempts++;
          console.log('Security violation:', type, 'Attempt:', attempts);
          
          if(attempts===1)showWarning('first');
          else if(attempts===2)showWarning('second');
          else if(attempts>=3)showWarning('final');
          return false;
        }
      }
      
      function showWarning(level){
        if(modalOpen)return;
        const modal=document.getElementById('securityModal'),icon=document.getElementById('securityIcon'),title=document.getElementById('securityTitle'),text=document.getElementById('securityText'),counter=document.getElementById('attemptCounter'),countSpan=document.getElementById('attemptCount');
        modalOpen=true;countSpan.textContent=attempts;
        
        if(level==='first'){
          icon.textContent='üëÄ';title.textContent='Security Notice';
          if(isIPhone) {
            text.innerHTML='<p>We noticed unusual activity. This might be due to iPhone browser behavior.</p><p><strong>If you were just using the login form:</strong> No problem! Click "I Understand" to continue.</p>';
          } else {
            text.innerHTML='<p>We noticed you tried to access developer tools.</p><p><strong>If this was accidental:</strong> No problem! Click "I Understand" to continue.</p>';
          }
          counter.style.background='rgba(33,150,243,0.2)';counter.style.borderColor='rgba(33,150,243,0.5)';counter.style.color='#2196F3'
        }else if(level==='second'){
          icon.textContent='‚ö†Ô∏è';title.textContent='Security Warning';
          if(isIPhone) {
            text.innerHTML='<p><strong>Second detection on iPhone.</strong></p><p>This might be caused by:</p><ul style="text-align:left;margin:10px 0"><li>Auto-fill or password manager</li><li>Copy/paste actions</li><li>Browser zoom or rotation</li></ul><p>If you\'re just trying to login, click "I Understand".</p>';
          } else {
            text.innerHTML='<p><strong>Second attempt detected.</strong></p><p>This system is protected for KNPC operations.</p>';
          }
          counter.style.background='rgba(255,193,7,0.2)';counter.style.borderColor='rgba(255,193,7,0.5)';counter.style.color='#ffc107'
        }else{
          icon.textContent='üö´';title.textContent='Access Restricted';
          if(isIPhone) {
            text.innerHTML='<p><strong>Multiple detections on iPhone.</strong></p><p>This could be due to:</p><ul style="text-align:left;margin:10px 0"><li>Browser compatibility issues</li><li>Aggressive security detection</li><li>iPhone-specific behavior</li></ul><p>Use "Reset Page" if you\'re having trouble logging in.</p>';
          } else {
            text.innerHTML='<p><strong>Maximum attempts exceeded.</strong></p>';
          }
          counter.style.background='rgba(244,67,54,0.2)';counter.style.borderColor='rgba(244,67,54,0.5)';counter.style.color='#f44336';
          setTimeout(()=>{if(attempts>=3)implementRestrictions()},5000)
        }
        modal.classList.add('show')
      }
      
      function implementRestrictions(){
        document.body.style.filter='blur(5px)';
        const overlay=document.createElement('div');
        if(isIPhone) {
          overlay.innerHTML='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;text-align:center;padding:20px"><h2 style="color:#f44336">iPhone Detection Issue</h2><p>This might be a compatibility issue with iPhone browsers.</p><button onclick="window.location.reload()" style="padding:12px 24px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer">üîÑ Refresh & Try Again</button></div>';
        } else {
          overlay.innerHTML='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);color:white;display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10000;text-align:center;padding:20px"><h2 style="color:#f44336">Security Restricted</h2><p>Contact Fahad - 17877</p><button onclick="window.location.reload()" style="padding:12px 24px;background:#4CAF50;color:white;border:none;border-radius:8px;cursor:pointer">üîÑ Refresh</button></div>';
        }
        document.body.appendChild(overlay)
      }
      
      window.acknowledgeWarning=()=>{
        document.getElementById('securityModal').classList.remove('show');
        modalOpen=false;
        isTyping=true; // Give user some grace period
        setTimeout(()=>isTyping=false, 2000);
      };
      window.resetPage=()=>window.location.reload();
      window.learnMore=()=>{
        document.getElementById('securityModal').classList.remove('show');
        modalOpen=false;
        isTyping=true;
        setTimeout(()=>isTyping=false, 2000);
      };
      
      initSecurity()
    })();

    const WHATSAPP_ADMIN = "96555222550";

    // Enhanced login function with Firebase and Device Fingerprinting
    async function handleLogin(event) {
      event.preventDefault();
      showMessage("", "");
      showLoading("loginBtn", "loginLoading", true);
      
      const usernameInput = document.getElementById("loginUsername");
      const password = document.getElementById("loginPassword").value;
      const rememberMe = document.getElementById("rememberMe").checked;

      // Convert username to lowercase
      const username = usernameInput.value.toLowerCase();
      console.log('üîê Login attempt for:', username);
      
      if (!username || !password) {
        showMessage('‚ùå Please enter username and password', 'error');
        showLoading("loginBtn", "loginLoading", false);
        return;
      }
      
      try {
        // Step 0: Set Firebase Auth Persistence based on PWA or Browser
        const isPWA = window.matchMedia('(display-mode: standalone)').matches;
        console.log('üì± Running as:', isPWA ? 'PWA (Standalone App)' : 'Browser');
        
        // ‚úÖ Always use LOCAL persistence for both PWA and Browser
        // This ensures Firebase Auth state persists across page navigation
        await setPersistence(auth, browserLocalPersistence);
        console.log('‚úÖ Auth Persistence: LOCAL (stay logged in)', isPWA ? '(PWA Mode)' : '(Browser Mode)');
        
        // Step 1: Generate device fingerprint
        console.log('üîç Generating device fingerprint...');
        showMessage('üîç Checking device security...', 'info');
        
        const deviceInfo = await generateDeviceFingerprint();
        const deviceId = deviceInfo.fingerprint;
        console.log('üì± Device ID:', deviceId);
        console.log('üì± Device Type:', deviceInfo.readableInfo.deviceType);
        
        // Step 2: Check device authorization for this user
        let deviceAllowed;
        try {
          deviceAllowed = await checkDeviceAuthorization(username, deviceId, deviceInfo);
        } catch (authError) {
          console.error('‚ùå Device authorization check failed:', authError);
          showMessage('‚ùå Unable to verify device. Please check your internet connection and try again.', 'error');
          showLoading("loginBtn", "loginLoading", false);
          return;
        }
        
        if (!deviceAllowed.allowed) {
          showMessage(`üö´ ${deviceAllowed.message}`, 'error');
          showLoading("loginBtn", "loginLoading", false);
          
          // Log unauthorized device access attempt
          try {
            await addDoc(collection(db, 'activities'), {
              action: `Unauthorized device access attempt: ${username} from device ${deviceId.slice(0, 20)}...`,
              username: username,
              timestamp: serverTimestamp(),
              ip: await getUserIP(),
              userAgent: navigator.userAgent.substring(0, 100),
              page: 'login',
              deviceInfo: deviceInfo.readableInfo
            });
          } catch (logError) {
            console.error('Error logging unauthorized attempt:', logError);
          }
          
          return;
        }
        
        if (deviceAllowed.isNewDevice) {
          showMessage('üì± New device registered successfully!', 'success');
          await new Promise(resolve => setTimeout(resolve, 1000));
        } else {
          showMessage('‚úÖ Device recognized. Welcome back!', 'success');
          await new Promise(resolve => setTimeout(resolve, 500));
        }
        
        showMessage('üîê Device authorized. Logging in...', 'success');
        
      } catch (deviceError) {
        console.error('‚ùå Device fingerprint error:', deviceError);
        showMessage('‚ùå Device security check failed. Please try again or contact admin.', 'error');
        showLoading("loginBtn", "loginLoading", false);
        
        // For admin account, allow complete bypass
        if (username === 'fam030') {
          console.log('‚ö†Ô∏è Admin access: Bypassing device check completely');
          showMessage('üîì Admin access: Device security bypassed', 'warning');
          // Skip device check entirely for admin
        } else {
          // For regular users, require device check
          showMessage('üîí Device verification required. Please try again.', 'error');
          return; // Stop login process
        }
      }
      
      try {
        // Check if user exists in Firebase
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists()) {
          // Check if it's admin account
          if (username === 'fam030' && password === 'Ff9718062') {
            console.log('‚úÖ Admin login successful');
            const userData = {
              id: 1,
              username: 'fam030',
              fullName: 'Fahad Admin',
              email: 'fam030@knpc.com',
              role: 'admin',
              isActive: true,
              loginTime: new Date().toISOString()
            };
            
            // Save session data
            localStorage.setItem('tanktools_current_user', JSON.stringify(userData));
            sessionStorage.setItem('tanktools_session', 'active');
            
            // ‚úÖ Save login timestamp for Auto-Logout (7 days)
            if (isPWA) {
              const loginTimestamp = Date.now();
              localStorage.setItem('tanktools_login_timestamp', loginTimestamp.toString());
              console.log('‚úÖ Login timestamp saved for PWA auto-logout (7 days)');
            }
            
            // Add login activity to Firebase
            await addActivity('admin_login', username);
            
            showMessage('‚úÖ Admin login successful! Redirecting... (Session Fix v5.1)', 'success');
            console.log('üî• SESSION FIX v5.1 - Extended timing and verification active');
            
            // üö´ UNREGISTER SERVICE WORKER TO PREVENT REDIRECT ISSUES
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.getRegistrations().then(registrations => {
                registrations.forEach(registration => {
                  console.log('üö´ Unregistering Service Worker to fix redirects');
                  registration.unregister();
                });
              });
            }
            
            // üîß EXTENDED DELAY + SESSION VERIFICATION
            setTimeout(() => {
              // Double-check session is saved
              const savedSession = sessionStorage.getItem('tanktools_session');
              const savedUser = localStorage.getItem('tanktools_current_user');
              
              console.log('üîç Pre-redirect check:', {
                session: savedSession,
                user: !!savedUser,
                userDataLength: savedUser ? savedUser.length : 0
              });
              
              if (!savedSession || !savedUser) {
                console.error('‚ùå Session not properly saved, re-saving...');
                sessionStorage.setItem('tanktools_session', 'active');
                localStorage.setItem('tanktools_current_user', JSON.stringify({
                  id: 1,
                  username: 'fam030',
                  fullName: 'Fahad Admin',
                  email: 'fam030@knpc.com',
                  role: 'admin',
                  isActive: true,
                  loginTime: new Date().toISOString()
                }));
                
                // Additional delay after re-saving
                setTimeout(() => {
                  console.log('üîÑ Redirecting after session re-save...');
                  window.location.href = 'dashboard.html';
                }, 500);
                return;
              }
              
              const redirect = sessionStorage.getItem('tanktools_redirect');
              if (redirect) {
                console.log('üîÑ Redirecting to saved redirect:', redirect);
                sessionStorage.removeItem('tanktools_redirect');
                window.location.href = redirect;
              } else {
                console.log('üîÑ Redirecting to dashboard.html');
                window.location.href = 'dashboard.html';
              }
            }, 2000); // Increased delay from 1500ms to 2000ms
            return;
          } else {
            showMessage('‚ùå User not found. Please register first.', 'error');
            return;
          }
        }
        
        const userData = userDoc.data();
        
        // üîÑ GRADUAL MIGRATION: Try Firebase Auth
        const email = `${username}@knpc.com`;
        let firebaseAuthUser = null;
        
        try {
          // Try to sign in with Firebase Auth
          const authResult = await signInWithEmailAndPassword(auth, email, password);
          firebaseAuthUser = authResult.user;
          console.log('‚úÖ [Migration] User already in Firebase Auth:', firebaseAuthUser.uid);
        } catch (authError) {
          console.log('‚ö†Ô∏è [Migration] User not in Firebase Auth:', authError.code);
          
          // Handle too-many-requests
          if (authError.code === 'auth/too-many-requests') {
            showMessage('‚è≥ ÿ™ŸÖ ÿ™ÿ¨ÿßŸàÿ≤ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿáÿß. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± 5-10 ÿØŸÇÿßÿ¶ŸÇ ÿ´ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 'error');
            showLoading("loginBtn", "loginLoading", false);
            return;
          }
          
          // User not in Firebase Auth - need to migrate
          if (authError.code === 'auth/user-not-found' || authError.code === 'auth/invalid-credential' || authError.code === 'auth/wrong-password') {
            // First verify password against Firestore
            if (userData.password !== password) {
              showMessage('‚ùå Invalid password', 'error');
              await addActivity('failed_login_attempt', username);
              showLoading("loginBtn", "loginLoading", false);
              return;
            }
            
            // Password correct - migrate to Firebase Auth
            console.log('üîÑ [Migration] Creating Firebase Auth account...');
            showMessage('üîÑ Migrating to new authentication system...', 'info');
            
            try {
              const createResult = await createUserWithEmailAndPassword(auth, email, password);
              firebaseAuthUser = createResult.user;
              console.log('‚úÖ [Migration] Firebase Auth account created:', firebaseAuthUser.uid);
              
              // Update Firestore with uid
              await updateDoc(userDocRef, {
                uid: firebaseAuthUser.uid,
                migratedToAuth: true,
                migrationDate: serverTimestamp()
              });
              
              showMessage('‚úÖ Account migrated successfully!', 'success');
              await new Promise(resolve => setTimeout(resolve, 1000));
              
            } catch (createError) {
              console.error('‚ùå [Migration] Failed to create Firebase Auth:', createError);
              
              if (createError.code === 'auth/too-many-requests') {
                showMessage('‚è≥ ÿ™ŸÖ ÿ™ÿ¨ÿßŸàÿ≤ ÿπÿØÿØ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿßÿ™ ÿßŸÑŸÖÿ≥ŸÖŸàÿ≠ ÿ®Ÿáÿß. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ± 5-10 ÿØŸÇÿßÿ¶ŸÇ ÿ´ŸÖ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 'error');
                showLoading("loginBtn", "loginLoading", false);
                return;
              }
              
              // Email already exists - sign in instead
              if (createError.code === 'auth/email-already-in-use') {
                console.log('‚úÖ [Migration] Account exists, signing in...');
                try {
                  const signInResult = await signInWithEmailAndPassword(auth, email, password);
                  firebaseAuthUser = signInResult.user;
                  
                  // Update Firestore with uid if missing
                  if (!userData.uid) {
                    await updateDoc(userDocRef, {
                      uid: firebaseAuthUser.uid,
                      migratedToAuth: true,
                      migrationDate: serverTimestamp()
                    });
                  }
                } catch (signInError) {
                  console.error('‚ùå [Migration] Sign in failed:', signInError);
                  showMessage('‚ùå Migration failed. Please contact admin.', 'error');
                  showLoading("loginBtn", "loginLoading", false);
                  return;
                }
              } else {
                showMessage('‚ùå Migration failed. Please contact admin.', 'error');
                showLoading("loginBtn", "loginLoading", false);
                return;
              }
            }
          } else {
            // Other auth errors
            console.error('‚ùå [Migration] Auth error:', authError);
            showMessage('‚ùå Authentication error. Please try again.', 'error');
            showLoading("loginBtn", "loginLoading", false);
            return;
          }
        }
        
        // Check password (if not already verified by Firebase Auth migration)
        if (!firebaseAuthUser && userData.password !== password) {
          showMessage('‚ùå Invalid password', 'error');
          await addActivity('failed_login_attempt', username);
          return;
        }
        
        // Check if user is active (approved by admin)
        if (!userData.isActive) {
          showMessage('‚è≥ Your account is pending admin approval. Please wait for activation.', 'warning');
          
          // Show contact admin button for pending users
          setTimeout(() => {
            const messageContainer = document.getElementById('messageContainer');
            messageContainer.innerHTML += `
              <div class="message info show" style="margin-top: 10px;">
                <div style="margin-bottom: 10px;">üìû Need help? Contact admin:</div>
                <button class="btn btn-secondary" onclick="contactAdminForActivation('${username}', '${userData.fullName || username}')" style="width: 100%; margin-top: 0;">
                  üì± Contact Admin for Activation
                </button>
              </div>
            `;
          }, 1000);
          
          return;
        }
        
        console.log('‚úÖ User login successful');
        
        // Update last login time
        await updateDoc(userDocRef, {
          lastLogin: serverTimestamp()
        });
        
        // Prepare user data for session
        const sessionUserData = {
          id: userData.id || Date.now(),
          username: userData.username,
          fullName: userData.fullName,
          email: userData.email,
          role: userData.role || 'user',
          isActive: userData.isActive,
          loginTime: new Date().toISOString()
        };
        
        // Save session data
        localStorage.setItem('tanktools_current_user', JSON.stringify(sessionUserData));
        localStorage.setItem('username', userData.username); // ‚úÖ Save username for Firebase Auth pages
        sessionStorage.setItem('tanktools_session', 'active');
        
        // ‚úÖ Save login timestamp for Auto-Logout (7 days)
        const isPWA = window.matchMedia('(display-mode: standalone)').matches;
        if (isPWA) {
          const loginTimestamp = Date.now();
          localStorage.setItem('tanktools_login_timestamp', loginTimestamp.toString());
          console.log('‚úÖ Login timestamp saved for PWA auto-logout (7 days)');
        }
        
        if (rememberMe) {
          localStorage.setItem('tanktools_remember', JSON.stringify({
            username: username,
            rememberMe: true
          }));
        }
        
        // Add login activity to Firebase
        await addActivity('user_login', username);
        
        showMessage('‚úÖ Login successful! Redirecting...', 'success');
        
        // üîß EXTENDED DELAY + SESSION VERIFICATION FOR REGULAR USERS
        setTimeout(() => {
          // Double-check session is saved
          const savedSession = sessionStorage.getItem('tanktools_session');
          const savedUser = localStorage.getItem('tanktools_current_user');
          
          console.log('üîç Regular user pre-redirect check:', {
            session: savedSession,
            user: !!savedUser,
            username: username,
            role: userData.role
          });
          
          if (!savedSession || !savedUser) {
            console.error('‚ùå Regular user session not properly saved, re-saving...');
            sessionStorage.setItem('tanktools_session', 'active');
            localStorage.setItem('tanktools_current_user', JSON.stringify(sessionUserData));
            
            // Additional delay after re-saving
            setTimeout(() => {
              console.log('üîÑ Redirecting regular user after session re-save...');
              const userRole = userData.role || userData.specialization;
              const defaultUrl = (userRole === 'admin' || userRole === 'supervisor') ? 'dashboard.html' : 'index.html';
              window.location.href = defaultUrl;
            }, 500);
            return;
          }
          
          const redirect = sessionStorage.getItem('tanktools_redirect');
          if (redirect) {
            console.log('üîÑ Redirecting regular user to saved redirect:', redirect);
            sessionStorage.removeItem('tanktools_redirect');
            window.location.href = redirect;
          } else {
            const userRole = userData.role || userData.specialization;
            const defaultUrl = (userRole === 'admin' || userRole === 'supervisor') ? 'dashboard.html' : 'index.html';
            console.log('üîÑ Redirecting regular user to default:', defaultUrl);
            window.location.href = defaultUrl;
          }
        }, 2000); // Increased delay from 1500ms to 2000ms
        
      } catch (error) {
        console.error('‚ùå Login error:', error);
        showMessage(`‚ùå Login failed: ${error.message}`, 'error');
      } finally {
        showLoading("loginBtn", "loginLoading", false);
      }
    }

    // Enhanced registration function with Firebase
    async function handleRegister(event) {
      event.preventDefault();
      
      const fullName = document.getElementById("fullName").value.trim();
      const usernameInput = document.getElementById("username");
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Convert username to lowercase
      const username = usernameInput.value.toLowerCase();
      console.log('üìù Registration attempt for:', username);
      
      // Validation
      if (!fullName || !username || !password || !confirmPassword) {
        showMessage('‚ùå Please fill all fields', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showMessage('‚ùå Passwords do not match', 'error');
        return;
      }
      
      if (password.length < 8) {
        showMessage('‚ùå Password must be at least 8 characters', 'error');
        return;
      }
      
      showLoading("registerBtn", "registerLoading", true);
      
      try {
        // Check if username already exists
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
          showMessage('‚ùå Username already exists. Please choose another.', 'error');
          return;
        }
        
        // Step 1: Create user in Firebase Auth
        console.log('üî• Creating user in Firebase Auth...');
        const email = `${username}@knpc.com`;
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const firebaseUser = userCredential.user;
        console.log('‚úÖ User created in Firebase Auth:', firebaseUser.uid);
        
        // Step 2: Create user data for Firestore
        const userData = {
          id: Date.now(),
          username: username,
          fullName: fullName,
          email: email,
          firebaseUid: firebaseUser.uid, // Store Firebase Auth UID
          role: 'user',
          isActive: false, // User needs admin approval
          createdAt: serverTimestamp(),
          emailVerified: false
        };
        
        // Step 3: Save user to Firestore
        await setDoc(userDocRef, userData);
        console.log('‚úÖ User data saved to Firestore');
        
        // Register user's first device during registration
        try {
          console.log('üì± Registering device during user registration...');
          const deviceInfo = await generateDeviceFingerprint();
          
          const deviceData = {
            username: username,
            deviceId: deviceInfo.fingerprint,
            deviceName: deviceInfo.readableInfo.deviceName,
            deviceType: deviceInfo.readableInfo.deviceType,
            browser: deviceInfo.readableInfo.browser,
            os: deviceInfo.readableInfo.os,
            screenResolution: deviceInfo.readableInfo.screenResolution,
            registeredAt: serverTimestamp(),
            lastUsed: serverTimestamp(),
            isActive: true,
            lastIP: await getUserIP(),
            fullDeviceInfo: deviceInfo,
            registeredDuringSignup: true
          };
          
          await addDoc(collection(db, 'userDevices'), deviceData);
          console.log('‚úÖ Device registered during signup');
          
        } catch (deviceError) {
          console.error('‚ö†Ô∏è Device registration during signup failed:', deviceError);
          // Don't fail registration if device registration fails
        }
        
        // Add registration activity
        await addActivity('user_registered', username);
        
        console.log('‚úÖ User registered successfully in Firebase');
        
        // Send Telegram notification to admin
        try {
          if (window.telegramNotifications) {
            console.log('üîî Sending Telegram notification to admin...');
            await window.telegramNotifications.sendNewUserNotification({
              displayName: fullName,
              username: username,
              email: `${username}@knpc.com`,
              department: 'Unknown', // Can be enhanced later
              phone: 'Not provided'
            });
            console.log('‚úÖ Telegram notification sent successfully');
          }
        } catch (telegramError) {
          console.error('‚ö†Ô∏è Telegram notification failed:', telegramError);
          // Don't fail registration if Telegram fails
        }
        
        showMessage('‚úÖ Registration successful! Your account is pending admin approval. Admin has been notified via Telegram.', 'success');
        
        // Show contact admin button after successful registration
        setTimeout(() => {
          const messageContainer = document.getElementById('messageContainer');
          messageContainer.innerHTML += `
            <div class="message info show" style="margin-top: 10px;">
              <div style="margin-bottom: 10px;">üìû Need faster approval? Contact admin directly:</div>
              <button class="btn btn-secondary" onclick="contactAdminForActivation('${username}', '${fullName}')" style="width: 100%; margin-top: 0;">
                üì± Contact Admin for Activation
              </button>
            </div>
          `;
        }, 1000);
        
        // Clear form manually
        document.getElementById('fullName').value = '';
        document.getElementById('username').value = '';
        document.getElementById('password').value = '';
        document.getElementById('confirmPassword').value = '';
        
        // Switch to login tab after delay
        setTimeout(() => {
          switchTabDirect('login');
          showMessage('‚ÑπÔ∏è Please wait for admin approval before attempting to login.', 'info');
        }, 3000);
        
      } catch (error) {
        console.error('‚ùå Registration error:', error);
        showMessage(`‚ùå Registration failed: ${error.message}`, 'error');
      } finally {
        showLoading("registerBtn", "registerLoading", false);
      }
    }

    // Add activity to Firebase
    async function addActivity(action, username) {
      try {
        const userIP = await fetch('https://api.ipify.org?format=json').then(r => r.json()).then(data => data.ip).catch(() => 'Unknown');
        const timestamp = new Date();
        const timeStr = timestamp.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
        const dateStr = timestamp.toLocaleDateString('en-GB');
        
        let detailedAction = action;
        if (action === 'user_login') {
          detailedAction = `ÿ™ŸÖ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${username} ÿ•ŸÑŸâ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÅŸä ${timeStr} - ${dateStr}`;
        } else if (action === 'admin_login') {
          detailedAction = `ÿ™ŸÖ ÿØÿÆŸàŸÑ ÿßŸÑÿ£ÿØŸÖŸÜ ${username} ÿ•ŸÑŸâ ÿßŸÑŸÜÿ∏ÿßŸÖ ŸÅŸä ${timeStr} - ${dateStr}`;
        } else if (action === 'failed_login_attempt') {
          detailedAction = `ŸÖÿ≠ÿßŸàŸÑÿ© ÿØÿÆŸàŸÑ ŸÅÿßÿ¥ŸÑÿ© ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${username} ŸÅŸä ${timeStr} - ${dateStr}`;
        } else if (action === 'user_registered') {
          detailedAction = `ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿ¨ÿØŸäÿØ: ${username} ŸÅŸä ${timeStr} - ${dateStr}`;
        } else if (action === 'password_reset_requested') {
          detailedAction = `ÿ∑ŸÑÿ® ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ${username} ŸÅŸä ${timeStr} - ${dateStr}`;
        }
        
        await addDoc(collection(db, 'activities'), {
          action: detailedAction,
          originalAction: action,
          username: username,
          timestamp: serverTimestamp(),
          ip: userIP,
          userAgent: navigator.userAgent.substring(0, 100),
          page: 'login'
        });
        console.log('‚úÖ Activity logged:', detailedAction);
      } catch (error) {
        console.error('‚ùå Error logging activity:', error);
      }
    }

    // Device Authorization System - Enhanced Error Handling
    async function checkDeviceAuthorization(username, deviceId, deviceInfo) {
      console.log('üîç Checking device authorization for:', username, deviceId?.substring(0, 20) + '...');
      
      // ÿßŸÑÿ™ÿ£ŸÉÿØ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ÿßŸÑŸÖÿπÿßŸÖŸÑÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
      if (!username || !deviceId || !deviceInfo) {
        console.error('‚ùå Missing required parameters for device authorization');
        return { 
          allowed: false, 
          isNewDevice: false, 
          message: 'Missing device information. Please try again.' 
        };
      }
      
      try {
        
        // Check user's registered devices with timeout
        console.log('üìä Querying user devices from Firebase...');
        
        const userDevicesQuery = query(
          collection(db, 'userDevices'), 
          where('username', '==', username)
        );
        
        // ÿ•ÿ∂ÿßŸÅÿ© timeout ŸÑŸÑÿßÿ≥ÿ™ÿπŸÑÿßŸÖ
        const deviceDocs = await Promise.race([
          getDocs(userDevicesQuery),
          new Promise((_, reject) => 
            setTimeout(() => reject(new Error('Database query timeout')), 10000)
          )
        ]);
        const userDevices = [];
        
        deviceDocs.forEach(doc => {
          userDevices.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('üì± User devices found:', userDevices.length);
        
        // Debug: ÿ∑ÿ®ÿßÿπÿ© ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ŸÑŸÑŸÖŸÇÿßÿ±ŸÜÿ©
        if (userDevices.length > 0) {
          console.log('üîç Debug - Current device ID:', deviceId?.substring(0, 30) + '...');
          userDevices.forEach((device, index) => {
            console.log(`üîç Debug - Saved device ${index + 1}:`, {
              id: device.deviceId?.substring(0, 30) + '...',
              name: device.deviceName,
              type: device.deviceType,
              registered: device.registeredAt
            });
          });
        }
        
        // Check if current device is already registered
        const existingDevice = userDevices.find(device => device.deviceId === deviceId);
        
        if (existingDevice) {
          console.log('‚úÖ Device already registered:', existingDevice.deviceName);
          
          // Update last used time
          try {
            await updateDoc(doc(db, 'userDevices', existingDevice.id), {
              lastUsed: serverTimestamp(),
              lastIP: await getUserIP()
            });
          } catch (updateError) {
            console.warn('‚ö†Ô∏è Could not update device last used time:', updateError);
            // Don't fail login for this
          }
          
          return { 
            allowed: true, 
            isNewDevice: false, 
            message: 'Device already registered and authorized' 
          };
        }
        
        // ÿßÿÆÿ™ÿ®ÿßÿ± ŸÖÿ∑ÿßÿ®ŸÇÿ© fingerprint ÿ®ÿ∑ÿ±ŸäŸÇÿ© ÿ£ŸÉÿ´ÿ± ŸÖÿ±ŸàŸÜÿ©
        const similarDevice = userDevices.find(device => {
          // ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ£ÿ¨ÿ≤ÿßÿ° ŸÖŸÜ fingerprint ÿ£Ÿà device info
          if (!device.fullDeviceInfo || !deviceInfo) return false;
          
          const savedInfo = device.fullDeviceInfo.readableInfo || device.fullDeviceInfo.readable || {};
          const currentInfo = deviceInfo.readableInfo || deviceInfo.readable || {};
          
          // ŸÖŸÇÿßÿ±ŸÜÿ© ÿßŸÑÿ¥ÿßÿ¥ÿ© ŸàÿßŸÑŸÖÿ™ÿµŸÅÿ≠
          const screenMatch = savedInfo.screenResolution === currentInfo.screenResolution;
          const browserMatch = savedInfo.browser === currentInfo.browser;
          const osMatch = savedInfo.os === currentInfo.os;
          
          // ÿ•ÿ∞ÿß ÿ™ÿ∑ÿßÿ®ŸÇÿ™ ŸÖÿπÿßŸäŸäÿ± ŸÉÿßŸÅŸäÿ©ÿå ÿßÿπÿ™ÿ®ÿ± ŸÜŸÅÿ≥ ÿßŸÑÿ¨Ÿáÿßÿ≤
          return screenMatch && browserMatch && osMatch;
        });
        
        if (similarDevice) {
          console.log('‚úÖ Device recognized by characteristics (updating fingerprint)');
          
          // ÿ™ÿ≠ÿØŸäÿ´ fingerprint ŸÑŸÑÿ¨Ÿáÿßÿ≤ ÿßŸÑŸÖÿ™ÿ¥ÿßÿ®Ÿá
          try {
            await updateDoc(doc(db, 'userDevices', similarDevice.id), {
              deviceId: deviceId,  // ÿ™ÿ≠ÿØŸäÿ´ fingerprint ÿßŸÑÿ¨ÿØŸäÿØ
              fullDeviceInfo: deviceInfo,
              lastUsed: serverTimestamp(),
              lastIP: await getUserIP(),
              fingerprintUpdated: serverTimestamp()
            });
            
            console.log('üîÑ Device fingerprint updated successfully');
          } catch (updateError) {
            console.warn('‚ö†Ô∏è Could not update device fingerprint:', updateError);
          }
          
          return { 
            allowed: true, 
            isNewDevice: false, 
            message: 'Device recognized and fingerprint updated' 
          };
        }
        
        // Get user's device limit from users collection
        const userDocRef = doc(db, 'users', username);
        const userDocSnap = await getDoc(userDocRef);
        const userDeviceLimit = userDocSnap.exists() ? (userDocSnap.data().deviceLimit || 1) : 1;
        
        console.log(`üìä User device limit: ${userDeviceLimit}`);
        
        // Check if user has reached device limit
        const activeDevices = userDevices.filter(device => device.isActive);
        
        if (activeDevices.length >= userDeviceLimit) {
          // User has reached limit, need admin approval for new device
          console.log('üö´ Device limit reached');
          
          // Log the attempt for admin review
          await addDoc(collection(db, 'deviceRequests'), {
            username: username,
            requestedDeviceId: deviceId,
            deviceInfo: deviceInfo.readableInfo,
            timestamp: serverTimestamp(),
            status: 'pending',
            requestIP: await getUserIP(),
            existingDevices: activeDevices.map(d => ({
              name: d.deviceName,
              registeredOn: d.registeredAt
            }))
          });
          
          return { 
            allowed: false, 
            isNewDevice: true, 
            message: `Device limit reached: Only ${userDeviceLimit} device(s) allowed per user. This device is not authorized. Contact admin for approval: +965 55222550` 
          };
        }
        
        // Register new device (user's first device)
        const newDeviceData = {
          username: username,
          deviceId: deviceId,
          deviceName: deviceInfo.readableInfo.deviceName,
          deviceType: deviceInfo.readableInfo.deviceType,
          browser: deviceInfo.readableInfo.browser,
          os: deviceInfo.readableInfo.os,
          screenResolution: deviceInfo.readableInfo.screenResolution,
          registeredAt: serverTimestamp(),
          lastUsed: serverTimestamp(),
          isActive: true,
          lastIP: await getUserIP(),
          fullDeviceInfo: deviceInfo
        };
        
        await addDoc(collection(db, 'userDevices'), newDeviceData);
        
        console.log('‚úÖ New device registered successfully');
        return { 
          allowed: true, 
          isNewDevice: true, 
          message: 'New device registered successfully' 
        };
        
      } catch (error) {
        console.error('‚ùå Device authorization error:', error);
        
        // Enhanced error handling
        if (error.code === 'permission-denied') {
          return { 
            allowed: false, 
            isNewDevice: false, 
            message: 'Database access denied. Please contact admin.' 
          };
        } else if (error.code === 'unavailable') {
          return { 
            allowed: false, 
            isNewDevice: false, 
            message: 'Database temporarily unavailable. Please try again.' 
          };
        } else {
          // For other errors, still block access
          return { 
            allowed: false, 
            isNewDevice: false, 
            message: `Device verification failed: ${error.message}` 
          };
        }
      }
    }
    
    // Helper function to get user IP
    async function getUserIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) {
        console.error('Error getting IP:', error);
        return 'Unknown';
      }
    }

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tab + 'Form').classList.add('active');
      clearMessages();
    }

    function switchTabDirect(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
      
      document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
      document.getElementById(tab + 'Form').classList.add('active');
      clearMessages();
    }

    function showForgotPassword() {
      document.getElementById('mainContainer').style.display = 'none';
      document.getElementById('forgotContainer').classList.add('active');
      clearMessages();
    }

    function backToLogin() {
      document.getElementById('forgotContainer').classList.remove('active');
      document.getElementById('mainContainer').style.display = 'block';
      clearMessages();
    }

    function contactAdmin() {
      const message = "Hello Fahad, I need help with Tank Tools password reset. My username is: " + document.getElementById('forgotUsername').value + "@knpc.com";
      const whatsappURL = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
      
      try {
        const newWindow = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
        if (!newWindow) window.location.href = whatsappURL;
        showMessage('üì± WhatsApp opened. Contact admin for password reset.', 'info');
      } catch (error) {
        showMessage('üì± Please contact admin via WhatsApp: +965 55222550', 'info');
      }
    }

    // New function for account activation requests
    function contactAdminForActivation(username, fullName) {
      const currentDate = new Date().toLocaleDateString();
      const message = `Hello Fahad,

I am requesting account activation for Tank Tools system.

User Details:
- Name: ${fullName}
- Username: ${username}@knpc.com
- Registration Date: ${currentDate}
- Status: Pending Approval

Please activate my account so I can access the PBCR & WASHERY system.

Thank you.`;

      const whatsappURL = `https://wa.me/${WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
      
      try {
        const newWindow = window.open(whatsappURL, '_blank', 'noopener,noreferrer');
        if (!newWindow) window.location.href = whatsappURL;
        showMessage('üì± WhatsApp opened. Message sent to admin for activation.', 'success');
      } catch (error) {
        showMessage('üì± Please contact admin via WhatsApp: +965 55222550', 'info');
      }
    }

    async function handleForgotPassword(event) {
      event.preventDefault();
      const usernameInput = document.getElementById('forgotUsername');
      
      // Convert username to lowercase
      const username = usernameInput.value.toLowerCase();
      
      if (!username) {
        showMessage('‚ùå Please enter your username', 'error');
        return;
      }
      
      showLoading("resetBtn", "forgotLoading", true);
      
      try {
        // Add password reset request to Firebase
        await addDoc(collection(db, 'passwordResets'), {
          username: username,
          email: `${username}@knpc.com`,
          requestTime: serverTimestamp(),
          status: 'pending'
        });
        
        await addActivity('password_reset_requested', username);
        
        showMessage('üìß Password reset request sent to admin. You will be contacted soon.', 'info');
        
      } catch (error) {
        console.error('Error requesting password reset:', error);
        showMessage('‚ùå Error sending reset request. Please try again.', 'error');
      } finally {
        showLoading("resetBtn", "forgotLoading", false);
      }
    }

    function showLoading(btnId, loadingId, show) {
      const btn = document.getElementById(btnId);
      const loading = document.getElementById(loadingId);
      
      if (btn && loading) {
        if (show) {
          btn.style.display = 'none';
          loading.style.display = 'block';
        } else {
          btn.style.display = 'block';
          loading.style.display = 'none';
        }
      } else {
        console.error("Error: Button or loading element not found for IDs:", btnId, loadingId);
      }
    }

    function showMessage(message, type) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="message ${type}">${message}</div>`;
      setTimeout(() => container.querySelector('.message').classList.add('show'), 100);
      setTimeout(() => container.innerHTML = '', 7000);
    }

    function clearMessages() {
      document.getElementById('messageContainer').innerHTML = '';
    }

    function checkExistingSession() {
      const session = sessionStorage.getItem('tanktools_session');
      const userData = localStorage.getItem('tanktools_current_user');
      
      console.log('üîç Login page checking existing session...');
      console.log('Session:', session);
      console.log('User data exists:', !!userData);
      
      // Only redirect if BOTH session AND valid user data exist
      if (session === 'active' && userData) {
        try {
          const user = JSON.parse(userData);
          console.log('User data parsed:', user);
          
          // Validate user data structure (support both role and specialization)
          if (user && user.username && (user.role || user.specialization)) {
            console.log('‚úÖ Valid session found, redirecting...');
            showMessage('‚úÖ Active session found, redirecting...', 'success');
            setTimeout(() => {
              const redirect = sessionStorage.getItem('tanktools_redirect');
              if (redirect) {
                sessionStorage.removeItem('tanktools_redirect');
                console.log('üéØ Redirecting to:', redirect);
                window.location.href = redirect;
              } else {
                const userRole = user.role || user.specialization;
                const defaultUrl = (userRole === 'admin' || userRole === 'supervisor') ? 'dashboard.html' : 'index.html';
                console.log('üéØ Redirecting to default:', defaultUrl);
                window.location.href = defaultUrl;
              }
            }, 1000);
            return;
          } else {
            console.log('‚ùå Invalid user data structure, clearing session');
            sessionStorage.removeItem('tanktools_session');
            localStorage.removeItem('tanktools_current_user');
          }
        } catch (error) {
          console.log('‚ùå Error parsing user data, clearing session');
          sessionStorage.removeItem('tanktools_session');
          localStorage.removeItem('tanktools_current_user');
        }
      } else {
        console.log('‚ÑπÔ∏è No valid session found, staying on login page');
      }
    }

    function loadSavedCredentials() {
      const saved = localStorage.getItem('tanktools_remember');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          if (data.rememberMe) {
            document.getElementById('loginUsername').value = data.username;
            document.getElementById('rememberMe').checked = true;
          }
        } catch (error) {
          console.log('Error loading saved credentials');
        }
      }
    }

    // Password strength checker
    document.getElementById('password').addEventListener('input', function() {
      const password = this.value;
      const strengthBar = document.getElementById('strengthBar');
      const strengthMsg = document.getElementById('passwordMsg');
      
      let strength = 0;
      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;
      
      const classes = ['strength-weak', 'strength-fair', 'strength-good', 'strength-strong'];
      const messages = ['Weak', 'Fair', 'Good', 'Strong'];
      
      strengthBar.className = 'password-strength-bar ' + (classes[strength - 1] || '');
      
      if (password.length > 0) {
        strengthMsg.textContent = messages[strength - 1] || 'Very Weak';
        strengthMsg.classList.add('show');
        strengthMsg.style.color = strength >= 3 ? '#4CAF50' : '#ff6b6b';
      } else {
        strengthMsg.classList.remove('show');
      }
    });

    // USERNAME LOWERCASE CONVERSION - MAIN FEATURE
    document.addEventListener('DOMContentLoaded', function() {
      // Login form username
      const loginUsernameField = document.getElementById('loginUsername');
      
      // Register form username  
      const registerUsernameField = document.getElementById('username');
      
      // Forgot password username
      const forgotUsernameField = document.getElementById('forgotUsername');
      
      // Function to handle lowercase conversion
      function setupLowercaseInput(field) {
        if (!field) return;
        
        // Convert to lowercase while typing
        field.addEventListener('input', function(e) {
          const cursorPosition = e.target.selectionStart;
          const originalValue = e.target.value;
          const lowercaseValue = originalValue.toLowerCase();
          
          if (originalValue !== lowercaseValue) {
            e.target.value = lowercaseValue;
            e.target.setSelectionRange(cursorPosition, cursorPosition);
          }
        });
        
        // Convert on paste
        field.addEventListener('paste', function(e) {
          setTimeout(() => {
            e.target.value = e.target.value.toLowerCase();
          }, 10);
        });
        
        // Convert on blur (focus out)
        field.addEventListener('blur', function(e) {
          e.target.value = e.target.value.toLowerCase();
        });
      }
      
      // Setup all username fields
      setupLowercaseInput(loginUsernameField);
      setupLowercaseInput(registerUsernameField);
      setupLowercaseInput(forgotUsernameField);
      
      // Add helpful hints
      function addUsernameHint(field) {
        if (!field) return;
        
        const container = field.closest('.username-container');
        if (container && !container.nextElementSibling?.classList.contains('username-hint')) {
          const hint = document.createElement('small');
          hint.className = 'username-hint';
          hint.textContent = 'Username automatically converted to lowercase';
          
          container.parentNode.insertBefore(hint, container.nextSibling);
        }
      }
      
      // Add hints to all username fields
      setTimeout(() => {
        addUsernameHint(loginUsernameField);
        addUsernameHint(registerUsernameField);
        addUsernameHint(forgotUsernameField);
      }, 1000);
    });

    // Font size control functions
    let currentFontSize = parseInt(localStorage.getItem('tanktools_font_size_login') || '16');
    
    function increaseFontSize() {
      if (currentFontSize < 24) {
        currentFontSize += 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_login', currentFontSize);
        showFontMessage(`üìà Font size increased to ${currentFontSize}px`);
      }
    }
    
    function decreaseFontSize() {
      if (currentFontSize > 12) {
        currentFontSize -= 2;
        applyFontSize();
        localStorage.setItem('tanktools_font_size_login', currentFontSize);
        showFontMessage(`üìâ Font size decreased to ${currentFontSize}px`);
      }
    }
    
    function applyFontSize() {
      const style = document.createElement('style');
      style.id = 'dynamic-font-style';
      
      const existingStyle = document.getElementById('dynamic-font-style');
      if (existingStyle) {
        existingStyle.remove();
      }
      
      style.textContent = `
        input { font-size: ${currentFontSize}px !important; }
        label { font-size: ${currentFontSize}px !important; }
        .btn { font-size: ${currentFontSize + 2}px !important; }
        .tab { font-size: ${currentFontSize}px !important; }
        .logo { font-size: ${currentFontSize + 32}px !important; }
        .subtitle { font-size: ${currentFontSize + 4}px !important; }
        .firebase-status { font-size: ${currentFontSize - 3}px !important; }
        .forgot-password-link { font-size: ${currentFontSize - 2}px !important; }
        .validation-message { font-size: ${currentFontSize - 4}px !important; }
      `;
      
      document.head.appendChild(style);
    }
    
    function showFontMessage(message) {
      const msgDiv = document.createElement('div');
      msgDiv.style.cssText = 'position:fixed;top:80px;right:20px;background:rgba(76,175,80,0.9);color:white;padding:10px 15px;border-radius:8px;font-size:12px;z-index:1000;animation:slideIn 0.3s ease';
      msgDiv.textContent = message;
      document.body.appendChild(msgDiv);
      setTimeout(() => msgDiv.remove(), 3000);
    }
    
    // Apply saved font size on page load
    applyFontSize();

    // Device Info Display Function
    async function showDeviceInfo() {
      try {
        showMessage('üîç Analyzing your device...', 'info');
        
        const deviceInfo = await generateDeviceFingerprint();
        const readableInfo = deviceInfo.readableInfo;
        
        const deviceInfoHTML = `
          <div style="background: rgba(0,0,0,0.8); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);" onclick="this.remove()">
            <div style="background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05)); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; padding: 25px; max-width: 400px; color: white; box-shadow: 0 8px 32px rgba(0,0,0,0.3); backdrop-filter: blur(10px);" onclick="event.stopPropagation()">
              <h3 style="text-align: center; margin: 0 0 20px 0; color: #2196F3;">üì± Your Device Information</h3>
              
              <div style="margin: 10px 0;">
                <strong>üè∑Ô∏è Device Name:</strong><br>
                <span style="color: #4CAF50;">${readableInfo.deviceName}</span>
              </div>
              
              <div style="margin: 10px 0;">
                <strong>üì± Device Type:</strong><br>
                <span style="color: #FF9800;">${readableInfo.deviceType}</span>
              </div>
              
              <div style="margin: 10px 0;">
                <strong>üåê Browser:</strong><br>
                <span style="color: #9C27B0;">${readableInfo.browser}</span>
              </div>
              
              <div style="margin: 10px 0;">
                <strong>üíª Operating System:</strong><br>
                <span style="color: #FF5722;">${readableInfo.os}</span>
              </div>
              
              <div style="margin: 10px 0;">
                <strong>üì∫ Screen:</strong><br>
                <span style="color: #607D8B;">${readableInfo.screenResolution}</span>
              </div>
              
              <div style="margin: 10px 0;">
                <strong>üåç Location:</strong><br>
                <span style="color: #795548;">${readableInfo.timezone}</span>
              </div>
              
              <div style="margin: 15px 0; padding: 10px; background: rgba(33,150,243,0.1); border-radius: 8px; border: 1px solid rgba(33,150,243,0.3);">
                <small style="color: #2196F3;">
                  üîê This information is used for security purposes to ensure only your registered device can access the system.
                </small>
              </div>
              
              <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 10px; background: linear-gradient(45deg, #4CAF50, #45a049); color: white; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                ‚úÖ Got it!
              </button>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', deviceInfoHTML);
        
      } catch (error) {
        console.error('Error showing device info:', error);
        showMessage('‚ùå Could not retrieve device information', 'error');
      }
    }

    // ‚úÖ Auto-Logout after 7 days (PWA only)
    function checkAutoLogout() {
      const isPWA = window.matchMedia('(display-mode: standalone)').matches;
      
      if (!isPWA) {
        // Not PWA, no auto-logout needed
        return;
      }
      
      const loginTimestamp = localStorage.getItem('tanktools_login_timestamp');
      if (!loginTimestamp) {
        // No timestamp saved, skip
        return;
      }
      
      const now = Date.now();
      const loginTime = parseInt(loginTimestamp);
      const sevenDaysInMs = 7 * 24 * 60 * 60 * 1000; // 7 days
      
      if (now - loginTime > sevenDaysInMs) {
        console.log('‚è∞ Auto-Logout: 7 days passed, logging out...');
        
        // Clear all session data
        localStorage.removeItem('tanktools_current_user');
        localStorage.removeItem('tanktools_login_timestamp');
        localStorage.removeItem('username');
        sessionStorage.removeItem('tanktools_session');
        
        // Sign out from Firebase Auth
        if (window.auth) {
          window.auth.signOut().then(() => {
            console.log('‚úÖ Firebase Auth signed out');
          }).catch(error => {
            console.error('‚ùå Error signing out:', error);
          });
        }
        
        alert('‚è∞ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿÆÿ±Ÿàÿ¨ŸÉ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ 7 ÿ£ŸäÿßŸÖ. Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.');
        window.location.href = 'login.html';
      } else {
        const daysLeft = Math.ceil((sevenDaysInMs - (now - loginTime)) / (24 * 60 * 60 * 1000));
        console.log(`‚úÖ Auto-Logout: ${daysLeft} days left until auto-logout`);
      }
    }
    
    // Make functions global
    window.handleLogin = handleLogin;
    window.handleRegister = handleRegister;
    window.switchTab = switchTab;
    window.showForgotPassword = showForgotPassword;
    window.backToLogin = backToLogin;
    window.contactAdmin = contactAdmin;
    window.contactAdminForActivation = contactAdminForActivation;
    window.handleForgotPassword = handleForgotPassword;
    window.increaseFontSize = increaseFontSize;
    window.decreaseFontSize = decreaseFontSize;
    window.showDeviceInfo = showDeviceInfo;

    // Initialize when page loads
    window.addEventListener('load', () => {
      loadSavedCredentials();
      
      // ‚úÖ Check auto-logout (7 days for PWA)
      checkAutoLogout();
      
      // Wait for Firebase to initialize before checking session
      setTimeout(() => {
        checkExistingSession();
      }, 1000);
    });

    console.log('%cüî• TANK TOOLS - FIREBASE LOGIN SYSTEM', 'color:orange;font-size:20px;font-weight:bold');
    console.log('%c‚úÖ Username lowercase conversion activated', 'color:green;font-size:16px;font-weight:bold');
    console.log('%cDeveloper: Fahad - 17877', 'color:green;font-size:16px');
    console.log('%cUsers require admin approval after registration', 'color:blue;font-size:14px');

    // WhatsApp functionality
    const WHATSAPP_NUMBER="96555222550";
    window.openWhatsApp=()=>{
      const message="ŸÖÿ±ÿ≠ÿ®ÿßÿå ÿ£ÿ™ŸàÿßÿµŸÑ ŸÖÿπŸÉ ŸÖŸÜ ÿÆŸÑÿßŸÑ ÿ™ÿ∑ÿ®ŸäŸÇ Tank Tools";
      const whatsappURL=`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
      try{
        const newWindow=window.open(whatsappURL,'_blank','noopener,noreferrer');
        if(!newWindow)window.location.href=whatsappURL
      }catch{
        navigator.clipboard.writeText(whatsappURL).then(()=>alert(`ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}`)).catch(()=>alert(`ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸàÿßÿ™ÿ≥ÿßÿ®:\n${whatsappURL}`))
      }
    };
  </script>

  <style>
    .whatsapp-link{color:#25D366;text-decoration:none;font-weight:bold;transition:all 0.3s ease;cursor:pointer}
    .whatsapp-link:hover{color:#128C7E;text-shadow:0 0 5px rgba(37,211,102,0.5);transform:scale(1.05)}
  </style>
</body>
</html>

