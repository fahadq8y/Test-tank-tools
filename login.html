<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tank Tools</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" href="icon.png" type="image/png">
  <meta name="theme-color" content="#003366">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Tank Tools">
  <style>
    *{margin:0;padding:0;box-sizing:border-box}body{background:linear-gradient(rgba(0,0,0,0.5),rgba(0,0,0,0.5)),url('background.jpg');background-size:cover;background-position:center;background-attachment:fixed;background-repeat:no-repeat;font-family:Arial,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:center;color:white}.container{background:rgba(255,255,255,0.1);backdrop-filter:blur(10px);border-radius:15px;padding:40px;box-shadow:0 8px 32px rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.2);width:100%;max-width:450px;text-align:center;position:relative;overflow:hidden}.container::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.1),transparent);transition:0.5s}.container:hover::before{left:100%}.logo{font-size:3rem;margin-bottom:10px;background:linear-gradient(45deg,#FFD700,#FFA500);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;animation:pulse 2s ease-in-out infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}.subtitle{font-size:1.2rem;margin-bottom:30px;opacity:0.9;font-weight:300}.tab-container{display:flex;margin-bottom:30px;background:rgba(255,255,255,0.1);border-radius:10px;padding:5px}.tab{flex:1;padding:12px 20px;border:none;background:transparent;color:white;cursor:pointer;border-radius:8px;transition:all 0.3s ease;font-weight:500}.tab.active{background:linear-gradient(45deg,#4CAF50,#45a049);box-shadow:0 5px 15px rgba(76,175,80,0.3);transform:translateY(-2px)}.form-container{display:none}.form-container.active{display:block;animation:slideIn 0.5s ease}@keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}.form-group{margin-bottom:20px;text-align:left}label{display:block;margin-bottom:8px;font-weight:500;color:rgba(255,255,255,0.9)}input{width:100%;padding:15px;border:none;border-radius:10px;background:rgba(255,255,255,0.9);color:#003366;font-size:16px;transition:all 0.3s ease;border:2px solid transparent;box-shadow:0 2px 5px rgba(0,0,0,0.3)}input::placeholder{color:rgba(0,51,102,0.6)}input:focus{outline:none;background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}.username-container{display:flex;align-items:center;background:rgba(255,255,255,0.9);border-radius:10px;border:2px solid transparent;transition:all 0.3s ease;box-shadow:0 2px 5px rgba(0,0,0,0.3)}.username-container:focus-within{background:rgba(255,255,255,1);border-color:#4CAF50;transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.2)}.username-input{background:transparent;border:none;padding:15px;flex:1;box-shadow:none;transform:none;color:#003366;font-family:monospace;text-transform:lowercase}.username-input:focus{background:transparent;border:none;box-shadow:none;transform:none}.email-suffix{padding:15px;color:#003366;font-weight:500;background:rgba(0,51,102,0.1);border-radius:0 8px 8px 0}.validation-message{margin-top:5px;font-size:12px;color:#ff6b6b;opacity:0;transition:opacity 0.3s ease}.validation-message.show{opacity:1}.validation-message.success{color:#4CAF50}.password-strength{margin-top:8px;height:4px;background:rgba(255,255,255,0.2);border-radius:2px;overflow:hidden}.password-strength-bar{height:100%;width:0%;transition:all 0.3s ease;border-radius:2px}.strength-weak{background:#ff6b6b;width:25%}.strength-fair{background:#ffa726;width:50%}.strength-good{background:#42a5f5;width:75%}.strength-strong{background:#4CAF50;width:100%}.btn{width:100%;padding:15px;border:none;border-radius:10px;font-size:18px;font-weight:600;cursor:pointer;transition:all 0.3s ease;margin-top:20px;position:relative;overflow:hidden}.btn-primary{background:linear-gradient(45deg,#4CAF50,#45a049);color:white}.btn-secondary{background:linear-gradient(45deg,#2196F3,#1976D2);color:white;margin-top:10px;font-size:14px;padding:10px}.btn-danger{background:linear-gradient(45deg,#f44336,#d32f2f);color:white;margin-top:10px;font-size:14px;padding:10px}.btn:hover{transform:translateY(-3px);box-shadow:0 15px 30px rgba(76,175,80,0.4)}.btn:disabled{background:#ccc;cursor:not-allowed;transform:none}.btn::before{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);transition:0.5s}.btn:hover::before{left:100%}.forgot-password-link{color:#2196F3;text-decoration:none;font-size:14px;display:block;margin-top:15px;transition:all 0.3s ease}.forgot-password-link:hover{color:#1976D2;text-shadow:0 0 5px rgba(33,150,243,0.5)}.message{margin-top:15px;padding:12px;border-radius:8px;font-size:14px;opacity:0;transform:translateY(-10px);transition:all 0.3s ease}.message.show{opacity:1;transform:translateY(0)}.message.success{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50}.message.error{background:rgba(255,107,107,0.2);border:1px solid rgba(255,107,107,0.5);color:#ff6b6b}.message.info{background:rgba(33,150,243,0.2);border:1px solid rgba(33,150,243,0.5);color:#2196F3}.message.warning{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#ffc107}.footer{margin-top:30px;font-size:12px;opacity:0.7;text-align:center}.loading{display:none;margin-top:10px}.spinner{border:3px solid rgba(255,255,255,0.3);border-radius:50%;border-top:3px solid white;width:30px;height:30px;animation:spin 1s linear infinite;margin:0 auto}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}.firebase-status{background:rgba(76,175,80,0.2);border:1px solid rgba(76,175,80,0.5);color:#4CAF50;padding:10px;border-radius:8px;margin-bottom:20px;font-size:13px;text-align:center}.forgot-container{display:none;text-align:center}.forgot-container.active{display:block;animation:slideIn 0.5s ease}.forgot-icon{font-size:4rem;margin-bottom:20px;color:#2196F3}.forgot-title{font-size:1.5rem;margin-bottom:15px;color:#2196F3}.forgot-text{margin-bottom:20px;opacity:0.8}.back-btn{background:transparent;border:1px solid rgba(255,255,255,0.3);color:white;padding:10px 20px;border-radius:8px;cursor:pointer;transition:all 0.3s ease;margin-top:10px}.back-btn:hover{background:rgba(255,255,255,0.1)}.security-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:9999;backdrop-filter:blur(5px)}.security-modal.show{display:flex;justify-content:center;align-items:center}.security-modal-content{background:rgba(255,255,255,0.95);padding:30px;border-radius:15px;max-width:500px;width:90%;color:#003366;text-align:center;animation:modalSlideIn 0.5s ease}@keyframes modalSlideIn{from{opacity:0;transform:scale(0.8)}to{opacity:1;transform:scale(1)}}.security-icon{font-size:3rem;margin-bottom:15px}.security-title{font-size:1.5rem;margin-bottom:15px;font-weight:bold}.security-text{margin-bottom:20px;line-height:1.5}.attempt-counter{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:10px;border-radius:8px;margin:15px 0;font-weight:bold}.security-buttons{display:flex;gap:10px;justify-content:center;flex-wrap:wrap}.modal-btn{padding:10px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease}.modal-btn-primary{background:#4CAF50;color:white}.modal-btn-secondary{background:#2196F3;color:white}.modal-btn-danger{background:#f44336;color:white}.modal-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,0.3)}.font-controls{position:absolute;top:15px;right:15px;display:flex;gap:8px}.font-btn{background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);color:white;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:18px;font-weight:bold;transition:all 0.3s ease;min-width:40px;min-height:40px;display:flex;align-items:center;justify-content:center}.font-btn:hover{background:rgba(255,255,255,0.3);transform:translateY(-1px);box-shadow:0 4px 8px rgba(0,0,0,0.2)}.username-hint{color:#999;font-size:11px;display:block;margin-top:3px;text-align:center}.device-warning{background:rgba(255,193,7,0.2);border:1px solid rgba(255,193,7,0.5);color:#f57c00;padding:15px;border-radius:8px;margin:15px 0;text-align:center}.device-warning h3{margin-bottom:10px;color:#e65100}.device-warning p{margin-bottom:15px;line-height:1.4}.whatsapp-btn{background:linear-gradient(45deg,#25D366,#128C7E);color:white;padding:12px 20px;border:none;border-radius:8px;cursor:pointer;font-weight:500;transition:all 0.3s ease;text-decoration:none;display:inline-block}.whatsapp-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(37,211,102,0.4)}@media (max-width:480px){.container{padding:30px 20px;margin:20px}.logo{font-size:2.5rem}.tab{padding:10px 15px;font-size:14px}.security-buttons{flex-direction:column}.modal-btn{width:100%}}
  </style>
</head>
<body>
  <div id="securityModal" class="security-modal">
    <div class="security-modal-content">
      <div class="security-icon" id="securityIcon">‚ö†Ô∏è</div>
      <div class="security-title" id="securityTitle">Security Warning</div>
      <div class="security-text" id="securityText">We detected you trying to access developer tools.</div>
      <div class="attempt-counter" id="attemptCounter">Attempts: <span id="attemptCount">1</span>/3</div>
      <div class="security-buttons">
        <button class="modal-btn modal-btn-primary" onclick="acknowledgeWarning()">I Understand</button>
        <button class="modal-btn modal-btn-secondary" onclick="resetPage()">Reset Page</button>
        <button class="modal-btn modal-btn-danger" onclick="learnMore()">Learn More</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="font-controls">
      <button class="font-btn" onclick="decreaseFontSize()" title="ÿ™ÿµÿ∫Ÿäÿ± ÿßŸÑÿÆÿ∑">-</button>
      <button class="font-btn" onclick="increaseFontSize()" title="ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿÆÿ∑">+</button>
    </div>
    <div class="logo">üõ†Ô∏è Tank Tools</div>
    <div class="subtitle">Kuwait National Petroleum Company</div>
    <div class="firebase-status">üî• Firebase Cloud Database - Real-time & Secure</div>
    
    <div id="mainContainer">
      <div class="tab-container">
        <button class="tab active" onclick="switchTab('login')">Login</button>
        <button class="tab" onclick="switchTab('register')">Register</button>
      </div>

      <div id="loginForm" class="form-container active">
        <form onsubmit="handleLogin(event)">
          <div class="form-group">
            <label for="loginUsername">üë§ Username:</label>
            <div class="username-container">
              <input type="text" id="loginUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
              <div class="email-suffix">@knpc.com</div>
            </div>
            <div class="validation-message" id="loginUsernameMsg"></div>
          </div>
          <div class="form-group">
            <label for="loginPassword">üîí Password:</label>
            <input type="password" id="loginPassword" placeholder="Enter your password" required>
          </div>
          <div class="form-group">
            <label><input type="checkbox" id="rememberMe" style="width:auto;margin-right:8px;">Remember me</label>
          </div>
          <button type="submit" class="btn btn-primary" id="loginBtn">üöÄ Login</button>
          <a href="#" class="forgot-password-link" onclick="showForgotPassword()">üîë Forgot Password?</a>
          <div class="loading" id="loginLoading"><div class="spinner"></div><div>Connecting to Firebase...</div></div>
        </form>
      </div>

      <div id="registerForm" class="form-container">
        <form onsubmit="handleRegister(event)">
          <div class="form-group">
            <label for="fullName">üë§ Full Name:</label>
            <input type="text" id="fullName" placeholder="Enter your full name" required minlength="3">
            <div class="validation-message" id="fullNameMsg"></div>
          </div>
          <div class="form-group">
            <label for="username">üìß Username (Email):</label>
            <div class="username-container">
              <input type="text" id="username" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
              <div class="email-suffix">@knpc.com</div>
            </div>
            <div class="validation-message" id="usernameMsg"></div>
          </div>

          <div class="form-group">
            <label for="password">üîí Password:</label>
            <input type="password" id="password" placeholder="Create a strong password" required minlength="8">
            <div class="password-strength"><div class="password-strength-bar" id="strengthBar"></div></div>
            <div class="validation-message" id="passwordMsg"></div>
          </div>
          <div class="form-group">
            <label for="confirmPassword">üîí Confirm Password:</label>
            <input type="password" id="confirmPassword" placeholder="Confirm your password" required>
            <div class="validation-message" id="confirmPasswordMsg"></div>
          </div>
          <button type="submit" class="btn btn-primary" id="registerBtn">‚ú® Create Account</button>
          <div class="loading" id="registerLoading"><div class="spinner"></div><div>Creating account in Firebase...</div></div>
        </form>
      </div>
    </div>

    <div id="forgotContainer" class="forgot-container">
      <div class="forgot-icon">üîë</div>
      <div class="forgot-title">Reset Password</div>
      <div class="forgot-text">Enter your username to reset your password</div>
      <form onsubmit="handleForgotPassword(event)">
        <div class="form-group">
          <label for="forgotUsername">üë§ Username:</label>
          <div class="username-container">
            <input type="text" id="forgotUsername" class="username-input" placeholder="abc123" required pattern="[a-zA-Z]{3}[0-9]{3}" maxlength="6">
            <div class="email-suffix">@knpc.com</div>
          </div>
        </div>
        <button type="submit" class="btn btn-secondary" id="resetBtn">üìß Send Reset Request</button>
        <button type="button" class="btn btn-danger" onclick="contactAdmin()" style="margin-top:10px;">üì± Contact Admin</button>
        <button type="button" class="back-btn" onclick="backToLogin()">Back to Login</button>
        <div class="loading" id="forgotLoading"><div class="spinner"></div><div>Processing request...</div></div>
      </form>
    </div>

    <!-- Device Warning Modal -->
    <div id="deviceWarning" class="device-warning" style="display:none;">
      <h3>üîí Device Access Restricted</h3>
      <p>This account is registered on another device. For security reasons, you cannot login from this device.</p>
      <p>If you need to change your registered device, please contact the administrator.</p>
      <a href="#" id="whatsappBtn" class="whatsapp-btn" onclick="contactAdminForDeviceChange()">üì± Contact Admin via WhatsApp</a>
    </div>

    <div id="messageContainer"></div>
    <div class="footer"><strong>üî• Firebase Powered</strong><br>By <strong>Fahad - 17877</strong> | Version v5.0 Device Management<br><small>Real-time cloud database</small></div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyD7lJcoY33FEC9d6eWy67QIO9SV4lS24pg",
      authDomain: "tank-tools-knpc-c2d95.firebaseapp.com",
      projectId: "tank-tools-knpc-c2d95",
      storageBucket: "tank-tools-knpc-c2d95.firebasestorage.app",
      messagingSenderId: "510062594324",
      appId: "1:510062594324:web:b892fd02007a5ca2f0da01"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Make Firebase functions globally available
    window.db = db;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.updateDoc = updateDoc;
    window.collection = collection;
    window.addDoc = addDoc;
    window.serverTimestamp = serverTimestamp;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;

    console.log('üî• Firebase initialized successfully!');
  </script>

  <script>
    // Enhanced Security system with improved device detection
    let securityAttempts = 0;
    const maxAttempts = 3;
    let fontSize = 16;

    // Device fingerprinting function
    function generateDeviceFingerprint() {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.textBaseline = 'top';
      ctx.font = '14px Arial';
      ctx.fillText('Device fingerprint', 2, 2);
      
      const fingerprint = btoa(
        navigator.userAgent + 
        screen.width + 'x' + screen.height + 
        screen.colorDepth + 
        new Date().getTimezoneOffset() +
        navigator.language +
        (navigator.platform || '') +
        canvas.toDataURL()
      ).replace(/[^a-zA-Z0-9]/g, '').substring(0, 32);
      
      console.log('Generated device fingerprint:', fingerprint);
      return fingerprint;
    }

    // Check device access
    async function checkDeviceAccess(username) {
      try {
        console.log('Checking device access for:', username);
        const currentDeviceId = generateDeviceFingerprint();
        console.log('Current device ID:', currentDeviceId);
        
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists()) {
          console.log('User document does not exist, allowing first-time login');
          return { allowed: true, isFirstTime: true };
        }
        
        const userData = userDoc.data();
        const maxDevices = userData.maxDevices || 1;
        const devices = userData.devices || [];
        
        console.log('User max devices:', maxDevices);
        console.log('Registered devices:', devices);
        
        // Check if current device is already registered
        const existingDevice = devices.find(device => device.id === currentDeviceId);
        if (existingDevice) {
          console.log('Device already registered, updating last used time');
          // Update last used time
          const updatedDevices = devices.map(device => 
            device.id === currentDeviceId 
              ? { ...device, lastUsed: new Date().toISOString() }
              : device
          );
          await updateDoc(userDocRef, { devices: updatedDevices });
          return { allowed: true, isFirstTime: false };
        }
        
        // Check if user has reached max devices
        if (devices.length >= maxDevices) {
          console.log('Max devices reached, access denied');
          return { allowed: false, reason: 'max_devices_reached', maxDevices, currentDevices: devices.length };
        }
        
        // Add new device
        console.log('Adding new device');
        const newDevice = {
          id: currentDeviceId,
          name: getDeviceName(),
          userAgent: navigator.userAgent,
          screen: `${screen.width}x${screen.height}`,
          addedAt: new Date().toISOString(),
          lastUsed: new Date().toISOString()
        };
        
        const updatedDevices = [...devices, newDevice];
        await updateDoc(userDocRef, { devices: updatedDevices });
        
        return { allowed: true, isFirstTime: false };
        
      } catch (error) {
        console.error('Error checking device access:', error);
        return { allowed: true, isFirstTime: false }; // Allow login on error
      }
    }

    // Get device name
    function getDeviceName() {
      const userAgent = navigator.userAgent;
      if (/iPhone/i.test(userAgent)) return 'iPhone';
      if (/iPad/i.test(userAgent)) return 'iPad';
      if (/Android/i.test(userAgent)) return 'Android';
      if (/Windows/i.test(userAgent)) return 'Windows PC';
      if (/Mac/i.test(userAgent)) return 'Mac';
      if (/Linux/i.test(userAgent)) return 'Linux';
      return 'Unknown Device';
    }

    // Contact admin for device change
    function contactAdminForDeviceChange() {
      const username = document.getElementById('loginUsername').value;
      const deviceInfo = getDeviceName();
      const screenInfo = `${screen.width}x${screen.height}`;
      const currentTime = new Date().toLocaleString('en-GB', { 
        timeZone: 'Asia/Kuwait',
        day: '2-digit',
        month: '2-digit', 
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      const message = `Hello Fahad,

I need to change my registered device for Tank Tools system.

User Details:
- Username: ${username}@knpc.com
- Request Date: ${currentTime.split(',')[0]}
- Request Time: ${currentTime.split(',')[1]}
- Current Device: ${deviceInfo}
- Screen: ${screenInfo}

My account is currently registered on another device. Please update my device registration so I can access the system from this device.

Thank you.`;

      const whatsappUrl = `https://wa.me/96599769769?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }

    // Enhanced login handler with device checking
    async function handleLogin(event) {
      event.preventDefault();
      
      const username = document.getElementById('loginUsername').value.toLowerCase();
      const password = document.getElementById('loginPassword').value;
      const rememberMe = document.getElementById('rememberMe').checked;
      
      if (!username || !password) {
        showMessage('Please fill in all fields', 'error');
        return;
      }
      
      showLoading('loginLoading', true);
      document.getElementById('loginBtn').disabled = true;
      
      try {
        // First check credentials
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists()) {
          showMessage('Invalid username or password', 'error');
          return;
        }
        
        const userData = userDoc.data();
        if (userData.password !== password) {
          showMessage('Invalid username or password', 'error');
          return;
        }
        
        if (!userData.isActive) {
          showMessage('Account is deactivated. Contact administrator.', 'error');
          return;
        }
        
        // Now check device access
        console.log('Credentials verified, checking device access...');
        const deviceCheck = await checkDeviceAccess(username);
        
        if (!deviceCheck.allowed) {
          console.log('Device access denied:', deviceCheck.reason);
          showDeviceWarning();
          return;
        }
        
        // Login successful
        console.log('Login successful, device access granted');
        
        // Set session active flag FIRST
        sessionStorage.setItem('tanktools_session', 'active');
        
        const sessionData = {
          username: username,
          fullName: userData.fullName,
          role: userData.role,
          permissions: userData.permissions || {},
          loginTime: new Date().toISOString(),
          deviceId: generateDeviceFingerprint()
        };
        
        // Save session with correct names that match permissions.js
        if (rememberMe) {
          localStorage.setItem('tankToolsSession', JSON.stringify(sessionData));
          localStorage.setItem('tanktools_current_user', JSON.stringify(sessionData));
        } else {
          sessionStorage.setItem('tankToolsSession', JSON.stringify(sessionData));
          sessionStorage.setItem('tanktools_current_user', JSON.stringify(sessionData));
        }
        
        console.log('Session data saved successfully:', sessionData);
        
        showMessage('Login successful! Redirecting...', 'success');
        
        setTimeout(() => {
          window.location.href = 'index.html';
        }, 1500);
        
      } catch (error) {
        console.error('Login error:', error);
        showMessage('Connection error. Please try again.', 'error');
      } finally {
        showLoading('loginLoading', false);
        document.getElementById('loginBtn').disabled = false;
      }
    }

    // Show device warning
    function showDeviceWarning() {
      document.getElementById('deviceWarning').style.display = 'block';
      document.getElementById('loginForm').style.display = 'none';
      showMessage('Device access restricted. Contact administrator to change registered device.', 'warning');
    }

    // Hide device warning and return to login
    function hideDeviceWarning() {
      document.getElementById('deviceWarning').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }

    // Enhanced register handler
    async function handleRegister(event) {
      event.preventDefault();
      
      const fullName = document.getElementById('fullName').value;
      const username = document.getElementById('username').value.toLowerCase();
      const password = document.getElementById('password').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (!fullName || !username || !password || !confirmPassword) {
        showMessage('Please fill in all fields', 'error');
        return;
      }
      
      if (password !== confirmPassword) {
        showMessage('Passwords do not match', 'error');
        return;
      }
      
      if (password.length < 8) {
        showMessage('Password must be at least 8 characters', 'error');
        return;
      }
      
      showLoading('registerLoading', true);
      document.getElementById('registerBtn').disabled = true;
      
      try {
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (userDoc.exists()) {
          showMessage('Username already exists', 'error');
          return;
        }
        
        const deviceId = generateDeviceFingerprint();
        const newDevice = {
          id: deviceId,
          name: getDeviceName(),
          userAgent: navigator.userAgent,
          screen: `${screen.width}x${screen.height}`,
          addedAt: new Date().toISOString(),
          lastUsed: new Date().toISOString()
        };
        
        const userData = {
          fullName: fullName,
          username: username,
          password: password,
          role: 'user',
          isActive: false,
          maxDevices: 1,
          devices: [newDevice],
          permissions: {
            canViewPBCR: false,
            canViewPLCR: false,
            canViewLiveTanks: false,
            canAddToLiveTanks: false,
            canEditLiveTanks: false,
            canDeleteFromLiveTanks: false
          },
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        await setDoc(userDocRef, userData);
        
        showMessage('Account created successfully! Please wait for admin approval.', 'success');
        
        setTimeout(() => {
          switchTab('login');
        }, 2000);
        
      } catch (error) {
        console.error('Registration error:', error);
        showMessage('Registration failed. Please try again.', 'error');
      } finally {
        showLoading('registerLoading', false);
        document.getElementById('registerBtn').disabled = false;
      }
    }

    // Forgot password handler
    async function handleForgotPassword(event) {
      event.preventDefault();
      
      const username = document.getElementById('forgotUsername').value.toLowerCase();
      
      if (!username) {
        showMessage('Please enter your username', 'error');
        return;
      }
      
      showLoading('forgotLoading', true);
      document.getElementById('resetBtn').disabled = true;
      
      try {
        const userDocRef = doc(db, 'users', username);
        const userDoc = await getDoc(userDocRef);
        
        if (!userDoc.exists()) {
          showMessage('Username not found', 'error');
          return;
        }
        
        const resetRequest = {
          username: username,
          requestedAt: new Date().toISOString(),
          status: 'pending',
          deviceInfo: {
            userAgent: navigator.userAgent,
            screen: `${screen.width}x${screen.height}`,
            deviceName: getDeviceName()
          }
        };
        
        await addDoc(collection(db, 'passwordResets'), resetRequest);
        
        showMessage('Password reset request sent! Admin will contact you soon.', 'success');
        
        setTimeout(() => {
          backToLogin();
        }, 3000);
        
      } catch (error) {
        console.error('Password reset error:', error);
        showMessage('Failed to send reset request. Please try again.', 'error');
      } finally {
        showLoading('forgotLoading', false);
        document.getElementById('resetBtn').disabled = false;
      }
    }

    // Contact admin function
    function contactAdmin() {
      const message = `Hello Fahad,

I need help with my Tank Tools account.

Please assist me with password reset or account access.

Thank you.`;

      const whatsappUrl = `https://wa.me/96599769769?text=${encodeURIComponent(message)}`;
      window.open(whatsappUrl, '_blank');
    }

    // Tab switching
    function switchTab(tabName) {
      const tabs = document.querySelectorAll('.tab');
      const containers = document.querySelectorAll('.form-container');
      
      tabs.forEach(tab => tab.classList.remove('active'));
      containers.forEach(container => container.classList.remove('active'));
      
      document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
      document.getElementById(`${tabName}Form`).classList.add('active');
      
      hideDeviceWarning();
      clearMessages();
    }

    // Show/hide forgot password
    function showForgotPassword() {
      document.getElementById('mainContainer').style.display = 'none';
      document.getElementById('forgotContainer').classList.add('active');
      hideDeviceWarning();
    }

    function backToLogin() {
      document.getElementById('mainContainer').style.display = 'block';
      document.getElementById('forgotContainer').classList.remove('active');
      clearMessages();
    }

    // Utility functions
    function showMessage(text, type) {
      const container = document.getElementById('messageContainer');
      container.innerHTML = `<div class="message ${type} show">${text}</div>`;
      
      setTimeout(() => {
        const message = container.querySelector('.message');
        if (message) {
          message.classList.remove('show');
          setTimeout(() => container.innerHTML = '', 300);
        }
      }, 5000);
    }

    function clearMessages() {
      document.getElementById('messageContainer').innerHTML = '';
    }

    function showLoading(elementId, show) {
      const element = document.getElementById(elementId);
      element.style.display = show ? 'block' : 'none';
    }

    // Font size controls
    function increaseFontSize() {
      fontSize = Math.min(fontSize + 2, 24);
      document.body.style.fontSize = fontSize + 'px';
    }

    function decreaseFontSize() {
      fontSize = Math.max(fontSize - 2, 12);
      document.body.style.fontSize = fontSize + 'px';
    }

    // Security functions
    function acknowledgeWarning() {
      document.getElementById('securityModal').classList.remove('show');
    }

    function resetPage() {
      location.reload();
    }

    function learnMore() {
      alert('Developer tools can compromise the security of this application. Please avoid using them.');
      document.getElementById('securityModal').classList.remove('show');
    }

    // Enhanced security monitoring
    document.addEventListener('keydown', function(e) {
      if (e.key === 'F12' || 
          (e.ctrlKey && e.shiftKey && e.key === 'I') ||
          (e.ctrlKey && e.shiftKey && e.key === 'C') ||
          (e.ctrlKey && e.key === 'U')) {
        e.preventDefault();
        securityAttempts++;
        
        if (securityAttempts >= maxAttempts) {
          document.getElementById('securityIcon').textContent = 'üö®';
          document.getElementById('securityTitle').textContent = 'Security Breach Detected';
          document.getElementById('securityText').textContent = 'Multiple attempts to access developer tools detected. This incident will be reported.';
        }
        
        document.getElementById('attemptCount').textContent = securityAttempts;
        document.getElementById('securityModal').classList.add('show');
      }
    });

    document.addEventListener('contextmenu', function(e) {
      e.preventDefault();
    });

    // Password strength checker
    document.getElementById('password')?.addEventListener('input', function() {
      const password = this.value;
      const strengthBar = document.getElementById('strengthBar');
      const strengthMsg = document.getElementById('passwordMsg');
      
      let strength = 0;
      let message = '';
      
      if (password.length >= 8) strength++;
      if (/[a-z]/.test(password)) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;
      
      strengthBar.className = 'password-strength-bar';
      
      switch (strength) {
        case 0:
        case 1:
          strengthBar.classList.add('strength-weak');
          message = 'Weak password';
          break;
        case 2:
          strengthBar.classList.add('strength-fair');
          message = 'Fair password';
          break;
        case 3:
          strengthBar.classList.add('strength-good');
          message = 'Good password';
          break;
        case 4:
        case 5:
          strengthBar.classList.add('strength-strong');
          message = 'Strong password';
          break;
      }
      
      strengthMsg.textContent = message;
      strengthMsg.className = 'validation-message show';
    });

    // Username validation
    document.getElementById('username')?.addEventListener('input', function() {
      const username = this.value;
      const msg = document.getElementById('usernameMsg');
      
      if (username.length === 6 && /^[a-zA-Z]{3}[0-9]{3}$/.test(username)) {
        msg.textContent = 'Valid username format';
        msg.className = 'validation-message success show';
      } else if (username.length > 0) {
        msg.textContent = 'Format: 3 letters + 3 numbers (e.g., abc123)';
        msg.className = 'validation-message show';
      } else {
        msg.className = 'validation-message';
      }
    });

    document.getElementById('loginUsername')?.addEventListener('input', function() {
      const username = this.value;
      const msg = document.getElementById('loginUsernameMsg');
      
      if (username.length === 6 && /^[a-zA-Z]{3}[0-9]{3}$/.test(username)) {
        msg.textContent = 'Valid username format';
        msg.className = 'validation-message success show';
      } else if (username.length > 0) {
        msg.textContent = 'Format: 3 letters + 3 numbers (e.g., abc123)';
        msg.className = 'validation-message show';
      } else {
        msg.className = 'validation-message';
      }
    });

    // Service Worker Registration - DISABLED temporarily to fix navigation issues
    /*
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/sw.js')
          .then(function(registration) {
            console.log('ServiceWorker registration successful');
          })
          .catch(function(err) {
            console.log('ServiceWorker registration failed');
          });
      });
    }
    */

    console.log('üî• Tank Tools Login System v5.0 - Device Management Ready');
  </script>
</body>
</html>

